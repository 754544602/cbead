var caList={ue:null,init:function(){caList.clearAlertBox();caList.getClassLis();$('select').niceSelect();caList.deleteInfo();if($("#types").val()==1){$('#reimbursementTitle').text('新增教师课酬报销')}else if($("#types").val()==2){$('#reimbursementTitle').text('新增教师差旅报销')}$("#types").change(function(){if($("#types").val()==1){$('#reimbursementTitle').text('新增教师课酬报销');$yt_baseElement.showLoading();setTimeout(window.location.href='reimbursementAdd.html',500);setTimeout($yt_baseElement.hideLoading(),500)}else if($("#types").val()==2){$('#reimbursementTitle').text('新增教师差旅报销');$yt_baseElement.showLoading();setTimeout(window.location.href='travelAdd.html',500);setTimeout($yt_baseElement.hideLoading(),500)}});$("#issueDayeString").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});var nextPersonList=caList.getNextOperatePerson();if(nextPersonList!=null){$.each(nextPersonList,function(i,n){$("#dealingWithPeople").append($('<option value="'+n.userCode+'">'+n.userName+'</option>').data("classData",n))})};var pkId=$yt_common.GetQueryString("pkId");if(pkId!=null){caList.getListUpdate(pkId)}$("#dealingWithPeople").niceSelect();$('.page-return-btn').off().on("click",function(){caList.backNewsListPage()});$('#cancel').off().on("click",function(){caList.backNewsListPage()});$('#save').off('click').on('click',function(){if($('#projectCode').val()!=""){caList.isNoNull(1)}else{$yt_alert_Model.prompt("请选择班级")}});$('#submit').off('click').on('click',function(){if($('#projectCode').val()!=""){caList.isNoNull(2)}else{$yt_alert_Model.prompt("请选择班级")}})},backNewsListPage:function(){window.location.href="reimbursementList.html"},getClassLis:function(){var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/reduction/lookForAllProject",data:{projectCode:projectCode,selectParam:''},async:false,success:function(data){if(data.flag==0){var userName=caList.userInfo();var projectHeadCode;var classTeacherCode;var projectSellCode;var projectAidCode;$.each(data.data,function(i,n){projectHeadCode=n.projectHeadCode;classTeacherCode=n.classTeacherCode;projectSellCode=n.projectSellCode;projectAidCode=n.projectAidCode;if(projectHeadCode.indexOf(userName)!=-1||classTeacherCode.indexOf(userName)!=-1||projectSellCode.indexOf(userName)!=-1||projectHeadCode.indexOf(userName)!=-1||projectAidCode.indexOf(userName)!=-1){$("#projectCode").append($('<option value="'+n.projectCode+'">'+n.projectName+'</option>').data("classData",n))}});$("#projectCode").niceSelect();$('#projectCode').off('click').on('change',function(){var projectUserName=$('#projectCode option:selected').data("classData").projectHead;projectUserName==null?projectUserName='':projectUserName=projectUserName;var createUser=$('#projectCode option:selected').data("classData").createUserName;$('#projectUserName').text(projectUserName);$('#createUser').text(createUser);var projectCode=$('#projectCode option:selected').data("classData").projectCode;caList.getListAdd(projectCode)})}else{$yt_alert_Model.prompt("查询失败")}$yt_baseElement.hideLoading()},error:function(){$yt_alert_Model.prompt("网络异常，请稍后重试")}})},userInfo:function(){var userName="";$.ajax({async:false,type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){userName=data.data.userName}});return userName},isNoNull:function(dataStates){var testSelect=$("#types").val();var className=$('#projectCode option:selected').val();var dealingWithPeople=$('#dealingWithPeople').val();$yt_valid.validForm($("#valid-tab"));if(testSelect==''||className==''||dealingWithPeople==''){$yt_valid.validForm($(".valid-tab"))}else{caList.addnewsInfo(dataStates)}},getNextOperatePerson:function(){var user=null;$.ajax({type:"post",url:$yt_option.base_path+"uniform/workFlowOperate/getSubmitPageData",data:{businessCode:"news",types:'1'},async:false,success:function(data){if(data.flag==0){$.each(data.data,function(i,n){for(var k in n){user=n[k]}})}}});return user},clearAlertBox:function(){$('#projectCode').val("");$('#projectUserName').val("");$('#types').val("");$('#dealingWithPeople').val("");$('select').niceSelect()},getList:[],getListUpdate:function(pkId){me=this;$.ajax({type:"post",url:$yt_option.base_path+"finance/teacherExpense/getBeanByIdClassExpense",async:false,data:{pkId:pkId},success:function(data){if(data.flag==0){$("select.type-select").setSelectVal(data.data.expenseType);$("select.user-name-sel").setSelectVal(data.data.projectCode);var projectUserName=$('#projectCode option:selected').data("classData").projectUserName;var createUser=$('#projectCode option:selected').data("classData").createUser;$('#projectUserName').text(data.data.projectHead);$('#createUser').text(data.data.createUser);$('.details').text(data.data.remarks);var projectCode=$('#projectCode option:selected').data("classData").projectCode;me.getListAdd(projectCode);$('#reimbursementTitle').text('修改教师课酬报销')}}})},getListAdd:function(projectCode){var me=this;var pkId=$yt_common.GetQueryString("pkId");pkId==null?pkId='':pkId=pkId;$.ajax({type:"post",url:$yt_option.base_path+"finance/teacherExpense/getTeacherClassExpenseDetails",async:false,data:{projectCode:projectCode,pkId:pkId},success:function(data){if(data.flag==0){me.getList=data.data;var htmlTbody=$('.class-tbody');var twoTbody=$('#two-table').empty();var htmlTr='';var twoTr='';htmlTbody.empty();if(data.data.length>0){var afterTaxSum=0;var surrenderPersonalSum=0;var expenseMoneySum=0;var num=0;$.each(data.data,function(i,v){var papersType=v.papersType;if(papersType==1){papersType='身份证'}if(papersType==2){papersType='护照'}if(papersType==3){papersType='军官证'}if(papersType==4){papersType='其他'}var courseDateJson=v.courseDateJson;var lengthJson=courseDateJson.length;num=i+1;var jsonTd='';afterTaxSum+=v.afterTax;surrenderPersonalSum+=v.surrenderPersonal;expenseMoneySum+=v.expenseMoney;$.each(courseDateJson,function(index,value){if(index==0){htmlTr='<tr  class="rows tr'+i+index+' row'+i+'"><td rowspan="'+lengthJson+'"  class="teacherId" style="display:none;">'+v.teacherId+'</td><td rowspan="'+lengthJson+'" style="text-align:center" class="num">'+num+'</td><td rowspan="'+lengthJson+'" style="text-align:center"><a class="teacherName" style="color:#2080bf">'+v.teacherName+'</a></td><td rowspan="'+lengthJson+'" style="text-align:center">'+papersType+'</td><td rowspan="'+lengthJson+'">'+v.papersNumber+'</td><td rowspan="'+lengthJson+'">'+v.registeredBank+'</td><td rowspan="'+lengthJson+'">'+v.account+'</td><td style="text-align:center" class="courseDate">'+value.courseDate+'</td><td rowspan="'+lengthJson+'" class="afterTax"><input type="text" class="moneyInput yt-input" value="'+v.afterTax.toFixed(2)+'" readonly="readonly" style="border:none;background:none;text-align:right"/></td><td rowspan="'+lengthJson+'" style="text-align:right" class="surrenderPersonal">'+v.surrenderPersonal.toFixed(2)+'</td><td rowspan="'+lengthJson+'" style="text-align:right" class="expenseMoney">'+v.expenseMoney.toFixed(2)+'</td><td style="text-align:center"><a class="delete-tb" style="color:red;">删除</a><span> </span><a class="update-tb">编辑</a></td></tr>';v.num=i;htmlTr=$(htmlTr).data('data',v);htmlTbody.append(htmlTr)}else{htmlTr='<tr class="tr'+i+index+' row'+i+'"><td style="text-align:center" class="courseDate">'+value.courseDate+'</td><td style="text-align:center"><a class="delete-tb" style="color:red;">删除</a><span> </span><a class="update-tb">编辑</a></td></tr>';htmlTbody.append(htmlTr)}$(".tr"+i+index).find('.courseDate').data('courseDateJson',value)});twoTr='<tr class="twoTr twoTr'+i+'"><td style="text-align:center" class="twonum">'+(i+1)+'</td><td style="text-align:center">'+v.teacherName+'</td><td style="text-align:center">'+papersType+'</td><td>'+v.papersNumber+'</td><td>'+v.registeredBank+'</td><td>'+v.account+'</td><td style="text-align:center">电汇</td><td style="text-align:right" class="twotablemoney" >'+v.afterTax.toFixed(2)+'</td></tr>';twoTbody.append(twoTr);$('.teacherName').off('click').on('click',function(){window.location.href='../teacher/teacherInf.html?pkId='+$(this).parents('tr').find('.courseDate').data('courseDateJson').teacherId})});var numb=num+1;htmlTr='<tr><td class="numb" style="display:none;">'+numb+'</td><td colspan="7" style="text-align:center">合计</td><td class="afterTaxSumNum"  style="text-align:right;font-weight:bold">'+afterTaxSum.toFixed(2)+'</td><td id="surrenderPersonalSum" style="text-align:right;font-weight:bold">'+surrenderPersonalSum.toFixed(2)+'</td><td id="expenseMoneySum" style="text-align:right;font-weight:bold">'+expenseMoneySum.toFixed(2)+'</td><td></td></tr>';htmlTbody.append(htmlTr)}else{htmlTr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="11" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},addnewsInfo:function(dataStates){var me=this;$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString("pkId");var processInstanceId="";if(pkId!=null){$.ajax({type:"post",url:$yt_option.base_path+"finance/teacherExpense/getBeanByIdClassExpense",async:false,data:{pkId:pkId},success:function(data){if(data.flag==0){processInstanceId=data.data.processInstanceId}}})}var teacherDetails=[];$.each($('.rows'),function(x,y){var json={teacherId:$(y).children('.teacherId').text(),afterTax:$(y).children('.afterTax').children('.moneyInput').val()};teacherDetails.push(json)});teacherDetails=JSON.stringify(teacherDetails);var expenseClassDetails=[];$.each($('.courseDate'),function(a,b){expenseClassDetails.push($(b).data('courseDateJson'))});if(me.deleteData!=''){expenseClassDetails=expenseClassDetails.concat(me.deleteData)}expenseClassDetails=JSON.stringify(expenseClassDetails);var projectCode=$('#projectCode').val();var expenseType=$("#types").val();var dealingWithPeople=$('#dealingWithPeople').val();var details=$('.details').val();var teacherCount=$('.num').length;var expenseMoney=$('.class-tbody').find('.afterTaxSumNum').text();$.ajax({type:"post",url:$yt_option.base_path+"finance/teacherExpense/addOrUpdateBeanClassExpense",data:{expenseClassDetails:expenseClassDetails,teacherDetails:teacherDetails,pkId:pkId,projectCode:projectCode,expenseType:expenseType,teacherCount:teacherCount,expenseMoney:expenseMoney,businessCode:"classExpense",dealingWithPeople:dealingWithPeople,dataStates:dataStates,processInstanceId:processInstanceId,remarks:details,nextCode:"submited"},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("添加成功");$(".yt-edit-alert,#heard-nav-bak").hide()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("提交失败")})}caList.backNewsListPage()}})},deleteData:[],deleteInfo:function(){var me=this;$('.list-box').on('click','.delete-tb',function(){var course=$(this).parent().siblings(".courseDate").data("courseDateJson");course.isEffective='0';me.deleteData.push(course);if($(this).parents('tr').children('td').attr('rowspan')==undefined){var trclass=$(this).parent().parent()[0].className.split(' ')[1];for(let j=0;j<$("."+trclass+'.rows').find('td').length;j+=1){if($("."+trclass+'.rows').find('td').eq(j).attr('rowspan')!=undefined){var rowspan=$("."+trclass+'.rows').find('td').eq(j).attr('rowspan');$("."+trclass+'.rows').find('td').eq(j).attr('rowspan',rowspan-1)}}$(this).parent().parent().remove()}else{if($(this).parent().parent().children('td').attr('rowspan')==1){if($(this).parents('tr').data('data')!=undefined){$('#two-table').find('.twoTr'+$(this).parents('tr').data('data').num).remove()}$(this).parent().parent().remove();$.each($('.num'),function(i,n){$(n).text(i+1);$('.twonum').eq(i).text(i+1)});me.allmoney()}else{for(let k=0;k<$(this).parent().parent().find('td').length;k+=1){if($(this).parent().parent().find('td').eq(k).attr('rowspan')!=undefined){var rowspan=$(this).parent().parent().find('td').eq(k).attr('rowspan');$(this).parent().parent().find('td').eq(k).attr('rowspan',rowspan-1)}}$(this).parent().parent().children('.courseDate').text($(this).parent().parent().next().children('.courseDate').text());$(this).parent().parent().children('.courseDate').data("courseDateJson",$(this).parent().parent().next().children('.courseDate').data("courseDateJson"));$(this).parent().parent().next().remove()}}if($('.class-tbody').find('tr').length==1){var tr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="11" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';$('.class-tbody').html(tr)}if($('#two-table').find('tr').length==0){var tr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="11" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';$('#two-table').append(tr)}});$('.list-box').on('click','.update-tb',function(){$('.list-box input').removeAttr('readonly');$('.list-box input').css('border','1px solid #e6e6e6');$(this).addClass('yes');$(this).text('确定')});$('.list-box').on('click','.yes',function(){$('.list-box input').attr('readonly','readonly');$('.list-box input').css('border','none');$('.yes').text('编辑');$('.yes').removeClass('yes');me.allmoney()})},allmoney:function(){var allmoney=0;var surrenderPersonalSum=0;var expenseMoneySum=0;$.each($('.moneyInput'),function(i,n){$(n).val()=='.'?$(n).val(0):$(n).val($(n).val());$(n).val(Number($(n).val()).toFixed(2));allmoney+=Number($(n).val())});$.each($('.surrenderPersonal'),function(i,n){surrenderPersonalSum+=Number($(n).text())});$.each($('.expenseMoney'),function(i,n){expenseMoneySum+=Number($(n).text())});$('.afterTaxSumNum').text(allmoney.toFixed(2));$('#surrenderPersonalSum').text(surrenderPersonalSum.toFixed(2));$('#expenseMoneySum').text(expenseMoneySum.toFixed(2))},getSurrender:function(afterTax,where){$.ajax({type:"post",url:$yt_option.base_path+"finance/teacherExpense/getSurrenderPersonal",async:false,data:{afterTax:afterTax},success:function(data){$(where).text(Number(data.data).toFixed(2))},error:function(data){$yt_alert_Model.prompt('网络异常,计算失败')}})}};$(function(){caList.init();$('.list-box').on('keyup','.moneyInput',function(){if($(this).val()==''){$(this).val('0')}$(this).val($(this).val().replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,''))});$('.list-box').on('blur','.moneyInput',function(){if($(this).val()==''){$(this).val('0')}caList.getSurrender($(this).val(),$(this).parent().siblings('.surrenderPersonal'));var surrenderPersonal=$(this).parent().siblings('.surrenderPersonal').text();var num=Number($(this).val())+Number(surrenderPersonal);$(this).parent().siblings('.expenseMoney').text(num.toFixed(2));$('#two-table').find('tr').eq($(this).parents('tr').index()).find('.twotablemoney').text(Number($(this).val()).toFixed(2));$(this).val($(this).val().replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,''));caList.allmoney()})});
var projectBudgetChange={init:function(){var pkId=$yt_common.GetQueryString('pkId');projectBudgetChange.getBudgetInf();$(".report-date").calendar({speed:200,complement:true,readonly:true,lowerLimit:"NaN",nowData:true,dateFmt:"yyyy-MM-dd HH:mm:ss",callback:function(){}});$(".out-hospital-date").calendar({speed:200,complement:true,readonly:true,lowerLimit:"NaN",nowData:true,dateFmt:"yyyy-MM-dd HH:mm:ss",callback:function(){}});var projectSelect=projectBudgetChange.getAddBudgetSelect();if(projectSelect!=null){$.each(projectSelect,function(i,n){$(".project-code").append('<option value="'+n.projectCode+'" createUserName="'+n.createUserName+'" projectType="'+n.projectType+'" classTeacher="'+n.classTeacher+'" projectHead="'+n.projectHead+'" startDate="'+n.startDate+'" endDate="'+n.endDate+'" traineeTotal="'+n.traineeTotal+'">'+n.projectName+'</option>')})}$(".project-code").niceSelect();var dealingWithPeople=projectBudgetChange.getListSelectDealingWithPeople();if(dealingWithPeople!=null){$.each(dealingWithPeople,function(i,n){$(".dealing-with-people").append('<option value="'+n.userCode+'">'+n.userName+'</option>')})}$(".dealing-with-people").niceSelect();$(".save-budget").click(function(){var dataStates=1;projectBudgetChange.projectBudgetChangeInf(dataStates);window.location.href="/cbead/website/view/projectBudget/budgetList.html"});$(".submit-budget").click(function(){var dataStates=2;projectBudgetChange.projectBudgetChangeInf(dataStates);window.location.href="/cbead/website/view/projectBudget/budgetList.html"});$(".btn-off").click(function(){window.location.href="/cbead/website/view/projectBudget/budgetList.html"})},getListSelectDealingWithPeople:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/workFlowOperate/getSubmitPageData",data:{businessCode:"project",processInstanceId:"",parameters:"",versionNum:""},async:false,success:function(data){$.each(data.data,function(i,n){console.log(n);console.log(i);for(var k in n){console.log('k',k);console.log("n[k]",n[k]);list=n[k]}})}});return list},getAddBudgetSelect:function(){debugger;var list=[];$.ajax({type:"post",url:$yt_option.base_path+"finance/reduction/lookForAllProject",data:{searchParameters:"",budget:"budget"},async:false,success:function(data){list=data.data||[]}});return list},getBudgetSubsidiary:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"finance/projectBudget/getProjectBudgetCostBase",data:{},async:false,success:function(data){list=data.data||[]}});return list},getBudgetInf:function(){var pkId=$yt_common.GetQueryString('pkId');$.ajax({type:"post",url:$yt_option.base_path+"finance/projectBudget/getBeanById",data:{pkId:pkId},success:function(data){if(data.flag==0){$(".budget-inf").setDatas(data.data);if(data.data.isOffSiteTraining==1){$(".training-true").setRadioState("check")}else{$(".training-false").setRadioState("check")}if(data.data.isOffSiteTraining==1){$(".cost-low").setRadioState("check")}else{$(".cost-height").setRadioState("check")}$(".project-code").setSelectVal(data.data.projectCode);$(".dealing-with-people").setSelectVal(data.data.dealingWithPeople);if($(".project-code").val()!=""){var createUserName=$("select.project-code option:selected").attr("createUserName");var projectType=$("select.project-code option:selected").attr("projectType");var classTeacher=$("select.project-code option:selected").attr("classTeacher");var projectHead=$("select.project-code option:selected").attr("projectHead");var startDate=$("select.project-code option:selected").attr("startDate");var endDate=$("select.project-code option:selected").attr("endDate");var traineeTotal=$("select.project-code option:selected").attr("traineeTotal");$(".create-user-name").text(createUserName);if(projectType==2){$(".project-type").text("委托")}if(projectType==3){$(".project-type").text("选学")}if(projectType==4){$(".project-type").text("调训")}if(classTeacher=="null"){$(".class-teacher").text("")}else{$(".class-teacher").text(classTeacher)}if(projectHead=="null"){$(".project-head").text("")}else{$(".project-head").text(projectHead)}$(".start-date").text(startDate.split(" ")[0]);$(".end-date").text(endDate.split(" ")[0]);traineeTotal=='null'?$(".trainee-total").text(0):$(".trainee-total").text(traineeTotal)}var times=data.data.dataType;var htmlappend='';if(times!=undefined){for(let j=0;j<times;j+=1){htmlappend='<div class="approval-change-after approval-change-after'+(j+1)+'"><div class="class-info-div">预算明细(第'+(j+1)+'次变更)</div><div class="tab-content class-info"><div class="class-info-centent budget-subsidiary-change"><div class="teach-related-expenses"><div class="teach-related-expenses-title"><span>教学相关费用</span></div><table class="class-info-table teach-related-expenses-table"></table></div><div class="logistics-related-expenses"><div class="teach-related-expenses-title"><span>后勤相关费用</span></div><table class="class-info-table logistics-related-expenses-table"></table></div></div></div></div>';$('#approval-change-after').append(htmlappend)}}else{$(".approval-change-after").hide();$("#approval-change-after").hide();$(".after-div").hide()}var projectBudgetDetailsArr=$.parseJSON(data.data.projectBudgetDetails);var projectBudget='';if(projectBudgetDetailsArr!=null){$.each(projectBudgetDetailsArr,function(i,n){projectBudget=$('<tr><td align="right"><input type="hidden" value="'+n.costCode+'" class="cost-code"><span>'+n.costName+'：</span></td><td><span></span><input type="text" class="yt-input budget-cost inp-span" data-val="budgetCost" placeholder="请输入"></td><td style="width: 50px;"><span>元</span></td><td class="content-td"><span></span><input type="text" class="yt-input according-instructions gist inp-span" data-val="accordingInstructions" placeholder="请输入依据说明"></td></tr>');projectBudget.setDatas(n);if(n.types==1){if(n.costType==1){$(".approval-change-before .teach-related-expenses-table").append(projectBudget)}if(n.costType==2){$(".approval-change-before .logistics-related-expenses-table").append(projectBudget)}}else if(n.types==2){if(n.costType==1){$(".approval-change-after"+n.dataType+" .teach-related-expenses-table").append(projectBudget)}if(n.costType==2){$(".approval-change-after"+n.dataType+" .logistics-related-expenses-table").append(projectBudget)}}})}$('.project-code').prev().text($('.project-code').find('option:checked').text());$('.project-code').hide();$(".report-date").prev().text($(".report-date").val());$(".report-date").hide();$(".out-hospital-date").prev().text($(".out-hospital-date").val());$(".out-hospital-date").hide();$(".entrust-org-count").prev().text($(".entrust-org-count").val());$(".entrust-org-count").hide();$('.is-off-site-training').setRadioState("disabled");if($('input[name="test"]:checked').val()==1){$(".training-span").text("是")}else{$(".training-span").text("否")}if($('input[name="test"]:checked').val()==1){$(".cost-span").text("基本标准")}else{$(".cost-span").text("高成本标准")}$(".check-label").hide();$(".cost-standard").setRadioState("disabled");$(".offsite-training-requirement").prev().text($(".offsite-training-requirement").val());$(".offsite-training-requirement").hide();$.each($(".teach-related-expenses-table tbody").find(".inp-span"),function(p,s){$(s).prev().text($(s).val());$(s).hide();$(s).parent().parent().find(".content-td").css("width","600px")});$.each($(".logistics-related-expenses-table tbody").find(".inp-span"),function(r,g){$(g).prev().text($(g).val());$(g).hide();$(g).parent().parent().find(".content-td").css("width","600px")})}else{$yt_alert_Model.prompt("获取失败")}}})},projectBudgetChangeInf:function(dataStates){var pkId=$yt_common.GetQueryString('pkId');var projectCode=$(".project-code").val();var reportDate=$(".report-date").val();var outHospitalDate=$(".out-hospital-date").val();var entrustOrgCount=$(".entrust-org-count").val();var isOffSiteTraining=$('input[name="test"]:checked').val();var offSiteTrainingRequirement=$(".offsite-training-requirement").val();var costStandard=$('input[name="costStandard"]:checked').val();var projectBudgetDetails="";var dealingWithPeople=$(".dealing-with-people").val();if($(".project-span").length>0){projectCode=$(".hid-project").val();isOffSiteTraining=$(".hid-is-offSite-training").val();costStandard=$(".hid-cost-standard").val()}var projectBudgetDetailsArr=[];$(".edit-teach-related-expenses-table tr").each(function(i,n){costCode=$(n).find(".cost-code").val();budgetCost=$(n).find(".budget-cost").val();accordingInstructions=$(n).find(".according-instructions").val();var arrProjectBudgetDetails={costCode:costCode,budgetCost:budgetCost,accordingInstructions:accordingInstructions};projectBudgetDetailsArr.push(arrProjectBudgetDetails)});$(".edit-logistics-related-expenses-table tr").each(function(i,n){costCode=$(n).find(".cost-code").val();budgetCost=$(n).find(".budget-cost").val();accordingInstructions=$(n).find(".according-instructions").val();var arrProjectBudgetDetails={costCode:costCode,budgetCost:budgetCost,accordingInstructions:accordingInstructions};projectBudgetDetailsArr.push(arrProjectBudgetDetails)});var projectBudgetDetails=JSON.stringify(projectBudgetDetailsArr);$.ajax({type:"post",url:$yt_option.base_path+"finance/projectBudget/addOrUpdateBean",data:{pkId:pkId,types:2,projectCode:projectCode,reportDate:reportDate,outHospitalDate:outHospitalDate,entrustOrgCount:entrustOrgCount,isOffSiteTraining:isOffSiteTraining,offSiteTrainingRequirement:offSiteTrainingRequirement,costStandard:costStandard,projectBudgetDetails:projectBudgetDetails,dataStates:dataStates,businessCode:"projectBudget",dealingWithPeople:dealingWithPeople,opintion:"",processInstanceId:"",nextCode:"submited"},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("操作成功")}else{$yt_alert_Model.prompt("操作失败")}}})}};$(function(){projectBudgetChange.init()});
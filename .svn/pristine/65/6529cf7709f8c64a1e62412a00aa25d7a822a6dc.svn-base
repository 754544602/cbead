var ticketOpenInfo={init:function(){ticketOpenInfo.getClassInfo();var projectType=$yt_common.GetQueryString("projectType");if(projectType==3){$(".entrust-info-title").hide();$(".entrust-info").hide()}else{$(".entrust-info-title").show();$(".entrust-info").show()}$(".tab-title-list button").click(function(){$(this).addClass("active").siblings().removeClass("active");operate=$(this).text();if(operate=="• 项目开票"){$(".programme").show();$('.bill-div').show();$('.class-div').hide();ticketOpenInfo.getPlanListInfo();ticketOpenInfo.getPersonListInfo()};if(operate=="• 班级信息"){$(".programme").hide();$('.class-div').show();$('.bill-div').hide();ticketOpenInfo.getClassInfo()}});$('.page-return-btn').on('click',function(){window.history.back()});$(".billing-inf-alert #project-states").change(function(){if($(this).val()==1){ticketOpenInfo.clearOpenTicket();$(".billing-inf-alert table span.per-span").text("*");$(".billing-inf-alert .is-not-comp label input[value='1']").setRadioState("check");$(".billing-inf-alert .is-not-comp").show()}else{ticketOpenInfo.clearOpenTicket();$(".billing-inf-alert table span.per-span").text("*");$(".billing-inf-alert table span.comp-span").text("*");$(".billing-inf-alert table span.comp-label-span").text("*");$(".billing-inf-alert .is-not-comp").hide()}});$(".billing-inf-alert .is-not-comp label").click(function(){var thisVal=$(this).find('input:checked').val();if(thisVal==1){ticketOpenInfo.clearOpenTicket();$(".billing-inf-alert table span.per-span").text("*");}else if(thisVal==2){ticketOpenInfo.clearOpenTicket();$(".billing-inf-alert table span.per-span").text("*");$(".billing-inf-alert table span.comp-span").text("*")}});$(".search-btn").click(function(){ticketOpenInfo.getPersonListInfo()});$('#checkBox1').change(function(){ticketOpenInfo.getPersonListInfo()});$('#checkBox2').change(function(){ticketOpenInfo.getPersonListInfo()});$('.edit-bill-info').click(function(){var projectCode=$yt_common.GetQueryString("projectCode");ticketOpenInfo.clearOpenTicket();ticketOpenInfo.clearBillInfoAlert();$(".billing-inf-alert table span.per-span").text("*");$('#project-states').niceSelect();var allCheck=$('.company-list tbody').find('.check');var stuCheck=$('.trainee-bill-table tbody').find('.check');var allChekData=allCheck.parents('tr').data('data');var stuData=stuCheck.parents('tr').data('data');if(allCheck.length+stuCheck.length==1){if(allCheck.length!=0){$('.hid-project-code').val(projectCode);$('.hid-types').val(allChekData.type);$('.hid-order-num').val(allChekData.orderNum);$('.hid-trainee-or-group-id').val(allChekData.groupId)}else if(stuCheck.length!=0){$('.hid-project-code').val(projectCode);$('.hid-types').val(stuData.type);$('.hid-order-num').val(stuData.orderNum);$('.hid-trainee-or-group-id').val(stuData.traineeId)}ticketOpenInfo.getCompanyInfo(projectCode,$('.hid-types').val(),$('.hid-trainee-or-group-id').val());ticketOpenInfo.billingInfoAlert()}else{$yt_alert_Model.prompt("请选中一行数据进行操作",2000)}});$(".bill-invoice-type").change(function(){if($(".bill-invoice-type").val()=="1"){$(".bill-check").show();$(".telephone-span,.address-span,.bank-span,.account-span").hide();$(".duty-telephone").attr("validform","{isNull:false,blurFlag:false,type:'phone',msg:'请输入电话'}");$(".duty-address").attr("validform","{isNull:false,blurFlag:false,msg:'请输入地址'}");$(".duty-registered-bank").attr("validform","{isNull:false,blurFlag:false,msg:'请输入开户行'}");$(".duty-account").attr("validform","{isNull:false,blurFlag:false,msg:'请输入账号'}");$(".duty-tax-number,.duty-telephone,.duty-address,.duty-registered-bank,.duty-account").removeClass("valid-hint");$(".duty-tax-number,.duty-telephone,.duty-address,.duty-registered-bank,.duty-account").next().text("")}else{$(".bill-check").hide();$(".tax-number-span,.telephone-span,.address-span,.bank-span,.account-span").show();$(".duty-tax-number").attr("validform","{isNull:true,blurFlag:true,msg:'请输入税号'}");$(".duty-telephone").attr("validform","{isNull:true,blurFlag:true,type:'phone',msg:'请输入电话'}");$(".duty-address").attr("validform","{isNull:true,blurFlag:true,msg:'请输入地址'}");$(".duty-registered-bank").attr("validform","{isNull:true,blurFlag:true,msg:'请输入开户行'}");$(".duty-account").attr("validform","{isNull:true,blurFlag:true,msg:'请输入账号'}")}});$(".group-check").change(function(){$(".org-name-span,tax-number-span").show();$(".tax-number-span").show();$(".duty-telephone").attr("validform","{isNull:false,blurFlag:false,type:'phone',msg:'请输入电话'}");$(".duty-address").attr("validform","{isNull:false,blurFlag:false,msg:'请输入地址'}");$(".duty-registered-bank").attr("validform","{isNull:false,blurFlag:false,msg:'请输入开户行'}");$(".duty-account").attr("validform","{isNull:false,blurFlag:false,msg:'请输入正确格式电话号！'}")});$(".person-check").change(function(){$(".tax-number-span,.telephone-span,.address-span,.bank-span,.account-span").hide();$(".duty-tax-number").attr("validform","{isNull:false,blurFlag:false,msg:'请输入税号'}");$(".duty-telephone").attr("validform","{isNull:false,blurFlag:false,type:'phone',msg:'请输入电话'}");$(".duty-address").attr("validform","{isNull:false,blurFlag:false,msg:'请输入地址'}");$(".duty-registered-bank").attr("validform","{isNull:false,blurFlag:false,msg:'请输入开户行'}");$(".duty-account").attr("validform","{isNull:false,blurFlag:false,msg:'请输入账号'}");$(".duty-tax-number").removeClass("valid-hint");$(".duty-tax-number").next().text("")});$('.write-bill-btn').click(function(){var projectCode=$yt_common.GetQueryString("projectCode");ticketOpenInfo.clearWriteBillAlert();$('.duty-invoiceOrder-type').niceSelect();var allCheck=$('.company-list tbody').find('.check');var stuCheck=$('.trainee-bill-table tbody').find('.check');var allChekData=allCheck.parents('tr').data('data');var stuData=stuCheck.parents('tr').data('data');if(allCheck.length+stuCheck.length==1){if(allCheck.length!=0){$('.hid-project-code').val(projectCode);$('.hid-types').val(allChekData.type);$('.hid-order-num').val(allChekData.orderNum);$('.hid-trainee-or-group-id').val(allChekData.groupId)}else if(stuCheck.length!=0){$('.hid-project-code').val(projectCode);$('.hid-types').val(stuData.type);$('.hid-order-num').val(stuData.orderNum);$('.hid-trainee-or-group-id').val(stuData.traineeId)}ticketOpenInfo.getOpnTicketMsg(projectCode,$('.hid-types').val(),$('.hid-trainee-or-group-id').val());ticketOpenInfo.writeBillingAlert();$('#project-states').niceSelect()}else{$yt_alert_Model.prompt("请选中一行数据进行操作",2000)}});$('.duty-sure-btn-table .duty-sure-btn').click(function(){var projectCode=$('.hid-project-code').val();var types=$('.hid-types').val();var traineeOrGroupId=$('.hid-trainee-or-group-id').val();var orderNum=$('.hid-order-num').val();var invoiceModel="";var count=$('.iduty-invoice-number').val();var price=$('.iduty-invoice-unit-price').val();var tuition=$('.iduty-tuition').val();if(!isNaN(parseInt(count))&&!isNaN(parseInt(price))&&!isNaN(parseInt(tuition))&&tuition!=""){ticketOpenInfo.addDutyInfo(projectCode,types,traineeOrGroupId,orderNum);$(".write-billing-alert").hide();$("#pop-modle-alert").hide()}else{if(isNaN(parseInt(count))){$yt_alert_Model.prompt("数量只能为数字！")}else if(isNaN(parseInt(price))){$yt_alert_Model.prompt("单价只能为数字！")}else if(isNaN(parseInt(tuition))){$yt_alert_Model.prompt("总金额只能为数字！")}else{$yt_alert_Model.prompt("总金额不能能空！")}}});$('.iduty-invoice-number').blur(function(){var count=$('.iduty-invoice-number').val();if(count==""){count=0}var price=$('.iduty-invoice-unit-price').val();if(price==""){price=0}count=parseInt(count);price=parseInt(price);if(!isNaN(count)){if(count!=""&&price!=""){$('.iduty-tuition').val(count*price);ticketOpenInfo.getTaxRate()}}else{$yt_alert_Model.prompt("数量只能为数字！")}});$('.iduty-invoice-unit-price').blur(function(){var count=$('.iduty-invoice-number').val();if(count==""){count=0}var price=$('.iduty-invoice-unit-price').val();if(price==""){price=0}count=parseInt(count);price=parseInt(price);if(!isNaN(count)){if(count!=""&&price!=""){$('.iduty-tuition').val(count*price);ticketOpenInfo.getTaxRate()}}else{$yt_alert_Model.prompt("单价只能为数字！")}});$('.iduty-tuition').blur(function(){var tuition=$('.iduty-tuition').val();tuition=parseInt(tuition);if(tuition==""){tuition=0}if(!isNaN(tuition)){if(tuition!=""){ticketOpenInfo.getTaxRate()}}else{$yt_alert_Model.prompt("金额只能为数字！")}});$('.duty-invoiceOrder-type').change(function(){ticketOpenInfo.getTaxRate()});$('.manual-bill-btn').click(function(){if($('.bill-div tbody input[type=checkbox]:checked').length==0){$yt_alert_Model.prompt('请选中一行数据进行操作')}else if($('.bill-div tbody input[type=checkbox]:checked').length!=1){$yt_alert_Model.prompt('只可选中一行数据进行操作')}else{alertDiv();var data=$('.yt-table-active').data('data');$('.manual-sure-btn').off().click(function(){if($yt_valid.validForm($('.manual-invoice-table'))){if(data.type==1){ticketOpenInfo.manualInvoice(data.type,data.groupId,data.orderNum)}else if(data.type==2){ticketOpenInfo.manualInvoice(data.type,data.traineeId,data.orderNum)}}})}$('.manual-invoice-dollar').off().blur(function(){$(this).val($yt_baseElement.fmMoney($(this).val(),2))});function alertDiv(){$(".manual-invoice-alert").show();$yt_model_drag.modelDragEvent($(".manual-invoice-alert .yt-edit-alert-title"));$yt_alert_Model.setFiexBoxHeight($(".manual-invoice-alert .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".manual-invoice-alert"));$('.manual-invoice-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".manual-invoice-alert").hide();$("#pop-modle-alert").hide()})}});$('.merge-bill-btn').click(function(){if($('.check-all-tab tbody input[type=checkbox]:checked').length==0&&$('.trainee-bill-table tbody input[type=checkbox]:checked').length==0){$yt_alert_Model.prompt('请选择数据');return false}$('.invoice-model-td input').setRadioState('uncheck');$('.mergeInvoiceTable input[type=text]').val('');$('.mergeInvoiceAlert .duty-table input[type=text]').val('');$('.taxt-rate').text('');$('.taxt-rate-money').text('');$('.invoicePeople').empty();var traineeOrGroupIds=[];var types=[];$.each($('.trainee-bill-table tbody input[type=checkbox]:checked'),function(i,n){var datas=$(n).parents('tr').data('data');var htmlTr='<li class="yt-list-li" style="float:left;border:none;width:135px"><label class="check-label yt-radio"><input type="radio" name="text"/><span>'+datas.realName+'</span><img src="../../resources/images/icons/eyes.png" class="eyes" style="margin-left:5px;"/></label></li>';htmlTr=$(htmlTr).data('data',datas);$('.invoicePeople').append(htmlTr);traineeOrGroupIds.push($(n).parents('tr').data('data').traineeId);types.push(2)});$.each($('.check-all-tab tbody input[type=checkbox]:checked'),function(i,n){var datas=$(n).parents('tr').data('data');var htmlTr='<li class="yt-list-li" style="float:left;border:none;"><label class="check-label yt-radio"><input type="radio" name="text"/><span>'+datas.groupName+'</span><img src="../../resources/images/icons/eyes.png" class="eyes" style="margin-left:5px;"/></label></li>';htmlTr=$(htmlTr).data('data',datas);$('.invoicePeople').append(htmlTr);traineeOrGroupIds.push($(n).parents('tr').data('data').groupId);types.push(1)});traineeOrGroupIds=traineeOrGroupIds.join(',');types=types.join(',');$('.eyes').hover(function(){$(this).attr('src','../../resources/images/icons/eyes-hover.png')},function(){$(this).attr('src','../../resources/images/icons/eyes.png')});$('.eyes').tooltip({content:function(){var lis=$(this).parents('li');var projectCode=$yt_common.GetQueryString("projectCode");var htmls;htmls=getInvoice(projectCode,lis,htmls);return htmls},onShow:function(){$(this).tooltip('tip').css({backgroundColor:'#666',borderColor:'#666',color:'#fff'})}});function getInvoice(projectCode,lis,htmls){var pkId=lis.data('data').traineeId;if(pkId==undefined){pkId=lis.data('data').groupId}$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getInvoice",async:false,data:{projectCode:projectCode,types:lis.data('data').type,traineeOrGroupId:pkId},beforeSend:function(){},success:function(data){if(data.flag==0){if(data.data==null){data.data={invoiceModel:'',orgName:'',invoiceType:'',taxNumber:'',telephone:'',address:'',registeredBank:'',account:''}}if(data.data.invoiceModel==1){data.data.invoiceModelVel='个人或事业单位'}else if(data.data.invoiceModel==2){data.data.invoiceModelVel='单位'}else{data.data.invoiceModelVel=''}if(data.data.invoiceType=='0'){data.data.invoiceTypeVel='暂不开票'}else if(data.data.invoiceType==1){data.data.invoiceTypeVel='普通发票'}else if(data.data.invoiceType==2){data.data.invoiceTypeVel='增值税发票'}else{data.data.invoiceTypeVel=''}lis.data('invoice',data.data);htmls='<table><tr style="height:30px"><td align="right">发票类型：</td><td style="width:100px">'+data.data.invoiceModelVel+'</td><td align="right">发票类型：</td><td style="width:100px">'+data.data.invoiceTypeVel+'</td></tr><tr style="height:30px"><td align="right">名称：</td><td>'+data.data.orgName+'</td><td align="right">税号：</td><td>'+data.data.taxNumber+'</td></tr><tr style="height:30px"><td align="right">电话：</td><td>'+data.data.telephone+'</td><td align="right">地址：</td><td>'+data.data.address+'</td></tr><tr style="height:30px"><td align="right">开户行：</td><td>'+data.data.registeredBank+'</td><td align="right">账号：</td><td>'+data.data.account+'</td></tr></table>'}else{$yt_alert_Model.prompt('查询失败')}$yt_baseElement.hideLoading()},error:function(){$yt_baseElement.hideLoading();$yt_alert_Model.prompt('网络异常，请稍后重试')}});return htmls}$('.invoicePeople input[type=radio]').change(function(){$yt_baseElement.showLoading();if($(this).parents('li').data('invoice')==undefined){var lis=$(this).parents('li');var projectCode=$yt_common.GetQueryString("projectCode");getInvoice(projectCode,lis)}$('.mergeInvoiceTable').setDatas($(this).parents('li').data('invoice'));$('.mergeInvoiceTable input[type=radio][name=radioType1][value='+$(this).parents('li').data('invoice').invoiceModel+']').setRadioState('check');$('.mergeInvoiceTable input[type=radio][name=radioType][value='+$(this).parents('li').data('invoice').invoiceType+']').setRadioState('check');if($('.mergeInvoiceTable input[type=radio][name=radioType1]:checked').val()==2){$('.mergeInvoiceTable .invoice-model-td label').hide();$('.invoiceModelTitle').hide()}else{$('.mergeInvoiceTable .invoice-model-td label').show();$('.invoiceModelTitle').show()}$yt_baseElement.hideLoading()});$('.mergeInvoiceTable .invoice-type').change(function(){if($(this).val()==2){$('.mergeInvoiceTable .invoice-model-td label').hide();$('.invoiceModelTitle').hide()}else{$('.mergeInvoiceTable .invoice-model-td label').show();$('.invoiceModelTitle').show()}});$('.mergeInvoiceAlert .invoice-invoiceOrder-type,.mergeInvoiceTable .invoice-type').niceSelect();if($('.mergeInvoiceTable .invoice-type').val()==2){$('.mergeInvoiceTable .invoice-model-td label').hide();$('.invoiceModelTitle').hide()}else{$('.mergeInvoiceTable .invoice-model-td label').show();$('.invoiceModelTitle').show()}$('.invoice-invoice-unit-price').blur(function(){$(this).val($(this).val().replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,''));if($(this).val()!=''&&$('.invoice-invoice-number').val()!=''){$('.invoice-tuition').val($(this).val()*$('.invoice-invoice-number').val());rate()}});$('.invoice-invoice-number').blur(function(){$(this).val($(this).val().replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,''));if($(this).val()!=''&&$('.invoice-invoice-unit-price').val()!=''){$('.invoice-tuition').val($(this).val()*$('.invoice-invoice-unit-price').val());rate()}});$('.invoice-tuition').blur(function(){$(this).val($(this).val().replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,''));rate()});$('.mergeInvoiceAlert .invoice-invoiceOrder-type').change(function(){rate()});function rate(){var tuition=Number($('.invoice-tuition').val());var invoiceOrderType=$('.mergeInvoiceAlert .invoice-invoiceOrder-type').val();if(invoiceOrderType==1||invoiceOrderType==4||invoiceOrderType==5){$('.taxt-rate').text("3%");$('.taxt-rate-money').text((tuition-(tuition/(1.03))).toFixed(2))}else if(invoiceOrderType==2||invoiceOrderType==3||invoiceOrderType==6){$('.taxt-rate').text("6%");$('.taxt-rate-money').text((tuition-(tuition/(1.06))).toFixed(2))}}$(".mergeInvoiceAlert").show();$yt_alert_Model.setFiexBoxHeight($(".mergeInvoiceAlert .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".mergeInvoiceAlert"));$yt_model_drag.modelDragEvent($(".mergeInvoiceAlert .yt-edit-alert-title"));$('.mergeInvoiceAlert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".mergeInvoiceAlert").hide()});$('.mergeInvoiceAlert .yt-eidt-model-bottom .yt-model-sure-btn').off().on('click',function(){var invoiceModel=$('.mergeInvoiceTable .invoice-type').val();var invoiceType=$('.mergeInvoiceTable input[type=radio][name=radioType]:checked').val();if(invoiceType==undefined){$yt_alert_Model.prompt('请选择发票抬头');return false}if(invoiceModel==2){if($yt_valid.validForm($(".mergeInvoiceTable"))){ticketOpenInfo.mergeBillFn(types,traineeOrGroupIds,1);$(".mergeInvoiceAlert").hide()}}if(invoiceModel==1&&invoiceType==1){if($yt_valid.validForm($("#invoice-org-name"))){ticketOpenInfo.mergeBillFn(types,traineeOrGroupIds,1);$(".mergeInvoiceAlert").hide()}}if(invoiceModel==1&&invoiceType==2){if($yt_valid.validForm($("#invoice-tax"))){ticketOpenInfo.mergeBillFn(types,traineeOrGroupIds,1);$(".mergeInvoiceAlert").hide()}}})});$('.separate-bill-btn').click(function(){var traineeOrGroupIds=[];var types=[];$.each($('.trainee-bill-table tbody input[type=checkbox]:checked'),function(i,n){traineeOrGroupIds.push($(n).parents('tr').data('data').traineeId);types.push(2)});$.each($('.check-all-tab tbody input[type=checkbox]:checked'),function(i,n){traineeOrGroupIds.push($(n).parents('tr').data('data').groupId);types.push(1)});traineeOrGroupIds=traineeOrGroupIds.join(',');types=types.join(',');ticketOpenInfo.mergeBillFn(types,traineeOrGroupIds,2)});$('.edit-remark-btn').click(function(){ticketOpenInfo.trainOrcompanyIsCheck();var types=$('.hid-types').val();var allCheck;if(types==1){allCheck=$('.company-list tbody input[type=checkbox]:checked')}else{allCheck=$('.trainee-bill-table tbody input[type=checkbox]:checked')};if(allCheck.length==1){var remark=allCheck.parent().parent().parent().find('.invoice-remarks');$('.edit-remark .remark-text').val(remark.text());ticketOpenInfo.editRemarkAlert()}else{$yt_alert_Model.prompt("请选中一行数据进行操作",2000)}});$(".bill-btn-div").on('click','.search-person-btn',function(){ticketOpenInfo.getPersonListInfo()});$('.remark-sure-btn').on('click',function(){$(".edit-remark-alert").hide();$("#pop-modle-alert").hide();ticketOpenInfo.invoiceRemarksFn()});$('.company-list tbody').on('click','.look-info',function(){var projectCode=$yt_common.GetQueryString("projectCode");var types=$(this).parent().parent().find('.types').val();var traineeOrGroupId=$(this).parent().parent().find('.trainee-or-group-id').val();ticketOpenInfo.lookBiilInfo(projectCode,types,traineeOrGroupId);ticketOpenInfo.lookBillingInfoAlert()});$('.class-tbody').off().on('click','.look-info',function(){var projectCode=$yt_common.GetQueryString("projectCode");var types=$(this).parent().parent().find('.types').val();var traineeOrGroupId=$(this).parent().parent().find('.trainee-or-group-id').val();ticketOpenInfo.lookBiilInfo(projectCode,types,traineeOrGroupId);ticketOpenInfo.lookBillingInfoAlert()});$(".invoice-export").on("click",function(){var projectCode=$yt_common.GetQueryString("projectCode");var selectParam=$('#keyword').val();var downUrl=$yt_option.base_path+"finance/projectInvoice/downloadProjectInvoice";$.ajaxDownloadFile({url:downUrl,data:{projectCode:projectCode,selectParam:selectParam,checkInState:"",isAdmission:"",invoiceStates:"",isDownload:true}})});$("input.check-all").change(function(){if($(this).parent().hasClass("check")){$(this).parents("table").find("tbody input[type='checkbox']").setCheckBoxState("uncheck");$(this).parents("table").find('tbody tr').removeClass('yt-table-active')}else{$(this).parents("table").find("tbody input[type='checkbox']").setCheckBoxState("check");$(this).parents("table").find('tbody tr').addClass('yt-table-active')}});$(".bill-div tbody").on("change","input[type='checkbox']",function(){if($(this).parents("table").find("tbody tr").length!=$(this).parents("table").find("tbody input[type='checkbox']:checked").length){$(this).parents("table").find(".check-all").setCheckBoxState("uncheck")}else{$(this).parents("table").find(".check-all").setCheckBoxState("check")}if($(this).is(':checked')){$(this).addClass('yt-table-active')}else{$(this).removeClass('yt-table-active')}});$(".ticket-open-tbody,.trainee-bill-table tbody").on('click','tr',function(){if($(this).hasClass('yt-table-active')){$(this).removeClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('uncheck')}else{$(this).addClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('check')}if($(this).parents("table").find("tbody tr").length!=$(this).parents("table").find("tbody input[type='checkbox']:checked").length){$(this).parents("table").find(".check-all").setCheckBoxState("uncheck")}else{$(this).parents("table").find(".check-all").setCheckBoxState("check")}return false});$('.person-list-div tbody,.company-list tbody').on('click','.invoice-states',function(){$(".invoiceHistory").show();$yt_model_drag.modelDragEvent($(".invoiceHistory .yt-edit-alert-title"));$('.invoiceHistory .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".invoiceHistory").hide();$("#pop-modle-alert").hide()});var traineeOrGroupId="";var types=$(this).parents('tr').data('data').type;var thisIndex=$(this).parents('tr').index();var thisTd=$(this).attr('rowspan');if(thisTd==null){if(types==1){traineeOrGroupId=$(this).parents('tr').data('data').groupId}else if(types==2){traineeOrGroupId=$(this).parents('tr').data('data').traineeId}}else{thisTd=thisTd-1;for(var i=0;i<=thisTd;i+=1){if(types==1){if(traineeOrGroupId==""){traineeOrGroupId=$(this).parents('tbody').find('tr').eq(thisIndex+i).data('data').groupId}else{traineeOrGroupId+=","+$(this).parents('tbody').find('tr').eq(thisIndex+i).data('data').groupId}}else if(types==2){if(traineeOrGroupId==""){traineeOrGroupId=$(this).parents('tbody').find('tr').eq(thisIndex+i).data('data').traineeId}else{traineeOrGroupId+=","+$(this).parents('tbody').find('tr').eq(thisIndex+i).data('data').traineeId}}}}console.log(traineeOrGroupId);var projectCode=$yt_common.GetQueryString("projectCode");var tbHtml;$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getInvoiceHistory",data:{projectCode:projectCode,types:types,traineeOrGroupIds:traineeOrGroupId},async:true,beforeSend:function(){$yt_baseElement.showLoading()},success:function(data){var htmlTr="";var num=".0";if(data.flag==0){$.each(data.data,function(i,t){t.updateTimeString=t.updateTimeString.substring(0,t.updateTimeString.indexOf(num));if(t.dataTypes==1){t.dataTypesVel='税控机开票'}else if(t.dataTypes==2){t.dataTypesVel='手动开票'}htmlTr+='<tr>'+'<td>'+t.ticketHolder+'</td><td>'+t.updateTimeString+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(t.tuition,2)+'</td><td>'+t.invoiceNum+'</td><td>'+t.dataTypesVel+'</td></tr>'});tbHtml='<table style="width:100%"><thead class="list-thead"><tr><th style="width: 185px;display:none;">订单号</th><th style="width: 300px;">开票人</th><th style="width: 120px;">日期</th><th style="width: 80px;">开票金额</th><th style="">发票号</th><th style="">数据类型</th></tr></thead><tbody class="yt-tbody list-tbody">'+htmlTr+'</tbody></table>';$('.invoiceHistory .yt-edit-alert-main').empty().append(tbHtml);$yt_alert_Model.setFiexBoxHeight($(".invoiceHistory .alert-form"));$yt_alert_Model.getDivPosition($(".invoiceHistory"))}$yt_alert_Model.setFiexBoxHeight($(".invoiceHistory .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".invoiceHistory"));$yt_baseElement.hideLoading()},error:function(){$yt_baseElement.hideLoading();$yt_alert_Model.prompt('网络异常，请稍后重试')}})});$('.trainee-bill-table tbody').on('click','.invoice-org-href',function(){var traineeId=$(this).parent().parent().find('.trainee-or-group-id').val();var headImg=new Image();var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getTraineeDetails",data:{traineeId:traineeId,projectId:projectCode},async:true,success:function(data){var htmlBody=$('.student-details-form .student-details-train-record tbody');var htmlTrs='';htmlBody.empty();if(data.flag==0){detailsMsg=data.data;detailsMsg.checkInDate=detailsMsg.checkInDate.split(" ")[0];if(detailsMsg.gender==1){detailsMsg.gender="男"}else{detailsMsg.gender="女"}if(detailsMsg.invoiceType==0){detailsMsg.invoiceType=""}else if(detailsMsg.invoiceType==1){detailsMsg.invoiceType="普通发票"}else{detailsMsg.invoiceType="增值税发票"}if(detailsMsg.checkInState==0){detailsMsg.checkInState="未报到"}else{detailsMsg.checkInState="已报到"}if(detailsMsg.paymentState==0){detailsMsg.paymentState="未对账"}else{detailsMsg.paymentState="已对账"}if(detailsMsg.isOrderNum==0){detailsMsg.isOrderNum="未开票"}else{detailsMsg.isOrderNum="已开票"}$('.student-details-form .cont-edit-test').setDatas(detailsMsg);if(detailsMsg.headPortrait!=""){headImg.src=detailsMsg.headPortraitUrl;headImg.onload=function(){$('.student-details-img').attr('src',headImg.src);$('.student-details-img').jqthumb({width:89,height:130})}}else{$('.student-details-img').attr('src','../../resources/images/classStudent/student-picture.png');$('.student-details-img').jqthumb({width:89,height:130})}$yt_baseElement.hideLoading()}$yt_baseElement.hideLoading()}});$(".student-details-form").show();$yt_alert_Model.setFiexBoxHeight($(".student-details-form .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".student-details-form"));$yt_model_drag.modelDragEvent($(".student-details-form .yt-edit-alert-title"));$('.student-details-form .yt-eidt-model-bottom .yt-model-sure-btn').off('click').on("click",function(){$(".student-details-form").hide()})});$(".yt-eidt-model-bottom").off('click').on('click','.sreduction-details-sure-btn',function(){var selecVal=$(".billing-inf-alert #project-states").val();var labVal=$(".billing-inf-alert .is-not-comp label input:checked").val();var perState=$yt_valid.validForm($(".billing-inf-alert td").eq(4));if(selecVal==1&&labVal==1){$(".billing-inf-alert table input").eq(2).removeClass('ticket-form-input');if(perState){ticketOpenInfo.savebillingInf()}}else if(selecVal==1&&labVal==2){$(".billing-inf-alert table input").eq(2).removeClass('ticket-form-input');$(".billing-inf-alert table input").eq(3).removeClass('ticket-form-input');var compState=$yt_valid.validForm($(".billing-inf-alert td").eq(6));if(perState&&compState){ticketOpenInfo.savebillingInf()}}else if(selecVal==2){$(".billing-inf-alert table input").removeClass('ticket-form-input');var allState=$yt_valid.validForm($(".billing-inf-alert table"));if(allState){ticketOpenInfo.savebillingInf()}}})},getOpnTicketMsg:function(projectCode,types,traineeOrGroupId){$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupId:traineeOrGroupId},success:function(data){if(data.flag==0){$(".write-billing-alert table").setDatas(data.data)}$yt_baseElement.hideLoading()}})},clearOpenTicket:function(){$(".billing-inf-alert table input").addClass('ticket-form-input');$(".billing-inf-alert table span.per-span").text("");$(".billing-inf-alert table span.comp-span").text("");$(".billing-inf-alert table span.comp-label-span").text("");$(".billing-inf-alert table span.valid-font").text("")},lookBiilInfo:function(projectCode,types,traineeOrGroupId){$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupId:traineeOrGroupId},success:function(data){if(data.flag==0){if(data.data!=null){if(data.data.invoiceType==1){data.data.invoiceType="普通发票"}else if(data.data.invoiceType==2){data.data.invoiceType="增值税专用发票"}$('.look-bill-info-table .invoice-model-info').text("");$('.look-bill-info-table .org-name-info').text("");$('.look-bill-info-table .tax-number-info').text("");$('.look-bill-info-table .address-info').text("");$('.look-bill-info-table .telephone-info').text("");$('.look-bill-info-table .registered-bank-info').text("");$('.look-bill-info-table .account-info').text("");$('.look-bill-info-table .invoice-model-info').text(data.data.invoiceType);$('.look-bill-info-table .org-name-info').text(data.data.orgName);$('.look-bill-info-table .tax-number-info').text(data.data.taxNumber);$('.look-bill-info-table .address-info').text(data.data.address);$('.look-bill-info-table .telephone-info').text(data.data.telephone);$('.look-bill-info-table .registered-bank-info').text(data.data.registeredBank);$('.look-bill-info-table .account-info').text(data.data.account)}}$yt_baseElement.hideLoading()}})},invoiceRemarksFn:function(){var projectCode=$yt_common.GetQueryString("projectCode");var types=$('.hid-types').val();var traineeOrGroupIds=$('.hid-trainee-or-group-id').val();var invoiceRemarks=$('.edit-remark .remark-text').val();$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/updateInvoiceRemarks",data:{projectCode:projectCode,types:types,traineeOrGroupId:traineeOrGroupIds,invoiceRemarks:invoiceRemarks},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading();ticketOpenInfo.getPlanListInfo();ticketOpenInfo.getPersonListInfo()}else{$yt_baseElement.hideLoading()}}})},mergeBillFn:function(types,traineeOrGroupIds,btnType){var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/updateInvoiceOrderNum",data:{projectCode:projectCode,types:types,traineeOrGroupIds:traineeOrGroupIds,orderNumType:btnType},async:false,success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){if(btnType==1){ticketOpenInfo.addinvoiceInfo(types,traineeOrGroupIds,data.data)}ticketOpenInfo.getPlanListInfo();ticketOpenInfo.getPersonListInfo();$('.check-all').setCheckBoxState('uncheck')})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt(data.message)})}}})},clearBillInfoAlert:function(){$('#project-states').setSelectVal(1);if($('#project-states').val()==1){$(".billing-inf-alert .is-not-comp").show()}else{$(".billing-inf-alert .is-not-comp").hide()}$('.orgName').val("");$('.taxNumber').val("");$('.address').val("");$('.telephone').val("");$('.registeredBank').val("");$('.account').val("")},clearWriteBillAlert:function(){$('.duty-org-name').val("");$('.duty-tax-number').val("");$('.duty-telephone').val("");$('.duty-address').val("");$('.duty-registered-bank').val("");$('.duty-account').val("");$('.iduty-specification-model').val("");$('.iduty-invoice-group').val("");$('.iduty-invoice-number').val("");$('.iduty-invoice-unit-price').val("");$('.iduty-tuition').val("");$('.taxt-rat').text("");$('.taxt-rat-money').text("")},getTaxRate:function(){var invoiceOrderType=$('.duty-invoiceOrder-type').val();var count=$('.iduty-invoice-number').val();var price=$('.iduty-invoice-unit-price').val();var tuition=$('.iduty-tuition').val();if((count!=""&&price!="")||tuition!=""){if(tuition==""){$('.iduty-tuition').val(count*price);tuition=$('.iduty-tuition').val()}var ratMoney=$('.taxt-rat-money');if(invoiceOrderType==1){$('.taxt-rat').text("3%");$('.taxt-rat-money').text((tuition-(tuition/(1.03))).toFixed(2))}else if(invoiceOrderType==2){$('.taxt-rat').text("6%");$('.taxt-rat-money').text((tuition-(tuition/(1.06))).toFixed(2))}else if(invoiceOrderType==3){$('.taxt-rat').text("6%");$('.taxt-rat-money').text((tuition-(tuition/(1.06))).toFixed(2))}else if(invoiceOrderType==4){$('.taxt-rat').text("3%");$('.taxt-rat-money').text((tuition-(tuition/(1.03))).toFixed(2))}else if(invoiceOrderType==5){$('.taxt-rat').text("3%");$('.taxt-rat-money').text((tuition-(tuition/(1.03))).toFixed(2))}else{$('.taxt-rat').text("6%");$('.taxt-rat-money').text((tuition-(tuition/(1.06))).toFixed(2))}}},trainOrcompanyIsCheck:function(){var checkTrueOrFalse="";var isOrNot=true;var check;var company=$('.company-list tbody tr').find('.check');var trainee=$('.trainee-bill-table tbody tr').find('.check');var companyLen=company.length;var traineeLen=trainee.length;if(companyLen>0){checkTrueOrFalse=1;check=company}else if(traineeLen>0){checkTrueOrFalse=1;check=trainee}else if(companyLen>0||traineeLen>0){$yt_alert_Model.prompt("请选中一行数据进行操作",3000);isOrNot=false}else{$yt_alert_Model.prompt("请选中一行数据进行操作",3000);isOrNot=false}if(check!=undefined){var projectCode=$yt_common.GetQueryString("projectCode");var types=check.parent().find('.types').val();var orderNum=check.parent().find('.order-num').val();var traineeOrGroupId="";$.each(check,function(i,v){if(traineeOrGroupId==""){traineeOrGroupId=$(v).parent().find('.trainee-or-group-id').val()}else{traineeOrGroupId+=','+$(v).parent().find('.trainee-or-group-id').val()}});$('.hid-project-code').val(projectCode);$('.hid-types').val(types);$('.hid-order-num').val(orderNum);$('.hid-trainee-or-group-id').val(traineeOrGroupId);$('.hid-check-true-or-false').val(checkTrueOrFalse)}return isOrNot},addDutyInfo:function(projectCode,types,traineeOrGroupId,orderNum){var invoiceType=$('.write-bill-table .invoice-type-td select.invoice-type').val();var invoiceModel=$('.write-bill-table .invoice-model-td').find('.check').children().val();var orgName=$('.duty-org-name').val();var taxNumber=$('.duty-tax-number').val();var telephone=$('.duty-telephone').val();var address=$('.duty-address').val();var registeredBank=$('.duty-registered-bank').val();var account=$('.duty-account').val();var invoiceOrderType=$('.write-billing-alert .duty-invoiceOrder-type').val();var invoiceSpecificationModel=$('.write-billing-alert .iduty-specification-model').val();var invoiceGroup=$('.write-billing-alert .iduty-invoice-group').val();var invoiceNumber=$('.write-billing-alert .iduty-invoice-number').val();var invoiceUnitPrice=$('.write-billing-alert .iduty-invoice-unit-price').val();var tuition=$('.write-billing-alert .iduty-tuition').val();var orderReamrks="";$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/addInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupIds:traineeOrGroupId,orderNum:orderNum,invoiceModel:invoiceModel,invoiceType:invoiceType,orgName:orgName,taxNumber:taxNumber,telephone:telephone,address:address,registeredBank:registeredBank,account:account,invoiceOrderType:invoiceOrderType,invoiceSpecificationModel:invoiceSpecificationModel,invoiceGroup:invoiceGroup,invoiceNumber:invoiceNumber,invoiceUnitPrice:invoiceUnitPrice,tuition:tuition,orderReamrks:orderReamrks},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading();$yt_alert_Model.prompt(data.message)}else{$yt_alert_Model.prompt(data.data);$yt_baseElement.hideLoading()}},error:function(){$yt_alert_Model.prompt('网络异常，开具发票失败');$yt_baseElement.hideLoading()}})},addinvoiceInfo:function(types,traineeOrGroupId,orderNum){var projectCode=$yt_common.GetQueryString("projectCode");var invoiceType=$('.mergeInvoiceAlert .invoice-type-td select.invoice-type').val();var invoiceModel=$('.mergeInvoiceAlert .invoice-model-td').find('.check').children().val();var orgName=$('.invoice-org-name').val();var taxNumber=$('.invoice-tax-number').val();var telephone=$('.invoice-telephone').val();var address=$('.invoice-address').val();var registeredBank=$('.invoice-registered-bank').val();var account=$('.invoice-account').val();var invoiceOrderType=$('.mergeInvoiceAlert .invoice-invoiceOrder-type').val();var invoiceSpecificationModel=$('.mergeInvoiceAlert .invoice-specification-model').val();var invoiceGroup=$('.mergeInvoiceAlert .invoice-invoice-group').val();var invoiceNumber=$('.mergeInvoiceAlert .invoice-invoice-number').val();var invoiceUnitPrice=$('.mergeInvoiceAlert .invoice-invoice-unit-price').val();var tuition=$('.mergeInvoiceAlert .invoice-tuition').val();var orderReamrks="";$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/addInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupIds:traineeOrGroupId,orderNum:orderNum,invoiceModel:invoiceModel,invoiceType:invoiceType,orgName:orgName,taxNumber:taxNumber,telephone:telephone,address:address,registeredBank:registeredBank,account:account,invoiceOrderType:invoiceOrderType,invoiceSpecificationModel:invoiceSpecificationModel,invoiceGroup:invoiceGroup,invoiceNumber:invoiceNumber,invoiceUnitPrice:invoiceUnitPrice,tuition:tuition,orderReamrks:orderReamrks},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading()}}})},writeBillingAlert:function(){$(".write-billing-alert").show();$(".write-billing-alert table .invoice-type").niceSelect();$yt_alert_Model.setFiexBoxHeight($(".write-billing-alert .alert-form"));$yt_alert_Model.getDivPosition($(".write-billing-alert"));$yt_model_drag.modelDragEvent($(".write-billing-alert .yt-edit-alert-title"));$('.write-billing-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".write-billing-alert").hide();$("#pop-modle-alert").hide()})},getCompanyInfo:function(projectCode,types,traineeOrGroupId){$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/getInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupId:traineeOrGroupId},async:false,success:function(data){if(data.flag==0){if(data.data!=null){if(data.data.invoiceType==1){$('.write-bill-info-table .is-not-comp').show();if(data.data.invoiceModel==1){$(".billing-inf-alert table span.per-span").text("*")}else if(data.data.invoiceModel==2){$(".billing-inf-alert table span.per-span").text("*");$(".billing-inf-alert table span.comp-span").text("*")}}else if(data.data.invoiceType==2){$('.write-bill-info-table .is-not-comp').hide();$(".billing-inf-alert table span.per-span").text("*");$(".billing-inf-alert table span.comp-span").text("*");$(".billing-inf-alert table span.comp-label-span").text("*")}data.data.invoiceId==undefined?data.data.invoiceId='':data.data.invoiceId=data.data.invoiceId;$('.write-bill-info-table .invoiceModel').setSelectVal(data.data.invoiceType);$('.write-bill-info-table .is-not-comp label input[value='+data.data.invoiceModel+']').setRadioState("check");$('.write-bill-info-table .orgName').val(data.data.orgName);$('.write-bill-info-table .taxNumber').val(data.data.taxNumber);$('.write-bill-info-table .address').val(data.data.address);$('.write-bill-info-table .telephone').val(data.data.telephone);$('.write-bill-info-table .registeredBank').val(data.data.registeredBank);$('.write-bill-info-table .account').val(data.data.account);$('.edit-bill-div .hid-invoice-id').val(data.data.invoiceId)}}$yt_baseElement.hideLoading()}})},savebillingInf:function(){var types=$('.hid-types').val();var projectCode=$yt_common.GetQueryString("projectCode");var invoiceModel=$('.write-bill-info-table .is-not-comp input:checked').val();var orgName=$('.write-bill-info-table .orgName').val();var taxNumber=$('.write-bill-info-table .taxNumber').val();var address=$('.write-bill-info-table .address').val();var telephone=$('.write-bill-info-table .telephone').val();var registeredBank=$('.write-bill-info-table .registeredBank').val();var account=$('.write-bill-info-table .account').val();var traineeOrGroupId=$('.hid-trainee-or-group-id').val();var invoiceId=$('.hid-invoice-id').val();var invoiceType=$("#project-states").val();$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/updateInvoice",data:{projectCode:projectCode,types:types,traineeOrGroupId:traineeOrGroupId,invoiceId:invoiceId,invoiceModel:invoiceModel,invoiceType:invoiceType,orgName:orgName,taxNumber:taxNumber,address:address,telephone:telephone,registeredBank:registeredBank,account:account},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("保存成功");$yt_baseElement.hideLoading();$(".billing-inf-alert").hide();$("#pop-modle-alert").hide()}else{$yt_alert_Model.prompt("保存失败");$yt_baseElement.hideLoading()}}})},editRemarkAlert:function(){$(".edit-remark-alert").show();$yt_alert_Model.setFiexBoxHeight($(".edit-remark-alert .alert-form"));$yt_alert_Model.getDivPosition($(".edit-remark-alert"));$yt_model_drag.modelDragEvent($(".edit-remark-alert .yt-edit-alert-title"));$('.edit-remark-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".edit-remark-alert").hide();$("#pop-modle-alert").hide()})},lookBillingInfoAlert:function(){$(".look-billing-inf-alert").show();$yt_alert_Model.setFiexBoxHeight($(".look-billing-inf-alert .alert-form"));$yt_alert_Model.getDivPosition($(".look-billing-inf-alert"));$yt_model_drag.modelDragEvent($(".look-billing-inf-alert .yt-edit-alert-title"));$('.look-billing-inf-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".look-billing-inf-alert").hide();$("#pop-modle-alert").hide()});$('.look-billing-inf-alert .yt-eidt-model-bottom .yt-model-sure-btn').off().on("click",function(){$(".look-billing-inf-alert").hide();$("#pop-modle-alert").hide()})},billingInfoAlert:function(){$(".billing-inf-alert").show();$yt_alert_Model.setFiexBoxHeight($(".billing-inf-alert .alert-form"));$yt_alert_Model.getDivPosition($(".billing-inf-alert"));$yt_model_drag.modelDragEvent($(".billing-inf-alert .yt-edit-alert-title"));$('.billing-inf-alert .yt-eidt-model-bottom .yt-model-canel-btn').off('click').on("click",function(){$(".billing-inf-alert").hide();$("#pop-modle-alert").hide()})},getPlanListInfo:function(){var projectCode=$yt_common.GetQueryString("projectCode");$.ajax({async:true,url:$yt_option.base_path+"finance/projectInvoice/getInvoiceToGroup",type:"post",data:{projectCode:projectCode},objName:'data',before:function(){$yt_baseElement.showLoading()},success:function(data){if(data.flag==0){var htmlTbody=$('.ticket-open-tbody');var htmlTr='';var projectType;var orderNum="0";var rowSpanNum=1;var lastTr;var trainIds="";var hidTrainIds="";if(data.data!=""){$(htmlTbody).empty();$.each(data.data,function(i,v){if(v.invoiceStates==1){v.invoiceStates="未开票"}else{v.invoiceStates="已开票"}if(v.isAdmission==0){v.isAdmission="未确认"}else{v.isAdmission="已确认"}htmlTr='<tr><td><input type="hidden" class="types" value="1"/><input type="hidden" class="order-num" value="'+v.orderNum+'"/><input type="hidden" class="trainee-or-group-id" value="'+v.groupId+'"/><label class="check-label yt-checkbox label-list"><input type="checkbox" name="test" class=""/></label></td><td class="groupName" style="text-align:left"><span class="project-code-href">'+v.groupName+'</span></td><td class="trainingExpenseNegotiatedPrice list-td" style="text-align:right;">'+v.trainingExpenseNegotiatedPrice+'</td><td class="list-td"><a style="color: #3c4687;" class="look-info look-stu-info look">查看</a></td><td class="isAdmission">'+v.isAdmission+'</td>';if(v.orderNum!=""||rowSpanNum>1){if(orderNum!=v.orderNum){if(rowSpanNum==1){trainIds=v.traineeId}else{$('.ticket-open-tbody tr').eq(lastTr).find("td").eq(5).attr("rowSpan",rowSpanNum);trainIds=v.traineeId;$('.ticket-open-tbody tr').eq(lastTr).find("td").eq(5).children().val(hidTrainIds);rowSpanNum=1}hidTrainIds="";lastTr=i;orderNum=v.orderNum;htmlTr+='<td class="invoiceStates invoice-states list-td"><input type="hidden" class="train-ids" value="'+trainIds+'"/><a>'+v.invoiceStates+'</a></td>';rowSpanNum=1}else{trainIds+=','+v.traineeId;hidTrainIds=trainIds;rowSpanNum+=1}}else{trainIds=v.traineeId;htmlTr+='<td class="invoiceStates invoice-states list-td"><input type="hidden" class="train-ids" value="'+trainIds+'"/><a>'+v.invoiceStates+'</a></td>';rowSpanNum=1}htmlTr+='<td class="orderReamrks list-td" style="width: 118px;overflow: hidden;text-align: left;">'+v.orderReamrks+'</td></tr>';v.type=1;htmlTr=$(htmlTr).data('data',v);htmlTbody.append(htmlTr)});$('.ticket-open-tbody tr').eq(lastTr).find("td").eq(5).attr("rowSpan",rowSpanNum)}else{$(htmlTbody).empty();htmlTr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="7" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},})},getPersonListInfo:function(){var invoiceStates=[];var checkBtn=$('.bill-btn-div .check-search input[type=checkbox]:checked');$.each(checkBtn,function(i,n){invoiceStates.push($(n).val())});invoiceStates=invoiceStates.join(',');checkBtn.length>1?invoiceStates='':invoiceStates=invoiceStates;var projectCode=$yt_common.GetQueryString("projectCode");var selectParam=$("#keyword").val();$('.class-page').pageInfo({async:true,pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"finance/projectInvoice/getInvoiceToTrainee",type:"post",data:{projectCode:projectCode,selectParam:selectParam,invoiceStates:invoiceStates},before:function(){$yt_baseElement.showLoading()},success:function(data){if(data.flag==0){var htmlTbody=$('.class-tbody');var htmlTr='';var invoiceType;var orderNum="0";var rowSpanNum=1;var lastTr;var trainIds="";var hidTrainIds="";if(data.data.rows.length>0){$(htmlTbody).empty();$.each(data.data.rows,function(i,v){if(v.checkInState==0){v.checkInState="未报到"}else if(v.checkInState==1){v.checkInState="已报到"}else{v.checkInState=""}if(v.invoiceStates==1){v.invoiceStates="未开票"}else if(v.invoiceStates==2){v.invoiceStates="已开票"}else{v.invoiceStates=""}if(v.isAdmission==0){v.isAdmission="未对账"}else if(v.isAdmission==1){v.isAdmission="已对账"}else{v.isAdmission=""}htmlTr='<tr style="position: relative;"><td><input type="hidden" class="types" value="2"/><input type="hidden" class="trainee-or-group-id" value="'+v.traineeId+'"/><input type="hidden" class="order-num" value="'+v.orderNum+'"/><input type="hidden" class="project-code" value="'+v.projectCode+'"/><label class="check-label yt-checkbox label-list" style="margin-left:7px"><input type="checkbox" name="test"/></label></td><td class = "group-num"><input type="hidden" class="types" value="2"/>'+v.groupNum+'</td><td style="text-align:left;" class="real-name"><a style="color: #3c4687;" class="invoice-org-href">'+v.realName+'</a></td><td class="room-number">'+v.roomNumber+'</td><td class="phone" >'+v.phone+'</td><td class="group-name" style="text-align:left">'+v.groupName+'</td><td class="group-org-name" style="text-align:left">'+v.groupOrgName+'</td><td><a style="color: #3c4687;" class="look-info">查看</a></td><td class="checkIn-state">'+v.checkInState+'</td><td class="is-admission">'+v.isAdmission+'</td>';if(v.orderNum!=""||rowSpanNum>1){if(orderNum!=v.orderNum){if(rowSpanNum==1){trainIds=v.traineeId}else{$('.class-tbody tr').eq(lastTr).find("td").eq(10).children().val(hidTrainIds);trainIds=v.traineeId;$('.class-tbody tr').eq(lastTr).find("td").eq(10).attr("rowSpan",rowSpanNum);rowSpanNum=1}hidTrainIds="";lastTr=i;orderNum=v.orderNum;htmlTr+='<td class="invoice-states rowspan-td"><input type="hidden" class="train-ids" value="'+trainIds+'"/><a>'+v.invoiceStates+'</a></td>';rowSpanNum=1}else{trainIds+=','+v.traineeId;hidTrainIds=trainIds;rowSpanNum+=1}}else{trainIds=v.traineeId;htmlTr+='<td class="invoice-states rowspan-td"><input type="hidden" class="train-ids" value="'+trainIds+'"/><a>'+v.invoiceStates+'</a></td>';rowSpanNum=1}htmlTr+='<td class="invoice-remarks" style="width: 118px;overflow: hidden;text-align: left;">'+v.invoiceRemarks+'</td></tr>';v.type=2;htmlTr=$(htmlTr).data("data",v);htmlTbody.append(htmlTr)});$('.class-tbody tr').eq(lastTr).find("td").eq(10).attr("rowSpan",rowSpanNum)}else{$(htmlTbody).empty();htmlTr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="12" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTr);$('.class-page').hide()}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},manualInvoice:function(types,traineeOrGroupIds,orderNum){$.ajax({type:"post",url:$yt_option.base_path+"finance/projectInvoice/addInvoiceManual",async:true,data:{projectCode:$yt_common.GetQueryString("projectCode"),types:types,traineeOrGroupIds:traineeOrGroupIds,orderNum:orderNum,tuition:$yt_baseElement.rmoney($('.manual-invoice-dollar').val()),invoiceNum:$('.manual-invoice-number').val(),orderReamrks:$('.manual-invoice-remark').val()},beforeSend:function(){$yt_baseElement.showLoading()},success:function(data){if(data.flag==0){$yt_alert_Model.prompt('手动开票成功');$('.class-page').pageInfo('refresh');ticketOpenInfo.getPlanListInfo()}else{$yt_alert_Model.prompt('手动开票失败')}$(".manual-invoice-alert").hide();$yt_baseElement.hideLoading()},error:function(){$yt_alert_Model.prompt('网络异常，手动开票失败');$yt_baseElement.hideLoading()}})},getClassInfo:function(){var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"class/getBeanByProjectCode",async:true,data:{projectCode:projectCode},objName:'data',success:function(data){if(data.flag==0){if(data.data.projectType==1){data.data.projectType="计划"}else if(data.data.projectType==2){data.data.projectType="委托"}else if(data.data.projectType==3){data.data.projectType="选学"}else if(data.data.projectType==4){data.data.projectType="调训"}$('.project-code').text(data.data.projectCode);$('.project-name').text(data.data.projectName);$('.project-type').text(data.data.projectType);$('.project-sell').text(data.data.projectSell);$('.start-date').text(data.data.startDate);$('.end-date').text(data.data.endDate);$('.train-date').text(data.data.trainDate);$('.details').text(data.data.details);$('.customer-unit').text(data.data.customerUnit);$('.customer-dept').text(data.data.customerDept);$('.customer-linkman').text(data.data.customerLinkman);$('.customer-linkman-position').text(data.data.customerLinkmanPosition);$('.customer-linkman-phone').text(data.data.customerLinkmanPhone);$('.customer-linkman-cellphone').text(data.data.customerLinkmanCellphone);$('.customer-linkman-fax').text(data.data.customerLinkmanFax);$('.customer-linkman-email').text(data.data.customerLinkmanEmail);$('.customer-trainee-position').text(data.data.customerTraineePosition);$('.customer-trainee-sum').text(data.data.customerTraineeSum);$('.customer-trainee-age-structure').text(data.data.customerTraineeAgeStructure);$('.customer-target-demand').text(data.data.customerTargetDemand);$('.project-head').text(data.data.projectHead);$('.class-teacher').text(data.data.classTeacher);$('.project-aid').text(data.data.projectAid);$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})}};$(function(){ticketOpenInfo.init()});
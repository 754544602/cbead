var caList={ue:null,init:function(){caList.clearAlertBox();caList.getPlanListInfo();caList.getOneListInfo();$('select').niceSelect();$("#issueDayeString").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});var classList=caList.getClassLis();var userName=caList.userInfo();if(classList!=null){var projectUser;var projectHeadmaster;var projectSell;var projectAid;$.each(classList.data,function(i,n){projectUser=n.projectUser;projectHeadmaster=n.projectHeadmaster;projectSell=n.projectSell;projectAid=n.projectAid;if(projectUser.indexOf(userName)!=-1||projectHeadmaster.indexOf(userName)!=-1||projectSell.indexOf(userName)!=-1||projectAid.indexOf(userName)!=-1){$("#projectCode").append($('<option value="'+n.projectCode+'">'+n.className+'</option>').data("classData",n))}});$("#projectCode").niceSelect();$('#projectCode').on('change',function(){var className=$('#projectCode option:selected').val();var projectUserName=$('#projectCode option:selected').data("classData").projectUserName;$('#projectUserName').text(projectUserName)});var nextPersonList=caList.getNextOperatePerson();if(nextPersonList!=null){$.each(nextPersonList,function(i,n){$("#dealingWithPeople").append($('<option value="'+n.userCode+'">'+n.userName+'</option>').data("classData",n))})};$("#dealingWithPeople").niceSelect();$('.page-return-btn').click(function(){caList.backNewsListPage()});$('.save').click(function(){caList.addnewsInfo(1)});$('.yt-model-sure-btn').click(function(){caList.addnewsInfo(2)});$('.yt-model-canel-btn').click(function(){var pageNum=$yt_common.GetQueryString("pageNum");if(pageNum==2){window.location.href="lookForByBacklogList.html"}else{window.location.href="newList.html"}})},backNewsListPage:function(){var pageNum=$yt_common.GetQueryString("pageNum");if(pageNum==2){window.location.href="lookForByBacklogList.html"}else{window.location.href="newList.html"}},getClassLis:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/getClasslist",data:{types:'4'},async:false,success:function(data){list=data||[]}});return list},userInfo:function(){var userName="";$.ajax({async:false,type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){userName=data.data.userName}});return userName},getNextOperatePerson:function(){var list=[];var dataObj;var user=null;$.ajax({type:"post",url:$yt_option.base_path+"uniform/workFlowOperate/getSubmitPageData",data:{businessCode:"news",types:'1'},async:false,success:function(data){if(data.flag==0){$.each(data.data,function(i,n){for(var k in n){user=n[k]}})}}});return user},clearAlertBox:function(){$('#projectCode').val("");$('#projectUserName').val("");$('#title').val("");$('#details').text("");$('#issueDayeString').val("");$('#dealingWithPeople').val("");$('select').niceSelect()},getPlanListInfo:function(){$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString("pkId");$.ajax({type:"post",url:$yt_option.base_path+"class/news/getBeanById",async:true,data:{pkId:pkId},objName:'data',success:function(data){if(data.flag==0){$('#projectCode').setSelectVal(data.data.projectCode);$('#projectUserName').text(data.data.projectUserName);$('#title').val(data.data.title);$('#issueDayeString').val(data.data.issueDayeString);$('#processInstanceId').val(data.data.processInstanceId);caList.ue=UE.getEditor('container',{toolbars:[['undo','redo','|','bold','italic','underline','forecolor','|','justifyleft','justifycenter','justifyright','justifyjustify','|','simpleupload','attachment']],autoHeightEnabled:true,autoFloatEnabled:false,elementPathEnabled:false,wordCount:false,enableAutoSave:false,enableAutoSave:false});caList.ue.ready(function(){caList.ue.setContent(data.data.details)});$('#dealingWithPeople').val(data.data.dealingWithPeople);$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询成功")})}}})},addnewsInfo:function(dataStates){$yt_baseElement.showLoading();var processInstanceId=$yt_common.GetQueryString("processInstanceId");var pkId=$yt_common.GetQueryString("pkId");var projectCode=$('#projectCode').val();var title=$('#title').val();var details=caList.ue.getContent();;var issueDayeString=$('#issueDayeString').val();var dealingWithPeople=$('#dealingWithPeople').val();$.ajax({type:"post",url:$yt_option.base_path+"class/news/addOrUpdateBean",data:{pkId:pkId,projectCode:projectCode,title:title,details:details,issueDayeString:issueDayeString,businessCode:"news",dealingWithPeople:dealingWithPeople,dataStates:dataStates,nextCode:"submited",processInstanceId:processInstanceId},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("提交失败")})}caList.backNewsListPage()}})},getOneListInfo:function(){$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString("pkId");var processInstanceId;$.ajax({type:"post",url:$yt_option.base_path+"class/news/getBeanById",async:false,data:{pkId:pkId},success:function(data){if(data.flag==0){if(data.data.flowLog.length!=0){$(".hide-approve-title").show();$(".hide-appreove").show();var flowLog=data.data.flowLog;var middleStepHtml;var length=flowLog.length;$.each(flowLog,function(i,v){if(i==0){$('.last-step-order').text(length);$('.last-step-operate-person-userName').text(v.userName);$('.last-step-operationState').text(v.operationState);$('.last-step-commentTime').text(v.commentTime)};if(i==length-1){$('.first-step-order').text(1);$('.first-step-operate-person-userName').text(v.userName);$('.first-step-taskName').text(v.operationState);$('.first-step-commentTime').text(v.commentTime)};if(i!=0&&i<length-1){var order=length-i;middleStepHtml='<div><div style="height: 150; "><div class="number-name-box"><span class="number-box-span middle-step-order middle-a-index" >'+order+'</span><span class="name-box-span middle-step-userName middle-a-index" >'+v.userName+'</span><img src="../../resources/images/open/openFlow.png" class="order-img" /></div></div><div class="middle-step-box-div"><ul class="middle-step-box-ul"><li style="height: 30px;"><span  class="middle-step-taskName view-taskName-span"  style="float: left;">'+v.operationState+'</span></li><li class="view-time-li middle-step-commentTime" >'+v.commentTime+'</li><li class="operate-view-box-li"><div class="operate-view-title-li">操作意见：</div><div class="operate-view-text-li middle-step-comment" style="padding-left: 10px;">'+v.comment+'</div></li></ul></div></div>';$('.last-step').append(middleStepHtml)}});$yt_baseElement.hideLoading()}}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})}};$(function(){caList.init()});
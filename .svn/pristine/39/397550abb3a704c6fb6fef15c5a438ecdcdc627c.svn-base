var carList = {
	//初始化方法
	init: function() {
		//初始化表头时间框
		$("#carDate").calendar({
			speed: 200, //日期列表展开显示速度, 参数"slow","normal","fast"，或毫秒数值，默认：200     
			complement: true, // 是否显示日期或年空白处的前后月的补充,默认：true     
			readonly: true, // 目标对象是否设为只读，默认：true     
			lowerLimit: "2010/01/01", // 日期下限，默认：NaN(不限制)     
			nowData: true, //默认选中当前时间,默认true  
			dateFmt: "yyyy-MM-dd",
			callback: function() {
				//选择日期调用列表
				carList.getPlanListInfo();
			}
		});

		//获取列表数据
		carList.getPlanListInfo();
		//点击导出
		$('.disableList').on('click', function() {
			carList.sendMeetListexport();
		});
		$('.submit-form').on('click', function() {
			carList.submitData();
		})
	},

	//初始化出发时间
	listTimeInput: function() {
		$(".out-list-time-input").calendar({
			speed: 200, //日期列表展开显示速度, 参数"slow","normal","fast"，或毫秒数值，默认：200     
			complement: true, // 是否显示日期或年空白处的前后月的补充,默认：true     
			readonly: true, // 目标对象是否设为只读，默认：true     
			lowerLimit: "2010/01/01", // 日期下限，默认：NaN(不限制)     
			nowData: true, //默认选中当前时间,默认true  
			dateFmt: "yyyy-MM-dd HH:mm",
			callback: function() {}
		});
	},

	//	//获取司机下拉列表
	driverNameLis: function(select) {
		$.ajax({
			type: "post",
			url: $yt_option.base_path + "uniform/user/getUsers",
			data: {
				compId: "81",
			},
			async: false,
			success: function(data) {
				$.each(data.data, function(i, d) {
					if(d.type == 3) {
						$(select).append('<option value="' + d.id + '">' + d.text + '</option>');
					}
				});
			}
		});
	},
	//	//获取车辆下拉列表
	carNameLis: function(select) {
		$.ajax({
			type: "post",
			url: $yt_option.base_path + "uniform/getCars",
			data: {
				searchParameters: "",
			},
			async: false,
			success: function(data) {
				$.each(data.data, function(i, c) {
					if(c.carStates == 1) {
						$(select).append('<option>' + c.carNum + '</option>');
					}
				});
			}
		});
	},
	/**
	 * 获取用车信息列表
	 */
	getPlanListInfo: function() {
		$yt_baseElement.showLoading();
		var carDate = $('#carDate').val();
		var carDate = $('#carDate').val();
		$('.page-info').pageInfo({
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "administrator/car/getCarApprove", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				carDate: carDate
			}, //ajax查询访问参数
			objName: 'data', //指获取数据的对象名称  
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.teacher-use-car-list .yt-tbody');
					var htmlTr = '';
					var num = 1;
					var driverName;
					var carName;
					var routeType;
					if(data.data.teacherCar.length > 0) {
						$('.class-info1').show();
						$('.repeat-come-div-nodata').remove();
						$('.class-info-bottom').show();
						$(htmlTbody).empty();
						//遍历接送站列表
						$.each(data.data.teacherCar, function(i, v) {
							if(v.routeType == 1) {
								routeType = "接站";
							} else {
								routeType = "送站";
							}

							htmlTr = '<tr class="teacherCar">' +
								'<td class="pk-id" style="text-align:center;display:none;">' + v.pkId + '</td>' +
								'<td class="business-code" style="text-align:center;display:none;">' + v.processInstanceId + '</td>' +
								'<td class="route-type" style="text-align:center;">' + routeType + '</td>' +
								'<td class="teacher-name" style="text-align:center;">' + v.teacherName + '</td>' +
								'<td class="phone" style="text-align:center;">' + v.phone + '</td>' +
								'<td class="flight-train-number" style="text-align:center;">' + v.flightTrainNumber + '</td>' +
								'<td class="date-time" style="text-align:center;">' + v.dateTime + '</td>' +
								'<td class="bourn" style="text-align:center;">' + v.bourn + '</td>' +
								'<td class="set-out-date" style="text-align:center;"><input class="calendar-input out-list-time-input" value="' + v.setOutDate + '" type="text" /></td>' +
								'<td class="driver-name" style="text-align:center;padding:0px 6px;">' +
								'<input style="width:113px;" class="yt-input driver-name-input" value="" type="text" />' +
								'<select style="width: 120px;" class="yt-select driver-name-select">' +
								'<option value="">请选择司机</option>' +
								'</select>' +
								'</td>' +
								'<td class="car-name" style="text-align:center;padding:0px 6px;">' +
								'<input style="width:113px;" class="yt-input car-name-input" value="" type="text" />' +
								'<select style="width: 120px;" class="yt-select car-name-select">' +
								'<option value="">请选择车辆</option>' +
								'</select>' +
								'</td>' +
								'<td class="create-user-string" style="text-align:center;">' + v.createUserString + '</td>' +
								'<td class="create-user-phone" style="text-align:center;">' + v.createUserPhone + '</td>' +
								'<td class="project-code" style="text-align:center;">' + v.projectCode + '</td>' +
								'<td class="project-name" style="text-align:center;">' + v.projectName + '</td>' +
								'</tr>';
							htmlTr = $(htmlTr);
							var slen = htmlTr.find('select.car-name-select option').length;
							var dlen = htmlTr.find('select.driver-name-select option').length;
							htmlTbody.append(htmlTr);
							if(slen < 2) {
								//车辆下拉列表
								carList.carNameLis("select.car-name-select");
							}

							if(dlen < 2) {
								//司机下拉列表
								carList.driverNameLis("select.driver-name-select");
							}
							htmlTr.find('select.yt-select').niceSelect();

							//司机输入框或下拉框
							if(v.driverCode == "") {
								htmlTr.find('div.driver-name-select').hide();
								htmlTr.find('.driver-name-input').show();
							} else {
								htmlTr.find('div.driver-name-select').show();
								htmlTr.find('.driver-name-input').hide()
							};

							//车辆输入框或下拉框
							if(v.carId == "") {
								htmlTr.find('div.car-name-select').hide();
								htmlTr.find('.car-name-input').show();
							} else {
								htmlTr.find('div.car-name-select').show();
								htmlTr.find('.car-name-input').hide()
							};
						});
						//初始化时间
						carList.listTimeInput();
					} else {
						$(htmlTbody).empty();
						$('.class-info1').hide();
						if($('.class-info1').css('display') == 'none' && $('.class-info2').css('display') == 'none') {
							if($('#project-main').find('.repeat-come-div-nodata')[0] == undefined) {
								$('#project-main').append('<div class="no-data repeat-come-div-nodata" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div>')
								$('.class-info-bottom').hide();
							}
						}
					}

					//外出教学列表
					var outHmlTbody = $('.out-list-table .yt-tbody');
					var outHtmlTr = '';
					if(data.data.courseCar.length > 0) {
						$('.class-info2').show();
						$('.class-info-bottom').show();
						$('.repeat-come-div-nodata').remove();
						$(outHmlTbody).empty();
						//遍历现场教学（外出教学）
						$.each(data.data.courseCar, function(i, v) {
							i = i + 1;
							outHtmlTr = '<tr class="courseCar">' +
								'<td class="pkid" style="text-align:center;display:none;">' + v.pkId + '</td>' +
								'<td class="process-instanceId" style="text-align:center;display:none;">' + v.processInstanceId + '</td>' +
								'<td class="types" style="text-align:center;">' + v.types + '</td>' +
								'<td class="user-count" style="text-align:center;">' + v.userCount + '</td>' +
								'<td class="start-time" style="text-align:center;">' + v.startTime + '</td>' +
								'<td class="address" style="text-align:center;">' + v.address + '</td>' +
								'<td class="set-out-date" style="text-align:center;">' +
								'<input class="calendar-input out-list-time-input" value="' + v.setOutDate + '" type="text" />' +
								'</td>' +
								'<td class="drivers" style="text-align:center;">' +
								'<input style="width:113px;" class="yt-input drivers-input" value="" type="text" />' +
								'<select style="width: 140px;" class="yt-select drivers-select out-select">' +
								'<option value="">请选择司机</option>' +
								'</select>' +
								'</td>' +
								'<td class="cars" style="text-align:center;">' +
								'<input style="width:113px;" class="yt-input cars-input"  value="" type="text" />' +
								'<select style="width: 140px;" class="yt-select cars-select out-select">' +
								'<option value="">请选择车辆</option>' +
								'</select>' +
								'</td>' +
								'<td class="create-uer-string" style="text-align:center;">' + v.createUserString + '</td>' +
								'<td class="create-user-phone" style="text-align:center;">' + v.createUserPhone + '</td>' +
								'<td class="project-code" style="text-align:center;">' + v.projectCode + '</td>' +
								'<td class="project-name" style="text-align:center;">' + v.projectName + '</td>' +
								'</tr>';
							outHmlTbody.append(outHtmlTr);
							//遍历车辆下拉框
							if($("select.drivers-select option").length < 2) {
								if(v.drivers.length != 0) {
									v.drivers = JSON.parse(v.drivers);
								}
								$.each(v.drivers, function(j, d) {
									$("select.drivers-select").append('<option value="' + d.driverCode + '">' + d.driverName + '</option>');
								});
							}
							if($("select.cars-select option").length < 2) {
								//遍历车辆下拉框
								if(v.cars.length != 0) {
									v.cars = JSON.parse(v.cars);
								}
								$.each(v.cars, function(j, c) {
									$("select.cars-select").append('<option value="' + c.carId + '">' + c.carName + '</option>');
								});
							}
							//初始化下拉列表
							$('select.out-select').niceSelect();
							//司机输入框或下拉框
							if(v.drivers.length == 0) {
								$('div.drivers-select').hide();
								$('.drivers-input').show();
							} else {
								$('div.drivers-select').show();
								$('.drivers-input').hide()
							};
							//车辆输入框或下拉框
							if(v.cars.length == 0) {
								$('div.cars-select').hide();
								$('.cars-input').show();
							} else {
								$('div.cars-select').show();
								$('.cars-input').hide()
							};
						});
						//初始化时间
						carList.listTimeInput();
					} else {
						$(outHmlTbody).empty();
						$('.class-info2').hide();
						if($('.class-info1').css('display') == 'none' && $('.class-info2').css('display') == 'none') {
							if($('#project-main').find('.repeat-come-div-nodata')[0] == undefined) {
								$('#project-main').append('<div class="no-data repeat-come-div-nodata" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div>')
								$('.class-info-bottom').hide();
							}
						}
					}
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	sendMeetListexport: function() {
		//接送站用车
		var sendOffMeetStationArrJson = "";
		//外出用车
		var courseCarDetailJson;
		//接送站
		var teacherList = $('.teacher-use-car-list .list-tbody tr');
		var len = $('.teacher-use-car-list .list-tbody tr td').length;
		var routeType;
		//乘车人
		var teacherName;
		//联系方式
		var phone;
		//航班/车次
		var flightTrainNumber;
		//预计到达/起飞时间
		var dateTime;
		//目的地
		var bourn;
		//出发时间
		var setOutDate;
		//司机
		var driverName;
		//车辆
		var carName;
		//用车人
		var createUserString;
		//联系方式
		var createUserPhone;
		//班级编号
		var projectCode;
		//班级名称
		var projectName;
		//定义接站数组
		var meetStationArr = [];
		//定义送站数组
		var sendOffArr = [];
		if(len >= 2) {
			$.each(teacherList, function(i, t) {
				routeType = $(this).find('.route-type').text();
				teacherName = $(this).find('.teacher-name').text();
				phone = $(this).find('.phone').text();
				flightTrainNumber = $(this).find('.flight-train-number').text();
				dateTime = $(this).find('.date-time').text();
				bourn = $(this).find('.bourn').text();
				setOutDate = $(this).find('.set-out-date').val();
				//获取司机名
				//如果输入框值为空，获取下拉框里面的值
				if($(this).find('.driver-name-input').val() == "") {
					driverName = $(this).find('.driver-name-select').val();
				}
				//如果下拉框的值为空，获取输入框里的值
				if($(this).find('.driver-name-select').val() == "") {
					driverName = $(this).find('.driver-name-input').val();
				}
				//获取车辆名
				//如果输入框值为空，获取下拉框里面的值
				if($(this).find('.car-name-input').val() == "") {
					carName = $(this).find('.car-name-select').val();
				}
				//如果下拉框的值为空，获取输入框里的值
				if($(this).find('.car-name-select').val() == "") {
					carName = $(this).find('.car-name-input').val();
				}
				createUserString = $(this).find('.create-user-string').text();
				createUserPhone = $(this).find('.create-user-phone').text();
				projectCode = $(this).find('.project-code').text();
				projectName = $(this).find('.project-name').text();
				if(routeType == "接站") {
					var meetStation = {
						teacherName: teacherName,
						phone: phone,
						flightTrainNumber: flightTrainNumber,
						dateTime: dateTime,
						bourn: bourn,
						setOutDate: setOutDate,
						driverName: driverName,
						carName: carName,
						createUserString: createUserString,
						createUserPhone: createUserPhone,
						projectCode: projectCode,
						projectName: projectName
					}
					meetStationArr.push(meetStation);
				}
				if(routeType == "送站") {
					var sendOff = {
						teacherName: teacherName,
						phone: phone,
						flightTrainNumber: flightTrainNumber,
						dateTime: dateTime,
						bourn: bourn,
						setOutDate: setOutDate,
						driverName: driverName,
						carName: carName,
						createUserString: createUserString,
						createUserPhone: createUserPhone,
						projectCode: projectCode,
						projectName: projectName
					}
					sendOffArr.push(sendOff);
				}
			});
			//接站details
			var meetStationDetail = {
				routeType: "接站",
				details: meetStationArr
			}
			//送站details
			var sendOffDetail = {
				routeType: "送站",
				details: sendOffArr
			}

			//教室用车teacherCar
			var sendOffMeetStationArr = [meetStationDetail, sendOffDetail];
			sendOffMeetStationArrJson = JSON.stringify(sendOffMeetStationArr);
		}

		//现场教学用车
		var courseCarList = $('.out-list-table .list-tbody tr');
		var len = $('.out-list-table .list-tbody tr td').length;
		//乘车人数
		var outUserCount;
		//上课时间
		var outStartTime;
		//目的地
		var outAddress;
		//出发时间
		var outSetOutDate;
		//司机
		var outDrivers;
		//车辆
		var outCars;
		//用车人
		var outCreateUserString;
		//联系方式
		var outCreateUserPhone;
		//班级编号
		var outProjectCode;
		//班级名称
		var outProjectName;
		var courseCarArr = [];
		if(len >= 2) {
			$.each(courseCarList, function(i, c) {
				outUserCount = $(this).find('.user-count').text();
				outStartTime = $(this).find('.start-time').text();
				outAddress = $(this).find('.address').text();
				outSetOutDate = $(this).find('.set-out-date').val();
				outDrivers = $(this).find('.drivers-select').val();
				outCars = $(this).find('.cars-select').val();
				outCreateUserString = $(this).find('.create-uer-string').text();
				outCreateUserPhone = $(this).find('.create-user-phone').text();
				outProjectCode = $(this).find('.project-code').text();
				outProjectName = $(this).find('.project-name').text();
				var courseCar = {
					userCount: outUserCount,
					startTime: outStartTime,
					address: outAddress,
					setOutDate: outSetOutDate,
					drivers: outDrivers,
					cars: outCars,
					createUserString: outCreateUserString,
					createUserPhone: outCreateUserPhone,
					projectCode: outProjectCode,
					projectName: outProjectCode,
				}
				courseCarArr.push(courseCar);
			});
			//外出教学数据

			var courseCarDetail = {
				types: "外出教学",
				details: courseCarArr
			}
			var courseCarDetailArr = [courseCarDetail];
			courseCarDetailJson = JSON.stringify(courseCarDetailArr);
		};
		//导出接口
		var exportDate = $('#carDate').val();
		$.ajaxDownloadFile({
			url: $yt_option.base_path + "administrator/car/exportCars",
			teacherCar: sendOffMeetStationArrJson,
			courseCar: courseCarDetailJson,
			fileName: exportDate + "用车申请导出"
		});
	},
	submitData: function() {
		$yt_baseElement.showLoading();
		var teacherCarArr = [];
		var courseCarArr = [];
		$.each($('.teacherCar'), function(i, n) {
			var json = {
				pkId: '',
				setOutDate: '',
				driverCode: '',
				carId: '',
				processInstanceId: '',
				nextCode: 'submit'
			}
			json.pkId = $(n).find('.pk-id').text();
			json.setOutDate = $(n).find('.out-list-time-input').val();
			$(n).find('.driver-name-input').val() == '' ? json.driverCode = $(n).find('.driver-name-select').val() : json.driverCode = $(n).find('.driver-name-input').val();
			$(n).find('.car-name-input').val() == '' ? json.carId = $(n).find('.car-name-select').val() : json.carId = $(n).find('.car-name-input').val();
			teacherCarArr.push(json);
		})
		$.each($('.courseCar'), function(i, n) {
			var json = {
				pkId: '',
				setOutDate: '',
				driverCode: '',
				carId: '',
				processInstanceId: '',
				nextCode: 'submit'
			}
			json.pkId = $(n).find('.pkid').text();
			json.setOutDate = $(n).find('.out-list-time-input').val();
			$(n).find('.drivers-input').val() == '' ? json.driverCode = $(n).find('.drivers-select').val() : json.driverCode = $(n).find('.drivers-input').val();
			$(n).find('.cars-input').val() == '' ? json.carId = $(n).find('.cars-select').val() : json.carId = $(n).find('.cars-input').val();
			courseCarArr.push(json);
		})
		teacherCar = JSON.stringify(teacherCarArr);
		courseCar = JSON.stringify(courseCarArr);
		$.ajax({
			type: "post",
			url: $yt_option.base_path + "administrator/car/updateCarApprove",
			async: true,
			data: {
				teacherCar:teacherCar,
				courseCar:courseCar
			},
			success: function(data) {
				if(data.flag==0){
					$yt_baseElement.hideLoading(function(){
						$yt_alert_Model.prompt("提交成功");
					});
					$('.class-info-bottom').hide();
					$('.class-info input').attr('readonly','readonly');
				}else{
					$yt_baseElement.hideLoading(function(){
						$yt_alert_Model.prompt("提交失败");
					});
				}
			},
			error: function(data) {

			}
		});
	}
};
$(function() {
	//初始化方法
	carList.init();
});
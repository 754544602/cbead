var index = {
	init: function() {
		var me = this;
		 dateinit();
		me.indexData();
		index.classplan();
		$('.index-rates-yes').show();
	},
	dates: '',
	year: '',
	month: '',
	days: '',
	indexData: function() {
		var me = this ;
		$.ajax({
			type: "post",
			url: $yt_option.base_path + "index/getIndexDataByRegistrar",
			beforeSend: function() {
				$yt_baseElement.showLoading();
			},
			async: true,
			data: {},
			success: function(data) {
				//今年项目统计
				$('.index-top-middle').setDatas(data.data.projectStatistics);
				//待办事项-立项审批
				function examination(){
				$('.index-rates-approve caption span').text('立项审批');
				if(data.data.examinationApproval.length > 0) {
					$('.index-rates-approve thead').empty().append('<tr><th>项目名称</th>'+
						'<th>委托单位</th>'+
						'<th>预计培训时间</th>'+
						'<th>项目销售</th>'+
						'<th>洽谈记录</th>'+
						'<th>学员数量</th>'+
						'<th>项目状态</th>'+
						'</tr>');
					var examinationBody = $('.index-rates-project').empty();
					var examinationHtml = '';
					$.each(data.data.examinationApproval, function(i, n) {
						//							洽谈状态 1:咨询 2:在谈3:意向4:方案5:调整6:签约7:取消
						if(n.projectNegotiationRecord == 1) {
							n.projectNegotiationRecord = '咨询'
						} else if(n.projectNegotiationRecord == 2) {
							n.projectNegotiationRecord = '在谈'
						} else if(n.projectNegotiationRecord == 3) {
							n.projectNegotiationRecord = '意向'
						} else if(n.projectNegotiationRecord == 4) {
							n.projectNegotiationRecord = '方案'
						} else if(n.projectNegotiationRecord == 5) {
							n.projectNegotiationRecord = '调整'
						} else if(n.projectNegotiationRecord == 6) {
							n.projectNegotiationRecord = '签约'
						} else if(n.projectNegotiationRecord == 7) {
							n.projectNegotiationRecord = '取消'
						}
						n.negotiationRecord == '' ? n.negotiationRecord = '0' : n.negotiationRecord = n.negotiationRecord;
						examinationHtml = '<tr>' +
							'<td>' + n.projectName + '</td>' +
							'<td>' + n.groupName + '</td>' +
							'<td>' + n.startDateString + '</td>' +
							'<td>' + n.projectSell + '</td>' +
							'<td>' + n.negotiationRecord + '次</td>' +
							'<td>' + n.traineeCount + '</td>' +
							'<td>' + n.projectNegotiationRecord + '</td>' +
							'</tr>'
						examinationBody.append(examinationHtml);
					});
				
				} else {
					examinationHtml = '<tr style="border:0px;background-color:#fff !important;" >' +
						'<td colspan="9" align="center" style="border:0px;">' +
						'<div class="no-data" style="width: 220px;margin: 0 auto;">' +
						'<img src="../../resources/images/common/no-data.png" alt="" style="width: 220px;padding: 35px 0 20px;">' +
						'</div>' +
						'</td>' +
						'</tr>';
					examinationBody.append(examinationHtml);
				}}
				examination();
				//报销审批
				function reimApproval(){
					$('.index-rates-approve caption span').text('报销审批');
					$('.index-rates-approve thead').empty().append('<tr><th>项目名称</th>'+
						'<th width="140px">报销类型</th>'+
						'<th width="140px">报销时间</th>'+
						'<th width="105px">项目主任</th>'+
						'<th width="100px">教师人数</th>'+
						'<th width="140px">报销金额</th>'+
						'</tr>');
				if(data.data.reimApproval.length > 0) {
					var examinationBody = $('.index-rates-project').empty();
					var examinationHtml = '';
					$.each(data.data.reimApproval, function(i, n) {
						//	洽谈状态 1:咨询 2:在谈3:意向4:方案5:调整6:签约7:取消
						if(n.expenseType == 1) {
							n.expenseType = '教师课酬报销'
						} else if(n.expenseType == 2) {
							n.expenseType = '教师差旅报销'
						}
						examinationHtml = '<tr>' +
							'<td>' + n.projectName + '</td>' +
							'<td>' + n.expenseType + '</td>' +
							'<td>' + n.createTimeString + '</td>' +
							'<td>' + n.projectHead + '</td>' +
							'<td>' + n.teacherCount + '</td>' +
							'<td>' + n.expenseMoney + '</td>' +
							'</tr>'
						examinationBody.append(examinationHtml);
					});
				
				} else {
					examinationHtml = '<tr style="border:0px;background-color:#fff !important;" >' +
						'<td colspan="9" align="center" style="border:0px;">' +
						'<div class="no-data" style="width: 220px;margin: 0 auto;">' +
						'<img src="../../resources/images/common/no-data.png" alt="" style="width: 220px;padding: 35px 0 20px;">' +
						'</div>' +
						'</td>' +
						'</tr>';
					examinationBody.append(examinationHtml);
				}}
				//切换标签
				$('.swich-title').on('click', 'li', function() {
					if($(this).index() == 0) {
						$(this).addClass('active').siblings().removeClass('active');
						examination();
					}
					if($(this).index() == 1) {
						$(this).addClass('active').siblings().removeClass('active');
						reimApproval();
					}
				})
				//本月班级信息
				if(data.data.projecDetails.length>0){
						var projecDetailsBody = $('.index-info tbody').empty();
						var projecDetailsHtml = '';
						$.each(data.data.projecDetails, function(i,n) {
							if(n.projectType==1){
								n.projectTypeVel = '计划'
							}
							else if(n.projectType==2){
								n.projectTypeVel = '委托'
							}
							else if(n.projectType==3){
								n.projectTypeVel = '选学'
							}
							else if(n.projectType==4){
								n.projectTypeVel = '调训'
							}
							if(n.projectStates==1){
								n.projectStates='未开始';
							}else if(n.projectStates==2){
								n.projectStates='进行中';
							}else if(n.projectStates==3){
								n.projectStates='已完成';
							}
							projecDetailsHtml = '<tr>'+
							'<td style="text-align:center" width="40px">'+(i+1)+'</td>'+
							'<td style="text-align:left">'+n.projectName+'</td>'+
							'<td style="text-align:center" width="60px">'+n.projectTypeVel+'</td>'+
							'<td style="text-align:center" width="90px">'+n.startDate+'</td>'+
							'<td style="text-align:center" width="90px">'+n.endDate+'</td>'+
							'<td style="text-align:left">'+n.projectHead+'</td>'+
							'<td style="text-align:right" width="100px">'+n.traineeCount+'</td>'+
							//应收金额
							'<td style="text-align:right" width="110px">'+n.amountReceivable+'</td>'+
							'<td style="text-align:right" width="70px">'+n.unpaid+'</td>'+
							'<td style="text-align:center" width="65px">'+n.projectStates+'</td>'+
							'</tr>'
							projecDetailsBody.append(projecDetailsHtml);
						});
					}else{
						ticketHtml = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="9" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 220px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="width: 220px;padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
							projecDetailsBody.append(projecDetailsHtml);
					}
					//本月班次决算
					if(data.data.projecFinalAccounts.length>0){
						var accountsBody = $('.index-scend tbody').empty();
						var accountsHtml = '';
						$.each(data.data.projecFinalAccounts, function(i,n) {
							accountsHtml = '<tr>'+
							'<td style="text-align:center">'+(i+1)+'</td>'+
							'<td>'+n.projectName+'</td>'+
							'<td style="text-align:center">'+n.endDate+'</td>'+
							'<td>'+n.projectHead+'</td>'+
							'<td style="text-align:right" >'+n.traineeCount+'</td>'+
							'<td style="text-align:right">'+n.amountReceivable+'</td>'+
							'<td style="text-align:right">'+n.netReceipts+'</td>'+
							//应收金额
							'<td style="text-align:right">'+n.teacherRemuneration+'</td>'+
							'<td style="text-align:right">'+n.teacherTravel+'</td>'+
							'<td style="text-align:right">'+n.expenditureTotal+'</td>'+
							'</tr>'
							accountsBody.append(accountsHtml);
						});
					}else{
						accountsHtml = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="9" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 220px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="width: 220px;padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
							accountsBody.append(accountsHtml);
					}
				$yt_baseElement.hideLoading();
				
			},
			error: function(data) {

			}
		});
	},
	classplan:function(){
		var me = this ;
		$.ajax({
			type: "post",
			url: $yt_option.base_path + "project/getShiftPlan",
			async: true,
			beforeSend: function() {
				$yt_baseElement.showLoading();
			},
			data: {
				classMonth: $("#txtDate").val()
			},
			success: function(data) {
				console.log(data.data);
				if(data.flag == 0) {
					this.dates = $("#txtDate").val().split('-');
					this.year = this.dates[0];
					this.month = this.dates[1];
					this.days = new Date(this.year, this.month, 0);
					this.days = this.days.getDate();
					$('.plan-table thead tr').empty();
					$('.plan-table tbody').empty();
					$('.plan-table thead tr').append("<th>培训主题</th>");
					for(let i = 0; i < data.data.length; i++) {
						$('.plan-table tbody').append('<tr><td>' + data.data[i].projectName + '</td></tr>'); //渲染培训主题
					}
					for(let i = 0; i < this.days; i++) {
						$('.plan-table tbody tr').append("<td class='state-day'></td>"); //渲染当月天数
					};
					setDayList(new Date($("#txtDate").val()));
					var num = 0;
					//循环每一行
					$.each(data.data, function(i, n) {
						//循环日期，赋予开始与结束类
						if(n.startDate.substring(5, 7) != n.endDate.substring(5, 7)) {
							//判断是否当月开始
							if(n.startDate.substring(5, 7) == $("#txtDate").val().substring(5, 7)) {
								$.each($('.index-plan thead tr .state-day'), function(k, v) {
									if(n.startDate == $(v).attr('currentday')) {
										$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('start-state line').data('classData', n);
										$('.index-plan tbody tr').eq(i).children('.state-day').eq($('thead tr .state-day').length-1).addClass('end-state line').data('classData', n);
									}
								});
							}
							//判断是否上月开始
							if(n.endDate.substring(5, 7) == $("#txtDate").val().substring(5, 7)) {
								$.each($('.index-plan thead tr .state-day'), function(k, v) {
									if(n.endDate == $(v).attr('currentday')) {
										$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('end-state line').data('classData', n);
										$('.index-plan tbody tr').eq(i).children('.state-day').eq(0).addClass('start-state line').data('classData', n);
									}
								});
							}
						} else {
							for(let j = 0; j < $('.index-plan thead tr .state-day').length; j++) {
								if(n.startDate == $('.index-plan thead tr .state-day').eq(j).attr('currentday')) {
									$('.index-plan tbody tr').eq(i).children('.state-day').eq(j).addClass('start-state line').data('classData', n);
								}
								if(n.endDate == $('thead tr .state-day').eq(j).attr('currentday')) {
									$('.index-plan tbody tr').eq(i).children('.state-day').eq(j).addClass('end-state line').data('classData', n);
								}

							}
						}
						//开始与结束之间增加线
						for(let k = $('.index-plan tbody tr').eq(i).children('.start-state').index() - 1; k < $('.index-plan tbody tr').eq(i).children('.end-state').index(); k++) {
							if(n.projectStates == '1') {
								$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('sub-use line').data("classData", n);
							} else if(n.projectStates == '2') {
								$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('all-use line').data("classData", n);
							} else if(n.projectStates == '3') {
								$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('no-use line').data("classData", n);
							} else if(n.projectStates == '4') {
								$('.index-plan tbody tr').eq(i).children('.state-day').eq(k).addClass('alr-use line').data("classData", n);
							}
						}
					});
					//在院人数
					$.each($('.plan-table thead .state-day'), function(i, n) {
						num = 0;
						for(let j = 0; j < data.data.length; j++) {
							var classData = $('.plan-table tbody tr').eq(j).find("td.state-day").eq(i).data("classData");
							if(classData != undefined && classData.projectStates != 0) {
								num = num + classData.traineeCount;
							}

						}
						$(n).data('traineeCount', num);
					})
					//hover
					//日子选中状态
					$('.plan-table th.state-day').hover(function() {
						th = this;
						$.each($('.index-plan tbody tr'), function(j, m) {
							$(this).children('.state-day').eq($(th).index() - 1).css('background-color', '#f6f7ff');
						});
					}, function() {
						$.each($('.index-plan tbody tr'), function(j, m) {
							$(this).children('.state-day').eq($(th).index() - 1).css('background', 'none')
						});
					});
					setTimeout($yt_baseElement.hideLoading(), 500);
					if(data.data == '') {
						$('.plan-table tbody').append("<td colspan='30' align='center' style='border:0px;'><div class='no-data' style='width: 280px;margin: 0 auto;'><img src='../../resources/images/common/no-data.png' style='width:200px;padding: 35px 0 20px;'></div></td>")
					};

					$('.plan-table th.state-day').tooltip({
						position: 'bottom',
						content: function() {
							var showBox = '<table class="tip-table">' +
								'<tr><td class="tip-lable">在院人数：</td><td><span style="color:red">' + $(this).data('traineeCount') + '</span>人</td></tr>' +
								'</table>';
							return showBox;
						},
						onShow: function() {
							$(this).tooltip('tip').css({
								backgroundColor: '#666',
								borderColor: '#666',
								color: '#fff'
							});
						}
					});
					//提示
					$('.line').tooltip({
						position: 'bottom',
						content: function() {
							var line = $(this).data('classData');
							line.projectType = line.projectType.replace("1", "计划").replace("2", "委托").replace("3", "选学").replace("4", "调训");
							var showBox = '<table class="tip-table">' +
								'<tr><td class="tip-lable" width="80px">班级名称：</td><td>' + line.projectName + '</td></tr>' +
								'<tr><td class="tip-lable" width="80px">项目类型：</td><td>' + line.projectType + '</td></tr>' +
								'<tr><td class="tip-lable" width="80px">项目主任：</td><td>' + line.projectHead + '</td></tr>' +
								'<tr><td class="tip-lable" width="80px">学员数量：</td><td>' + line.traineeCount + '人</td></tr>' +
								'<tr><td class="tip-lable" width="80px">委托单位：</td><td>' + line.groupName + '</td></tr>' +
								'</table>';
							return showBox;
						},
						onShow: function() {
							$(this).tooltip('tip').css({
								backgroundColor: '#666',
								borderColor: '#666'
							});
						}
					});
					//
				} else {
					setTimeout($yt_baseElement.hideLoading(), 500);
				}
			}
		});
	}
};

function dateinit() {
	$("#txtDate").calendar({
		speed: 200, //日期列表展开显示速度, 参数"slow","normal","fast"，或毫秒数值，默认：200     
		complement: true, // 是否显示日期或年空白处的前后月的补充,默认：true     
		readonly: true, // 目标对象是否设为只读，默认：true     
		lowerLimit: "2010/01/01", // 日期下限，默认：NaN(不限制)     
		nowData: true, //默认选中当前时间,默认true  
		dateFmt: "yyyy-MM",
		callback: function() { // 点击选择日期后的回调函数  
			//        alert("您选择的日期是：" + $("#txtDate").val());  
			setDayList(new Date($("#txtDate").val()));
			index.classplan();
		}
	});
}
$(document).ready(function() {
	//月份选择

	$(".plan-table caption div.right span").click(function() {
		var currentData = $("#txtDate").val();
		if($(this).index() == 0) {
			currentData = getPreMonth(currentData);
		} else if($(this).index() == 1) {
			currentData = new Date();
			var y = new Date().getFullYear(); //年
			var m = new Date().getMonth() + 1; //月
			var day = new Date().getDate(); //日
			currentData = y + "-" + (m < 10 ? "0" + m : m);
		} else {
			currentData = getNextMonth(currentData);
		}
		//初始化数据

		$("#txtDate").val(currentData);
		setDayList(new Date($("#txtDate").val()));
		index.classplan();
	});
	index.init();
});
function setDayList(currentDate) {
	//获取时间
	//var currentDate = new Date();
	currentDate.setDate(1);
	var year = currentDate.getFullYear();

	var month = currentDate.getMonth() + 1;
	var d = new Date(year, month, 0);
	$(".occupy-list .state-day").remove();
	var y, m, day, th;
	for(var i = 0; i < d.getDate(); i++) {

		if(i > 0) {
			currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000);
		}
		y = currentDate.getFullYear(); //年
		m = currentDate.getMonth() + 1; //月
		day = currentDate.getDate(); //日
		currentdayStr = y + "-" + (m < 10 ? "0" + m : m) + "-" + (day < 10 ? "0" + day : day);
		th = $('<th class="state-day" currentday="' + currentdayStr + '"><div>' + currentDate.getDate() + '</div></th>');
		if(currentDate.getDay() == 0) {
			th.addClass("sun");
		} else if(currentDate.getDay() == 6) {
			th.addClass("sat");
		}
		$(".occupy-list tr").append(th);
	}
}
/**
 * 获取上一个月
 *
 * @date 格式为yyyy-mm-dd的日期，如：2014-01-25
 */
function getPreMonth(date) {
	var arr = date.split('-');
	var year = arr[0]; //获取当前日期的年份
	var month = arr[1]; //获取当前日期的月份
	var day = arr[2]; //获取当前日期的日
	var days = new Date(year, month, 0);
	days = days.getDate(); //获取当前日期中月的天数
	var year2 = year;
	var month2 = parseInt(month) - 1;
	if(month2 == 0) {
		year2 = parseInt(year2) - 1;
		month2 = 12;
	}
	var day2 = day;
	var days2 = new Date(year2, month2, 0);
	days2 = days2.getDate();
	if(day2 > days2) {
		day2 = days2;
	}
	if(month2 < 10) {
		month2 = '0' + month2;
	}
	var t2 = year2 + '-' + month2;
	return t2;
}

/**
 * 获取下一个月
 *
 * @date 格式为yyyy-mm-dd的日期，如：2014-01-25
 */
function getNextMonth(date) {
	var arr = date.split('-');
	var year = arr[0]; //获取当前日期的年份
	var month = arr[1]; //获取当前日期的月份
	var day = arr[2]; //获取当前日期的日
	var days = new Date(year, month, 0);
	days = days.getDate(); //获取当前日期中的月的天数
	var year2 = year;
	var month2 = parseInt(month) + 1;
	if(month2 == 13) {
		year2 = parseInt(year2) + 1;
		month2 = 1;
	}
	var day2 = day;
	var days2 = new Date(year2, month2, 0);
	days2 = days2.getDate();
	if(day2 > days2) {
		day2 = days2;
	}
	if(month2 < 10) {
		month2 = '0' + month2;
	}

	var t2 = year2 + '-' + month2;
	return t2;
}
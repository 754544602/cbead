var borrowInfo={init:function(){borrowInfo.getBorrowInfo();$('.page-return-btn').on('click',function(){var first="borrow";var backType=$yt_common.GetQueryString("backType");if(backType=="f1"||backType=="f2"||backType=="j1"||backType=="j2"){window.location.href="myApproveList.html?first="+first+"&backType="+backType+"&apprOrInf="+21}$('.reduce-list').hide();$('.borrow-list').show();$yt_baseElement.showLoading()});borrowInfo.getNextOperatePerson();$("#nextPeople").niceSelect();$(".check-label input[type='radio']").change(function(){var tastKey=$('.hid-tast-key').val();var rad=$(this).val();if(rad=="completed"){if(tastKey=="activitiEndTask"){$('.hid-input').hide()}else{$('.hid-input').show()}};if(rad=="returnedSubmit"){$('#nextPeople').val("");$('.hid-input').hide()}});$('#last-submit').click(function(){var dealingWithPeople=$('#nextPeople').val();var pkId=$yt_common.GetQueryString("pkId");var processInstanceId=$('.hid-process-instance-id').val();var opintion=$('#opintion').val();var nextCode=$('input[name="radioType"]:checked ').val();var tastKey=$('.hid-tast-key').val();if(nextCode=="returnedSubmit"||tastKey=="activitiEndTask"){dealingWithPeople=""}if(dealingWithPeople=="no"){$yt_alert_Model.prompt("请选择下一步操作人！",3000)}else{$.ajax({type:"post",url:$yt_option.base_path+"finance/invoicing/updateApply",async:false,data:{pkId:pkId,businessCode:"invoicing",processInstanceId:processInstanceId,dealingWithPeople:dealingWithPeople,opintion:opintion,nextCode:nextCode},objName:'data',success:function(data){if(data.flag==0){}}});window.location.href="myApproveList.html?apprOrInf="+21}});$('#last-cancel').click(function(){window.location.href="myApproveList.html?apprOrInf="+21})},getNextOperatePerson:function(){var getAllNextPeople=borrowInfo.getworkFlowOperate();if(getAllNextPeople.data.length!=0){var data=getAllNextPeople.data[0]['{"taskId":"activitiStartTask","nextCode":"submited","parameters":"","nextName":"提交【NEXT_CODE】"}'];if(data!=null){$.each(data,function(i,n){$("#nextPeople").append('<option value="'+n.userCode+'">'+n.userName+'</option>')})}}},getworkFlowOperate:function(){var processInstanceId=$('.hid-process-instance-id').val();var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/workFlowOperate/getSubmitPageData",data:{businessCode:"openHonorsStart"},async:false,success:function(data){list=data||[]}});return list},getBorrowInfo:function(){var pkId=$yt_common.GetQueryString("pkId");var applicationInvoice;$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/invoicing/getBeanById",async:true,data:{pkId:pkId},objName:'data',success:function(data){$yt_baseElement.hideLoading();if(data.flag==0){if(data.data.workFlawState!='审批中'){window.location.href='borrowInfo.html?pkId='+data.data.pkId}$('.create-user').text(data.data.createUser);$('.dept-name').text(data.data.deptName);$('.create-time-string').text(data.data.createTimeString);applicationInvoice=data.data.applicationInvoice;money=applicationInvoice.toFixed(2)+"";money=money.replace(/(\d{1,3})(?=(\d{3})+(?:$|\.))/g,'$1,');$('.application-invoice').text(money);$('.invoice-org').text(data.data.invoiceOrg);$('.invoice-type').text((borrowInfo.borrowTypeInfo(data.data.invoiceType)));$('.org-name').text(data.data.orgName);$('.tax-number').text(data.data.taxNumber);$('.address').text(data.data.address);$('.telephone').text(data.data.telephone);$('.registered-bank').text(data.data.registeredBank);$('.account').text(data.data.account);$('.invoice-reason').text(data.data.invoiceReason);$('.work-flaw-state').text(data.data.workFlawState);var projectJSON=$.parseJSON(data.data.projects);var htmlTr="";var htmlTbody=$(".project-tbody");htmlTbody.html("");var num=0;$.each(projectJSON,function(i,v){htmlTr='<tr><td style = "text-align: center;" class="projectCode">'+v.projectCode+'</td><td >'+v.projectName+'</td><td style = "text-align: center;">'+v.projectHead+'</td><td style = "text-align: center;">'+v.startDate+'</td><td style = "text-align: center;">'+v.endDate+'</td></tr>';htmlTbody.append(htmlTr)});var flowLog=data.data.flowLog;var middleStepHtml;var length=flowLog.length;$('.hid-process-instance-id').val(data.data.processInstanceId);$.each(flowLog,function(i,v){if(i==0){$('.hid-tast-key').val(v.tastKey);if(v.tastKey=="activitiEndTask"){$('.next-operate-person-tr').hide()}$('.last-step-order').text(length);$('.last-step-operate-person-userName').text(v.userName);$('.last-step-operationState').text(v.operationState);$('.last-step-commentTime').text(v.commentTime)};if(i==length-1){$('.first-step-order').text(1);$('.first-step-operate-person-userName').text(v.userName);$('.first-step-taskName').text(v.operationState);$('.first-step-commentTime').text(v.commentTime)};if(i!=0&&i<length-1){var order=length-i;middleStepHtml='<div><div style="height: 150; "><div class="number-name-box"><span class="number-box-span middle-step-order middle-a-index" >'+order+'</span><span class="name-box-span middle-step-userName middle-a-index" >'+v.userName+'</span><img src="../../resources/images/open/openFlow.png" class="order-img" /></div></div><div class="middle-step-box-div"><ul class="middle-step-box-ul"><li style="height: 30px;"><span  class="middle-step-taskName view-taskName-span"  style="float: left;">'+v.operationState+'</span></li><li class="view-time-li middle-step-commentTime" >'+v.commentTime+'</li><li class="operate-view-box-li"><div class="operate-view-title-li">操作意见：</div><div class="operate-view-text-li middle-step-comment" style="padding-left:10px;">'+v.comment+'</div></li></ul></div></div>';$('.last-step').append(middleStepHtml)}});$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})},borrowTypeInfo:function(code){if(code==1){return "普通发票"}else if(code==2){return "增值税发票"}else{return ''}}};$(function(){borrowInfo.init()});
var search="";var projectDetails={costOldMoney:'',init:function(){var pkId=$yt_common.GetQueryString("pkId");var projectCode=$yt_common.GetQueryString("projectCode");var projectType=$yt_common.GetQueryString("projectType");if(projectType==3||projectType==2||projectType==1){$(".other-income-btn").hide()}$('.page-return-btn').click(function(){window.location.href="projectSettlementList.html"});projectDetails.getStudetListInfo();$(".settlement-tbody").on("click",".project-name",function(){window.location.href="projectSettlementList.html"});$(".out-file").click(function(){projectDetails.getOutFile()});$(".in-Date-hh").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});$(".out-Date-hh").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});$('.amend-expense-list').click(function(){if($('.project-student-tbody .yt-table-active').length==0){$yt_alert_Model.prompt("请选择要修改的数据");return false}$(".in-Date-hh").val($(".yt-table-active").data('data').arrivalTime);$(".out-Date-hh").val($(".yt-table-active").data('data').departureTime);$(".yt-table-active").data('data').roomNumber;$(".student-details-form").show();$yt_alert_Model.setFiexBoxHeight($(".student-details-form .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".student-details-form"));$yt_model_drag.modelDragEvent($(".student-details-form .yt-edit-alert-title"));$yt_baseElement.showLoading();var data=$(".yt-table-active").data('data');projectDetails.costOldMoney=data;var realName=$(".yt-table-active").data('data').realName;var groupNum=$(".yt-table-active").data('data').groupNum;var gender=$(".yt-table-active").data('data').gender;var phone=$(".yt-table-active").data('data').phone;var idNumber=$(".yt-table-active").data('data').idNumber;var groupName=$(".yt-table-active").data('data').groupName;var groupOrgName=$(".yt-table-active").data('data').groupOrgName;var deptPosition=$(".yt-table-active").data('data').deptPosition;var roomNumber=$(".yt-table-active").data('data').roomNumber;var trainingExpenseNegotiatedPrice=$(".yt-table-active").data('data').trainingExpenseNegotiatedPrice;var quarterageNegotiatedPrice=$(".yt-table-active").data('data').quarterageNegotiatedPrice;var mealFeeNegotiatedPrice=$(".yt-table-active").data('data').mealFeeNegotiatedPrice;var incidental=$(".yt-table-active").data('data').incidental;var traineeId=$(".yt-table-active").data('data').traineeId;var numberDinner=Number($(".yt-table-active").data('data').breakfastFor)+Number($(".yt-table-active").data('data').numberLunch)+Number($(".yt-table-active").data('data').numberDinner);var otherCost=$(".yt-table-active").data('data').otherCost;if(gender==1){gender="男"}else if(gender==2){gender="女"}$(".student-details-form").setDatas($(".yt-table-active").data('data'));$(".course-price-hid-inp").val($(".yt-table-active").data('data').traineeNegotiatedPrice);$(".course-price").val($yt_baseElement.fmMoney($(".yt-table-active").data('data').traineeNegotiatedPrice));$(".real-money-hid-inp").val($(".yt-table-active").data('data').cash);$(".real-money").text($yt_baseElement.fmMoney($(".yt-table-active").data('data').cash));$(".card-money").text($yt_baseElement.fmMoney($(".yt-table-active").data('data').creditCard));$(".card-money-hid-inp").val($(".yt-table-active").data('data').creditCard);$(".student-details-form .realName").text(realName);$(".student-details-form .groupNum").text(groupNum);$(".student-details-form .gender").text(gender);$(".student-details-form .phone").text(phone);$(".student-details-form .idNumber").text(idNumber);$(".student-details-form .groupName").text(groupName);$(".student-details-form .groupOrgName").text(groupOrgName);$(".student-details-form .deptPosition").text(deptPosition);$(".student-details-form .roomNumber").text(roomNumber);$(".student-details-form .training-expense-negotiated-price-input").val($yt_baseElement.fmMoney(trainingExpenseNegotiatedPrice));$(".student-details-form .quarterage-negotiated-price-input").val($yt_baseElement.fmMoney(quarterageNegotiatedPrice));$(".student-details-form .meal-fee-negotiated-price-input").val($yt_baseElement.fmMoney(mealFeeNegotiatedPrice));$(".student-details-form .incidental-input").val($yt_baseElement.fmMoney(incidental));$(".student-details-form .traineeId-hidden-input").val(traineeId);$('.cost-table').setDatas(data);$.each($('.cost-table input[type=text]'),function(i,n){$(n).val($yt_baseElement.fmMoney($(n).val()));$(n).off('focus').on('focus',function(){$(this).val($yt_baseElement.rmoney($(this).val()))})});$('.cost-table .cost-cash').off('blur').on('blur',function(){var allm=0;$.each($('.cost-table .cost-cash'),function(j,k){allm+=$yt_baseElement.rmoney($(k).val())});allm=$yt_baseElement.fmMoney(allm);$('.real-money').text(allm);$(this).val($yt_baseElement.fmMoney($(this).val()))});$('.cost-table .cost-bank').off('blur').on('blur',function(){var allm=0;$.each($('.cost-table .cost-bank'),function(j,k){allm+=$yt_baseElement.rmoney($(k).val())});allm=$yt_baseElement.fmMoney(allm);$('.card-money').text(allm);$(this).val($yt_baseElement.fmMoney($(this).val()))});var projectType=$yt_common.GetQueryString("projectType");if(projectType==3||projectType==2){$(".student-details-form .training-expense-negotiated-price-hidden-input").val(trainingExpenseNegotiatedPrice);$(".student-details-form .quarterage-negotiated-price-hidden-input").val(quarterageNegotiatedPrice);$(".student-details-form .meal-fee-negotiated-price-hidden-input").val(mealFeeNegotiatedPrice);$(".student-details-form .incidental-hidden-input").val(incidental)}else if(projectType==4){$(".student-details-form .meal-fee-negotiated-price-input").val($yt_baseElement.fmMoney(numberDinner));$(".student-details-form .incidental-input").val($yt_baseElement.fmMoney(otherCost))}$yt_baseElement.hideLoading();$('.update-student-sure-btn').off().click(function(){projectDetails.amendExpenseList()});$('.update-student-canel-btn').click(function(){$(".student-details-form").hide()});$(".cost-of-listing tbody .money-tr").find("input").blur(function(){$(this).val($yt_baseElement.fmMoney($(this).val()))})});$('.project-income-div,.project-student-tbody').off('click').on('click','.real-name-inf',function(){var traineeId=$(this).parent().parent().find(".hid-trainId").val();var projectCode=$yt_common.GetQueryString("projectCode");projectDetails.seeStudentDetails(traineeId,projectCode);$(".project-pay-student-details-form").show();$yt_alert_Model.setFiexBoxHeight($(".project-pay-student-details-form .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".project-pay-student-details-form"));$yt_model_drag.modelDragEvent($(".project-pay-student-details-form .yt-edit-alert-title"));$('.project-pay-student-details-form .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".project-pay-student-details-form").hide()})});$('.project-student-tbody').off('click').on('click','.real-name-inf',function(){var traineeId=$(this).parent().parent().find(".hid-trainId").val();var projectCode=$yt_common.GetQueryString("projectCode");projectDetails.seeStudentDetails(traineeId,projectCode);$(".pay-student-details-form-money").show();$yt_alert_Model.setFiexBoxHeight($(".pay-student-details-form-money .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".pay-student-details-form-money"));$yt_model_drag.modelDragEvent($(".pay-student-details-form-money .yt-edit-alert-title"));$('.pay-student-details-form-money .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".pay-student-details-form-money").hide()})});$('.expenditure-cancel-btn').click(function(){$('.expenditure-sure-btn').text("修改");$('.expenditure-sure-btn').attr('sure-state','true');$('.otherCost-tbody tr td input').hide();$('.otherCost-tbody tr td span').show();$(this).hide()});$('.expenditure-sure-btn').click(function(){var sureState=$(this).attr('sure-state');if(sureState=="true"){$(this).text("确定");$(this).attr('sure-state','false');$('.otherCost-tbody tr').each(function(){$(this).find('td').eq(3).find('input').css('width',"99%");$(this).find('td').eq(2).find('input').css('text-align','right')});$('.otherCost-tbody tr td input').show();$('.otherCost-tbody tr td span').hide();$(".expenditure-cancel-btn").show()}else{$(this).text("修改");$(this).attr('sure-state','true');$('.otherCost-tbody tr td input').hide();$('.otherCost-tbody tr td span').show();$(".expenditure-cancel-btn").hide();var costCode="";var spendMoney="";var details="";var otherCostJsonArr=[];$(".otherCost-tbody tr").each(function(i,n){costCode=$(n).attr("costCode");spendMoney=$(n).find('td').eq(2).find('input').val();details=$(n).find('td').eq(3).find('input').val();if(costCode!=null){var otherCostArr={costCode:costCode,spendMoney:$yt_baseElement.rmoney(spendMoney),details:details};otherCostJsonArr.push(otherCostArr)}});console.log(otherCostJsonArr);var otherCost=JSON.stringify(otherCostJsonArr);var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/settlement/addExpenditure",data:{projectCode:projectCode,otherCost:otherCost},async:false,success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("添加成功");projectDetails.getExpenditureListInf()})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("添加失败");projectDetails.getExpenditureListInf()})}}})}});$('.project-total-cost-tbody').on('click','span',function(){var repairAcc=$(this).parent().attr('repair-acc');if(repairAcc=="true"){$(this).parents('tr').find('td').eq(2).find('span').hide();$(this).parents('tr').find('td').eq(2).find('input').show();$(this).text("确定");$(this).parent().attr('repair-acc',false)}else{$(this).parents('tr').find('td').eq(2).find('span').show();$(this).parents('tr').find('td').eq(2).find('input').hide();var costData=[];var trList=$('.project-total-cost-tbody tr');$.each(trList,function(i,n){var costType=$(n).find('td').eq(0).text();var costReduction=$(n).find('td').eq(2).find('input').val();var costMap={costType:costType,costReduction:$yt_baseElement.rmoney(costReduction)};costData.push(costMap)});costData=JSON.stringify(costData);projectDetails.repairAllAppe(costData);var img='<img style="margin-right: 2px;" src="../../resources/images/icons/amend.png">';$(this).text("");$(this).append(img);$(this).parent().attr('repair-acc',true)}});$(".tab-title-list button").click(function(){$(this).addClass("active").siblings().removeClass("active");$(".box-list .content-box").hide().eq($(this).index()).show();if($(this).index()==0){projectDetails.getStudetListInfo();$('#project-main').css("min-width","1120px")}else if($(this).index()==1){search="";projectDetails.userInfo();$('#project-main').css("min-width","1420px");if(projectType==2||projectType==3){projectDetails.getStudentCostsList();projectDetails.getCheckList();projectDetails.getCompanyList();}else{search="";$(".project-expenses-list").hide();$('button.amend-expense-list').hide();projectDetails.getStudentCostsList1();projectDetails.getCompanyList1();}$(".project-student-tbody").on("click",".cost-details",function(){$(".addBorrow-tbody").empty();var htmTbo=$(".addBorrow-tbody");var projectCode=$yt_common.GetQueryString("projectCode");var traineeId=$(this).prev().val();$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/settlement/getNoDetailedPersonalListDetails",data:{projectCode:projectCode,traineeId:traineeId},async:true,success:function(data){if(data.flag==0){if(data.data!=null){$.each(data.data,function(i,v){var TrHtml='<tr><td>'+v.dateData+'</td><td>'+v.breakfastFor+'</td><td>'+v.numberLunch+'</td><td>'+v.numberDinner+'</td></tr>';htmTbo.append(TrHtml)})}else{TrHtml='<tr style="border:0px;background-color:#fff !important;" ><td colspan="4" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmTbo.append(TrHtml)}$(".select-teacher-div").show();$yt_alert_Model.setFiexBoxHeight($(".select-teacher-div .yt-edit-alert-main"));$yt_alert_Model.getDivPosition($(".select-teacher-div"));$yt_model_drag.modelDragEvent($(".select-teacher-div .yt-edit-alert-title"));$('.select-teacher-canel-btn').click(function(){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})}else{$yt_alert_Model.prompt("查询失败!")}projectDetails.getTotalList();$yt_baseElement.hideLoading()}})})}else if($(this).index()==2){$('#project-main').css("min-width","1500px");if(projectType==2||projectType==3){$(".project-income-study").show();$(".project-revenue-training").hide();projectDetails.getIncomesList();projectDetails.getIncomeCostsList();projectDetails.getTotalList()}else{$(".project-income-study").hide();$(".project-revenue-training").show();projectDetails.projectRevenueTraining()}}else if($(this).index()==3){$('#project-main').css("min-width","1120px");projectDetails.getOtherIncomeList()}else if($(this).index()==4){$('#project-main').css("min-width","1120px");$('.expenditure-sure-btn').text("修改");$('.expenditure-sure-btn').attr('sure-state','true');$('.otherCost-tbody tr td input').hide();$('.otherCost-tbody tr td span').show();$('.expenditure-cancel-btn').hide();projectDetails.getExpenditureListInf()}});$(".project-income-study .search-btn").click(function(){projectDetails.getIncomesList()});$(".stu-info-list").off().on('click','.search-btn',function(){search="search";if(projectType==4){projectDetails.getStudentCostsList1();projectDetails.getCompanyList1()}else{projectDetails.getStudentCostsList();projectDetails.getCompanyList()}});$('.incomeSubmit').off('click').on('click',function(){projectDetails.updateIncome()})},userInfo:function(){var me=this;var projectCode=$yt_common.GetQueryString("projectCode");var roleIds;var getRemarks;$.ajax({async:false,type:"post",url:$yt_option.base_path+"finance/settlement/getProjectRemarkAndCheck",data:{projectCode:projectCode},success:function(data){if(data.flag==0){if(data.data!=null){getRemarks=data.data;var projectDetailedRemarks=$(".projectDetailedRemarks").val(data.data.projectDetailedRemarks);var projectHead=$(".projectHead").val(data.data.projectHead);var projectSell=$(".projectSell").val(data.data.projectSell);var deanAcademicAffairs=$(".deanAcademicAffairs").val(data.data.deanAcademicAffairs)}else{getRemarks={projectDetailedRemarks:"",projectDetailedRemarksCreateTime:"",projectDetailedRemarksCreateUser:"",projectHead:"",projectHeadCreateTime:"",projectHeadCreateUser:"",projectSell:"",projectSellCreateTime:"",projectSellCreateUser:"",deanAcademicAffairsCreateTime:"",deanAcademicAffairsCreateUser:"",deanAcademicAffairs:""}}}}});$(".remark-box").find("p").text("");var userData;$.ajax({async:false,type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){roleIds=','+data.data.roleIds+',';userData=data.data;if(roleIds.indexOf(',128,')==-1){$(".projectDetailedRemarks").hide();if($(".projectDetailedRemarks").val()!=""){$(".projectDetailedRemarks").next().text($(".projectDetailedRemarks").val());}else{$(".projectDetailedRemarks").parent().hide()}};if((','+me.studentListInfo.projectHead+',').indexOf(','+data.data.userName+',')==-1){$(".projectHead").hide();if($(".projectHead").val()!=""){$(".projectHead").next().text($(".projectHead").val())}else{$(".projectHead").parent().hide()}};if(me.studentListInfo.projectSell.indexOf(data.data.userName)==-1){$(".projectSell").hide();if($(".projectSell").val()!=""){$(".projectSell").next().text($(".projectSell").val())}else{$(".projectSell").parent().hide()}};if(roleIds.indexOf(',129,')==-1){$(".deanAcademicAffairs").hide();if($(".deanAcademicAffairs").val()!=""){$(".deanAcademicAffairs").next().text($(".deanAcademicAffairs").val())}else{$(".deanAcademicAffairs").parent().hide()}};if(roleIds.indexOf(',128,')!=-1||me.studentListInfo.projectSell.indexOf(data.data.userName)||(','+me.studentListInfo.projectHead+',').indexOf(','+data.data.userName+',')||roleIds.indexOf(',129,')!=-1){$(".remark-btn").show()}else{$(".remark-btn").hide()}}});$(".remark-btn").off().click(function(){var projectDetailedRemarks=$(".projectDetailedRemarks").val();var projectHead=$(".projectHead").val();var projectSell=$(".projectSell").val();var deanAcademicAffairs=$(".deanAcademicAffairs").val();var isEditArr=[];if(roleIds.indexOf(',128,')!=-1){if(getRemarks.projectDetailedRemarks!=projectDetailedRemarks){isEditArr.push('projectDetailedRemarks')}};if((','+userData.userName+',').indexOf(','+me.studentListInfo.projectHead+',')!=-1){if(getRemarks.projectHead!=projectHead){isEditArr.push('projectHead')}};if(userData.userName.indexOf(me.studentListInfo.projectSell)!=-1){if(getRemarks.projectSell!=projectSell){isEditArr.push('projectSell')}};if(roleIds.indexOf(',129,')!=-1){if(getRemarks.deanAcademicAffairs!=deanAcademicAffairs){isEditArr.push('deanAcademicAffairs')}};isEditArr=isEditArr.join(',');$.ajax({async:false,type:"post",url:$yt_option.base_path+"finance/settlement/updateProjectRemarkAndCheck",data:{projectCode:projectCode,projectDetailedRemarks:projectDetailedRemarks,projectDetailedRemarksCreateTime:getRemarks.projectDetailedRemarksCreateTime,projectDetailedRemarksCreateUser:getRemarks.projectDetailedRemarksCreateUser,projectHead:projectHead,projectHeadCreateTime:getRemarks.projectHeadCreateTime,projectHeadCreateUser:getRemarks.projectHeadCreateUser,projectSell:projectSell,projectSellCreateTime:getRemarks.projectSellCreateTime,projectSellCreateUser:getRemarks.projectSellCreateUser,deanAcademicAffairs:deanAcademicAffairs,deanAcademicAffairsCreateTime:getRemarks.deanAcademicAffairsCreateTime,deanAcademicAffairsCreateUser:getRemarks.deanAcademicAffairsCreateUser,isEdit:isEditArr},success:function(data){if(data.flag==0){projectDetails.userInfo();$yt_alert_Model.prompt("操作成功!")}}})})},repairAllAppe:function(costData){var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/settlement/updateDetailedReduction",data:{projectCode:projectCode,costData:costData},async:true,success:function(data){if(data.flag==0){$yt_alert_Model.prompt("修改成功")}else{$yt_alert_Model.prompt("修改失败")}projectDetails.getTotalList();$yt_baseElement.hideLoading()}})},seeStudentDetails:function(traineeId,projectId){var headImg=new Image();$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"class/trainee/getTraineeDetails",data:{traineeId:traineeId,projectId:projectId},async:true,success:function(data){var htmlBody=$('.pay-student-details-form .student-details-train-record tbody');var htmlTrs='';htmlBody.empty();if(data.flag==0){data.data.workTime=="0000-00-00"?data.data.workTime='':data.data.workTime=data.data.workTime;detailsMsg=data.data;if(data.data.idType==1){$(".pay-id-type").text("身份证")}else if(data.data.idType==2){$(".pay-id-type").text("护照")}else if(data.data.idType==3){$(".pay-id-type").text("军官证")}else if(data.data.idType==4){$(".pay-id-type").text("其他")}detailsMsg.checkInDate=detailsMsg.checkInDate.split(" ")[0];if(detailsMsg.gender==1){detailsMsg.gender="男"}else{detailsMsg.gender="女"}if(detailsMsg.invoiceType==0){detailsMsg.invoiceType="暂不开票"}else if(detailsMsg.invoiceType==1){detailsMsg.invoiceType="普通发票"}else{detailsMsg.invoiceType="增值税发票"}if(detailsMsg.checkInState==0){detailsMsg.checkInState="未报到"}else{detailsMsg.checkInState="已报到"}if(detailsMsg.paymentState==0){detailsMsg.paymentState="未对账"}else{detailsMsg.paymentState="已对账"}if(detailsMsg.isOrderNum==0){detailsMsg.isOrderNum="未开票"}else{detailsMsg.isOrderNum="已开票"}$('.pay-student-details-form .cont-edit-test').setDatas(detailsMsg);console.log("学员头像",detailsMsg.headPortraitUrl);if(detailsMsg.headPortrait!=""){headImg.src=detailsMsg.headPortraitUrl;headImg.onload=function(){$('.student-details-img').attr('src',headImg.src);$('.student-details-img').jqthumb({width:89,height:130})}}else{$('.student-details-img').attr('src','../../resources/images/classStudent/student-picture.png');$('.student-details-img').jqthumb({width:89,height:130})}var recordList=data.data.orderList;var recordBody=$('.pay-student-details-form .student-details-tecket .order-list-tbody').empty();var recordHtml='';if(recordList.length!=0){$.each(recordList,function(i,v){v.isOrderNum==1?v.isOrderNum='已开票':v.isOrderNum='未开票';recordHtml='<tr><td style="text-align: right;" width="80px">开票状态：</td><td style="text-align: left;" width="150px">'+v.isOrderNum+'</td>';if(v.isOrderNum=="未开票"){recordHtml+='<td class="order-num" style="text-align: right;" width="80px">发票号：</td><td style="text-align: left;" width="120px">'+v.orderNum+'</td><td class="order-money" style="text-align: right;" width="80px">开票金额：</td><td style="text-align: left;" width="120px">'+v.tuition+'</td>'}recordHtml+='<td width="80px"><div class="addorder addorder'+i+'" style="display:none;padding: 5px 10px;border: 1px dashed #E6E6E6;cursor: pointer;">合并开票</div></td>';'</tr>';recordBody.append(recordHtml);if(v.trainees!=undefined){var trainees=[]}else{var trainees=v.trainees.split(',')}if(trainees.length>1){$('.addorder'+i).show().data('trainees',trainees.join('  '))}$('.addorder').tooltip({position:'bottom',content:function(){var showBox='<table class="tip-table"><tr><td style="text-align:left">合并开票者：</td></tr><tr><td>'+$(this).data('trainees')+'</td></tr></table>';return showBox},onShow:function(){$(this).tooltip('tip').css({backgroundColor:'#666',borderColor:'#666',color:'#fff'})}})})}else{recordHtml='<tr style="border:0px;background-color:#fff !important;" ><td width="77px" align="right" style="border:0px;">开票状态：</td><td align="left" style="border:0px;">未开票</td></tr>';recordBody.append(recordHtml)}$yt_baseElement.hideLoading()}}})},studentListInfo:'',getStudetListInfo:function(){var me=this;$(".initProjectShell").val("");$(".initProjectHead").val("");var pkId=$yt_common.GetQueryString("pkId");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"project/getBeanById",async:true,data:{pkId:pkId},objName:'data',success:function(data){if(data.flag==0){if(data.data.projectType==1){data.data.projectType="计划"}else if(data.data.projectType==2){data.data.projectType="委托"}else if(data.data.projectType==3){data.data.projectType="选学";$(".projectType-2").hide()}else if(data.data.projectType==4){data.data.projectType="调训"}$('.project-code').text(data.data.projectCode);$('.project-name').text(data.data.projectName);$('.project-type').text(data.data.projectType);$('.project-sell').text(data.data.projectSell);$('.start-date').text(data.data.startDate);$('.end-date').text(data.data.endDate);$('.details').text(data.data.details);$('.train-date').text(data.data.trainDate);$('.customer-unit').text(data.data.groupName);$('.customer-dept').text(data.data.customerDept);$('.customer-linkman').text(data.data.customerLinkman);$('.customer-linkman-position').text(data.data.customerLinkmanPosition);$('.customer-linkman-phone').text(data.data.customerLinkmanPhone);$('.customer-linkman-cellphone').text(data.data.customerLinkmanCellphone);$('.customer-linkman-fax').text(data.data.customerLinkmanFax);$('.customer-linkman-email').text(data.data.customerLinkmanEmail);$('.customer-trainee-position').text(data.data.customerTraineePosition);$('.customer-trainee-sum').text(data.data.customerTraineeSum);$('.customer-trainee-age-structure').text(data.data.customerTraineeAgeStructure);$('.customer-target-demand').text(data.data.customerTargetDemand);$('.project-sell').text(data.data.projectSellName);$(".initProjectShell").val(data.data.projectSell);$('.project-head').text(data.data.projectHeadName);$(".initProjectHead").val(data.data.projectHead);$('.class-teacher').text(data.data.projectHeadmasterName);$('.project-aid').text(data.data.projectAidName);$yt_baseElement.hideLoading();me.studentListInfo=data.data}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})},getCheckList:function(){$yt_baseElement.showLoading();var projectCode=$yt_common.GetQueryString("projectCode");$.ajax({async:true,url:$yt_option.base_path+"finance/settlement/getDetailedList",type:"post",data:{projectCode:projectCode},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.project-check-List-tbody');var htmlTr='';htmlTbody.empty();$.each(data.data.settlementDetailedList,function(i,v){htmlTr+='<tr><td>'+(i+1)+'</td><td style="text-align:left;">'+v.name+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.amountReceivableTotal)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.amountReceivableNoTax)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.amountReceivableTax)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.netReceiptsTotal)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.netReceiptsNoTax)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.netReceiptsTax)+'</td><td style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.uncollectedTotal)+'</td>'+'</tr>'});htmlTbody.html(htmlTr);$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getCompanyList:function(){$yt_baseElement.showLoading();var projectCode=$yt_common.GetQueryString("projectCode");var groupLisstLen;$.ajax({async:false,url:$yt_option.base_path+"finance/settlement/getDetailedList",type:"post",data:{projectCode:projectCode},success:function(data){if(data.flag==0){var htmlTbody=$('.project-company-tbody');var htmlTr='';var htmlPlan='';var amountReceivableSum=0;var netReceiptsSum=0;var uncollectedSum=0;$(htmlTbody).empty();groupLisstLen=data.data.settlementGroupDetails.length;if(data.data.settlementGroupDetails.length!=0){$.each(data.data.settlementGroupDetails,function(i,v){htmlTr+='<tr><td style="text-align:left;">'+v.groupName+'</td><td class="should" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.amountReceivable)+'</td><td class="already" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.netReceipts)+'</td><td class="account" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.uncollected)+'</td></tr>';amountReceivableSum+=v.amountReceivable;netReceiptsSum+=v.netReceipts;uncollectedSum+=v.uncollected});htmlTbody.html(htmlTr);htmlPlan+='<tr><td style="font-weight: bold;">小计</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(amountReceivableSum)+'</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(netReceiptsSum)+'</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(uncollectedSum)+'</td></tr>';htmlTbody.append(htmlPlan)}else{htmlTr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="6" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr);$(".group-list-title").hide()}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})};if(groupLisstLen==0){if($(".stu-list").css("display")=="none"){$(".group-list-box .list-thead").hide();$(".stu-list").hide();}else{$(".group-list-box").hide();}};if(search=="search"){$(".stu-list").show();};search=""},isSelPageNum:true })},getStudentCostsList:function(){var selectParam=$('.selectParam').val();var projectCode=$yt_common.GetQueryString("projectCode");$('.project-student-page').pageInfo({async:false,pageIndexs:1,pageNum:10000,pageSize:10,url:$yt_option.base_path+"finance/settlement/getDetailedPersonalList",type:"post",data:{projectCode:projectCode,selectParam:selectParam,trainingExpenseStart:"",trainingExpenseEnd:"",traineeNegotiatedPriceStart:"",traineeNegotiatedPriceEnd:"",quarterageStart:"",quarterageEnd:"",mealFeeStart:"",mealFeeEnd:"",otherChargesStart:"",otherChargesEnd:"",uncollectedStart:"",uncollectedEnd:""},before:function(){$yt_baseElement.showLoading()},success:function(data){if(data.flag==0){$('.project-student-tbody').empty();var htmlTbody=$('.project-student-tbody');var htmlTrSelection='';var htmlTrBreak='';if(data.data.rows.length>0){$(".amend-expense-list").show();$('.project-student-page').show();var arrivalTime=[];var departureTime=[];$(htmlTbody).empty();$.each(data.data.rows,function(i,v){if(v.arrivalTime!=""){arrivalTime=v.arrivalTime.split(":");v.arrivalTime=arrivalTime[0]+':'+arrivalTime[1]};if(v.departureTime!=""){departureTime=v.departureTime.split(":");v.departureTime=departureTime[0]+':'+departureTime[1]};htmlTrSelection+='<tr><td class="groupNum"><input type="hidden" value="'+v.headPortraitUrl+'" class="headPortraitUrl">'+(i+1)+'</td><td class="realName"><span class="stu-realname-look-info"><input type="hidden" value="'+v.gender+'" class="gender">'+v.realName+'</span></td><td class="groupOrgName" style="text-align:left"><input type="hidden" value="'+v.phone+'" class="phone">'+v.groupOrgName+'</td><td class="roomNumber"><input type="hidden" value="'+v.idNumber+'" class="idNumber">'+v.roomNumber+'</td><td class="arrivalTime">'+v.arrivalTime+'</td><td class="departureTime">'+v.departureTime+'</td><td style="text-align:right" class="trainingExpenseNegotiatedPrice"><input type="hidden" value="'+v.idNumber+'" class="idNumber">'+$yt_baseElement.fmMoney(v.trainingExpenseNegotiatedPrice)+'</td><td style="text-align:right"><input type="hidden" value="'+v.deptPosition+'" class="deptPosition">'+$yt_baseElement.fmMoney(v.traineeNegotiatedPrice)+'</td><td style="text-align:right" class="quarterageNegotiatedPrice"><input type="hidden" value="'+v.traineeId+'" class="traineeId hid-trainId">'+$yt_baseElement.fmMoney(v.quarterageNegotiatedPrice)+'</td><td style="text-align:right" class="mealFeeNegotiatedPrice">'+$yt_baseElement.fmMoney(v.mealFeeNegotiatedPrice)+'</td><td style="text-align:right" class="incidental">'+$yt_baseElement.fmMoney(v.incidental)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.smallPlan)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.cash)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.creditCard)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.wireTransfer)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.moneyTotal)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.uncollected)+'</td></tr>';htmlTrSelection=$(htmlTrSelection).data("data",v);htmlTbody.append(htmlTrSelection)});$(".detailed-hide-break").hide();$(".detailed-hide-selection").show()}else{htmlTrSelection='<tr style="border:0px;background-color:#fff !important;" ><td colspan="15" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTrSelection);if(search!="search"){$(".stu-list").hide();};$('.project-student-page').hide();$(".amend-expense-list").hide()}$yt_baseElement.hideLoading();$(".page-stu").hide()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getCompanyList1:function(){$yt_baseElement.showLoading();var projectCode=$yt_common.GetQueryString("projectCode");var groupLisstLen;$.ajax({async:false,url:$yt_option.base_path+"finance/settlement/getNoDetailedList",type:"post",data:{projectCode:projectCode},objName:'data',success:function(data){$('.project-company-tbody').empty();if(data.flag==0){var htmlTbody=$('.project-company-tbody');var htmlTr='';var htmlPlan='';var amountReceivableSum=0;var netReceiptsSum=0;var uncollectedSum=0;$(htmlTbody).empty();groupLisstLen=data.data.length;if(data.data.length!=""){$.each(data.data,function(i,v){htmlTr+='<tr><td style="text-align:left;">'+v.groupName+'</td><td class="should" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.amountReceivable)+'</td><td class="already" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.netReceipts)+'</td><td class="account" style="text-align:right;word-wrap:break-word;">'+$yt_baseElement.fmMoney(v.uncollected)+'</td></tr>';amountReceivableSum+=v.amountReceivable;netReceiptsSum+=v.netReceipts;uncollectedSum+=v.uncollected});htmlTbody.html(htmlTr);htmlPlan+='<tr><td style="font-weight: bold;">小计</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(amountReceivableSum)+'</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(netReceiptsSum)+'</td><td style="text-align:right;font-weight: bold;">'+$yt_baseElement.fmMoney(uncollectedSum)+'</td></tr>';htmlTbody.append(htmlPlan)}else{htmlTr='<tr style="border:0px;background-color:#fff !important;" ><td colspan="6" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTr);$(".group-list-title").hide()}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}if(groupLisstLen==0){if($(".stu-list").css("display")=="none"){$(".group-list-box .list-thead").hide();$(".stu-list").hide();}else{$(".group-list-box").hide();}}if(search=="search"){$(".stu-list").show();}search=""},isSelPageNum:true })},getStudentCostsList1:function(){$(".group-list-title").show();$(".stu-list").show();$(".group-list-box").show();$(".group-list-box .list-thead").show();$(".th-arrival-time").hide();$(".th-departure-time").hide();var selectParam=$('.selectParam').val();var projectCode=$yt_common.GetQueryString("projectCode");$('.stu-list .project-student-page').pageInfo({async:false,pageIndexs:1,pageNum:10000,pageSize:10,url:$yt_option.base_path+"finance/settlement/getNoDetailedPersonalList",type:"post",data:{selectParam:selectParam,projectCode:projectCode,breakfastForStart:"",breakfastForEnd:"",numberLunchStart:"",numberLunchEnd:"",numberDinnerStart:"",numberDinnerEnd:"",otherChargesStart:"",otherChargesEnd:""},before:function(){$yt_baseElement.showLoading()},objName:'data',success:function(data){if(data.flag==0){$('.project-student-tbody').empty();var htmlTbody=$('.project-student-tbody');var htmlTrSelection='';var htmlTrBreak='';if(data.data.rows.length>0){$('.project-student-page').show();$(htmlTbody).empty();$.each(data.data.rows,function(i,v){htmlTrBreak='<tr><td>'+(i+1)+'</td><td><a style="color: #3c4687;" class="real-name-inf">'+v.realName+'</a></td><td style="text-align:left">'+v.groupOrgName+'</td><td>'+v.roomNumber+'</td><td style="text-align:right">'+v.breakfastFor+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.numberLunch)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.numberDinner)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.otherCost)+'</td><td><input type="hidden" class="hid-trainId train-id-info" name="" value="'+v.traineeId+'" /><a style="color: #3c4687;" class="cost-details" href="#">详情</a></td></tr>';htmlTrBreak=$(htmlTrBreak).data('data',v);htmlTbody.append(htmlTrBreak)});$(".detailed-hide-selection").hide();$(".detailed-hide-break").show()}else{htmlTrBreak='<tr style="border:0px;background-color:#fff !important;" ><td colspan="9" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTrBreak);$('.project-student-page').hide();if(search!="search"){$(".stu-list").hide();}}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}$(".page-stu").hide()},isSelPageNum:true })},amendExpenseList:function(){$yt_baseElement.showLoading();var me=this;var projectCode=$yt_common.GetQueryString("projectCode");var traineeId=$(".student-details-form .traineeId-hidden-input").val();var data=$(".yt-table-active").data('data');var costData="";var costDataArr=[];var costjson={trainingExpenseNegotiatedPrice:$yt_baseElement.rmoney($('.training-expense-negotiated-price-input').val()),traineeNegotiatedPrice:$yt_baseElement.rmoney($('.course-price').val()),quarterageNegotiatedPrice:$yt_baseElement.rmoney($('.quarterage-negotiated-price-input').val()),mealFeeNegotiatedPrice:$yt_baseElement.rmoney($('.meal-fee-negotiated-price-input').val()),incidental:$yt_baseElement.rmoney($('.incidental-input').val()),cash:$yt_baseElement.rmoney($('.real-money').text()),creditCard:$yt_baseElement.rmoney($('.card-money').text())};var costjsons={trainingExpenseNegotiatedPrice:'1',traineeNegotiatedPrice:'2',quarterageNegotiatedPrice:'3',mealFeeNegotiatedPrice:'4',incidental:'5',cash:'6',creditCard:'7'};for(i in costjson){if(costjson[i]!=data[i]){var arrCouncil={costType:costjsons[i],costOld:data[i],costNew:costjson[i]};costDataArr.push(arrCouncil)}}costDataArr=JSON.stringify(costDataArr);var json={traineeNegotiatedPriceCash:$yt_baseElement.rmoney($('.traineeNegotiatedPriceCash').val()),traineeNegotiatedPriceCreditcard:$yt_baseElement.rmoney($('.traineeNegotiatedPriceCreditcard').val()),trainingExpenseCash:$yt_baseElement.rmoney($('.trainingExpenseCash').val()),trainingExpenseCreditcard:$yt_baseElement.rmoney($('.trainingExpenseCreditcard').val()),quarterageCash:$yt_baseElement.rmoney($('.quarterageCash').val()),quarterageCreditcard:$yt_baseElement.rmoney($('.quarterageCreditcard').val()),mealFeeCash:$yt_baseElement.rmoney($('.mealFeeCash').val()),mealFeeCreditcard:$yt_baseElement.rmoney($('.mealFeeCreditcard').val()),otherchargesCash:$yt_baseElement.rmoney($('.otherchargesCash').val()),otherchargesCreditcard:$yt_baseElement.rmoney($('.otherchargesCreditcard').val())};var json2={traineeNegotiatedPriceCash:'2,1',traineeNegotiatedPriceCreditcard:'2,2',trainingExpenseCash:'1,1',trainingExpenseCreditcard:'1,2',quarterageCash:'3,1',quarterageCreditcard:'3,2',mealFeeCash:'4,1',mealFeeCreditcard:'4,2',otherchargesCash:'5,1',otherchargesCreditcard:'5,2'};var netData=[];var netDataJson='';for(k in json){me.costOldMoney[k]==undefined?me.costOldMoney[k]='':me.costOldMoney[k]=me.costOldMoney[k];if(json[k]!=me.costOldMoney[k]){netDataJson={costType:json2[k].split(',')[0],costDataType:json2[k].split(',')[1],costOld:me.costOldMoney[k],costNew:json[k]};netData.push(netDataJson)}}if(netData.length>0){netData=JSON.stringify(netData)}else{netData=''}$.ajax({url:$yt_option.base_path+"finance/settlement/addTraineeCost",type:"post",async:false,data:{projectCode:projectCode,traineeId:traineeId,traineeType:$('.project-student-tbody .yt-table-active').data('data').traineeType,costData:costDataArr,netData:netData},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("修改成功");$(".student-details-form").hide();projectDetails.getStudentCostsList();projectDetails.getCompanyList()})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt(data.message);$(".student-details-form").hide()})}},error:function(){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt('网络异常');$(".student-details-form").hide()})}});var roomNumber=data.roomNumber;var projectCode=$yt_common.GetQueryString("projectCode");var projectType=$yt_common.GetQueryString("projectType");var arrivalTime=$(".in-Date-hh").val();var departureTime=$(".out-Date-hh").val();var traineeName=data.realName;$.ajax({url:$yt_option.base_path+"finance/settlement/updateTraineeHotelDate",type:"post",async:false,data:{roomNumber:roomNumber,projectCode:projectCode,projectType:projectType,arrivalTime:arrivalTime,departureTime:departureTime,traineeName:traineeName},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt(data.message);$(".student-details-form").hide()})}},})},getIncomesList:function(){var selectParam=$('.project-income-study .selectParam').val();var projectCode=$yt_common.GetQueryString("projectCode");$('.project-in .project-student-page').pageInfo({async:true,pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"finance/settlement/getIncomeList",type:"post",data:{selectParam:selectParam,projectCode:projectCode},before:function(){$yt_baseElement.showLoading()},objName:'data',success:function(data){if(data.flag==0){$(".actual").text($yt_baseElement.fmMoney(data.data.amountReceivabletotal));$(".must").text($yt_baseElement.fmMoney(data.data.netReceiptsTotal));$('.project-income-student-tbody').empty();var htmlTbody=$('.project-income-student-tbody');var htmlTr='';$(htmlTbody).empty();if(data.data.rows.length>0){$('.project-student-page').show();$.each(data.data.rows,function(i,v){var invoiceNums='';var tuitions='';if(v.invoiceOrderList!=undefined){$.each(v.invoiceOrderList,function(j,k){if(j!=v.invoiceOrderList.length-1){invoiceNums+='<p style="border-bottom:1px solid #EDEBEC;height:16px;" class="invoiceNums">'+k.invoiceNum+'</p>';tuitions+='<p style="border-bottom:1px solid #EDEBEC;height:16px;" class="tuitions">'+$yt_baseElement.fmMoney(k.tuition)+'</p>'}else{invoiceNums+='<p class="invoiceNums">'+k.invoiceNum+'</p>';tuitions+='<p class="tuitions">'+$yt_baseElement.fmMoney(k.tuition)+'</p>'}})}htmlTr+='<tr><td>'+(i+1)+'</td><td data-train="'+v.traineeId+'"><input type="hidden" class="hid-trainId" value="'+v.traineeId+'" /><a style="color: #3c4687;" class="real-name-inf">'+v.realName+'</a></td><td style="text-align:left">'+v.groupOrgName+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.trainingExpenseNegotiatedPrice)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.traineeNegotiatedPrice)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.quarterageNegotiatedPrice)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.mealFeeNegotiatedPrice)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.incidental)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.smallPlan)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.cash)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.creditCard)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.wireTransfer)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.moneyTotal)+'</td><td style="padding:0px">'+invoiceNums+'</td><td style="padding:0px">'+tuitions+'</td></tr>'});htmlTbody.html(htmlTr);$('.invoiceNums').css('min-height',$('.tuitions').height()+'px');var lastNum=0;var allNum=0;$.each($('tbody.project-income-student-tbody tr'),function(i,n){if(lastNum==parseInt($(this).find('td').eq(8).text())){allNum=allNum+lastNum}else{allNum=parseInt($(this).find('td').eq(8).text())+lastNum+allNum;lastNum=parseInt($(this).find('td').eq(8).text())}})}else{$('.project-student-page').hide();htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="13" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getIncomeCostsList:function(){var selectParam=$('.selectParam').val();var projectCode=$yt_common.GetQueryString("projectCode");$('.project-income-page').pageInfo({async:true,pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"finance/settlement/getIncomeDetailsList",type:"post",data:{selectParam:selectParam,projectCode:projectCode},before:function(){$yt_baseElement.showLoading()},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.project-income-cost-tbody');var htmlTr='';$(htmlTbody).empty();if(data.data!=null){if(data.data.rows.length>0){$(".checkInDateCount").text(data.data.checkInDateCount);$(".reductionAfterCount").text(data.data.reductionAfterCount);$(".reliefDaysCount").text(data.data.reliefDaysCount);$(".reliefMoneyCount").text(data.data.reliefMoneyCount);$('.project-income-page').show();$.each(data.data.rows,function(i,v){if(v.groupNum==null){v.groupNum=""}if(v.userType==1){v.userTypeVal='工作人员'}else if(v.userType==2){v.userTypeVal='学员'}else{v.userTypeVal=''}if(v.reductionAfter==undefined||v.reductionAfter==''){v.reductionAfter=0}var reductionAfterDate=Number(v.checkInDate)-Number(v.reductionAfter);var reductionAfterMoney=(Number(v.rackRate)*Number(v.checkInDate))-(Number(v.negotiatedPrice)*Number(v.reductionAfter));htmlTr='<tr><td>'+(i+1)+'</td><td data-train="'+v.traineeId+'"><input type="hidden" class="hid-trainId" value="'+v.traineeId+'" /><a style="color: #3c4687;" class="real-name-inf">'+v.realName+'</a></td><td style="text-align:left">'+v.groupOrgName+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.rackRate)+'</td><td style="text-align:right">'+$yt_baseElement.fmMoney(v.negotiatedPrice)+'</td>'+'<td>'+v.checkInDate+'</td><td><input type="text" class="yt-input reductionAfter" style="width:70px" value="'+v.reductionAfter+'"/></td><td class="reductionAfterDate">'+reductionAfterDate+'</td><td class="reductionAfterMoney">'+$yt_baseElement.fmMoney(reductionAfterMoney)+'</td></tr>';htmlTr=$(htmlTr).data('data',v);htmlTbody.append(htmlTr)});$('.reductionAfter').off('blur').on('blur',function(){$(this).val($(this).val().replace(/[^\d]/g,''));var v=$(this).parents('tr').data('data');var value=$(this).val();var reductionAfterDate=Number(v.checkInDate)-Number(value);var reductionAfterMoney=$yt_baseElement.fmMoney((Number(v.rackRate)*Number(v.checkInDate))-(Number(v.negotiatedPrice)*Number(value)));$(this).parents('tr').find('.reductionAfterDate').text(reductionAfterDate);$(this).parents('tr').find('.reductionAfterMoney').text(reductionAfterMoney)})}else{$('.project-income-page').hide();htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="10" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}}else{$('.project-income-page').hide();htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="10" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getTotalList:function(){$yt_baseElement.showLoading();var projectCode=$yt_common.GetQueryString("projectCode");$.ajax({async:false,url:$yt_option.base_path+"finance/settlement/getDetailedReduction",type:"post",data:{projectCode:projectCode},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.project-total-cost-tbody');var htmlTr='';if(data.data!=null){htmlTbody.empty();htmlTr='<tr><td>1</td><td>培训费减免</td><td style="text-align:right;"><input class="yt-input" style="text-align:right;display:none;" value="'+$yt_baseElement.fmMoney(data.data.trainingExpenseReduction)+'"/><span>'+$yt_baseElement.fmMoney(data.data.trainingExpenseReduction)+'</span></td><td repair-acc="true"><span><img style="margin-right: 2px;" src="../../resources/images/icons/amend.png"></span></td></tr><tr><td>2</td><td>课程费减免</td><td style="text-align:right;"><input class="yt-input" style="text-align:right;display:none;" value="'+$yt_baseElement.fmMoney(data.data.traineeNegotiatedPriceReduction)+'"/><span>'+$yt_baseElement.fmMoney(data.data.traineeNegotiatedPriceReduction)+'</span></td><td repair-acc="true"><span><img style="margin-right: 2px;" src="../../resources/images/icons/amend.png"></span></td></tr><tr><td>3</td><td>住宿费减免</td><td style="text-align:right;"><input class="yt-input" style="text-align:right;display:none;" value="'+$yt_baseElement.fmMoney(data.data.quarterageReduction)+'"/><span>'+$yt_baseElement.fmMoney(data.data.quarterageReduction)+'</span></td><td repair-acc="true"><span><img style="margin-right: 2px;" src="../../resources/images/icons/amend.png"></span></td></tr><tr><td>4</td><td>餐费减免</td><td style="text-align:right;"><input class="yt-input" style="text-align:right;display:none;" value="'+$yt_baseElement.fmMoney(data.data.mealFeeReduction)+'"/><span>'+$yt_baseElement.fmMoney(data.data.mealFeeReduction)+'</span></td><td repair-acc="true"><span><img style="margin-right: 2px;" src="../../resources/images/icons/amend.png"></span></td></tr><tr><td>5</td><td>杂费减免</td><td style="text-align:right;"><input class="yt-input" style="text-align:right;display:none;" value="'+$yt_baseElement.fmMoney(data.data.otherChargesReduction)+'"/><span>'+$yt_baseElement.fmMoney(data.data.otherChargesReduction)+'</span></td><td repair-acc="true"><span><img style="margin-right: 2px;" src="../../resources/images/icons/amend.png"></span></td></tr>';htmlTbody.html(htmlTr);var totalMoney=data.data.trainingExpenseReduction+data.data.traineeNegotiatedPriceReduction+data.data.quarterageReduction+data.data.otherChargesReduction+data.data.mealFeeReduction;$(".total-money").text($yt_baseElement.fmMoney(totalMoney,2));}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},projectRevenueTraining:function(){$yt_baseElement.showLoading();var projectCode=$yt_common.GetQueryString("projectCode");$.ajax({async:true,url:$yt_option.base_path+"finance/settlement/getNoDetailedList",type:"post",data:{projectCode:projectCode},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.project-revenue-training-tbody');var htmlTr='';$(htmlTbody).empty();if(data.data.length>0){$.each(data.data,function(i,v){htmlTr+='<tr><td style="text-align:center;">'+(i+1)+'</td><td class="should" style="text-align:left;word-wrap:break-word;">'+v.groupName+'</td><td class="already" style="text-align:right;word-wrap:break-word;">'+v.amountReceivable+'</td><td class="account" style="text-align:right;word-wrap:break-word;">'+v.netReceipts+'</td></tr>'});htmlTbody.html(htmlTr)}else{htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="4" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getOtherIncomeList:function(){$(".group-list-title").show();$(".stu-list").show();$(".group-list-box").show();$(".group-list-box .list-thead").show();var projectCode=$yt_common.GetQueryString("projectCode");var selectParam=$('#keyword').val();$('.project-income-other-page').pageInfo({async:true,pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"finance/settlement/getNoDetailedPersonalList",type:"post",data:{selectParam:selectParam,projectCode:projectCode,breakfastForStart:"",breakfastForEnd:"",numberLunchStart:"",numberLunchEnd:"",numberDinnerStart:"",numberDinnerEnd:"",otherChargesStart:"",otherChargesEnd:""},before:function(){$yt_baseElement.showLoading()},objName:'data',success:function(data){if(data.flag==0){if(data.data.otherCostTotal==null){data.data.otherCostTotal=0};if(data.data.netReceiptsTotal==null){data.data.netReceiptsTotal=0};$(".other-receivables").text(data.data.otherCostTotal);$(".other-paid-in").text(data.data.netReceiptsTotal);$('.project-income-other-tbody').empty();var htmlTbody=$('.project-income-other-tbody');var htmlTrSelection='';$(htmlTbody).empty();if(data.data.rows.length>0){$.each(data.data.rows,function(i,v){htmlTrSelection+='<tr><td>'+(i+1)+'</td><td><a style="color: #3c4687;">'+v.realName+'</a></td><td style="text-align:left">'+v.groupOrgName+'</td><td style="text-align:right;">'+v.otherCost+'</td><td style="text-align:right;">'+v.netReceipts+'</td></tr>'});if(true){$(".income-hide").show();htmlTbody.html(htmlTrSelection)}else{$(".income-hide").hide()}}else{htmlTrSelection='<tr style="border:0px;background-color:#fff !important;" ><td colspan="5" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.append(htmlTrSelection)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}$(".income-search-btn").click(function(){projectDetails.getOtherIncomeList()});$('#keyword').val("")},isSelPageNum:true })},getExpenditureListInf:function(){var projectCode=$yt_common.GetQueryString("projectCode");$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"finance/settlement/getExpenditure",async:true,data:{projectCode:projectCode},objName:'data',success:function(data){if(data.flag==0){var expenseDetails=data.data.expenseDetails;var expenseClassDetails=data.data.expenseClassDetails;var otherCost=data.data.otherCost;var expenseDetailsTbody=$('.expenseDetails-tbody');var expenseDetailsTr='';var expenseClassDetailsTbody=$('.expenseClassDetails-tbody');var expenseClassDetailsTr='';var otherCostTbody=$('.otherCost-tbody');var otherCostTr='';var faresNum=0;var changeFeeRefundNum=0;var expenseMoneyNum=0;expenseDetailsTbody.empty();if(expenseDetails!=""){$.each(expenseDetails,function(i,v){expenseDetailsTr+='<tr><td teacherId="'+v.teacherId+'">'+(i+1)+'</td><td>'+v.teacherName+'</td><td>'+v.flighttrainNumber+'</td><td>'+v.placeDeparture+'</td><td>'+v.bourn+'</td><td>'+v.startEndTime+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.fares)+'</td><td style="text-align:left;">'+v.changeFeeRefundDetails+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.changeFeeRefund)+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.expenseMoney)+'</td></tr>';faresNum+=v.fares;changeFeeRefundNum+=v.changeFeeRefund;expenseMoneyNum+=v.expenseMoney})}else{expenseDetailsTbody.empty();expenseDetailsTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="10" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>'};expenseDetailsTr+='<tr><td>合计</td><td></td><td></td><td></td><td></td><td></td><td style="text-align:right;">'+$yt_baseElement.fmMoney(faresNum)+'</td><td></td><td style="text-align:right;">'+$yt_baseElement.fmMoney(changeFeeRefundNum)+'</td><td style="text-align:right;"><input class="expense-money-num" type="hidden" value="'+expenseMoneyNum+'" class="teacherId">'+$yt_baseElement.fmMoney(expenseMoneyNum)+'</td></tr>';expenseDetailsTbody.append(expenseDetailsTr);var afterTaxNum=0;var surrenderPersonalNum=0;var expenseMoneyNum=0;if(expenseClassDetails!=""){expenseClassDetailsTbody.empty();$.each(expenseClassDetails,function(i,v){i+=1;if(v.papersType==1){v.papersType="身份证"}else if(v.papersType==2){v.papersType="护照"}else if(v.papersType==3){v.papersType="军官证"}else{v.papersType="其他"}expenseClassDetailsTr+='<tr><td><input type="hidden" value="'+v.teacherId+'" class="teacherId">'+i+'</td><td>'+v.teacherName+'</td>'+'<td>'+v.papersType+'</td><td>'+v.papersNumber+'</td><td>'+v.registeredBank+'</td><td>'+v.account+'</td><td>'+v.courseDate+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.afterTax)+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.surrenderPersonal)+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(v.expenseMoney)+'</td></tr>';afterTaxNum+=v.afterTax;surrenderPersonalNum+=v.surrenderPersonal;expenseMoneyNum+=v.expenseMoney})}else{expenseClassDetailsTbody.empty();expenseClassDetailsTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="10" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>'};expenseClassDetailsTr+='<tr><td>合计</td><td></td><td></td><td></td><td></td><td></td><td></td><td style="text-align:right;">'+$yt_baseElement.fmMoney(afterTaxNum)+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(surrenderPersonalNum)+'</td><td style="text-align:right;"><input class="out-expense-money-num" type="hidden" value="'+expenseMoneyNum+'" class="teacherId">'+$yt_baseElement.fmMoney(expenseMoneyNum)+'</td></tr>';expenseClassDetailsTbody.html(expenseClassDetailsTr);var spendMoneyNum=0;$('.otherCost-tbody tr td input').addClass('yt-input input-tr-repair');if(otherCost.length!=0){$.each(otherCost,function(i,v){if(v.costCode=="fieldTeachingFee"){$('.otherCost-tbody tr').eq(0).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(0).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(0).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(0).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(0).find('td').eq(3).find('input').val(v.details)}else if(v.costCode=="trainingMaterialsFee"){$('.otherCost-tbody tr').eq(1).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(1).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(1).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(1).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(1).find('td').eq(3).find('input').val(v.details)}else if(v.costCode=="trafficFee"){$('.otherCost-tbody tr').eq(2).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(2).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(2).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(2).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(2).find('td').eq(3).find('input').val(v.details)}else if(v.costCode=="accommodationFee"){$('.otherCost-tbody tr').eq(3).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(3).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(3).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(3).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(3).find('td').eq(3).find('input').val($yt_baseElement.fmMoney(v.details))}else if(v.costCode=="foodFee"){$('.otherCost-tbody tr').eq(4).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(4).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(4).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(4).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(4).find('td').eq(3).find('input').val(v.details)}else{$('.otherCost-tbody tr').eq(5).attr('costCode',v.costCode);$('.otherCost-tbody tr').eq(5).find('td').eq(2).find('span').text($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(5).find('td').eq(3).find('span').text(v.details);$('.otherCost-tbody tr').eq(5).find('td').eq(2).find('input').val($yt_baseElement.fmMoney(v.spendMoney));$('.otherCost-tbody tr').eq(5).find('td').eq(3).find('input').val(v.details)}spendMoneyNum+=v.spendMoney;$('.otherCost-tbody tr').eq(6).find('td').eq(1).text($yt_baseElement.fmMoney(spendMoneyNum))})}$("input.spendMoney").blur(function(){var firstSpendMoney=0;$("input.spendMoney").each(function(i,n){firstSpendMoney=firstSpendMoney+parseFloat($(n).val())});$(".all-spend-money-total").val(firstSpendMoney);$('.spendMoneyTotal').text($yt_baseElement.fmMoney(firstSpendMoney))});$yt_baseElement.hideLoading();$(".teach-total-money").text($yt_baseElement.fmMoney($yt_baseElement.rmoney($(".expense-money-num").val())+$yt_baseElement.rmoney($(".out-expense-money-num").val())+$yt_baseElement.rmoney($(".spendMoneyTotal").text())))}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})};$(".otherCost-tbody").find(".money-pay").blur(function(){var totalMoney=0;$.each($(".otherCost-tbody").find(".money-pay"),function(m,n){totalMoney+=$yt_baseElement.rmoney($(n).val())});$('.spendMoneyTotal').text($yt_baseElement.fmMoney(totalMoney));$(".teach-total-money").text($yt_baseElement.fmMoney($yt_baseElement.rmoney($(".expense-money-num").val())+$yt_baseElement.rmoney($(".out-expense-money-num").val())+$yt_baseElement.rmoney(totalMoney)));$(this).val($yt_baseElement.fmMoney($(this).val()))})}})},getOutFile:function(){var projectCode=$yt_common.GetQueryString("projectCode");var projectName=$(".page-title .project-name").text();var selectParam=$(".project-income-div .selectParam").text();$.ajaxDownloadFile({url:$yt_option.base_path+"finance/settlement/exportIncomeList",data:{projectCode:projectCode,projectName:projectName,selectParam:selectParam}})},updateIncome:function(){var traineeJson=[];$.each($('.project-income-cost-tbody').find('tr'),function(i,n){var data=$(n).data('data');var json={userType:data.userType,traineeId:data.traineeId,reductionAfter:$(n).find('.reductionAfter').val()};traineeJson.push(json)});traineeJson=JSON.stringify(traineeJson);$.ajax({type:"post",url:$yt_option.base_path+"finance/settlement/updateIncomeDetailsList",async:false,beforeSend:function(){$yt_baseElement.showLoading()},data:{projectCode:$yt_common.GetQueryString("projectCode"),traineeJson:traineeJson},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt('提交成功')})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt('提交失败')})}},error:function(){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt('网络异常，提交失败')})}});projectDetails.getIncomeCostsList()}};$(function(){projectDetails.init()});
var projectList={init:function(){projectList.getPlanListInfo();$('.search-btn-slect').on('click','.add-class',function(){$('#alert-type').val("开班式");$('.out-order').hide();$('#types').val(1);projectList.clearAlert();$('.offer-course-time').text("开班时间：");$(".main-title-span").text("新增开班式");$(".cal-title-p").text("开班式");$(".order-title-p").text("开班式会序");$(".file-title-p").text("开班式讲稿");projectList.addShowAlert()});$('.search-btn-slect').on('click','.winding-up',function(){$('#alert-type').val("结业式");$('.out-order').hide();$('#types').val(2);projectList.clearAlert();$('.offer-course-time').text("结业时间");$(".main-title-span").text("新增结业式");$(".cal-title-p").text("结业式");$(".order-title-p").text("结业式会序");$(".file-title-p").text("结业式讲稿");projectList.addShowAlert()});$('select').niceSelect();$(".startTime").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});var classList=projectList.getClassLis();var userRealName=projectList.userInfo();if(classList!=null){var projectUserName;$.each(classList.data,function(i,n){projectUserName=n.projectUserName;if(projectUserName.indexOf(userRealName)!=-1){$(".projectName").append($('<option value="'+n.projectCode+'">'+n.className+'</option>').data("classData",n))}});$(".projectName").niceSelect()};$(".projectName").change(function(){var classData=$(this).find("option:selected").data("classData");$('#project-user-name-edit').text(classData.projectUserName);$('#trainee-count-edit').text(classData.traineeCount)});$(".projectName").niceSelect();projectList.reorder();projectList.addAlineDelTabRwo();projectList.delFileTr();$(".operate-file-box").off().undelegate().delegate("input","change",function(){var me=$(this);var addFile=$(this).attr("id");var fileName=$(this).val().split('\\');var fm=fileName[fileName.length-1];var url=$yt_option.acl_path+"api/tAscPortraitInfo/addFile?modelCode=caFile";$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:addFile,success:function(data,textStatus){var resultData=$.parseJSON(data);var fileId=resultData.obj.pkId;if(resultData.success==0){$yt_alert_Model.prompt("附件上传成功");fileList=[resultData.obj.naming,fileId];var num=$(".add-lecture-tb").children("tr").length+1;projectList.addLineLecture(resultData.obj.naming,fileId,num)}else{$yt_alert_Model.prompt("附件上传失败")}$("#"+addFile).val("")},error:function(data,status,e){$yt_alert_Model.prompt("附件上传失败!!!!");$("#"+addFile).val("")}})});$('.down-files tbody').on('click',".down-file",function(){var filePkId=$(this).parent().parent().find('.file-span-id').val();var fileURL=$(this).parent().parent().find('.fileURL').val();$.ajaxDownloadFile({url:fileURL})});$('.operate-file-box').on('click','.down-modle-file',function(){projectList.downloadOrder()});$('.add-shuttle-box .submit-btn').off().on('click',function(){var processInstanceId=$('#processInstanceId').val();$(".add-lecture-tb").empty();projectList.addClassInfo(2)});$('.yt-eidt-model-bottom').off().on('click','#save',function(){$(".add-lecture-tb").empty();projectList.addClassInfo(1)});$('.list-table .yt-tbody').on('click','.class-name',function(){projectList.clearAlert();var states=$(this).parent().parent().find('.state').text();var pkId=$(this).parent().parent().find('.pkId').text();var types=$(this).parent().parent().find('.types').text();$('#types').val(types);$('#pkId').val(pkId);if(types==1){projectList.clearAlert();$(".main-title-span").text("新增开班式");$(".cal-title-p").text("开班式");$(".order-title-p").text("开班式会序");$(".file-title-p").text("开班式讲稿")};if(types==2){projectList.clearAlert();$(".main-title-span").text("新增结业式");$(".cal-title-p").text("结业式");$(".order-title-p").text("结业式会序");$(".file-title-p").text("结业式讲稿")}if(states=="未通过"||states=="草稿"){projectList.getOneListInfo(pkId,types);projectList.addShowAlert()};if(states=="已完成"||states=="审批中"){projectList.getOnlyLookInfo(pkId,types);projectList.onlyLookShowAlert()}});projectList.getNextOperatePerson();$("#nextPeople").niceSelect();$('.order-div-box').on('click','.add-one-line',function(){var len=$(".add-order-tb tbody").children().length;if(len!=0){var details=$(".add-order-tb tbody tr:last").find('.details').val();var dateLength=$(".add-order-tb tbody tr:last").find('.dateLength').val();if(details==""||dateLength==""){$yt_valid.validForm($(".valid-tab"))}else{projectList.addLineInfo()}}else{projectList.addLineInfo()}$(".add-order-tb").off().on("click",".vaild-input",function(){$yt_valid.validForm($(".valid-tab"))});projectList.addAlineDelTabRwo()});$('.key-word').off().on('click','.search-btn',function(){projectList.getPlanListInfo();$('#keyword').val("")})},clearAlert:function(){$('#processInstanceId').val("");$('#businessCode').val("");$('#project-code-edit').setSelectVal("");$('#project-user-name-edit').val("");$('#txtDate').val("");$('#trainee-count-edit').val("");$(".add-order-tb tbody").html("");$(".add-lecture-tb tbody").html("");$(".only-look-order-tb tbody").html("");$(".only-look-lecture-tb tbody").html("")},addClassInfo:function(dataStates){$yt_baseElement.showLoading();var operateType;var operateTypeText;var pkId="";var processInstanceId=$('#processInstanceId').val();var businessCode="";var identifiers=$('#types').val();if(identifiers==1){operateType=1;businessCode="openHonorsStart"}if(identifiers==2){operateType=2;businessCode="openHonorsEnd"}operateTypeText=$('.main-title-span').text();if(operateTypeText=="新增开班式"){operateType=1;businessCode="openHonorsStart"}if(operateTypeText=="新增结业式"){operateType=2;businessCode="openHonorsEnd"}var projectCode=$('#project-code-edit').val();var startTime=$('.startTime').val();var orderListArr=[];var details="";var dateLength="";var orderBy="";$(".add-order-tb tbody tr").each(function(i,n){orderBy=i+1;details=$(n).find('.details').val();dateLength=$(n).find('.dateLength').val();var orderList={details:details,dateLength:dateLength,orderBy:orderBy};orderListArr.push(orderList)});var orderListJson=JSON.stringify(orderListArr);var fileListArr=[];var fileId="";var fileName="";var types="";var fileListArr=[];$(".add-lecture-tb tbody tr").each(function(i,n){fileId=$(n).find('.file-span-id').val();fileName=$(n).find('.fileName').text();var fileList={fileId:fileId,fileName:fileName,types:2};fileListArr.push(fileList)});var fileListJson=JSON.stringify(fileListArr);var opintion="";var dealingWithPeople=$('#nextPeople').val();debugger;$.ajax({type:"post",url:$yt_option.base_path+"class/openHonors/addOrUpdateBean",data:{pkId:pkId,types:operateType,projectCode:projectCode,startTime:startTime,orderList:orderListJson,fileList:fileListJson,dataStates:dataStates,businessCode:businessCode,opintion:opintion,dealingWithPeople:dealingWithPeople,nextCode:"submited",processInstanceId:processInstanceId},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){$(".yt-edit-alert,#heard-nav-bak").hide()})}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("添加失败");$(".yt-edit-alert,#heard-nav-bak").hide()})}projectList.init()}})},getNextOperatePerson:function(){var getAllNextPeople=projectList.getworkFlowOperate();var data=getAllNextPeople.data[0]['{"taskId":"activitiStartTask","nextCode":"submited","parameters":"","nextName":"提交【NEXT_CODE】"}'];if(data!=null){$.each(data,function(i,n){$("#nextPeople").append('<option value="'+n.userCode+'">'+n.userName+'</option>')})}},getworkFlowOperate:function(){var businessCode;var types=$('#types').val();if(businessCode=="新增开班式"){businessCode="openHonorsStart"};if(businessCode=="新增结业式"){businessCode="openHonorsEnd"}var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/workFlowOperate/getSubmitPageData",data:{businessCode:"openHonorsStart"},async:false,success:function(data){list=data||[]}});return list},downloadOrder:function(){var typeName=$('#alert-type').val();var fileName="";var type;if(typeName=="开班式"){type=1;fileName="开班式模板"};if(typeName=="结业式"){type=2;fileName="结业式模板"}$.ajaxDownloadFile({url:$yt_option.base_path+"class/openHonors/downloadOrder",data:{types:type}})},delFileTr:function(){$(".add-lecture-tb").on('click',".entry-del-icon",function(){var tr=$(this).parent().parent();var fileLineNum=$(this).parent().parent().find("span.fileLineNum").text();$("#pop-modle-alert").css("z-index",103);$yt_alert_Model.alertOne({haveAlertIcon:false,closeIconUrl:"",leftBtnName:"确定",rightBtnName:"取消",alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove();$(".add-lecture-tb").find("span.fileLineNum").each(function(){if($(this).text()>fileLineNum){$(this).text($(this).text()-1)}});$("#pop-modle-alert").show().css("z-index",100)},cancelFunction:function(){$("#pop-modle-alert").show().css("z-index",100)}})})},addLineLecture:function(fileName,fileId,num){var lineTrHtml='<tr class="file-tr-border-style"><input type="hidden" class="fileURL" value="http://10.2.1.249:7216/acl/api/tAscPortraitInfo/download?isDownload=true&pkId='+fileId+'"><td class="lecture-tds">【<span class="fileLineNum">'+num+'</span>】</td><td class="fileName"><input type="hidden" class="file-span-id" value="'+fileId+'" >'+fileName+'</td><td style="display:none;" class="lecture-tds"><img class="ioc-img" src="../../resources/images/open/yulan.png" /></td><td style="width: 40px; display:none;">预览</td><td class="lecture-tds" style="text-align:center;width:70px"><span style="cursor: pointer;" class="down-file"><img class="ioc-img" src="../../resources/images/open/xiazai2.png" />下载</span></td><td class="lecture-tds" style="text-align:center;width:170px"><span style="cursor: pointer;" class="entry-del-icon"><img class="ioc-img" src="../../resources/images/open/delete.png" />删除</span></td></tr>';$(".add-lecture-tb tbody").before(lineTrHtml)},getOutOpenHonors:function(){var pkId=$('#pkId').val();var type=$('#types').val();$.ajaxDownloadFile({url:$yt_option.base_path+"class/openHonors/exportOrder",data:{pkId:pkId,types:type}})},addAlineDelTabRwo:function(){$(".add-order-tb").on('click',".entry-del-icon",function(){var tr=$(this).parent().parent();$("#pop-modle-alert").css("z-index",103);$yt_alert_Model.alertOne({haveAlertIcon:false,closeIconUrl:"",leftBtnName:"确定",rightBtnName:"取消",alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove();$("#pop-modle-alert").show().css("z-index",100);},cancelFunction:function(){$("#pop-modle-alert").show().css("z-index",100);}})})},reorder:function(){$('.add-order-tb').tableDnD({onDragClass:"ondragclass",onDrop:function(table,row){var rows=table.tBodies[0].rows;var debugStr="拖拽结束后的行："+row.id;for(var i=0;i<rows.length;i+=1){debugStr+=rows[i].id+" "}},onDragStart:function(table,row){}})},addLineInfo:function(){var num=$(".add-order-tb tbody").children().length+1;var lineTrHtml='<tr class="add-textList tr-border-style" style="cursor: pointer;"><td class="order-by" style="cursor: pointer;">'+num+'</td><td class="td-input" style="cursor: pointer;"><input style="width: 600px; float: left;" type="text" class="yt-input vaild-input details" validform="{isNull:true,blurFlag:true,size:20,msg:\'请输入内容,不要超过20个字\'}"/><span class="valid-font z-style"></span></td><td  style="position: relative;cursor: pointer;"><input type="text" class="yt-input vaild-input dateLength td-input-time" validform="{isNull:true,blurFlag:true,size:10,msg:\'请输入会序时长\'}"/> <span class="valid-font z-style"></span><p class="time-txt" style="float: left;margin: 4px;">分钟</p></td><td class="td-img" style="cursor: pointer;"><img class="orderBy-dele-img img-size" src="../../resources/images/open/tiaoxu.png"/></td><td class="handle-td td-img" style="cursor: pointer;"><span class="entry-del-icon" onclick=""><img class="orderBy-dele-img img-size" src="../../resources/images/open/delete.png"/></span></td></tr>';$(".add-order-tb tbody").append(lineTrHtml);projectList.reorder()},getClassLis:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/getClasslist",data:{types:'4'},async:false,success:function(data){list=data||[]}});return list},userInfo:function(){var userRealName="";$.ajax({async:false,type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){userRealName=data.data.userRealName}});return userRealName},addShowAlert:function(){$(".add-shuttle-box").show();$yt_alert_Model.getDivPosition($(".add-shuttle-box"));$yt_model_drag.modelDragEvent($(".add-shuttle-box .yt-edit-alert-title"));$('.add-shuttle-box .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},onlyLookShowAlert:function(){$(".only-look").show();$yt_alert_Model.getDivPosition($(".only-look"));$yt_model_drag.modelDragEvent($(".only-look .yt-edit-alert-title"));$('.only-look .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},getPlanListInfo:function(){$yt_baseElement.showLoading();var queryParams=$('#keyword').val();$('.page-info').pageInfo({pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+" class/openHonors/lookForAll",type:"post",data:{searchParameters:queryParams},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.open-class-tbody');var htmlTr='';var num=1;var xuhao=1;var states="";var type="";if(data.data.rows.length>0){$.each(data.data.rows,function(i,v){xuhao=i+1;if(v.types==1){type="开班式"}if(v.types==2){type="结业式"}if(v.states==1){states="未通过"}if(v.states==2){states="已通过"}if(v.states==3){states="草稿"}htmlTr+='<tr class="td-list"><td class="pkId" style="display:none;">'+v.pkId+'</td><td class="types" style="display:none;">'+v.types+'</td><td style="text-align: center;">'+xuhao+'</td><td><a class="class-name">'+v.className+'</a></td><td style="text-align: center;">'+type+'</td><td class="userName">'+v.userName+'</td><td style="text-align: center;">'+v.startTimeString+'</td><td style="text-align: center;">'+v.createTimeString+'</td><td style="text-align: center;" class="state">'+v.states+'</td></tr>'})}else{htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="7" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>'}htmlTbody.html(htmlTr);$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},getOneListInfo:function(pkId,types){$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"class/openHonors/getBeanById",async:false,data:{pkId:pkId,types:types},objName:'data',success:function(data){if(data.flag==0){$('#project-code-edit').setSelectVal(data.data.projectCode);$('#project-user-name-edit').text(data.data.projectUserName);$('.star-date-input').val(data.data.startTime);$('#trainee-count-edit').text(data.data.traineeCount);$('#processInstanceId').val(data.data.processInstanceId);$('#businessCode').val(data.data.businessCode);$("add-order-tb tbody").empty();var orderList=data.data.orderList;$(".add-order-tb tbody").html("");var orderListObj=$.parseJSON(orderList);$.each(orderListObj,function(i,v){var num=$(".add-order-tb tbody tr").length+1;var lineTrHtml='<tr class="add-textList"><td class="order-by"><input type="hidden" class="orderBy" value="'+v.orderBy+'"/>'+num+'</td><td class="td-input"><input style="width: 600px; float: left;" type="text" class="yt-input details" value="'+v.details+'" validform="{isNull:true,size:20,msg:\'请输入内容,不要超过20个字\'}"/><span class="valid-font"></span></td><td  style="position: relative;"><input type="text" class="yt-input dateLength td-input-time" value="'+v.dateLength+'" validform="{isNull:true,size:10,msg:\'请输入会序时长\'}"/> <span class="valid-font"></span><p class="time-txt" style="float: left;margin: 4px;">分钟</p></td><td class="td-img"><img class="orderBy-dele-img img-size" src="../../resources/images/open/tiaoxu.png"/></td><td class="handle-td td-img"><span class="entry-del-icon" onclick=""><img class="orderBy-dele-img img-size" src="../../resources/images/open/delete.png"/></span></td></tr>';$(".add-order-tb tbody").append(lineTrHtml)});var fileList=data.data.fileList;var fileListObj=$.parseJSON(fileList);$(".add-lecture-tb").html("");$.each(fileListObj,function(i,v){var num=$(".add-lecture-tb tbody tr").length+1;var lineTrHtml='<tr class="tr-border-style"><input type="hidden" class="fileURL" value="http://10.2.1.249:7216/acl/api/tAscPortraitInfo/download?isDownload=true&pkId='+v.fileId+'"><td class="lecture-tds">【<span class="fileLineNum">'+num+'</span>】</td><td class="fileName"><input type="hidden" class="file-span-id" value="'+v.fileId+'" >'+v.fileName+'</td><td style="display:none;" class="lecture-tds"><img class="ioc-img" src="../../resources/images/open/yulan.png" /></td><td style="width: 40px; display:none;">预览</td><td class="lecture-tds" style="text-align:center;width:70px"><span style="cursor: pointer;" class="down-file"><img class="ioc-img" src="../../resources/images/open/xiazai2.png" />下载</span></td><td class="lecture-tds" style="text-align:center;width:170px"><span style="cursor: pointer;" class="entry-del-icon"><img class="ioc-img" src="../../resources/images/open/delete.png" />删除</span></td></tr>';$(".add-lecture-tb").append(lineTrHtml)});$(".projectName").niceSelect();$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})},getOnlyLookInfo:function(pkId,types){$yt_baseElement.showLoading();$.ajax({type:"post",url:$yt_option.base_path+"class/openHonors/getBeanById",async:false,data:{pkId:pkId,types:types},objName:'data',success:function(data){if(data.flag==0){$('#project-name-info').text(data.data.projectName);$('#project-user-name-info').text(data.data.projectUserName);$('#start-time-info').text(data.data.startTime);$('#trainee-count-info').text(data.data.traineeCount);$('#create-time-string-info').text(data.data.createTimeString);$('#create-user-info').text(data.data.createUserName);var orderList=data.data.orderList;var orderListObj=$.parseJSON(orderList);$.each(orderListObj,function(i,v){i=i+1;var lineTrHtml='<tr class="add-textList tr-border-style"><td class="order-by"> <input type="hidden" class="orderBy" value="'+v.orderBy+'"/>'+i+'</td><td class="td-input details">'+v.details+'</td><td class="dateLength" style="padding-right:10px;"><span style="margin-right:5px">'+v.dateLength+'</span>分钟</td></tr>';$(".only-look-order-tb tbody").append(lineTrHtml)});var fileList=data.data.fileList;var fileListObj=$.parseJSON(fileList);$.each(fileListObj,function(i,v){i=i+1;var lineTrHtml='<tr class="file-tr-border-style"><input type="hidden" class="fileURL" value="http://10.2.1.249:7216/acl/api/tAscPortraitInfo/download?isDownload=true&pkId='+v.fileId+'"><td class="lecture-tds">【<span class="fileLineNum">'+i+'</span>】</td><td class="fileName"><input type="hidden" class="file-span-id" value="'+v.fileId+'" >'+v.fileName+'</td><td style="display:none;" class="lecture-tds"><img class="ioc-img" src="../../resources/images/open/yulan.png" /></td><td style="width: 40px;display:none;">预览</td><td class="lecture-tds" style="text-align:center;width:70px"><span style="cursor: pointer;" class="down-file"><img class="ioc-img" src="../../resources/images/open/xiazai2.png" />下载</span></td></tr>';$(".only-look-lecture-tb").append(lineTrHtml)});$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})}};$(function(){projectList.init()});
var loanApply={riskExcMark:"../../../../../resources-sasac/images/common/war-red.png",riskWarImg:"../../../../../resources-sasac/images/common/risk-war.png",riskViaImg:"../../../../../resources-sasac/images/common/risk-via.png",loanId:"",loanDataObj:"",init:function(){$('#flowApproveDiv').html(sysCommon.createFlowApproveMode());var requerParameter=$yt_common.GetRequest();loanApply.loanId=requerParameter.loanId;loanApply.loanMoneyEvent();loanApply.funOperationEvent(loanApply.eaa);$("#loanApply").css("min-height",$(window).height()-32);loanApply.events();loanApply.showReturnLoanModel();loanApply.fmMonList();loanApply.getLoanInfoDetail()},fmMoney:function(str){return $yt_baseElement.fmMoney(str||'0')},rmoney:function(str){return $yt_baseElement.rmoney(str||'0')},fmMonList:function(){$(".refund-tab-inp").attr("placeholder","0.00");var moneyInpArray=$(".refund-tab-inp");for(j=0;j<moneyInpArray.length;j+=1){if(moneyInpArray.eq(j).val()!=''){moneyInpArray.eq(j).val($yt_baseElement.fmMoney(moneyInpArray.eq(j).val()))}};var moneyTextArray=$(".moneyText");for(h=0;h<moneyTextArray.length;h+=1){if(moneyTextArray.eq(h).text()!=''){moneyTextArray.eq(h).text($yt_baseElement.fmMoney(moneyTextArray.eq(h).text()))}else{moneyTextArray.eq(h).text($yt_baseElement.fmMoney(0))}}},events:function(){$('.refund-tab-inp').on('focus',function(){var ts=$(this);if(ts.val()!=""){ts.val($yt_baseElement.rmoney(ts.val()))}});$('.refund-tab-inp').on('blur',function(){var ts=$(this);if(ts.val()!=''){ts.val($yt_baseElement.fmMoney(ts.val()))}});$("#printingLoanBtn").click(function(){var pageUrl="view/system-sasac/expensesReim/module/print/printLoanApply.html?loanId="+loanApply.loanId;$yt_baseElement.openNewPage(2,pageUrl)});$("#printingLoanDetailsBtn").on("click",function(){var pageUrl="view/system-sasac/expensesReim/module/print/printLoanApplyDetails.html?loanId="+loanApply.loanId;$yt_baseElement.openNewPage(2,pageUrl)});$('.refund-tab-inp').on('keyup',function(){var ts=$(this);if(ts.val()!=''){ts.val(ts.val().replace(/[^\d.]/g,''))}});$('.refund-tab-inp').blur(function(){loanApply.refundTotal()});$('.yt-table tbody').on('click','tr',function(){var ts=$(this);var trs=ts.siblings();trs.removeClass('yt-table-active');ts.addClass('yt-table-active')});$('table.payee-personal').on('click','.to-data',function(){var tr=$(this).parents('tr');$('#perPayeeName').text(tr.attr('payeename')||'--');$('#perPersonalTotal').text(tr.attr('personalTotal')||'0.00');var choiceLoan=tr.attr('choiceLoan');if(choiceLoan&&choiceLoan!='请选择'){$('.personal-payment .display-loan').show();$('#perChoiceLoan').text(tr.attr('choiceLoan')||'--');$('.per-arrears-money').text(tr.attr('arrearsmoney')||'0.00');$('.per-reverse-money').text(tr.attr('thereversemoney')||'0.00')}else{$('.personal-payment .display-loan').hide();$('#perChoiceLoan').text('');$('.per-arrears-money').text('0.00');$('.per-reverse-money').text('0.00')}$('#perWiteOffPersonal').text(tr.find('td').eq(2).text()||'无');if(tr.attr('witeOffPersonal')){$('.personal-payment .display-loan').show()}else{$('.personal-payment .display-loan').hide()}$('.per-writeoff-money').text(tr.attr('personalWriteoff')||'0.00');$('#perCash').text(tr.attr('cash')||'0.00');$('#perOfficialCard').text(tr.attr('officialCard')||'0.00');$('#perTransferAccounts').text(tr.attr('transferAccounts')||'0.00');$('#perIdCarkno').text(tr.attr('idCarkno')||'--');$('#perPerank').text(tr.attr('personalUnit')||'--');$('#perPayeeBank').text(tr.attr('payeeBank')||'--');$('#perBankName').text(tr.attr('bankName')||'--');$('#perPhoneNum').text(tr.attr('phoneNum')||'--');$('#perOffOpenBank').text(tr.attr('offOpenBank')||'--');$('#perOffAccounts').text(tr.attr('offAccounts')||'--');var payeeRadio=tr.attr('payeeRadio');$('#payeeRadio').text(payeeRadio==1?'有':'无');$('#perSpecial').text(tr.attr('personalSpecial')||'无');$('#personalPayment').show();$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition($('#personalPayment'));$('#pop-modle-alert').show();$('#personalPayment').show()});$('#personalPayment .model-bottom-btn .yt-cancel-btn').on('click',function(){$yt_baseElement.hideMongoliaLayer();$('#pop-modle-alert').hide();$('#personalPayment').hide();$('#perPayeeName').text('--');$('#perPersonalTotal').text('0.00');$('#perWiteOffPersonal').text('--');$('.per-writeoff-money').text('0.00');$('#perCash').text('0.00');$('#perOfficialCard').text('0.00');$('#perTransferAccounts').text('0.00');$('#perIdCarkno').text('--');$('#perPerank').text('--');$('#perPayeeBank').text('--');$('#perBankName').text('--');$('#perPhoneNum').text('--');$('#payeeRadio').text('--');$('#perSpecial').text('无')});$('#personalPayment .closed-span').on('click',function(){$yt_baseElement.hideMongoliaLayer();$('#pop-modle-alert').hide();$('#personalPayment').hide();$('#perPayeeName').text('--');$('#perPersonalTotal').text('0.00');$('#perWiteOffPersonal').text('--');$('.per-writeoff-money').text('0.00');$('#perCash').text('0.00');$('#perOfficialCard').text('0.00');$('#perTransferAccounts').text('0.00');$('#perIdCarkno').text('--');$('#perPerank').text('--');$('#perPayeeBank').text('--');$('#perBankName').text('--');$('#perPhoneNum').text('--');$('#payeeRadio').text('--');$('#perSpecial').text('无')})},getLoanInfoDetail:function(){$.ajax({type:"post",url:"sz/loanApp/getLoanAppInfoDetailByLoanAppId",async:false,data:{loanAppId:loanApply.loanId},success:function(data){if(data.flag==0){var dataObj=data.data;loanApply.loanDataObj=dataObj;if(dataObj&&dataObj!=""&&dataObj!=undefined){$("#formNum").text(dataObj.loanAppNum);$("#applyDate").text(dataObj.applicantTime);$("#busiUsers").text(dataObj.applicantUserName);$("#deptName").text(dataObj.applicantUserDeptName);$("#jobName").text(dataObj.applicantUserPositionName==""?"--":dataObj.applicantUserPositionName);$("#telPhone").text(dataObj.applicantUserPhone==""?"--":dataObj.applicantUserPhone);$("#loanAppName").text(dataObj.loanAppName);$("#lonMon").text($yt_baseElement.fmMoney(dataObj.loanAmount));$("#moneyUpper").text(arabiaToChinese(dataObj.loanAmount+''));$("#loanTerm").text(dataObj.loanTerm);$("#expectRepaymentTime").text(dataObj.expectRepaymentTime||'--');var paymentMethod="";if(dataObj.paymentMethod=="1"){paymentMethod="现金"}else if(dataObj.paymentMethod=="2"){paymentMethod="支票"}$("#paymentMethod").text(paymentMethod);if(dataObj.isSettleInfo){$("#noCloseOut").text(dataObj.isSettleInfo.noCloseOut);if(data.data.rows.length>0){var datas=data.data.rows;var htmlSpan="";$.each(datas,function(i,n){if(datas.length-1==i){htmlSpan+='<a class="yt-link to-detail" loanAppId="'+n.loanAppId+'">'+n.loanAppNumStr+'</a>'}else{htmlSpan+='<a class="yt-link to-detail" loanAppId="'+n.loanAppId+'">'+n.loanAppNumStr+'</a>,'}});$("#loanAppNumStr").html(htmlSpan);loanApply.toDetails()}else{$("#loanAppNumStr").text('--')}}if(dataObj.amountRecord){var money=dataObj.amountRecord.loanAmount;var frozenLoanAmount=dataObj.amountRecord.blockingAmount;var usedAmount=dataObj.amountRecord.usedAmount;var allowUseAmount=dataObj.amountRecord.allowUseAmount;$("#loanSumAmount").text(money==""?"0.00":($yt_baseElement.fmMoney(money)));$("#frozenLoanAmount").text(frozenLoanAmount==""?"0.00":($yt_baseElement.fmMoney(frozenLoanAmount)));$("#haveBeenLoanAmount").text(usedAmount==""?"0.00":($yt_baseElement.fmMoney(usedAmount)));$("#loanBillAB").text(allowUseAmount==""?"0.00":($yt_baseElement.fmMoney(allowUseAmount)))}$(".paymentHistory tbody").empty();if(dataObj.refundList&&dataObj.refundList.length>0){var trStr="";$.each(dataObj.refundList,function(i,n){trStr=$('<tr><td style="text-align: center !important;">'+n.refundTime+'</td><td style="padding-right: 5px;"style="text-align: right;"><div class="moneyText">'+(n.refundAmount==""?"0.00":($yt_baseElement.fmMoney(n.refundAmount)))+'</div></td><td style="padding-right: 5px;"><div class="moneyText">'+(n.chargeAgainst==""?"0.00":($yt_baseElement.fmMoney(n.chargeAgainst)))+'</div></td><td style="padding-right: 5px;"><div class="moneyText">'+(n.cash==""?"0.00":($yt_baseElement.fmMoney(n.cash)))+'</div></td><td style="padding-right: 5px;"><div class="moneyText">'+(n.cheque==""?"0.00":($yt_baseElement.fmMoney(n.cheque)))+'</div></td><td style="padding-right: 5px;"><div class="moneyText">'+(n.transfer==""?"0.00":($yt_baseElement.fmMoney(n.transfer)))+'</div></td></tr>');trStr.data("refundInfo",n);$(".paymentHistory tbody").append(trStr)})}loanApply.showCostDetail(dataObj)}sysCommon.getApproveFlowData("SZ_LOAN_APP",dataObj.processInstanceId)}else{$yt_alert_Model.prompt(data.message,2000)}}})},refundTotal:function(){var body=$('.amount-table');var refundCash=0;var refundCheck=0;var refundTransfer=0;if(body.find('#refundCash').val()!=''){refundCash=parseFloat($yt_baseElement.rmoney(body.find('#refundCash').val()))}if(body.find('#refundCheck').val()!=''){refundCheck=parseFloat($yt_baseElement.rmoney(body.find('#refundCheck').val()))}if(body.find('#refundTransfer').val()!=''){refundTransfer=parseFloat($yt_baseElement.rmoney(body.find('#refundTransfer').val()))}var refundTotal=refundCash+refundCheck+refundTransfer;body.find('#refundTotal').text($yt_baseElement.fmMoney(refundTotal))},funOperationEvent:function(){$('#approveCanelBtn').on("click",function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/expensesReim/module/approval/loanApprovalList.html'}})});$("#approveSubBtn").off().on("click",function(){$(this).attr("disabled",true).addClass("btn-disabled");var ajaxUrl="sz/loanApp/submitLoanAppInfo";var validFlag=$yt_valid.validForm($("#flowApproveDiv"));if(validFlag){var loanObj="";if(loanApply.loanDataObj&&loanApply.loanDataObj!=""){loanObj={loanAppId:loanApply.loanId,loanAppNum:loanApply.loanDataObj.loanAppNum,loanAppName:loanApply.loanDataObj.loanAppName,loanAmount:loanApply.loanDataObj.loanAmount,loanTerm:loanApply.loanDataObj.loanTerm,paymentMethod:loanApply.loanDataObj.paymentMethod,expectRepaymentTime:loanApply.loanDataObj.expectRepaymentTime,applicantUser:loanApply.loanDataObj.applicantUser,parameters:"",dealingWithPeople:$("select#approve-users").val(),opintion:$("#opintion").val(),processInstanceId:loanApply.loanDataObj.processInstanceId,nextCode:$("#operate-flow").val()}}$.ajax({type:"post",url:ajaxUrl,async:false,data:loanObj,success:function(data){if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/expensesReim/module/approval/loanApprovalList.html'}});}$yt_alert_Model.prompt(data.message,2000);$(this).attr('disabled',false).removeClass('btn-disabled')}})}else{sysCommon.pageToScroll($("#loanApply .valid-font"));$(this).attr('disabled',false).removeClass('btn-disabled')}})},fromProjectModelEvent:function(){$(".yt-edit-alert,#heard-nav-bak").show();$yt_alert_Model.getDivPosition($(".yt-edit-alert"));$yt_model_drag.modelDragEvent($(".yt-edit-alert .yt-edit-alert-title"));$('.yt-edit-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()});$("#confirmedPayment").off().on("click",function(){loanApply.refundTotal();var isTrue=$yt_valid.validForm($(".valid-tab"));var retMon=0;var loanBillAB=0;if($("#retMon").val()!=''){retMon=$yt_baseElement.rmoney($("#retMon").val())}else{retMon=0}if($("#loanBillAB").text()!=''){loanBillAB=$yt_baseElement.rmoney($("#loanBillAB").text())}else{loanBillAB=0}if(retMon>loanBillAB){isTrue=false}if(isTrue){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide();var retMonDate=$("#retMonDate").val();var retMon=$("#retMon").val();var refundCash=$("#refundCash").val();var refundCheck=$("#refundCheck").val();var refundTransfer=$("#refundTransfer").val();var refundTotal=$("#refundTotal").text();var dataObj={loanAppId:loanApply.loanId,refundTime:retMonDate,refundAmount:retMon,refundWay:2,chargeAgainst:"",cash:refundCash,cheque:refundTransfer,transfer:refundTotal};$.ajax({type:"post",url:"sz/loanApp/saveRefund",async:false,data:dataObj,success:function(data){if(data.flag==0){if(retMonDate!=''||retMon!=''){$(".paymentHistory .yt-tbody").append('<tr><td style="text-align: center !important;"><span id="">'+retMonDate+'</span></td><td style="padding-right: 5px;"><div class="moneyText" style="width: 100%;text-align: right;" id="repaymentAmount">'+retMon+'</div></td><td style="padding-right: 5px;"><div class="moneyText" style="width: 100%;text-align: right;" id=""></div></td><td style="padding-right: 5px;"><div class="moneyText" style="width: 100%;text-align: right;" id="">'+refundCash+'</div></td><td style="padding-right: 5px;"><div class="moneyText" style="width: 100%;text-align: right;" id="">'+refundCheck+'</div></td><td style="padding-right: 5px;"><div class="moneyText" style="width: 100%;text-align: right;" id="">'+refundTransfer+'</div></td></tr>');loanApply.fmMonList()}}$yt_alert_Model.prompt(data.message)}})}else{$yt_alert_Model.prompt("还款金额不能大于借款单可用余额")}})},showReturnLoanModel:function(){$("#returnLoanBut").off().on("click",function(){$("#retMonDate").val('');$("#retMon").val('');$("#refundCash").val('');$("#refundCheck").val('');$("#refundTransfer").val('');loanApply.fmMonList();loanApply.fromProjectModelEvent()})},loanMoneyEvent:function(){$("#loanMoney").on("focus",function(){if($(this).val()!=""&&$(this).val()!=null){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()}});$("#loanMoney").on("blur",function(){if($(this).val()!=""&&$(this).val()!=null){var fmMoney=$yt_baseElement.fmMoney($(this).val());$(this).val(fmMoney);var lowerMoney=arabiaToChinese($(this).val()+'');$("#moneyLower").text(lowerMoney)}})},showCostDetail:function(data){var me=this;var fMoney=$yt_baseElement.fmMoney;var payReceivablesData=data.payReceivablesData;var gatheringUnitList=payReceivablesData.gatheringUnitList;var otherPayeeHtml="";var otherPayeeTotale=0;$.each(gatheringUnitList,function(i,n){otherPayeeHtml+='<tr><td>'+n.unitName+'</td><td style="text-align:right;">'+$yt_baseElement.fmMoney(n.amount)+'</td><td >'+n.openBank+'</td><td >'+n.accounts+'</td><td >'+(n.isContract==1?'是':'否')+'</td><td >'+(n.isSettlement==1?'汇款':'支票')+'</td><td >'+(n.remarks||"无")+'</td></tr>';otherPayeeTotale+= +n.amount});$(".payee-unit .yt-tbody .payee-unit-total").before(otherPayeeHtml);$(".payee-unit .payee-unit-total .payee-unit-money").text($yt_baseElement.fmMoney(otherPayeeTotale));if(gatheringUnitList.length==0){$(".payee-unit-model").hide()}var gatheringPersonList=payReceivablesData.gatheringPersonList;var gatheringPersonHtml="";var gatheringPersonTotale=0;$.each(gatheringPersonList,function(i,n){gatheringPersonHtml+='<tr class="payee-personal-tr" pkid="" personalUnit="'+n.personalUnit+'" payeeval="'+n.personalCode+'" payeename="'+n.personalName+'" pedepartment="'+n.personalDept+'" perank="'+n.personalJobLevelName+'" personaltotal="'+n.amount+'" witeoffpersonal="'+n.reverseTheWay+'" personalwriteoff="'+n.replaceAmount+'" cash="'+n.cash+'" officialcard="'+n.officialCard+'" transferaccounts="'+n.transfer+'" payeeradio="'+n.isContract+'" personalspecial="'+n.remarks+'" idcarkno="'+n.idCard+'" payeebank="'+n.accounts+'" bankname="'+n.openBank+'" phonenum="'+n.phoneNum+'" choiceloan="'+n.loanAppNum+'" choiceloanval="'+n.loanAppId+'" arrearsmoney="'+n.loanAppArrearsAmount+'" thereversemoney="'+n.writeOffAmount+'" offOpenBank="'+n.offOpenBank+'" offAccounts="'+n.offAccounts+'"><td class="per" value="personal">'+n.personalName+'</td><td style="text-align: right;" class="personalTotal">'+loanApply.fmMoney(n.amount)+'</td><td style="text-align: right;">'+(loanApply.fmMoney(n.cash))+'</td><td style="text-align: right;">'+(loanApply.fmMoney(n.officialCard))+'</td><td style="text-align: right;">'+(loanApply.fmMoney(n.transfer))+'</td><td><a class="yt-link to-data">详情</a></td><td>'+(n.isContract==1?'有':'无')+'</td><td>'+(n.remarks||'无')+'</td></tr>';gatheringPersonTotale+= +n.amount});$(".payee-personal .yt-tbody .payee-personal-total").before(gatheringPersonHtml);$(".payee-personal .payee-personal-total .payee-personal-money").text($yt_baseElement.fmMoney(gatheringPersonTotale));if(gatheringPersonList.length==0){$(".payee-personal-model").hide()}var gatheringOtherList=payReceivablesData.gatheringOtherList;var gatheringOtherHtml="";var gatheringOtherTotale=0;$.each(gatheringOtherList,function(i,n){gatheringOtherHtml+='<tr><td>'+n.otherName+'</td>'+'<td style="text-align:right;">'+$yt_baseElement.fmMoney(n.amount)+'</td>'+'<td >'+(n.isContract==1?'是':'否')+'</td>'+'<td>'+(n.remarks||"无")+'</td>'+'</tr>';gatheringOtherTotale+= +n.amount});$(".payee-other .yt-tbody .payee-other-total").before(gatheringOtherHtml);$(".payee-other .payee-other-total .payee-other-total-money").text($yt_baseElement.fmMoney(gatheringOtherTotale));if(gatheringOtherList.length==0){$(".payee-other-model").hide()}if(gatheringOtherList.length==0&&gatheringPersonList.length==0&&gatheringUnitList.length==0){$(".payee-info-isshow").html('<table style="width:100%"><tr style="border:0px;background-color:#fff !important;"><td align="center"style="border:0px;"><div class="no-data" style="width: 280px;padding:0;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding:10px 0;"></div></td></tr></table>')}},toDetails:function(){$('.to-detail').off("click").on('click',function(){$yt_baseElement.eventStopPageaction();var loanAppId=$(this).attr("loanAppId");var pageUrl="view/system-sasac/expensesReim/module/loanApply/loanApplyDetail.html?loanId="+loanAppId;$yt_baseElement.openNewPage(2,pageUrl)})}};$(function(){loanApply.init()});
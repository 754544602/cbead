var trainingProgramsList={init:function(){trainingProgramsList.getTreeAllPersonnel();$(".yt-select").niceSelect();$(".chose-year").calendar({speed:200,complement:true,readonly:true,lowerLimit:"NaN",nowData:true,dateFmt:"yyyy",callback:function(){trainingProgramsList.getTrainingProgramsList();trainingProgramsList.getAnnualTarget()}});var judgeList=2;$(".addList").on('click',function(){window.location.href=$yt_option.base_path+"website/view/project/addProjectList.html?judgeList=2"});$(".updateList").on('click',function(){if($("tr.yt-table-active").length==0){$yt_alert_Model.prompt("请选择要修改的数据");return false}var projectType=$("tr.yt-table-active").find(".hid-project-type").val();window.location.href=$yt_option.base_path+"website/view/project/addProjectList.html?pkId="+$('.yt-table-active .pkId').val()+"&judgeList=2&projectType="+projectType});$(".train-tbody").on('click',".real-name-inf",function(){var projectType=$("tr.yt-table-active").find(".hid-project-type").val();var projectState=$(this).parents('tr').find(".project-state-step").val();window.location.href=$yt_option.base_path+"website/view/project/projectDetails.html?pkId="+$('.yt-table-active .pkId').val()+"&history=trainingProgramsList&projectCode="+$('.yt-table-active .project-code-list').text()+"&judgeList=2&projectState="+projectState+"&projectType="+projectType});$(".set-principal-btn").off().on('click',function(){if($("tr.yt-table-active").length==0){$yt_alert_Model.prompt("请选择要操作的数据");return false}var num=Number($('tr.none-tr').index());if($('select.project-director').length>1){var length=$('select.project-director').length;$.each($('select.project-director'),function(x,y){if(x!=length-1){if($(y).parents('tr').find('.project-head')[0]==undefined){$(y).parents('tr').remove()}else{$(y).parents('tr').next().find('td').eq(0).text($(this).parents('tr').find('.project-head').text());$(y).parents('tr').next().find('td').eq(0).addClass('project-head');$(y).parents('tr').remove()}}});$('select.project-director').attr('class','yt-select project-director project-director1 types');$('div.project-director').attr('class','nice-select yt-select project-director project-director1 types');$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.type==3){$("select.project-director1").append('<option value="'+m.textName+'" types="2" realName="'+m.text+'" >'+m.text+'</option>')}});$("select.project-director option:eq(0)").prop("selected","selected")}if($('select.teacher-head').length>1){var length=$('select.teacher-head').length;$.each($('select.teacher-head'),function(x,y){if(x!=length-1){if($(y).parents('tr').find('.projectHeadmaster')[0]==undefined){$(y).parents('tr').remove()}else{$(y).parents('tr').next().find('td').eq(0).text($(this).parents('tr').find('.projectHeadmaster').text());$(y).parents('tr').next().find('td').eq(0).addClass('projectHeadmaster');$(y).parents('tr').remove()}}});$('select.teacher-head').attr('class','yt-select teacher-head teacher-head1 types');$('div.teacher-head').attr('class','nice-select yt-select teacher-head teacher-head1 types');$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.type==3){$(".projectAidTr").prev().find("select.teacher-head"+length).append('<option value="'+m.textName+'" types="3" realName="'+m.text+'" >'+m.text+'</option>')}});$("select.teacher-head option:eq(0)").prop("selected","selected")};$('.none-tr').parents('tbody').find('tr').eq(2).find('select').val('');var name=$(".yt-table-active").find('.real-name-inf').text();var projectType=$(".yt-table-active").find('.projectType').text();var principalInf=$(".yt-table-active").data('legalData').projectHeadCode;var principalArr=principalInf.split(",");var teacherHead=$(".yt-table-active").data('legalData').projectHeadmasterCode;var teacherHeadArr=teacherHead.split(",");$('.project-name').text(name);$('.project-type').text(projectType);var selectVal="";$('.project-assistant').setSelectVal($(".yt-table-active").data('legalData').projectAidCode);$.each(principalArr,function(i,n){if(i==0){$('select.project-director:eq(0)').setSelectVal(n);$(".set-principal-alert").find("select.project-director").eq(0).hide()}else{var length=$('select.project-director').length+1;addProjectHead('add',n);$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.type==3){$(".none-tr").prev().find("select.project-director"+length).append('<option value="'+m.textName+'" types="2" realName="'+m.text+'" >'+m.text+'</option>')}});$(".none-tr").prev().find("select.project-director"+length).setSelectVal(n)}});$.each(teacherHeadArr,function(i,n){if(i==0){$('select.teacher-head:eq(0)').setSelectVal(n);$(".set-principal-alert").find("select.teacher-head").eq(0).hide()}else{var length=$('select.teacher-head').length+1;addTeacherHead('add',n);$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.type==3){$(".projectAidTr").prev().find("select.teacher-head"+length).append('<option value="'+m.textName+'" types="3" realName="'+m.text+'" >'+m.text+'</option>')}});$(".projectAidTr").prev().find(".teacher-head"+length).setSelectVal(n)}});trainingProgramsList.setPrincipal();$(".set-principal-alert").off().on('click','.add-project-director',function(){addProjectHead()});function addProjectHead(a,b){var length=$('select.project-director').length+1;$(".none-tr").before('<tr><td align="right"></td><td><div class="set-principal-alert-select"><select class="yt-select project-director project-director'+length+' types" data-val="" style="width: 201px;" ><option value="">请选择</option></select></div></td><td width="100px" style="padding-left: 10px;color: lightskyblue;cursor: pointer;"><span class="add-project-director">新增</span></td></tr>');$(".none-tr").prev().prev().find('.add-project-director').text('删除');$(".none-tr").prev().prev().find('.add-project-director').attr('class','delete-project-director');$('.delete-project-director').off().click(function(){if($(this).parents('tr').find('.project-head')[0]==undefined){$(this).parents('tr').remove()}else{$(this).parents('tr').next().find('td').eq(0).text($(this).parents('tr').find('.project-head').text());$(this).parents('tr').next().find('td').eq(0).addClass('project-head');$(this).parents('tr').remove()}});if(a=='add'){$(".none-tr").prev().find(".project-director"+length).niceSelect({search:true,backFunction:function(text){$(".none-tr").prev().find("select.project-director"+length+" option").remove();if(text==""){$(".none-tr").prev().find("select.project-director"+length).append('<option value="">请选择</option>')}$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.text.indexOf(text)!=-1){if(m.type==3){$(".none-tr").prev().find("select.project-director"+length).append('<option value="'+m.textName+'" types="2" realName="'+m.text+'" >'+m.text+'</option>')}}})}})}else{var treeAllPersonal=trainingProgramsList.allPersonnel;$(".project-director"+length).niceSelect({search:true,backFunction:function(text){$("select.project-director"+length+" option").remove();if(text==""){$("select.project-director"+length).append('<option value="">请选择</option>')}$.each(treeAllPersonal,function(i,n){if(n.text.indexOf(text)!=-1){if(n.type==3){$("select.project-director"+length).append('<option value="'+n.textName+'" types=2 >'+n.text+'</option>')}}})}})}}$(".set-principal-alert").on('click','.add-teacher-head',function(){$(this).text("");addTeacherHead()});function addTeacherHead(a,b){var length=$('select.teacher-head').length+1;$(".project-assistant").parent().parent().parent().before('<tr><td align="right"></td><td><div class="set-principal-alert-select"><select class="yt-select teacher-head teacher-head'+length+' types" data-val="" style="width: 201px;" ><option value="">请选择</option></select></div></td><td width="100px" style="padding-left: 10px;color: lightskyblue;cursor: pointer;"><span class="add-teacher-head">新增</span></td></tr>');$(".project-assistant").parent().parent().parent().prev().prev().find('.add-teacher-head').text('删除');$(".project-assistant").parent().parent().parent().prev().prev().find('.add-teacher-head').attr('class','delete-teacher-director');$('.delete-teacher-director').off().click(function(){if($(this).parents('tr').find('.projectHeadmaster')[0]==undefined){$(this).parents('tr').remove()}else{$(this).parents('tr').next().find('td').eq(0).text($(this).parents('tr').find('.projectHeadmaster').text());$(this).parents('tr').next().find('td').eq(0).addClass('projectHeadmaster');$(this).parents('tr').remove()}});if(a=='add'){$(".projectAidTr").prev().find(".teacher-head"+length).niceSelect({search:true,backFunction:function(text){$(".projectAidTr").prev().find("select.teacher-head"+length+" option").remove();if(text==""){$(".projectAidTr").prev().find("select.teacher-head"+length).append('<option value="">请选择</option>')}$.each(trainingProgramsList.allPersonnel,function(j,m){if(m.text.indexOf(text)!=-1){if(m.type==3){$(".projectAidTr").prev().find("select.teacher-head"+length).append('<option value="'+m.textName+'" types="3" realName="'+m.text+'" >'+m.text+'</option>')}}})}})}else{var treeAllPersonal=trainingProgramsList.allPersonnel;$(".teacher-head"+length).niceSelect({search:true,backFunction:function(text){$("select.teacher-head"+length+" option").remove();if(text==""){$("select.teacher-head"+length).append('<option value="">请选择</option>')}$.each(treeAllPersonal,function(i,n){if(n.text.indexOf(text)!=-1){if(n.type==3){$("select.teacher-head"+length).append('<option value="'+n.textName+'" types=3 >'+n.text+'</option>')}}})}})}}$(".set-principal-alert .yt-model-sure-btn").off().on('click',function(){trainingProgramsList.setHeadAlert()})});trainingProgramsList.getTrainingProgramsList();trainingProgramsList.getAnnualTarget();$(".amend-annual-target").click(function(){$(this).hide();$(".annual-target-span").hide();$(".annual-target-inf").show();$(".save-annual-target").show();$(".save-annual-target").click(function(){trainingProgramsList.saveAnnualTarget();$(this).hide();$(".amend-annual-target").show();$(".annual-target-span").show();$(".annual-target-inf").hide();trainingProgramsList.getAnnualTarget()})});$('.search-btn').click(function(){trainingProgramsList.getTrainingProgramsList()});var treeAllPersonal=trainingProgramsList.allPersonnel;if(treeAllPersonal!=null){$.each(treeAllPersonal,function(i,n){if(n.type==3){$(".project-director").append('<option value="'+n.textName+'" types=2 realName="'+n.text+'">'+n.text+'</option>');$(".teacher-head").append('<option value="'+n.textName+'" types=3 >'+n.text+'</option>');$(".project-assistant").append('<option value="'+n.textName+'" types=4 >'+n.text+'</option>')}})}$(".project-director1").niceSelect({search:true,backFunction:function(text){$("select.project-director1 option").remove();if(text==""){$("select.project-director1").append('<option value="">请选择</option>')}$.each(treeAllPersonal,function(i,n){if(n.text.indexOf(text)!=-1){if(n.type==3){$("select.project-director1").append('<option value="'+n.textName+'" types=2 realName="'+n.text+'">'+n.text+'</option>')}}})}});$(".teacher-head1").niceSelect({search:true,backFunction:function(text){$("select.teacher-head1 option").remove();if(text==""){$("select.teacher-head1").append('<option value="">请选择</option>')}$.each(treeAllPersonal,function(i,n){if(n.text.indexOf(text)!=-1){if(n.type==3){$("select.teacher-head1").append('<option value="'+n.textName+'" types=3 >'+n.text+'</option>')}}})}});$(".project-assistant").niceSelect({search:true,backFunction:function(text){$("select.project-assistant option").remove();if(text==""){$("select.project-assistant").append('<option value="">请选择</option>')}$.each(treeAllPersonal,function(i,n){if(n.text.indexOf(text)!=-1){if(n.type==3){$("select.project-assistant").append('<option value="'+n.textName+'" types=4 >'+n.text+'</option>')}}})}})},allPersonnel:'',getTreeAllPersonnel:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/user/getUsers",beforeSend:function(){$yt_baseElement.showLoading()},data:{},async:false,success:function(data){list=data.data||[];trainingProgramsList.allPersonnel=data.data;$yt_baseElement.hideLoading()}});return list},getTrainingProgramsList:function(){$yt_baseElement.showLoading();var selectParam=$(".selectParam").val();var years=$(".chose-year").val();$('.train-page').pageInfo({pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"project/lookForAllByTrainClass",type:"post",data:{selectParam:selectParam,years:years},objName:'data',success:function(data){if(data.flag==0){var htmlTbody=$('.list-table .train-tbody');var htmlTr='';var projectType="";if(data.data.rows.length>0){$(htmlTbody).empty();$.each(data.data.rows,function(i,v){if(v.projectType==1){projectType="计划"}else if(v.projectType==2){projectType="委托"}else if(v.projectType==3){projectType="选学"}else if(v.projectType==4){projectType="调训"}htmlTr='<tr><td class="project-code-list"><input type="hidden" value="'+v.pkId+'" class="pkId">'+v.projectCode+'</td><td style="text-align: left;"><a href="#" class="real-name-inf" style=" color:#3c4687">'+v.projectName+'</a></td><td class="projectType"><input type="hidden" value="'+v.projectType+'" class="hid-project-type">'+projectType+'</td><td>'+v.startDate+'</td><td style="text-align: right;">'+v.trainDateCount+'</td><td style="text-align: left;">'+v.projectSell+'</td><td style="text-align: left;" class="project-head-text">'+v.projectHead+'</td><td style="text-align: right;">'+v.traineeCount+'</td><td><input type="hidden" value="'+v.projectStates+'" class="project-state-step">'+(v.projectStates==4?"已立项":(v.projectStates==5?"培训中":(v.projectStates==6?"未结项":"已结项")))+'</td></tr>';$(".train-page").show();htmlTbody.append($(htmlTr).data("legalData",v))})}else{$(".train-page").hide();htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="9" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';htmlTbody.html(htmlTr)}$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading();$yt_alert_Model.prompt("查询失败")}},isSelPageNum:true })},setHeadAlert:function(){$yt_baseElement.showLoading();var projectCode=$('.yt-table-active').data("legalData").projectCode;var userList="";var userListArr=[];var array=[];$(".set-principal-alert .set-principal-alert-select").each(function(i,n){types=$(n).find("select.types option:selected").attr("types");typesData=$(n).find("select.types option:selected").val();var arrUserList={types:types,typesData:typesData};userListArr.push(arrUserList)});var userList=JSON.stringify(userListArr);$.ajax({type:"post",url:$yt_option.base_path+"project/updateProjectPrincipal",data:{projectCode:projectCode,userList:userList},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("操作成功");window.location.reload()});$(".set-principal-alert").hide()}else{$yt_baseElement.hideLoading();$yt_alert_Model.prompt("操作失败");$('.train-page').pageInfo("refresh");$(".set-principal-alert").hide()}}})},setPrincipal:function(){$(".set-principal-alert").show();$yt_alert_Model.getDivPosition($(".set-principal-alert"));$yt_alert_Model.setFiexBoxHeight($(".cont-edit-test"));$yt_model_drag.modelDragEvent($(".set-principal-alert .yt-edit-alert-title"));$('.set-principal-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".set-principal-alert").hide();$("#pop-modle-alert").hide()})},getAnnualTarget:function(){var yearData=$(".chose-year").val();$.ajax({type:"post",url:$yt_option.base_path+"class/trainee/getTrainPlanByTear",data:{yearData:yearData},success:function(data){if(data.flag==0){$(".annual-target").setDatas(data.data);$(".annual-target-span").text(data.data.trainCount)}else{$yt_alert_Model.prompt("本年度班次目标操作失败")}}})},saveAnnualTarget:function(){var yearData=$(".chose-year").val();var trainCount=$(".annual-target-inf").val();$.ajax({type:"post",async:false,url:$yt_option.base_path+"class/trainee/updateTrainPlanByTear",data:{yearData:yearData,trainCount:trainCount},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("本年度班次目标保存成功")}else{$yt_alert_Model.prompt("本年度班次目标保存失败")}}})}};$(function(){trainingProgramsList.init()});
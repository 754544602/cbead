var applyObj={budgetAppId:"",processInstanceId:"",init:function(){$(".bottom-btn-model").before(sysCommon.createFlowApproveMode());$("select").niceSelect();applyObj.getYearAndStageInfo();applyObj.budgetAppId=$yt_common.GetQueryString('budgetAppId');if(applyObj.budgetAppId&&applyObj.budgetAppId!=undefined&&applyObj.budgetAppId!=""){applyObj.getBudgetApplyDetailInfo()}else{sysCommon.getLoginUserInfo()}sysCommon.getApproveFlowData("BUDGET_DATA_APP",applyObj.processInstanceId);applyObj.initEvent();applyObj.getTableModelInfo()},initEvent:function(){$("#submitBtn").click(function(){var thisBtn=$(this);$(thisBtn).attr("disabled","disabled");var validFlag=$yt_valid.validForm($(".apply-main-model"));if(validFlag){var submitData={processInstanceId:applyObj.processInstanceId,budgetAppId:applyObj.budgetAppId,booksId:$("select.year-sel").val(),budgetYear:$("select.year-sel option:selected").text(),budgetStage:$("select.stage-sel").val()};$.ajax({type:'post',url:'budget/appMain/submitBudgetAppInfo',async:false,data:submitData,success:function(data){$(thisBtn).attr("disabled",false);if(data.flag==0){if(data.data&&data.data!=undefined&&data.data!=null){var isSuc=applyObj.submitWorkflow(data.data);if(isSuc){$yt_alert_Model.prompt(data.message);$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/approval/budgetMyList.html'}})}}}else{$yt_alert_Model.prompt(data.message)}},error:function(e){$(thisBtn).attr("disabled",false)}})}})},getYearAndStageInfo:function(){$.ajax({type:'post',url:'budget/appMain/getBudgetYearInfo',async:false,success:function(data){if(data.flag==0){if(data.data&&data.data.length>0){$.each(data.data,function(i,n){$("select.year-sel").append('<option value="'+n.booksId+'">'+n.budgetYear+'</option>')});$("select.year-sel").niceSelect();$("select.year-sel").change(function(){applyObj.getTableModelInfo()})}}}});$.ajax({type:'post',url:'budget/details/getBudgetStageInfo',data:{type:"1"},async:false,success:function(data){if(data.flag==0){if(data.data&&data.data.length>0){$.each(data.data,function(i,n){$("select.stage-sel").append('<option value="'+n.budgetStage+'">'+n.budgetStageName+'</option>')});$("select.stage-sel").niceSelect();$("select.stage-sel").change(function(){var selTabIndex=$(".tabs li.tabs-selected").index();applyObj.getTableModelInfo(selTabIndex)})}}}})},getBudgetApplyDetailInfo:function(){$.ajax({type:'post',url:'budget/appMain/getBudgetAppInfoByAppId',async:false,data:{"budgetAppId":applyObj.budgetAppId},success:function(data){if(data.flag==0){if(data.data){var datas=data.data;$(".apply-main-model").setDatas(datas);applyObj.processInstanceId=datas.processInstanceId;$("#formNum").removeClass("form-num");$("#busiUsers").text(datas.applicantUserName);$("#deptName").text(datas.applicantUserDeptName);$("#jobName").text(datas.applicantUserJobName==""?"--":datas.applicantUserJobName);$("#telPhone").text(datas.applicantUserPhone==""?"--":datas.applicantUserPhone);$('select.stage-sel option[value="'+datas.budgetStage+'"]').prop("selected","selected");$('select.year-sel option[value="'+datas.booksId+'"]').prop("selected","selected");$("select").niceSelect()}}else{$yt_alert_Model.prompt(data.message)}}})},submitWorkflow:function(appId){var isSuc=true;var subDataObj={appId:appId,parameters:"",dealingWithPeople:$("#approve-users").val(),opintion:$("#opintion").val(),processInstanceId:applyObj.processInstanceId,nextCode:$("#operate-flow").val()};$.ajax({type:'post',url:'budget/appMain/submitWorkFlow',async:false,data:subDataObj,success:function(data){if(data.flag==0){isSuc=true}else{$yt_alert_Model.prompt(data.message);isSuc=false}}});return isSuc},getTableModelInfo:function(selTabIndex){$.ajax({type:'post',url:'budget/details/getTabInfoListByParams',data:{booksId:$("select.year-sel").val(),budgetStage:$("select.stage-sel").val(),deptId:''},success:function(data){if(data.flag==0){if(data.data&&data.data.length>0){var oldSelTabIndex=0;var contStr="";$('#tableTemplate').show();$(".listNoData").hide();$(".temp-model").html('<div id="tableTemplate"></div>');$.each(data.data,function(i,n){contStr='<div title="'+n.tableName+'"><input type="hidden" class="hid-table-id" value="'+n.tableId+'"/><input type="hidden" class="hid-table-code" value="'+n.tableCode+'"/></div>';$("#tableTemplate").append(contStr)});$('#tableTemplate').tabs({onSelect:function(title,index){var tableId=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-id").val();var tableCode=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-code").val();var tabIndex=index;var thisSelPanel=$(".tabs-panels .panel").eq(tabIndex).find(".panel-body");applyObj.getBudgetTableDetailByTableId(tableId,thisSelPanel);applyObj.getTableInfoList(tableId,thisSelPanel);$(".tabs-panels .panel").eq(tabIndex).find(".panel-body .tab-table-title").remove();var tableTitle='<div class="tab-table-title">'+tableCode+'--'+title+'</div>';$(".tabs-panels .panel").eq(tabIndex).find(".panel-body table").before(tableTitle)}});var tab=$('#tableTemplate').tabs('getSelected');var index=$('#tableTemplate').tabs('getTabIndex',tab);if(selTabIndex!=undefined){$('#tableTemplate').tabs('select',selTabIndex)}else{$('#tableTemplate').tabs('select',index)}}else{$('#tableTemplate').hide();$(".listNoData").show()}}else{$('#tableTemplate').hide();$(".listNoData").show();$yt_alert_Model.prompt(data.message)}}})},getBudgetTableDetailByTableId:function(tableId,creatTableAreaObj){$.ajax({type:'post',url:'budget/table/getBudgetTableDetailByTableId',async:false,data:{tableId:tableId},success:function(data){var dataObj=data.data||{};if(data.flag==0){$(creatTableAreaObj).newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:false});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$(creatTableAreaObj).find('.rule-table .indicate-head tr .indicate').eq(index-1).addClass('dis');$(creatTableAreaObj).find('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('dis')})}else if(proper.type=='r'){$(creatTableAreaObj).find('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('dis')}}$(creatTableAreaObj).find('.rule-table').data('tableData',dataObj);$(creatTableAreaObj).find('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$(creatTableAreaObj).find('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();if(!isNaN(html)){html='<span class="money-text">'+html+'</span>'}else{html='<span>'+html+'</span>'}$(this).html(html)})}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableInfoList:function(tableId,thisPanel){$.ajax({type:"post",url:'budget/details/getBudgetDataDetailInfoByTable',async:false,data:{tableId:tableId,booksId:$("select.year-sel").val(),budgetStage:$("select.stage-sel").val(),deptId:''},success:function(data){if(data.flag==0){if(data.data.length>0){var tbody=$('.rule-table .yt-tbody');$.each(data.data,function(i,n){$(thisPanel).find(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}})}};$(function(){applyObj.init()});
var beforeApproList={init:function(){$("#paymDate").calendar({speed:0,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:false,speed:0,dateFmt:"yyyy-MM-dd",callback:function(){sysCommon.clearValidInfo($(".paym-date"))}});$(".money-input").blur(function(){if($(this).val()){$(this).val($yt_baseElement.fmMoney($(this).val()))}});$(".money-input").focus(function(){if($(this).val()){$(this).val($yt_baseElement.rmoney($(this).val()))}})},searchInput:function(){$('.search').on('keydown',function(){if($(this).val()!=''){$('.clearImg').show()}});$('.clearImg').on('click',function(){$('.search').val('');$(this).hide();beforeApproList.searchList()});$("#resetBtn").off().on("click",function(){$('.search').val('');$('.clearImg').hide();beforeApproList.searchList()});$("#heardSearchBtn").off().on("click",function(){beforeApproList.searchList()})},eventList:function(){$('.handle-and-end').on("click","img.account",function(){var thisObj=$(this);var thisTr=thisObj.parents('tr');var loanId=thisTr.find("input.hid-loan-id").val();beforeApproList.showPaymRecordPop(loanId)});$(".handle-and-end,.pending").on('click','.process-state',function(){var processInstanceId=$(this).parents("tr").find(".processInstanceId").val();sysCommon.processStatePop(processInstanceId)});$("#retuMoneyBtn").click(function(){var selTrLen=$(".handle-and-end tbody tr.yt-table-active").length;var thisTr=$(".handle-and-end tbody tr.yt-table-active");if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var loanId=$(".handle-and-end tbody tr.yt-table-active").find("input.hid-loan-id").val();beforeApproList.showPaymRegisterPop(loanId)}});$("#printingLoanBtn").click(function(){var selTrLen=$(".tab-content tbody tr.yt-table-active").length;if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var loanId=$(".tab-content tbody tr.yt-table-active").find("input.hid-loan-id").val();var pageUrl="view/system-sasac/expensesReim/module/print/printLoanApply.html?loanId="+loanId;$yt_baseElement.openNewPage(2,pageUrl)}});$("#printingLoanBtnDetails").click(function(){var selTrLen=$(".tab-content tbody tr.yt-table-active").length;if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var loanId=$(".tab-content tbody tr.yt-table-active").find("input.hid-loan-id").val();var pageUrl="view/system-sasac/expensesReim/module/print/printLoanApplyDetails.html?loanId="+loanId;$yt_baseElement.openNewPage(2,pageUrl)}});$('.screen input').change(function(){var stateCode="WF_PASS_QUERY_SQL_PARAMS";var signState=function(){var states=$('.screen .check');if($(states).length>=2||$(states).length<=0){return '2'}else if($(states).length<2){return $(states).find('input').val()}return ''};var sta='';if($(this).parent().hasClass('check')){$(this).setCheckBoxState("uncheck");sta=signState()}else{$(this).setCheckBoxState("check");sta=signState()}beforeApproList.getProcessingAndFinishList(stateCode,sta)});var check=true;$('.all-checked').click(function(){if(check){$('.handle-and-end tbody').setCheckBoxState("checkAll");$('.handle-and-end tbody tr').addClass('yt-table-active')}else{$('.handle-and-end tbody').setCheckBoxState("unCheckAll");$('.handle-and-end tbody tr').removeClass('yt-table-active')}check=!check});$('.already-printed').click(function(){var ids='';$('.handle-and-end tbody .check').each(function(i,n){ids+=$(n).find('input').val()+(i<$('.handle-and-end tbody .check').length-1?',':'')});if(ids){beforeApproList.updateLoanIsPrintStateYes(ids);check=true}else{$yt_alert_Model.prompt('请选择数据进行操作')}});$('.non-printing').click(function(){var ids='';$('.handle-and-end tbody .check').each(function(i,n){ids+=$(n).find('input').val()+(i<$('.handle-and-end tbody .check').length-1?',':'')});if(ids){beforeApproList.updateLoanIsPrintStateNo(ids);check=true}else{$yt_alert_Model.prompt('请选择数据进行操作')}});$(".handle-and-end .yt-tbody").on('change','input[type=checkbox]',function(){if($(this)[0].checked){$(this).parents('tr').addClass('yt-table-active')}else{$(this).parents('tr').removeClass('yt-table-active')}return false});$(".handle-and-end .yt-tbody").on('click','tr',function(){if($(this).hasClass('yt-table-active')){$(this).removeClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('uncheck')}else{$(this).addClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('check')}})},updateLoanIsPrintStateYes:function(ids){$.ajax({type:"post",url:"sz/loanApp/updateLoanIsPrintStateYes",async:false,data:{ids:ids},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);beforeApproList.searchList()}else{$yt_alert_Model.prompt(data.message)}}})},updateLoanIsPrintStateNo:function(ids){$.ajax({type:"post",url:"sz/loanApp/updateLoanIsPrintStateNo",async:false,data:{ids:ids},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);beforeApproList.searchList()}else{$yt_alert_Model.prompt(data.message)}}})},loanQtip:function(logQtipObj){logQtipObj.qtip({content:{text:function(){var txt='<div style="margin-top:-5px;">点击查看还款记录</div>';return txt}},position:{my:'right top',at:'left top',container:false,viewport:$('body'),adjust:{x:8,y:8,mouse:true,resize:true,method:'flip flip'}},hide:{fixed:true},style:{classes:'showmod',tip:{corner:true,mimic:false,width:10,height:10,border:true,offset:0}}})},showPaymRecordPop:function(loanId){$(".yt-edit-alert.paym-record-pop,#heard-nav-bak").show();$.ajax({type:"post",url:"sz/loanApp/getRefundDetailInfoByLoanAppId",async:false,data:{loanAppId:loanId},success:function(data){if(data.flag==0){var dataObj=data.data;if(dataObj&&dataObj!=""&&dataObj!=undefined){$("#lonMon").text($yt_baseElement.fmMoney(dataObj.loanAmount?dataObj.loanAmount:0));$("#paymMon").text($yt_baseElement.fmMoney(dataObj.refundTotalAmount?dataObj.refundTotalAmount:0));$("#debtMon").text($yt_baseElement.fmMoney(dataObj.arrearsAmount?dataObj.arrearsAmount:0));$("#inHandPaymMon").text($yt_baseElement.fmMoney(dataObj.inApprovalRefundAmount?dataObj.inApprovalRefundAmount:0));$(".paymentHistory tbody").empty();if(dataObj.refundRecordList&&dataObj.refundRecordList.length>0){var trStr="";$.each(dataObj.refundRecordList,function(i,n){var refundWay='';if(n.refundWay==1){refundWay="现金"}else if(n.refundWay==2){refundWay="支票"}else if(n.refundWay==3){refundWay="转账"}else if(n.refundWay==4){refundWay="报销单冲销"}trStr=$('<tr><td>'+n.refundNum+'</td><td style="text-align: right;padding-right: 5px;">'+(n.refundAmount==""?"0.00":($yt_baseElement.fmMoney(n.refundAmount)))+'</td><td>'+n.refundTime+'</td><td>'+refundWay+'</td></tr>');trStr.data("refundInfo",n);$(".paymentHistory tbody").append(trStr)})}}sysCommon.getApproveFlowData("SZ_LOAN_APP",dataObj.processInstanceId)}else{$yt_alert_Model.prompt(data.message,2000)}}});$yt_alert_Model.getDivPosition($(".yt-edit-alert.paym-record-pop"));$('.yt-edit-alert.paym-record-pop .yt-eidt-model-bottom .close-btn').off().on("click",function(){$(".yt-edit-alert.paym-record-pop,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},showPaymRegisterPop:function(loanId){$(".yt-edit-alert.paym-register-pop,#heard-nav-bak").show();$.ajax({type:"post",url:" sz/loanApp/getRefundInfoByLoanAppId",async:false,data:{loanAppId:loanId},success:function(data){if(data.flag==0){var dataObj=data.data;if(dataObj&&dataObj!=""&&dataObj!=undefined){$("#debtMoney").text($yt_baseElement.fmMoney(dataObj.arrearsAmount?dataObj.arrearsAmount:0))}}else{$yt_alert_Model.prompt(data.message,2000)}}});$yt_alert_Model.getDivPosition($(".yt-edit-alert.paym-register-pop"));$('.yt-edit-alert.paym-register-pop .yt-eidt-model-bottom .save-btn').off().on("click",function(){var isTrue=true;var refundAmount=$yt_baseElement.rmoney($("#refundAmount").val());var debtMoney=$yt_baseElement.rmoney($("#debtMoney").text());if(refundAmount>debtMoney){isTrue=false}var tableVerigfy=$yt_valid.validForm($('#registration'));if(isTrue&&tableVerigfy){var loanAppId=loanId;var refundTime=$("#paymDate").val();var refundWay=$(".refund-way .check input").val();$.ajax({type:"post",url:"sz/loanApp/saveRefund",async:false,data:{loanAppId:loanAppId,refundTime:refundTime,refundAmount:refundAmount,refundWay:refundWay},success:function(data){$yt_alert_Model.prompt(data.message)}});$(".yt-edit-alert.paym-register-pop,#heard-nav-bak").hide();$("#pop-modle-alert").hide();$(".money-input").val('');$("#paymDate").val('');beforeApproList.getProcessingAndFinishList('WF_PASS_QUERY_SQL_PARAMS','2')}else{$yt_alert_Model.prompt("还款金额不能大于借款单可用余额")}});$('.yt-edit-alert.paym-register-pop .yt-eidt-model-bottom .yt-cancel-btn').off().on("click",function(){$(".money-input").val('');$("#paymDate").val('');$(".yt-edit-alert.paym-register-pop,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},searchList:function(){beforeApproList.getProcessingAndFinishList('WF_PASS_QUERY_SQL_PARAMS','2')},getProcessingAndFinishList:function(stateCode,printState){var keyWord=$('.search').val();$('.page2').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:"sz/loanApp/getUserLoanAppInfoBusinessListToPageByParams",type:"post",data:{queryStateParams:stateCode,queryParams:keyWord,printState:printState},objName:'data',success:function(data){var datas=data.data.rows;var htmlTbody=$('.handle-and-end .yt-tbody');htmlTbody.empty();var trStr="";if(data.flag==0){if(stateCode=="WF_PASS_QUERY_SQL_PARAMS"){$("#processState").text("欠款金额（元）")}else{$("#processState").text("当前状态")}if(datas.length>0){if(stateCode=="WF_PASS_QUERY_SQL_PARAMS"){$("#retuMoneyBtn").show()}$('.page2').show();$.each(datas,function(i,n){trStr+='<tr><td><label style="position: relative;z-index: 100;" class="check-label yt-checkbox"><input type="checkbox" name="test" value="'+n.loanAppId+'"/></label></td><td><a class="yt-link to-detail">'+n.loanAppNum+'</a><input type="hidden" class="hid-loan-id" value="'+n.loanAppId+'"/><input type="hidden" class="processInstanceId" value="'+n.processInstanceId+'"/></td><td class="tl">'+(n.loanAppName==""?"":n.loanAppName)+'</td><td>'+n.applicantUserName+'</td><td>'+(n.applicantUserDeptName==""?"":n.applicantUserDeptName)+'</td><td style="text-align: right;">'+(n.loanAmount==""?"":($yt_baseElement.fmMoney(n.loanAmount)))+'</td><td>'+(n.loanTerm==""?"":n.loanTerm)+'</td><td>'+n.applicantTime+'</td>';if(stateCode=="WF_PASS_QUERY_SQL_PARAMS"){trStr+='<td style="text-align: right;">'+$yt_baseElement.fmMoney(n.arrearsAmount)+'<img src="../../../../../resources-sasac/images/common/loanIcon.png" class="account log-loan" style="width: 18px;height: 18px;position: relative;z-index: 100;" /></td>'}else{trStr+='<td class="tl"><a class="yt-link process-state">'+n.nodeNowState+'</a></td>'}trStr+='<td class="print-state" style="color: '+(n.isPrint==0?'#333333':'#417095')+';">'+(n.isPrint==0?'未打印':'已打印')+'</td><td><a class="yt-link log-mod">日志</a></td></tr>'});htmlTbody.append(trStr);beforeApproList.goApprovePage();sysCommon.initQtip($(".log-mod"));beforeApproList.loanQtip($(".log-loan"));beforeApproList.toDetails()}else{$('.page2').hide();htmlTbody.append(sysCommon.noDataTrStr(8))}}},isSelPageNum:true })},toDetails:function(){$('.yt-link.to-detail').off("click").on('click',function(){$yt_baseElement.eventStopPageaction();var processInstanceId=$(this).parents('tr').find('.processInstanceId').val();var loanId=$(this).parents('tr').find('.hid-loan-id').val();var pageUrl="view/system-sasac/expensesReim/module/loanApply/loanApplyDetail.html?processInstanceId="+processInstanceId+"&loanId="+loanId;$yt_baseElement.openNewPage(2,pageUrl)})},goApprovePage:function(){$(".apprv-btn").off().click(function(){var loanId=$(this).parents("tr").find(".hid-loan-id").val();var pageUrl='view/system-sasac/expensesReim/module/approval/loanApproval.html?loanId='+loanId;parent.parent.$yt_baseElement.showLoading();window.location.href=$yt_option.websit_path+pageUrl});$(".handle-btn").off().on("click",function(){var loanId=$(this).parents("tr").find(".hid-loan-id").val();var pageUrl='view/system-sasac/expensesReim/module/loanApply/loanApply.html?loanId='+loanId;parent.parent.$yt_baseElement.showLoading();window.location.href=$yt_option.websit_path+pageUrl})}};$(function(){beforeApproList.init();beforeApproList.eventList();beforeApproList.searchInput();beforeApproList.searchList();$("#reimApproList").css("min-height",$(window).height()-12)});
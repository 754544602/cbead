var detailObj={booksId:'',init:function(){$("select").niceSelect();detailObj.getAllDeptsAndStageInfo();detailObj.booksId=$yt_common.GetQueryString('booksId');var booksYear=$yt_common.GetQueryString('booksYear');$(".year-val").text(booksYear);$(".apply-main-model").css("min-height",$(window).height()-18);detailObj.tableModelEvent();$("#cancelBtn").click(function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/budgetTableManager.html'}})})},getAllDeptsAndStageInfo:function(){$.ajax({type:"post",url:"user/userInfo/getAllDeptsInfo",async:false,success:function(data){var datas=data.data;if(data.flag==0){$.each(datas,function(i,n){if(n.type==2){$('select.dept-sel').append('<option value="'+n.id+'">'+n.text+'</option>')}});$("select.dept-sel").niceSelect();$("select.dept-sel").change(function(){detailObj.getTableModelInfo()})}}});$.ajax({type:"post",url:"budget/details/getBudgetStageInfo",async:false,data:{type:'2'},success:function(data){var datas=data.data;if(data.flag==0){$.each(datas,function(i,n){$('select.stage-sel').append('<option value="'+n.budgetStage+'">'+n.budgetStageName+'</option>')});$("select.stage-sel").niceSelect();$("select.stage-sel").change(function(){detailObj.getTableModelInfo()})}}})},tableModelEvent:function(){detailObj.getTableModelInfo()},getTableModelInfo:function(){$.ajax({type:'post',url:'budget/details/getTabInfoListByParams',data:{booksId:detailObj.booksId,budgetStage:$("select.stage-sel").val(),deptId:$("select.dept-sel").val()},success:function(data){if(data.flag==0){var contStr="";if(data.data&&data.data.length>0){$('#tableTemplate').show();$(".listNoData").hide();$.each(data.data,function(i,n){contStr='<div title="'+n.tableName+'"><input type="hidden" class="hid-table-id" value="'+n.tableId+'"/><input type="hidden" class="hid-table-code" value="'+n.tableCode+'"/></div>';$("#tableTemplate").append(contStr)});$('#tableTemplate').tabs({onSelect:function(title,index){var tableId=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-id").val();var tableCode=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-code").val();var tabIndex=index;var thisSelPanel=$(".tabs-panels .panel").eq(tabIndex).find(".panel-body");detailObj.getBudgetTableDetailByTableId(tableId,thisSelPanel);detailObj.getTableInfoList(tableId,thisSelPanel);$(".tabs-panels .panel").eq(tabIndex).find(".panel-body .tab-table-title").remove();var tableTitle='<div class="tab-table-title">'+tableCode+'--'+title+'</div>';$(".tabs-panels .panel").eq(tabIndex).find(".panel-body table").before(tableTitle)}});var tab=$('#tableTemplate').tabs('getSelected');var index=$('#tableTemplate').tabs('getTabIndex',tab);$('#tableTemplate').tabs('select',index);var tableId=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-id").val();var tableCode=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-code").val();var tabIndex=index;var thisSelPanel=$(".tabs-panels .panel").eq(tabIndex).find(".panel-body");detailObj.getBudgetTableDetailByTableId(tableId,thisSelPanel);detailObj.getTableInfoList(tableId,thisSelPanel)}else{$('#tableTemplate').hide();$(".listNoData").show()}}else{$('#tableTemplate').hide();$(".listNoData").show();$yt_alert_Model.prompt(data.message)}}})},getBudgetTableDetailByTableId:function(tableId,creatTableAreaObj){$.ajax({type:'post',url:'budget/table/getBudgetTableDetailByTableId',async:false,data:{tableId:tableId},success:function(data){var dataObj=data.data||{};if(data.flag==0){$(creatTableAreaObj).newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:false});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$(creatTableAreaObj).find('.rule-table .indicate-head tr .indicate').eq(index-1).addClass('dis');$(creatTableAreaObj).find('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('dis')})}else if(proper.type=='r'){$(creatTableAreaObj).find('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('dis')}}$(creatTableAreaObj).find('.rule-table').data('tableData',dataObj);$(creatTableAreaObj).find('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$(creatTableAreaObj).find('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();if(!isNaN(html)){html='<span class="money-text">'+html+'</span>'}else{html='<span>'+html+'</span>'}$(this).html(html)})}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableInfoList:function(tableId,thisPanel){$.ajax({type:"post",url:'budget/details/getBudgetDataDetailInfoByTable',async:false,data:{tableId:tableId,booksId:detailObj.booksId,budgetStage:$("select.stage-sel").val(),deptId:$("select.dept-sel").val()},success:function(data){if(data.flag==0){if(data.data.length>0){var tbody=$('.rule-table .yt-tbody');$.each(data.data,function(i,n){$(thisPanel).find(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}})}};$(function(){detailObj.init()});
var demand={budgetObj:"",init:function(){$(".flow-approve-model").html(sysCommon.createFlowApproveMode());$("#demandApply").css("min-height",$(window).height()-32);$("select").niceSelect();sysCommon.getLoginUserInfo();var budgetPrjAppId=$yt_common.GetQueryString('budgetPrjAppId');demand.getBudgetPrjAppInfoByAppId(budgetPrjAppId);$("#clearBtn").click(function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/projectApproval/budgetProjectList.html'}})});$('#submitPayment').on('click',function(){var thisBtn=$(this);thisBtn.attr('disabled',true).addClass('btn-disabled');if($yt_valid.validForm($('.flow-approve-model'))){var d=demand.budgetObj;demand.submitWorkFlow(d,thisBtn)}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}})},submitWorkFlow:function(subData,thisBtn){$.ajax({type:"post",url:"budget/prjApp/submitWorkFlow",async:true,data:{appId:subData.budgetPrjAppId,dealingWithPeople:$("#approve-users").val(),opintion:$("#opintion").val(),processInstanceId:subData.processInstanceId,nextCode:$("#operate-flow").val()},success:function(data){if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/projectApproval/budgetProjectList.html'}})}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}$yt_alert_Model.prompt(data.message)}})},getBudgetPrjAppInfoByAppId:function(budgetPrjAppId){$.ajax({type:"post",url:"budget/prjApp/getBudgetPrjAppInfoByAppId",async:false,data:{budgetPrjAppId:budgetPrjAppId},success:function(data){if(data.flag==0){var datas=data.data;demand.budgetObj=datas;demand.budgetApprovalDetails=datas;if(datas&&datas!=""&&datas!=undefined){$("#formNum").text(datas.budgetPrjAppNum);$("#applyDate").text(datas.applicantTime);$("#busiUsers").text(datas.applicantUserName);$("#deptName").text(datas.applicantUserDeptName);$("#jobName").text(datas.applicantUserJobName==""?"--":datas.applicantUserJobName);$("#telPhone").text(datas.applicantUserPhone==""?"--":datas.applicantUserPhone);$(".project-name").text(datas.prjName);$(".project-company").text(datas.prjUnitName);$(".company-code").text((datas.compUnitName||'无'));$(".project-type").text(datas.prjClassifyName);$(".project-year").text(datas.prjStartYear);$(".project-cycle").text(datas.prjCycle);$(".implementation-company").text(datas.implUnitName);$(".project-attribute").text((datas.prjAttrName||"无"));$(".project-basis").html((datas.prjBasisContent||'无'));$(".implementation-feasibility").html((datas.implPlanFeasContent||'无'));demand.midGoalInfo(datas.midGoalInfo);demand.yearGoalInfo(datas.yearGoalInfo);demand.showFileList(datas.attrList)}sysCommon.getApproveFlowData("BUDGET_PRJ_APP",datas.processInstanceId)}else{}}})},midGoalInfo:function(datas){if(datas&&datas!=''&&datas!=undefined){$(".metaphase-total").text($yt_baseElement.fmMoney(datas.totalAmount)+"万元"||'--');$(".among-finance").text($yt_baseElement.fmMoney(datas.financeAmount)+"万元"||'--');$(".other-capital").text($yt_baseElement.fmMoney(datas.otherAmount)+"万元"||'--');$(".metaphase-target").html(datas.goalContent||"无");var midKpiInfoList=datas.midKpiInfoList;var trStr="";var htmlTbody=$('.metaphase-table .yt-tbody');if(midKpiInfoList&&midKpiInfoList!=''&&midKpiInfoList!=undefined){htmlTbody.empty();$.each(midKpiInfoList,function(i,n){trStr+='<tr><td oneTargetCode='+n.oneTargetCode+'>'+n.oneTargetName+'</td><td twoTargetCode='+n.twoTargetCode+'>'+n.twoTargetName+'</td><td threeTargetCode='+n.threeTargetCode+'>'+n.threeTargetName+'</td><td style="">'+n.prjTargetValue+'</td><td>'+(n.units||"--")+'</td></tr>'});htmlTbody.append(trStr)}else{htmlTbody.html(sysCommon.noDataTrStr(5))}}else{$yt_alert_Model.prompt('无中期目标')}},yearGoalInfo:function(datas){if(datas&&datas!=''&&datas!=undefined){$(".year-total").text($yt_baseElement.fmMoney(datas.totalAmount)+"万元"||'--');$(".year-finance").text($yt_baseElement.fmMoney(datas.financeAmount)+"万元"||'--');$(".year-other").text($yt_baseElement.fmMoney(datas.otherAmount)+"万元"||'--');$(".year-target").html(datas.goalContent||"无");var yearKpiInfoList=datas.yearKpiInfoList;var trStr="";var htmlTbody=$('.year-table .yt-tbody');if(yearKpiInfoList&&yearKpiInfoList!=''&&yearKpiInfoList!=undefined){htmlTbody.empty();$.each(datas.yearKpiInfoList,function(i,n){trStr+='<tr><td oneTargetCode='+n.oneTargetCode+'>'+n.oneTargetName+'</td><td twoTargetCode='+n.twoTargetCode+'>'+n.twoTargetName+'</td><td threeTargetCode='+n.threeTargetCode+'>'+n.threeTargetName+'</td><td style="">'+n.prjTargetValue+'</td><td>'+(n.units||"--")+'</td></tr>'});htmlTbody.append(trStr)}else{htmlTbody.html(sysCommon.noDataTrStr(5))}}else{$yt_alert_Model.prompt('无年度目标')}},showFileList:function(list){if(list.length>0){var ls='';var src='';$.each(list,function(i,n){var imgType=n.attName.split('.');if(imgType.length>1&&(imgType[1]=='png'||imgType[1]=='jpeg'||imgType[1]=='bmp'||imgType[1]=='jpg')){src=$yt_option.base_path+'fileUpDownload/download?pkId='+n.attId+'&isDownload=false';ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pv">预览<img src="'+src+'" ></label></div>'}else{ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pvno">预览</label></div>'}});$('#attIdStr').html(ls);$('#attIdStr .file-dw').on('click',function(){var id=$(this).parent().attr('fid');window.location.href=$yt_option.base_path+'fileUpDownload/download?pkId='+id+'&isDownload=true'});$('#attIdStr .file-pv img').showImg()}else{$("#attIdStr").html("暂无附件")}}};$(function(){demand.init()});
/**
 * 项目管理列表
 */
var caList={init:function(){$("#start-time").calendar({controlId:"startDate",nowData:false,upperLimit:$("#end-time")});$("#end-time").calendar({controlId:"endDate",nowData:false,lowerLimit:$("#start-time")});$("#endDate-time").calendar({controlId:"endDateTime",nowData:false,});caList.getPlanListInfo();caList.exportClass();caList.endDate();caList.setEndDate();caList.sendNotice();$('.list-table').on("click",".projectName",function(){var projectCode=$(this).parents("tr").find('.projectCode').text();var projectType=$(".yt-table-active .projectType").val();var pkId=$(this).parents("tr").find('.pkId').val();if(projectType==1||projectType==2||projectType==4){window.location.href="nonsatisfiedScore.html?projectCode="+projectCode+"&pkId="+pkId}if(projectType==3){window.location.href="nonsatisfiedScoreTrue.html?projectCode="+projectCode+"&pkId="+pkId}});$('#search-button').click(function(){caList.getPlanListInfo()})},getPlanListInfo:function(){var selectParam=$('#keyword').val();var endTimeStart=$('#start-time').val();var endTimeEnd=$('#end-time').val();$('.list-page').pageInfo({async:true,pageIndexs:1,pageNum:15,pageSize:10,url:$yt_option.base_path+"class/questionnaire/lookForAll",type:"post",data:{selectParam:selectParam,endTimeStart:endTimeStart,endTimeEnd:endTimeEnd},objName:'data',before:function(){$yt_baseElement.showLoading()},success:function(data){if(data.flag==0){var htmlTbody=$('.class-tbody');var htmlTr='';if(data.data.rows.length>0){$.each(data.data.rows,function(i,v){var projectType=v.projectType;switch(projectType){case '1':projectType='计划';break;case '2':projectType='委托';break;case '3':projectType='选学';break;case '4':projectType='调训';break;default:projectType='';break}var questionnaireStates=v.questionnaireStates;switch(questionnaireStates){case '1':v.questionnaireStates='未结束';break;case '2':v.questionnaireStates='已结束';break;case '3':v.questionnaireStates='已发送';break;default:v.questionnaireStates='';break}htmlTr+='<tr><td class="projectCode" style="word-wrap : break-word ;">'+v.projectCode+'</td><input type="hidden" value="'+v.pkId+'" class="pkId"><td style="text-align:left;"><a style="color: #3c4687;" class="projectName">'+v.projectName+'</a></td><input type="hidden" value="'+v.projectType+'" class="projectType"><td>'+projectType+'</td><td class="text-overflow" style="text-align:left">'+v.projectHead+'</td><td class="endTime" deadlineDate="'+v.deadlineDate+'">'+v.endTime+'</td><td style="text-align:right">'+v.checkCount+'</td><td style="text-align:right">'+v.questionnaireCount+'</td><td>'+questionnaireStates+'</td><td>'+v.populationQuestionnaire+'</td></tr>';});$('.list-page').show()}else{$('.list-page').hide();htmlTr+='<tr style="border:0px;background-color:#fff !important;" ><td colspan="9" align="center" style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>'}htmlTbody.html(htmlTr);$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}},isSelPageNum:true })},exportClass:function(){$('.btn-all').on('click','.exportList',function(){var downUrl=$yt_option.base_path+"class/questionnaire/exportClass";var selectParam=$('#keyword').val();$.ajaxDownloadFile({url:downUrl,data:{selectParam:selectParam,endTimeStart:'',endTimeEnd:''}})})},getTreeData:function(data,parentId){var me=this;var result=[],temp;for(var i in data){if(data[i].parentId==parentId){result.push(data[i]);temp=me.getTreeData(data,data[i].id);if(temp.length>0){data[i].children=temp}}}return result},sendNotice:function(){var me=this;var treeList=[];$('.sendNotice').on('click',function(){if($('.yt-table-active').index()=='-1'){$yt_alert_Model.prompt('请先选择需要推送的项目')}else{caList.showAlert5(".class-room-tye-shuttle-box")}});$.ajax({type:"post",url:$yt_option.base_path+"uniform/user/getUsers",async:true,data:{},success:function(data){$.each(data.data,function(i,n){n.userCode=n.textName});$("#tt").tree({data:me.getTreeData(data.data,"0"),formatter:function(node){if(node.type==3){treeList.push(node)}return node.text},animate:true,checkbox:true,onClick:function(node){console.log(node)}})}});function ajax(selectParams,type,func){$.ajax({type:"post",url:$yt_option.base_path+'class/questionnaire/getDeadlineSendUser',async:true,data:{types:type,selectParam:selectParams},success:function(data){func(data)}})}function bb(data){$yt_baseElement.hideLoading();$('#rightTree').empty();$.each(data.data,function(i,n){$('#rightTree').append('<li class="tree-node" userCode="'+n.userCode+'">'+n.userName+'</li>')})}ajax('',2,bb);$('.sendNotice-right ul').on('click','.tree-node',function(){if($(this).hasClass('tree-node-selected')){$(this).removeClass('tree-node-selected')}else{$(this).addClass('tree-node-selected')}});$('.sendNotice-right ul').on('mouseenter','.tree-node',function(){$(this).addClass('tree-node-hover')});$('.sendNotice-right ul').on('mouseout','.tree-node',function(){$(this).removeClass('tree-node-hover')});function addUser(nodes){$.each(nodes,function(k,v){var bool=true;$.each($('#rightTree .tree-node'),function(j,m){if(v.userCode==$(m).attr('usercode')){bool=false}});if(bool){if(v.type==3){$('#rightTree').append('<li class="tree-node" userCode="'+v.userCode+'">'+v.text+'</li>')}}})}$('#setleft').on('click',function(){$.each($('.sendNotice-right .tree-node'),function(i,n){if($(n).hasClass('tree-node-selected')){$(n).remove()}})});$('#setright').on('click',function(){var nodes=$('#tt').tree('getChecked');addUser(nodes)});$('#allsetleft').on('click',function(){$('#rightTree').empty()});$('#allsetright').on('click',function(){var sele=$('#tt').tree('getChecked',['checked','unchecked']);addUser(sele)});$('#saveUser').click(function(){var a=[];$.each($('.sendNotice-right .tree-node'),function(c,v){a.push($(v).attr('userCode'))});a=a.join(',');if(a!=''){caList.saveUser(a)}else{$yt_alert_Model.prompt('请选择需要保存的人员')}});$('#getUser').click(function(){$yt_baseElement.showLoading();ajax('',1,bb)});$('#sendNotice-submit').click(function(){var b=[];$.each($('.sendNotice-right .tree-node'),function(c,v){b.push($(v).attr('userCode'))});b=b.join(',');if(b!=''){caList.setUser(b)}else{$yt_alert_Model.prompt('请选择需要推送的人员')}})},endDate:function(){$('.endDate').click(function(){if($('.yt-table-active').index()=='-1'){$yt_alert_Model.prompt('请先选择需要设置的项目')}else{$('.endDate-projectCode').text('');$('.endDate-projectName').text('');$('#endDate-time').val('');$('.endDate-projectCode').text($('.yt-table-active .projectCode').text());$('.endDate-projectName').text($('.yt-table-active .projectName').text());$('#endDate-time').val($('.yt-table-active .endTime').attr('deadlineDate'));caList.showAlert5(".endDate-shuttle-box")}})},showAlert5:function(clas){$(clas).show();$yt_alert_Model.getDivPosition($(clas));$yt_alert_Model.setFiexBoxHeight($(clas+" .yt-edit-alert-main"));$yt_model_drag.modelDragEvent($(clas+" .yt-edit-alert-title"));$(clas+" .yt-model-canel-btn").off().on("click",function(){$(clas+",#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},setEndDate:function(){$('.endDate-btn').on('click',function(){console.log(1);if($('#endDate-time').val()==''){$yt_alert_Model.prompt('请选择结束日期')}else{$(".endDate-shuttle-box,#heard-nav-bak").hide();$("#pop-modle-alert").hide();$.ajax({type:"post",url:$yt_option.base_path+"class/questionnaire/updateDeadlineDate",async:true,data:{projectCode:$('.endDate-projectCode').text(),deadlineDate:$('#endDate-time').val()},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("修改成功",1000);caList.getPlanListInfo()}}})}})},saveUser:function(userCodes){$.ajax({type:"post",url:$yt_option.base_path+"class/questionnaire/saveDeadlineSendDefaultUser",async:true,data:{userCode:userCodes,types:1},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("保存成功",1000)}}})},setUser:function(userCodes){var projectCode=$('.yt-table-active').find('.projectCode').text();$.ajax({type:"post",url:$yt_option.base_path+"class/questionnaire/saveDeadlineSendDefaultUser",async:true,data:{userCode:userCodes,projectCode:projectCode,types:2},success:function(data){if(data.flag==0){$(".class-room-tye-shuttle-box,#heard-nav-bak").hide();$("#pop-modle-alert").hide();$yt_alert_Model.prompt("推送成功",1000)}}})}};$(function(){caList.init()});
var pmPlanQueryObj={orderDef:'../../../../../resources-sasac/images/module/order-def.png',orderAsc:'../../../../../resources-sasac/images/module/order-acs.png',orderDesc:'../../../../../resources-sasac/images/module/order-desc.png',userList:[],getUserList:function(){pmPlanQueryObj.userList=sysCommon.getUserAllInfo("","","");$("select.user-name-sel").html('<option value="">请选择</option>').niceSelect({search:true,backFunction:function(text){$("select.user-name-sel option").remove();$.each(pmPlanQueryObj.userList,function(i,n){if(n.userName.indexOf(text)!=-1){$("select.user-name-sel").append('<option value="'+n.userItcode+'">'+n.userName+'</option>')}})}})},init:function(){$("select").niceSelect();pmPlanQueryObj.getDeptList();pmPlanQueryObj.getUserList();$("#startDate").calendar({controlId:"startTime",nowData:false,upperLimit:$("#endDate"),speed:0,callback:function(){}});$("#endDate").calendar({controlId:"endTime",nowData:false,lowerLimit:$("#startDate"),speed:0,callback:function(){}});$("#repaymentDate").calendar({controlId:"startTime",nowData:false,upperLimit:$("#repaymentendDate"),speed:0,callback:function(){}});$("#repaymentendDate").calendar({controlId:"endTime",nowData:false,lowerLimit:$("#repaymentDate"),speed:0,callback:function(){}});$(".plan-list-model").css("min-height",$(window).height()-52-$(".heard-query-model").height());$(window).resize(function(){$(".plan-list-model").css("min-height",$(window).height()-52-$(".heard-query-model").height())})},fmMoney:function(str){return $yt_baseElement.fmMoney(str||'0')},rmoney:function(str){return $yt_baseElement.rmoney(str||'0')},eventFun:function(){$('#keyWord').on('keydown',function(){if($(this).val()!=''){$('.clearImg').show()}});$('.clearImg').on('click',function(){$('#keyWord').val('');$(this).hide()});$("#resetBtn").on("click",function(){$(".heard-query-model input").val('');$(".heard-query-model select").each(function(){$(this).find("option:eq(0)").prop("selected","selected")});$(".heard-query-model select").niceSelect();$('.clearImg').hide();$('#keyWord').val('')});$('.checkbox-state,.checkbox-quota,.checkbox-term').change(function(){pmPlanQueryObj.getBeforehandList()})},switchtimeclick:function(){$(".sort-span").on("click",function(){var img=$(this).find('img');var src=img.attr("src");var code=$(this).attr('code');$(".sort-span img").attr('src',pmPlanQueryObj.orderDef);if(src==pmPlanQueryObj.orderAsc){img.attr("src",pmPlanQueryObj.orderDesc);pmPlanQueryObj.getBeforehandList('DESC',code)}else if(src==pmPlanQueryObj.orderDesc||src==pmPlanQueryObj.orderDef){img.attr("src",pmPlanQueryObj.orderAsc);pmPlanQueryObj.getBeforehandList('ASC',code)}})},switchloanclick:function(){$(".loan-img").on("click",function(){var src=$(".loan-img").attr("src");if(src=="../../../../../resources-sasac/images/module/order-acs.png"){$(".loan-img").attr("src","../../../../../resources-sasac/images/module/order-desc.png")}else if(src=="../../../../../resources-sasac/images/module/order-desc.png"){$(".loan-img").attr("src","../../../../../resources-sasac/images/module/order-acs.png")}})},switchrepaymentclick:function(){$(".repayment-img").on("click",function(){var src=$(".repayment-img").attr("src");if(src=="../../../../../resources-sasac/images/module/order-acs.png"){$(".repayment-img").attr("src","../../../../../resources-sasac/images/module/order-desc.png")}else if(src=="../../../../../resources-sasac/images/module/order-desc.png"){$(".repayment-img").attr("src","../../../../../resources-sasac/images/module/order-acs.png")}})},switchnonrepaymentclick:function(){$(".nonrepayment-img").on("click",function(){var src=$(".nonrepayment-img").attr("src");if(src=="../../../../../resources-sasac/images/module/order-acs.png"){$(".nonrepayment-img").attr("src","../../../../../resources-sasac/images/module/order-desc.png")}else if(src=="../../../../../resources-sasac/images/module/order-desc.png"){$(".nonrepayment-img").attr("src","../../../../../resources-sasac/images/module/order-acs.png")}})},moneyFormat:function(){$(".top-money,.bottom-money").on("focus",function(){if($(this).val()!=""){$(this).val($yt_baseElement.rmoney($(this).val()))}});$(".top-money,.bottom-money").on("blur",function(){if($(this).val()!=""){$(this).val($yt_baseElement.fmMoney($(this).val()))}})},multiSelection:function(){var str='';$('.checkbox-state').each(function(i,n){if(n.checked){var s=$(n).val();str+=s+','}});str=str.substring(0,str.length-1);return str},quotaCheck:function(){var str='';$('.checkbox-quota').each(function(i,n){if(n.checked){var s=$(n).val();str+=s+','}});str=str.substring(0,str.length-1);return str},termCheck:function(){var str='';$('.checkbox-term').each(function(i,n){if(n.checked){var s=$(n).val();str+=s+','}});str=str.substring(0,str.length-1);return str},queryBeforehand:function(){$("#heardSearchBtn").on("click",function(){pmPlanQueryObj.getBeforehandList()})},getBeforehandList:function(order,property){order=order||'DESC';property=property||'m.APPLICANT_TIME';var keyWord=$('.keyword-input').val();var applicant=$('select.user-name-sel option:selected').val();var modeType=$('select.cost-types option:selected').val();var department=$('select.department option:selected').val();var applyMoneyTop=($('.top-money').val()==""?"":($yt_baseElement.rmoney($('.top-money').val())));var applyMoneyBottom=($('.bottom-money').val()==""?"":($yt_baseElement.rmoney($('.bottom-money').val())));var applyDateTop=$('#startDate').val();var applyDateBottom=$('#endDate').val();var repaymentDate=$('#repaymentDate').val();var repaymentendDate=$('#repaymentendDate').val();var state=pmPlanQueryObj.multiSelection();var quota=pmPlanQueryObj.quotaCheck();var term=pmPlanQueryObj.termCheck();$('.table-page').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:'sz/loanApp/getTotalLoanAppQueryByParams',type:"post",data:{queryStateParams:state,queryParams:keyWord,userCode:applicant,deptId:department,startDate:applyDateTop,endDate:applyDateBottom,startAmount:applyMoneyTop,endAmount:applyMoneyBottom,paymentMethod:modeType,startRefundDate:repaymentDate,endRefundDate:repaymentendDate,isSettle:quota,loanTerm:term,property:property,direction:order},success:function(data){var datas=data.data.rows;var htmlTbody=$('#loanApplyTable tbody');htmlTbody.empty();var trStr="";if(data.flag==0){$(".loan-all-amount").text((data.data.loanAllAmount==""?"":$yt_baseElement.fmMoney(data.data.loanAllAmount)));$(".unRefund-all-amount").text((data.data.unRefundAllAmount==""?"":$yt_baseElement.fmMoney(data.data.unRefundAllAmount)));if(datas.length>0){$('.table-page').show();var payMethod="";$.each(datas,function(i,n){trStr+='<tr><input class="processInstanceId" type="hidden" value="'+n.processInstanceId+'"/><td>'+n.applicateTime+'</td><td>'+n.appNum+'</td><td style="text-align: left;">'+n.appName+'</td><td style="text-align: right;">'+(n.totalAmount==""?"":$yt_baseElement.fmMoney(n.totalAmount))+'</td><td>'+n.applicantUserName+'</td><td>'+n.applicantUserDeptName+'</td>';if(n.paymentMethod==1){payMethod="现金"}else if(n.paymentMethod==2){payMethod="支票"}else if(n.paymentMethod==3){payMethod="转账"}trStr+='<td>'+payMethod+'</td><td>'+n.loanTerm+'</td><td>'+n.refundTime+'</td><td>'+n.workFlowState+'</td><td>'+n.isSettle+'</td><td style="text-align: right;">'+(n.unRefundAmount==""?"":$yt_baseElement.fmMoney(n.unRefundAmount))+'</td><td><a class="yt-link log-mod">查看</a></td></tr>'});htmlTbody.append(trStr);pmPlanQueryObj.initQtip();}else{$('.table-page').hide();htmlTbody.append(pmPlanQueryObj.noDataTrStr(13))}}},isSelPageNum:true })},noDataTrStr:function(trNum){var noDataStr='<tr style="border:0px;background-color:#fff !important;"><td  colspan="'+trNum+'" align="center"style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';return noDataStr},clearBtn:function(){$('.yt-reset-btn').on('click',function(){pmPlanQueryObj.clearAlert($(".loadApp"));pmPlanQueryObj.getBeforehandList()})},clearAlert:function(obj){var selects=obj.find('select:not(.user-name-sel)');$.each(selects,function(i,n){$(n).find('option:eq(0)').attr('selected',true)});selects.niceSelect();pmPlanQueryObj.getUserList();var check1=obj.find('.checkbox-state');$.each(check1,function(i,n){$(n).setCheckBoxState("uncheck")});var check2=obj.find('.checkbox-quota');$.each(check2,function(i,n){$(n).setCheckBoxState("uncheck")});var check3=obj.find('.checkbox-term');$.each(check3,function(i,n){$(n).setCheckBoxState("uncheck")});var inputs=obj.find('input:not(input[type="checkbox"])');inputs.val('')},getDeptList:function(code){$.ajax({type:"post",url:"user/userInfo/getAllDeptsInfo",async:true,success:function(data){var list=data.data||[];var opts='<option value="">请选择</option>';$.each(list,function(i,n){if(n.type==2){if(code&&code==n.id){opts+='<option selected="selected" value="'+n.id+'">'+n.text+'</option>'}else{opts+='<option value="'+n.id+'">'+n.text+'</option>'}}});$('.department').html(opts).niceSelect()}})},initQtip:function(){$('.log-mod').qtip({content:{text:function(event,api){var txt='';var WorkFlowLogList=[];var thisTr=$(this).parents("tr");var processInstanceId=thisTr.find('.processInstanceId').val();$.ajax({type:"post",url:"basicconfig/workFlow/getWorkFlowLog",async:false,data:{processInstanceId:processInstanceId},success:function(data){if(data.data!=undefined&&data.data!=null){WorkFlowLogList=data.data}if(WorkFlowLogList==null||WorkFlowLogList==undefined){return}shomd="";shomd='<div class="suspension" >';var WorkFlowLog;for(var i=0;i<WorkFlowLogList.length;i+=1){WorkFlowLog=WorkFlowLogList[i];if(i==0){shomd+='<div class="log-msg-model"><div><div class="first-log-msg"><span class="log-num">'+(WorkFlowLogList.length-i)+'</span></div><span class="user-name">'+(WorkFlowLog.userName==""?'无':WorkFlowLog.userName)+'</span><div style="clear:both;"></div></div><div class="log-line-div" style="'+(i==(WorkFlowLogList.length-1)?"padding-bottom: 0px;":"padding-bottom: 10px;")+''+(WorkFlowLogList.length==1?"border:0px;":"")+'"><div style="'+(WorkFlowLogList.length==1?"border:0px;":"border-bottom: 1px solid #D6E6F3;")+'"><div class="oper-status-model"><label class="log-label-text">操作状态</label><span>：</span><span>'+(WorkFlowLog.taskName==""?"无":WorkFlowLog.taskName)+'</span></div><div class="oper-time-model"><label class="log-label-text">操作时间</label><span>：</span><span>'+(WorkFlowLog.commentTime==""?"无":WorkFlowLog.commentTime)+'</span></div>';if(WorkFlowLog.comment!=""&&WorkFlowLog.comment!=null&&WorkFlowLog.comment!=" "){shomd+='<div class="log-comment-model"><label class="log-label-text">操作意见</label><span>：</span><div class="oper-comment-msg">'+WorkFlowLog.comment+'</div></div>'}shomd+='</div></div>'}else{shomd+='<div class="log-msg-model"><div><div class="log-msg-def-bak"><span class="log-num">'+(WorkFlowLogList.length-i)+'</span></div><span class="user-name" style="top:0px;">'+(WorkFlowLog.userName==""?'无':WorkFlowLog.userName)+'</span><div style="clear:both;"></div></div><div class="log-line-div" style="'+(i==(WorkFlowLogList.length-1)?"padding-bottom: 0px;":"padding-bottom: 10px;")+''+(i==(WorkFlowLogList.length-1)?"border:0px;":"")+'"><div style="'+(i==(WorkFlowLogList.length-1)?"border:0px;":"border-bottom: 1px solid #D6E6F3;")+'"><div class="oper-status-model"><label class="log-label-text">操作状态</label><span>：</span><span>'+(WorkFlowLog.taskName==""?"无":WorkFlowLog.taskName)+'</span></div><div class="oper-time-model"><label class="log-label-text">操作时间</label><span>：</span><span>'+(WorkFlowLog.commentTime==""?"无":WorkFlowLog.commentTime)+'</span></div>';if(WorkFlowLog.comment!=""&&WorkFlowLog.comment!=null&&WorkFlowLog.comment!=" "){shomd+='<div class="log-comment-model"><label class="log-label-text">操作意见</label><span>：</span><div class="oper-comment-msg">'+WorkFlowLog.comment+'</div></div>'}shomd+='</div></div>'}shomd+='</div>'}}});return(WorkFlowLogList.length<1?'<span style="color:#999">暂无数据</span>':shomd);}},position:{my:'right top',at:'left top',container:false,viewport:$('body'),adjust:{x:0,y:0,mouse:true,resize:true,method:'flip flip'}},hide:{fixed:true,},style:{classes:'showmod',tip:{corner:true,mimic:false,width:10,height:10,border:true,offset:0}},events:{show:function(data){$(data.target).find(".qtip-content").css("max-height",$('#frame-right-model').height()-200)}}})}};$(function(){pmPlanQueryObj.init();pmPlanQueryObj.eventFun();pmPlanQueryObj.switchtimeclick();pmPlanQueryObj.moneyFormat();pmPlanQueryObj.queryBeforehand();pmPlanQueryObj.getBeforehandList();pmPlanQueryObj.clearBtn()});
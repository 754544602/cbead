var billListInfo = {

	//初始化方法
	init: function() {
		
		//对账单信息列表
		billListInfo.getBillListInfo();
		//获取所有下拉框项目数据
		billListInfo.getProjectInfo();
		$(".bank-more-div").on("click",function() {
			if($(".bank-more-div").text() == "查看更多") {
				$('.bank-more-div').text("收起");
				$(".bank-th-hide").show();
				$(".bank-tbody-td").attr("colspan", "18");
			} else{
				$('.bank-more-div').text("查看更多");
				$(".bank-th-hide").hide();
				$(".bank-tbody-td").attr("colspan", "7");
			}
		});
		//认领记录
		$(".claim-record").click(function(){
			if($(".yt-table-active").length != 0) {
				var pkId = $(".yt-table-active").find(".pkId").val();
				window.location.href = "claimRecord.html?pkId="+pkId;
			}else{
				$yt_alert_Model.prompt("请选择一行数据！");
			}
		});
		//模糊查询
		$(".search-btn").click(function(){
			billListInfo.groupOrPerson();
		});
		//认领弹窗
		$(".admission-manual").click(function() {
			if($(".yt-table-active").length != 0) {
				//其他班级弹窗样式设置
				$(".alert-table-div").show();
				$(".alert-div-input").show();
				$("#confiscate-amount").hide();
				$("#user-name").css({
					float: "left",
					'margin': "0px 0px 0px 20px"
				});
				$("#last-amount").css({
					float: "left",
					'margin': "0px 0px 0px 100px"
				});
				$(".select-teacher-div").width("1100px");
				$(".yt-edit-alert-main").height("736px");
	
				//显示选择所属项目弹出框
				$(".select-teacher-div").show();
				//查询选择所属项目列表
				//计算弹出框位置
				$yt_alert_Model.setFiexBoxHeight($(".select-teacher-div .yt-edit-alert-main"));
				$yt_alert_Model.getDivPosition($(".select-teacher-div"));
				$yt_model_drag.modelDragEvent($(".select-teacher-div .yt-edit-alert-title"));
				$("select").niceSelect();
				//取消按钮
				$('.select-teacher-canel-btn').click(function() {
					$(".yt-edit-alert,#heard-nav-bak").hide();
					$("#pop-modle-alert").hide();
				});
			}else{
				$yt_alert_Model.prompt("请选择一行数据！");
			}
		});
		$(".admission-sure").click(function() {
			//其他班级弹窗样式设置
			$(".alert-table-div").hide();
			$(".alert-div-input").hide();
			$("#confiscate-amount").show();
			$("#user-name").css({
				float: "none",
				'margin': "8px 48px 8px 84px"
			});
			$("#last-amount").css({
				float: "none",
				'margin': "8px 0px 8px 42px"
			});
			$("#form-class").css({
				float: "none",
				'margin': "8px 48px 8px 84px"
			});
			$(".select-teacher-div").width("auto");
			$(".yt-edit-alert-main").height("auto");

			//显示选择所属项目弹出框
			$(".select-teacher-div").show();
			//查询选择所属项目列表
			//计算弹出框位置
			$yt_alert_Model.setFiexBoxHeight($(".select-teacher-div .yt-edit-alert-main"));
			$yt_alert_Model.getDivPosition($(".select-teacher-div"));
			$yt_model_drag.modelDragEvent($(".select-teacher-div .yt-edit-alert-title"));
			$("select").niceSelect();
			//取消按钮
			$('.select-teacher-canel-btn').click(function() {
				$(".yt-edit-alert,#heard-nav-bak").hide();
				$("#pop-modle-alert").hide();
			});
		});
		//班级项目下拉框点击事件
		$('.class-select').change(function(){
			var classData = $(this).find("option:selected").data("classData");
			
			//在页面隐藏项目类型用于模糊查询判断
			$('.hid-project-type').val(classData.projectType);
			//调用单位列表查询
			billListInfo.getPlanListInfo();
			//调用个人信息列表
			billListInfo.groupOrPerson();
			//
			billListInfo.getNotReconciliations();
		});
		//单位列表复选框点击事件
		$(".company-table").on('click','.select-checkbox',function(){//当前行的隐藏input只要值不为空当前行都是被选中的
			var states = $(this).parent().find(".states").val();
			//隐藏的input的值为0，是被删除的，值为1是已经认领的，值为2是新增的
			if (states == 1) {//已经认领
				$(this).parent().find(".states").val(0);//已经被认领的取消选中，该条信息被标识为删除0
			}else if (states == 0){//院被删除的在标识为1，原来被删除的有重新被勾选
				$(this).parent().find(".states").val(1);
			}else if (states == 2){//值为2当前行信息是将要认领的数据
				$(this).parent().find(".states").val("");
			}else{//当前行input值为空，没被勾选
				$(this).parent().find(".states").val(2);
			}
		});
		//个人信息列表复选框点击事件
		$(".person-table").on('click','.select-checkbox',function(){
			var states = $(this).parent().find(".states").val();
			//隐藏的input的值为0，是被删除的，值为1是已经认领的，值为2是新增的
			if (states == 1) {//已经认领
				$(this).parent().find(".states").val(0);//已经被认领的取消选中，该条信息被标识为删除0
			}else if (states == 0){//院被删除的在标识为1，原来被删除的有重新被勾选
				$(this).parent().find(".states").val(1);
			}else if (states == 2){//值为2当前行信息是将要认领的数据
				$(this).parent().find(".states").val("");
			}else{//当前行input值为空，没被勾选
				$(this).parent().find(".states").val(2);
			}
		});
		//点击认领提交方法
		$('.select-teacher-sure-btn').click(function(){
			billListInfo.getAllClaimFn();
		});
	},
	//认领提交
	getAllClaimFn:function(){
		var companyTr = $('.company-table tbody').children();
		var personTr = $('.person-table tbody').children();
		var projectCode = $('.class-select').val();
		var paymentListDeleteArr = [];
		var paymentListAddArr = [];
		var uncollectedTotal = [];
		var paymentValue = "";
		//遍历单位列表
		$.each(companyTr, function(i,c) {
			if($(c).find(".states").val() == 0){//删除的
				paymentValue = $(c).find(".group-id").val();
				var paymentListDeleteJson = {
						paymentType:"1",
						paymentValue:paymentValue
					};
				paymentListDeleteArr.push(paymentListDeleteJson);
			};
			if($(c).find(".states").val() == 2){//新增的
				paymentValue = $(c).find(".group-id").val();
				var paymentListAddArrJson = {
						paymentType:"1",
						paymentValue:paymentValue
					}
				paymentListAddArr.push(paymentListAddArrJson);
			};
			
		});
		//遍历个人详情列表
		$.each(personTr, function(j,k) {
			if($(k).find(".states").val() == 0){
				paymentValue = $(j).find(".select-trainee-pkId").val();
				paymentListDeleteJson = {
					paymentType:"2",
					paymentValue:paymentValue
				};
				paymentListDeleteArr.push(paymentListDeleteJson);
			};
			if($(k).find(".states").val() == 2){//新增的
				paymentValue = $(k).find(".select-trainee-pkId").val();
				var paymentListAddArrJson = {
						paymentType:"2",
						paymentValue:paymentValue
					}
				paymentListAddArr.push(paymentListAddArrJson);
			};
			
		});
		var paymentListDeleteArrJson = JSON.stringify(paymentListDeleteArr);
		var paymentListAddArrJson = JSON.stringify(paymentListAddArr);
		var uncollectedTotal ="";
		var projectCode = $('.class-select').val();
		var identifications = $(".yt-table-active").find(".identifications");
		var bankStatementDetailsIds = $(".yt-table-active").find(".pkId");
		$.ajax({
			async: true,
			url: $yt_option.base_path + "finance/projectStatement/addNotReconciliations", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				projectCode: projectCode,
				bankStatementDetailsIds:bankStatementDetailsIds,
				identifications:identifications,
				paymentListDelete:paymentListDeleteArrJson,
				paymentListAdd:paymentListAddArrJson,
				uncollectedTotal:""
			}, //ajax查询访问参数
			before: function() {
				$yt_baseElement.showLoading();
			},
			success: function(data) {
				if(data.flag == 0) {
					$yt_baseElement.hideLoading();
				}else{
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("认领失败");
					});
				}
			}, 
		});
	},
	//选择所属项目之后获取已经对账的数据
	getNotReconciliations:function(){
		//获取所有单位行
		var companyTr = $('.company-table tbody').children();
		//获取所有个人信息行
		var personTr = $('.person-table tbody').children();
		var projectCode = $('.class-select').val();
		var identifications = $(".yt-table-active").find(".identifications").val();
		$.ajax({
			async: true,
			url: $yt_option.base_path + "finance/projectStatement/getProjectStatementByProjectCode", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				projectCode:projectCode,
				identifications: identifications
			}, //ajax查询访问参数
			before: function() {
				$yt_baseElement.showLoading();
			},
			success: function(data) {
				if (data.flag == 0) {
					if (data.data != null) {
						$.each(data.data,function(i,v){
							if (data.data.paymentType == 1) {//单位
								$.each(companyTr,function(j,c){
									if($(c).find(".group-id").val() == v.paymentValue){
										$(c).find(".check-label").addClass("check");
										$(c).find(".states").val(1);//隐藏input值为1标识为是原本已经存在的对账
									}
								});
							}else{//人员
								$.each(personTr,function(k,p){
									if($(p).find(".select-trainee-pkId").val() == v.paymentValue){
										$(p).find(".check-label").addClass("check");
										$(p).find(".states").val(1);//隐藏input值为1标识为是原本已经存在的对账
									}
								});
							}
						});
					}
					
				}
				

			}, //回调函数 匿名函数返回查询结果  
		});
	},
	//获取所有班级
	groupOrPerson:function(){
		//获取项目类型， 1:计划 2:委托 3:选学 4:调训
		var projectType = $('.hid-project-type').val();
		//判断项目类型调用对应项个人详情列表
		if (projectType == 3 || projectType == 4) {
			//调用选学和委托方法
			billListInfo.getAlertListInfoDepute();
		}else{
			//调用计划和调训方法
			billListInfo.getAlertListInfoPlan();
		}
	},
	
	/**
	 * 对账单信息列表
	 */
	getBillListInfo: function() {
		$yt_baseElement.showLoading();
		var keyword = $('.selectParam').val();
		$('.page-info').pageInfo({
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "project/getBankStatementList", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				selectParam: keyword
			}, //ajax查询访问参数
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.project-tbody');
					var htmlTr = '';
					htmlTbody.empty();
					if(data.data.rows.length > 0) {
						$.each(data.data.rows, function(i, v) {
							htmlTr += '<tr>' +
								'<td><input type="hidden" value="' + v.pkId + '" class="pkId">' + i + '</td>' +
								'<td><input type="hidden" class="identifications" value="'+v.identification+'"/>' + v.exchangeHour + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.draw + '</td>' +
								'<td style="text-align:right">' + v.income + '</td>' +
								'<td style="text-align:left">' + v.otherPartyName + '</td>' +
								'<td>' + v.remarks + '</td>' +
								'<td>' + v.otherPartyAccounts + '</td>' +
								'<td>' + v.otherPartyGroup + '</td>' +
								
								'<td class="bank-th-hide" style="display:none">' + v.balance + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.currency + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.accountDate + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.abstractData + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.bankTradeNumber + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.enterpriseTradeNumber + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.voucherType + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.voucherNo + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.associatedAccount + '</td>' +
								'<td class="bank-th-hide" style="display:none">' + v.alias + '</td>' +
								'</tr>';
								
								
//								htmlTr = '<tr>' +
//								'<td style="text-align: center;display:none;">' +
//								'<label class="check-label yt-checkbox select-teacher-checkbox"><input type="checkbox" name="test" class="select-teacher-pkId" value="' +v.projectCode + '"/></label>' + '</td>' +
//								'<td>' + i + '</td>' +
//								'<td><input type="hidden" class="identifications" value="'+v.identification+'"/>' + v.exchangeHour + '</td>' +
//								'<td class="bank-th-hide" style="text-align:right;display:none">' + '3400.00' + '</td>' +
//								'<td style="text-align:right">' + v.income + '</td>' +
//								'<td class="bank-th-hide" style="text-align:right;display:none">' + '50000.00' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '人名币元' + '</td>' +
//								'<td style="text-align:left">' + v.otherPartyName + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '2015-12-12' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '人民币卡消费款' + '</td>' +
//								'<td>' + '收单清算款105210282200085' + '</td>' +
//								'<td>' + '6228543444345321' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '27130-21228008916TPTNITU0' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '27130-21228008916TPTNITU0' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '电汇凭证' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '2284875' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + '21201501910059106618' + '</td>' +
//								'<td class="bank-th-hide" style="display:none">' + 'QAQ' + '</td>' +
//								'<td>' + '建行大连栾金支行' + '</td>' +
//								'</tr>';
						});
					}else{
						htmlTbody.empty();
						htmlTr = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="7" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
						}
						htmlTbody.append(htmlTr);
						$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	//认领弹弹窗单位列表
	getPlanListInfo: function() {
		$yt_baseElement.showLoading();
		var projectCode = $('.class-select').val();
		$('.page-info').pageInfo({
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "finance/settlement/getNoDetailedList", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				projectCode: projectCode
			}, //ajax查询访问参数
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.company-tbody');
					var htmlTr = '';
					var num = 1;
					htmlTbody.empty();
					if(data.data.length > 0) {
						var states;
						var projectStates;
						$.each(data.data, function(i, v) {
							htmlTr += '<tr>' +
								'<td style="text-align: center;">' +
								'<input type="hidden" class="states"/>'+
								'<label class="check-label yt-checkbox select-checkbox">'+
									'<input type="checkbox" name="test" class="group-id" value="'+v.groupId+'"/></label>' +
								'</td>' +
								'<td style="text-align:left">' + v.settlementGroupDetails.groupName + '</td>' +
								'<td style="text-align:right">' + v.settlementGroupDetails.amountReceivable + '</td>' +
								'<td style="text-align:right">' + v.settlementGroupDetails.netReceipts + '</td>' +
								'<td style="text-align:right">' + v.settlementGroupDetails.uncollected + '</td>' +
								'</tr>';
							
						});
					}else{
						htmlTbody.empty();
						htmlTr = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="5" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
							$('.page-info').hide();
						}
					htmlTbody.append(htmlTr);
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	/**
	 * 认领弹窗选学和委托个人信息列表
	 */
	getAlertListInfoDepute: function() {
		//获取项目code
		var projectCode = $(".class-select").val();
		var keyword = $('#keyword').val();
		$yt_baseElement.showLoading();
		$('.page-info').pageInfo({
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "finance/settlement/getDetailedPersonalList", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				projectCode: projectCode,
				selectParam:keyword
			}, //ajax查询访问参数
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.person-tbody');
					var htmlTr = '';
					htmlTbody.empty();
					if(data.data.rows.length > 0) {
						var states;
						var projectStates;
						$.each(data.data.rows, function(i, v) {
							htmlTr += '<tr>' +
								'<td style="text-align: center;">' +
									'<input type="hidden" class="states"/>'+
									'<label class="check-label yt-checkbox select-checkbox">'+
										'<input type="checkbox" name="test" class="select-trainee-pkId" value="' +v.traineeId + '"/></label>' +
								'</td>' +
								'<td style="text-align:left">' + v.realName + '</td>' +
								'<td style="text-align:right">' + v.gender + '</td>' +
								'<td style="text-align:right">' + v.groupName + '</td>' +
								'<td style="text-align:right">' + v.groupOrgName + '</td>' +
								'<td style="text-align:right">' + v.trainingExpenseNegotiatedPrice + '</td>' +
								'<td style="text-align:right">' + v.cash + '</td>' +
								'<td style="text-align:right">' + v.uncollected + '</td>' +
								'</tr>';
							
						});
					}else{
						htmlTbody.empty();
						htmlTr = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="9" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
						}
					htmlTbody.append(htmlTr);
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	//计划和调训个人信息列表
	getAlertListInfoPlan: function() {
		//获取项目code
		var projectCode = $(".class-select").val();
		var keyword = $('#keyword').val();
		$yt_baseElement.showLoading();
		$('.page-info').pageInfo({
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "finance/settlement/getNoDetailedPersonalList", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				projectCode: projectCode,
				selectParam:keyword
			}, //ajax查询访问参数
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.person-tbody');
					var htmlTr = '';
					htmlTbody.empty();
					if(data.data.rows.length > 0) {
						var states;
						var projectStates;
						$.each(data.data.rows, function(i, v) {
							htmlTr += '<tr>' +
								'<td style="text-align: center;">' +
									'<input type="hidden" class="states"/>'+
									'<label class="check-label yt-checkbox select-teacher-checkbox">'+
									'	<input type="checkbox" name="test" class="select-trainee-pkId" value="' +v.traineeId + '"/></label>' +
								'</td>' +
								'<td style="text-align:left">' + v.realName + '</td>' +
								'<td style="text-align:right">' + v.gender + '</td>' +
								'<td style="text-align:right">' + v.groupName + '</td>' +
								'<td style="text-align:right">' + v.groupOrgName + '</td>' +
								'<td style="text-align:right">' + v.trainingExpenseNegotiatedPrice + '</td>' +
								'<td style="text-align:right">' + v.otherCost + '</td>' +
								'<td style="text-align:right">' + v.netReceipts + '</td>' +
								'<td style="text-align:right">0.00</td>' +
								'</tr>';
						});
					}else{
						htmlTbody.empty();
						htmlTr = '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="9" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
						}
					htmlTbody.append(htmlTr);
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	//项目类型设置
	projectTypeInfo: function(code) {
		if(code == 1) {
			return "计划";
		} else if(code == 2) {
			return "委托";
		} else if(code == 3) {
			return "选学";
		} else if(code == 4) {
			return "调训";
		} else {
			return '';
		};
	},
	//获取所属项目下拉列表
	getProjectInfo: function() {
		$yt_baseElement.showLoading();
		var selectParam = "";
		$.ajax({
			async: true,
			url: $yt_option.base_path + "finance/projectStatement/getProjects", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				selectParam: selectParam,
			}, //ajax查询访问参数
			objName: 'data', //指获取数据的对象名称  
			before: function() {
				$yt_baseElement.showLoading();
			},
			success: function(data) {
				if(data.flag == 0) {
					if(data.data && data.data && data.data.length > 0) {
						//遍历给下拉框添加数据
						$.each(data.data, function(i, v) {
							$("select.class-select").append($('<option value="' + v.projectCode + '">' + v.projectName + '</option>').data("classData", v));
						});
						$('select.class-select').niceSelect();
					}
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function() {
						$yt_alert_Model.prompt("查询失败");
						$yt_baseElement.hideLoading();
					});
				}

			}, //回调函数 匿名函数返回查询结果  
		});
	}
}
$(function() {
	//初始化方法
	billListInfo.init();
});
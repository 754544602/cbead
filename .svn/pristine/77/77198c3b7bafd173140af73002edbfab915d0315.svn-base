/**
 * 办班动态相关数据
 */
var caList = {
	//初始化方法
	init: function() {
		$("#start-time").calendar({  
		    controlId: "startDate",  
		    nowData:false,//默认选中当前时间,默认true  
		    upperLimit:$("#end-time"), //开始日期最大为结束日期  
		    callback: function() { // 点击选择日期后的回调函数  
		    	caList.getPlanListInfo();
		    }  
		});  
		$("#end-time").calendar({  
		    controlId: "endDate",  
		    nowData:false,//默认选中当前时间,默认true  
		    lowerLimit:$("#start-time"), //结束日期最小为开始日期  
		    callback: function() { // 点击选择日期后的回调函数  
		    	caList.getPlanListInfo();
		    } 
		});
			
		
		//调用获取列表数据方法
		caList.getPlanListInfo();
		caList.getExportList();
		//多选框点击事件
		$('#checkBox1').click(function(){
			caList.getClassDynamicList();
		});
		$('#checkBox2').click(function(){
			caList.getClassDynamicList();
		});
		$('#checkBox3').click(function(){
			caList.getClassDynamicList();
		});
	},
	
	/**
	 * 班次统计和全年占比(柱形图)
	 */
	getPlanListInfo: function() {
		var statisticsStart = $('#start-time').val();
		var statisticsEnd = $('#end-time').val();
		var downUrl = $yt_option.base_path + "class/getClassDynamic";
		$.post(downUrl,{'statisticsStart':statisticsStart,'statisticsEnd':statisticsEnd},function(data){
			if(data.flag == 0) {
				var classStatisticsBarName=['计划','委托','选学','调训'];//柱状图
				var classStatisticsBarValue=[];//柱状图
				var barxAxis =data.data.classStatisticsBar.xAxis;//柱状图横坐标
				var barxNoFinished =data.data.classStatisticsBar.noFinished;//柱状图数据未完成
				var barxFinished =data.data.classStatisticsBar.finished;//柱状图数据已完成
				var noFinishedName =[]; //未完成存储类型（1计划,2委托,3选学,4调训）
				var noFinishedValue =[]; //未完成存储类型（1计划,2委托,3选学,4调训）
				var noFinishedResValue =[]; //返回的数据（未完成）
				var finishedName =[]; //已完成存储类型（1计划,2委托,3选学,4调训）
				var finishedValue =[]; //已完成存储类型（1计划,2委托,3选学,4调训）
				var finishedResValue =[]; //返回的数据（已完成）
				//柱状图数据 未完成
				$.each(barxNoFinished,function(k,v){
					var n = k+1;
					if (v.projectType== n){
						noFinishedValue.push(v.count);
					}else{
						noFinishedValue.push(0);
					}
					noFinishedName.push(Number(v.projectType));
				});
				//柱状图数据 已完成
				$.each(barxFinished,function(k,v){
					var n = k+1;
					if (v.projectType== n){
						finishedValue.push(v.count);
					}else{
						finishedValue.push(0);
					}
					finishedName.push(Number(v.projectType));
				});
				
				for (var i=0;i<4;i++){
					//柱状图横坐标
					var projectValue=barxAxis[i].count;
					if (projectValue ==null){
						projectValue ='0';
					}
					if (i==0){
						classStatisticsBarName[i]='计划'+projectValue;
						classStatisticsBarValue.push(projectValue);
					}
					if (i==1){
						classStatisticsBarName[i]='委托'+projectValue;
						classStatisticsBarValue.push(projectValue);
					}
					if (i==2){
						classStatisticsBarName[i]='选学'+projectValue;
						classStatisticsBarValue.push(projectValue);
					}
					if (i==3){
						classStatisticsBarName[i]='调训'+projectValue;
						classStatisticsBarValue.push(projectValue);
					}
					
					//柱状图数据 未完成
					var num = i+1;
					if (caList.getData(num, noFinishedName)){
						noFinishedResValue.push(num);
					}else{
						noFinishedResValue.push(0);
					}
					//柱状图数据 未完成
					var num = i+1;
					if (caList.getData(num, finishedName)){
						finishedResValue.push(num);
					}else{
						finishedResValue.push(0);
					}
				}
				var classStatisticsPie = data.data.classStatisticsPie;//饼图
				var myChart = echarts.init($('.drawing-1').get(0));
				option = {
				    tooltip : {
				        trigger: 'axis',
				        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
				            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
				        }
				    },
				    grid: {
				        left: '3%',
				        bottom: '3%',
				        containLabel: true
				    },
				    yAxis:  {
				        type: 'value'
				    },
				    xAxis: {
				        type: 'category',
				        data: classStatisticsBarName
				    },
				    series: [
				        {
				            name: '未完成',
				            type: 'bar',
				            barMaxWidth:40,
				            stack: '总量',
				            label: {
				                normal: {
				                    show: true,
				                    position: 'insideRight'
				                }
				            },
				            data: noFinishedResValue //未完成
				        },
				        {
				            name: '已完成',
				            type: 'bar',
				            stack: '总量',
				            label: {
				                normal: {
				                    show: true,
				                    position: 'insideRight'
				                }
				            },
				            data: finishedResValue//项目已立项已完成
				        }
				    ]
				};
				// 使用刚指定的配置项和数据显示图表。
				myChart.setOption(option);
				caList.getPlanListInfo2(classStatisticsPie);
				caList.getClassDynamicList();
				caList.getNowYearClassStatistics(data.data);
				caList.getClassStatisticsList(data.data);
			}
		});
	},
	/**
	 * 班次统计和全年占比(饼图)
	 */
	getPlanListInfo2:function(classStatisticsPie){
		var resultData=[];
		$.each(classStatisticsPie,function(k,v){
			resultData.push({name:v.pieName,value:v.pieValue});
		});
		var myChart = echarts.init($('.drawing-2').get(0));
		option={
		    tooltip: {
		        trigger: 'item',
		        formatter: "{a} <br/>{b}: {c} ({d}%)"
		    },
		   
		    series: [
		        {
		            name:'访问来源',
		            type:'pie',
		            selectedMode: 'single',
		            radius: [0, '60%'],
		            label: {
		                normal: {
		                    position: 'inner'
		                }
		            },
		            labelLine: {
		                normal: {
		                    show: false
		                }
		            },
		            data:resultData
		        }
		    ]
		};
		// 使用刚指定的配置项和数据显示图表。
		myChart.setOption(option);
	},
	/**
	 * 班次列表查询
	 */
	getClassDynamicList:function(){
		$('.list-box .class-tbody').empty();
		var classCacsi = caList.getChecks();
		$('.page-info').pageInfo({
			async:true,
			pageIndexs: 1,
			pageNum: 15, //每页显示条数  
			pageSize: 10, //显示...的规律  
			url: $yt_option.base_path + "class/getClassDynamicList", //ajax访问路径  
			type: "post", //ajax访问方式 默认 "post"  
			data: {
				classType:classCacsi
			}, //ajax查询访问参数
			objName: 'data', //指获取数据的对象名称  
			before:function(){
				$yt_baseElement.showLoading();
			},
			success: function(data) {
				if(data.flag == 0) {
					var htmlTbody = $('.list-box .class-tbody');
					var htmlTr = '';
					if(data.data.rows.length > 0) {
						$.each(data.data.rows, function(i, v) {
							htmlTr += '<tr>' +
								'<td>' + v.projectCode+'</td>' +
								'<td>' + v.projectName + '</td>' +
								'<td>' + v.projectType + '</td>' +
								'<td>' + v.groupName + '</td>' +
								'<td>' + v.projectHead + '</td>' +
								'<td>' + v.startDate + '</td>' +
								'<td>' + v.endDate + '</td>' +
								'<td>' + v.trainDateCount + '</td>' +
								'<td>' + v.traineeCount + '</td>'+
								'<td>' + v.projectStates + '</td>'+
								'</tr>';
						});
						//$('.details-box').show();
					} else {
						//$('.list-page').hide();
						htmlTr += '<tr style="border:0px;background-color:#fff !important;" >' +
							'<td colspan="9" align="center" style="border:0px;">' +
							'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
							'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
							'</div>' +
							'</td>' +
							'</tr>';
					}
					htmlTbody.html(htmlTr);
					$yt_baseElement.hideLoading();
				} else {
					$yt_baseElement.hideLoading(function (){
						$yt_alert_Model.prompt("查询失败");
					});
				}

			}, //回调函数 匿名函数返回查询结果  
			isSelPageNum: true //是否显示选择条数列表默认false  
		});
	},
	/**
	 * 导出列表
	 */
	getExportList:function(){
		//点击导出
        $(".exportList").on("click",function (){
        	/*if($("tr.yt-table-active").length == 0){
				$yt_alert_Model.prompt("请选择要操作的数据");
				return false;
			}*/
    		var classType = caList.getChecks();
            var downUrl = $yt_option.base_path + "class/exportClassDynamicList";
            $.ajaxDownloadFile({
            	url:downUrl,
            	data:{
    				classType:classType,
            	}
            });
        });
	},
	/**
	 * 本年度班次统计
	 */
	getNowYearClassStatistics:function(data){
		var myChart = echarts.init($('.drawing-4').get(0));
		var nowYearClassStatistics =data.nowYearClassStatistics;
		option = {
			    title: {
			        text: '本年度班次统计'
			    },
			    tooltip: {
			        trigger: 'axis',
			        axisPointer: { // 坐标轴指示器，坐标轴触发有效
			            type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
			        }
			    },
			    legend: {
			        data: ['计划','委托','选学','调训'],
			        top: 20,
			       
			    },
			    grid: {
			        left: '3%',
			        right: '4%',
			        bottom: '3%',
			        containLabel: true
			    },
			    xAxis: [{
			        type: 'category',
			        data: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
			    }],
			    yAxis: [{
			        type: 'value',
			        axisLabel: {
			            formatter: '{value}'
			        }
			    }],
			    series: [{
			        name: '计划',
			        type: 'bar',
			        data: nowYearClassStatistics.planClassCount
			    }, {
			        name: '委托',
			        type: 'bar',
			        data: nowYearClassStatistics.entrustClassCount
			    }, {
			        name: '选学',
			        type: 'bar',
			        data: nowYearClassStatistics.selectionCount
			    }, {
			        name: '调训',
			        type: 'bar',
			        data: nowYearClassStatistics.bleakInCount
			    }]
			};
			// 使用刚指定的配置项和数据显示图表。
			myChart.setOption(option);
	},
	
	/**
	 * 班次统计列表
	 */
	getClassStatisticsList:function(data){
		$('.list-box2 .class-tbody').empty();
        var datas = data.classStatisticsList;
	    if(datas.length >0){
	    	var htmlTbody = $('.list-box2 .class-tbody');
			var htmlTr = '';
		    if(datas.length > 0) {
		    	var planClassAllCount= 0;
		    	var planClassAllDate= 0;
		    	var planClassAllUser= 0;
		    	var planClassAllUserDate= 0;
		    	var entrustClassAllCount= 0;
		    	var entrustClassAllDate= 0;
		    	var entrustClassAllUser= 0;
		    	var entrustClassAllUserDate= 0;
		    	var selectingplanClassAllCount= 0;
		    	var selectingClasAllsDate= 0;
		    	var selectingClassAllUser= 0;
		    	var selectingClassAllUserDate= 0;
		    	var bleakInClassAllCount= 0;
		    	var bleakInClassAllDate= 0;
		    	var bleakInClassAllUser= 0;
		    	var bleakInClassUserAllDate= 0;
		    	var subtotalplanClassAllCount= 0;
		    	var subtotalClassAllDate= 0;
		    	var subtotalClassAllUser= 0;
		    	var subtotalClassUserAllDate= 0;
					$.each(datas, function(i, v) {
						planClassAllCount += Number(v.planClassCount);
						planClassAllDate += Number(v.planClassDate);
						planClassAllUser += Number(v.planClassUser);
						planClassAllUserDate += Number(v.planClassUserDate);
						entrustClassAllCount += Number(v.entrustClassCount);
						entrustClassAllDate += Number(v.entrustClassDate);
						entrustClassAllUser += Number(v.entrustClassUser);
						entrustClassAllUserDate += Number(v.entrustClassUserDate);
						selectingplanClassAllCount += Number(v.selectingplanClassCount);
						selectingClasAllsDate += Number(v.selectingClassDate);
						selectingClassAllUser += Number(v.selectingClassUser);
						selectingClassAllUserDate += Number(v.selectingClassUserDate);
						bleakInClassAllCount += Number(v.bleakInClassCount);
						bleakInClassAllDate += Number(v.bleakInClassDate);
						bleakInClassAllUser += Number(v.bleakInClassUser);
						bleakInClassUserAllDate += Number(v.bleakInClassUserDate);
						subtotalplanClassAllCount += Number(v.subtotalplanClassCount);
						subtotalClassAllDate += Number(v.subtotalClassDate);
						subtotalClassAllUser += Number(v.subtotalClassUser);
						subtotalClassUserAllDate += Number(v.subtotalClassUserDate);
						
						htmlTr += '<tr>' +
							'<td>' + v.monthData+'</td>' +
							'<td>' + v.planClassCount + '</td>' +
							'<td>' + v.planClassDate + '</td>' +
							'<td>' + v.planClassUser + '</td>' +
							'<td>' + v.planClassUserDate + '</td>' +
							'<td>' + v.entrustClassCount + '</td>' +
							'<td>' + v.entrustClassDate + '</td>' +
							'<td>' + v.entrustClassUser + '</td>' +
							'<td>' + v.entrustClassUserDate + '</td>' +
							'<td>' + v.selectingplanClassCount + '</td>'+
							'<td>' + v.selectingClassDate + '</td>'+
							'<td>' + v.selectingClassUser + '</td>'+
							'<td>' + v.selectingClassUserDate + '</td>'+
							'<td>' + v.bleakInClassCount + '</td>'+
							'<td>' + v.bleakInClassDate + '</td>'+
							'<td>' + v.bleakInClassUser + '</td>'+
							'<td>' + v.bleakInClassUserDate + '</td>'+
							'<td>' + v.subtotalplanClassCount + '</td>'+
							'<td>' + v.subtotalClassDate + '</td>'+
							'<td>' + v.subtotalClassUser + '</td>'+
							'<td>' + v.subtotalClassUserDate + '</td>'+
							'</tr>';
					});
					htmlTr+='<tr>' +
						         '<td>总计</td>'+
						         '<td>'+ planClassAllCount +'</td>'+
						         '<td>'+ planClassAllDate +'</td>'+
						         '<td>'+ planClassAllUser +'</td>'+
						         '<td>'+ planClassAllUserDate +'</td>'+
						         '<td>'+ entrustClassAllCount +'</td>'+
						         '<td>'+ entrustClassAllDate +'</td>'+
						         '<td>'+ entrustClassAllUser +'</td>'+
						         '<td>'+ entrustClassAllUserDate +'</td>'+
						         '<td>'+ selectingplanClassAllCount +'</td>'+
						         '<td>'+ selectingClasAllsDate +'</td>'+
						         '<td>'+ selectingClassAllUser +'</td>'+
						         '<td>'+ selectingClassAllUserDate +'</td>'+
						         '<td>'+ bleakInClassAllCount +'</td>'+
						         '<td>'+ bleakInClassAllDate +'</td>'+
						         '<td>'+ bleakInClassAllUser +'</td>'+
						         '<td>'+ bleakInClassUserAllDate +'</td>'+
						         '<td>'+ subtotalplanClassAllCount +'</td>'+
						         '<td>'+ subtotalClassAllDate +'</td>'+
						         '<td>'+ subtotalClassAllUser +'</td>'+
						         '<td>'+ subtotalClassUserAllDate +'</td>'+
					        '</tr>';
			  } else {
					//$('.list-page').hide();
					htmlTr += '<tr style="border:0px;background-color:#fff !important;" >' +
						'<td colspan="9" align="center" style="border:0px;">' +
						'<div class="no-data" style="width: 280px;margin: 0 auto;">' +
						'<img src="../../resources/images/common/no-data.png" alt="" style="padding: 35px 0 20px;">' +
						'</div>' +
						'</td>' +
						'</tr>';
			  }
			htmlTbody.html(htmlTr);
			$yt_baseElement.hideLoading();
		} else {
			$yt_baseElement.hideLoading(function (){
				$yt_alert_Model.prompt("查询失败");
			});
		}
	},
	/**
	 * 数组中是否包含某个字段
	 */
	getData:function (stringToSearch, arrayToSearch) {
	     for (var s = 0; s < arrayToSearch.length; s++) {
		      thisEntry = arrayToSearch[s].toString();
		      if (thisEntry == stringToSearch) {
		        return true;
		      }
	     }
	     return false;
	},
	/**
	 * 多选框
	 */
	getChecks:function (){
		var classCacsi='';
	    var checks = document.getElementsByName("test");
	    for(k in checks){
	        if(checks[k].checked){
	        	if (classCacsi ==''){
	        		classCacsi += checks[k].value;
	        	}else{
	        		classCacsi += ','+checks[k].value;
	        	}
	        }
	    }
	    return classCacsi;
	},
	
};
$(function() {
	//初始化方法
	caList.init();
	
});
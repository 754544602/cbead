var projectList={init:function(){projectList.getOneListInfo();$(".star-date-input").calendar({speed:200,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:true,dateFmt:"yyyy-MM-dd HH:mm",callback:function(){}});var classList=projectList.getClassLis();var userRealName=projectList.userInfo();if(classList!=null){var projectUserName;$.each(classList.data,function(i,n){projectUserName=n.projectUserName;if(projectUserName.indexOf(userRealName)!=-1){$(".projectName").append($('<option value="'+n.projectCode+'">'+n.className+'</option>').data("classData",n))}});$(".projectName").niceSelect()};$(".projectName").change(function(){var classData=$(this).find("option:selected").data("classData");if(classData!=undefined){$('#projectUserName').text(classData.projectUserName);$('#traineeCount').text(classData.traineeCount)}});$(".projectName").niceSelect();$('.add-one-line').click(function(){var bol=$yt_valid.validForm($(".valid-tab"));if(bol==true){projectList.addLineInfo()}});projectList.reorder();projectList.addAlineDelTabRwo();projectList.delFileTr();$(".up-btn-div-box").undelegate().delegate("input","change",function(){$(".up-fileIds").next().text("");var addFile=$(this).attr("id");var fileName=$(this).val().split('\\');var fm=fileName[fileName.length-1];var url=$yt_option.acl_path+"api/tAscPortraitInfo/addFile?modelCode=caFile";$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:addFile,success:function(data,textStatus){var resultData=$.parseJSON(data);var fileId=resultData.obj.pkId;if(resultData.success==0){$yt_alert_Model.prompt("附件上传成功");fileList=[fm,fileId];projectList.addLineLecture(fm,fileId)}else{$yt_alert_Model.prompt("附件上传失败")}},error:function(data,status,e){$yt_alert_Model.prompt("附件上传失败!!!!")}})});$('.add-lecture-tb tbody').on('click',".down-file",function(){var filePkId=$(this).parent().parent().find('.file-span-id').val();var fileURL=$(this).parent().parent().find('.fileURL').val();$.ajaxDownloadFile({url:fileURL})});$('.up-btn-div-box').on('click','.down-modle-file',function(){projectList.downloadOrder()});$("#submit").click(function(){projectList.addClassInfo()});$('#last-cancel').click(function(){window.location.href="waitOpenHonorsList.html"});var num=$yt_common.GetQueryString("num");$('.back-btn').click(function(){if(num==1){window.location.href="waitOpenHonorsList.html"}})},addClassInfo:function(){$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString("pkId");var operateType=$yt_common.GetQueryString("types");var businessCode=$('#businessCode').val();var processInstanceId=$('#processInstanceId').val();var projectCode=$('#projectCode').val();var startTime=$('.startTime').val();var orderListArr=[];var details="";var dateLength="";var orderBy="";$(".add-order-tb tbody tr").each(function(i,n){orderBy=i+1;details=$(n).find('.details').val();dateLength=$(n).find('.dateLength').val();var orderList={details:details,dateLength:dateLength,orderBy:orderBy};orderListArr.push(orderList)});var orderListJson=JSON.stringify(orderListArr);var fileListArr=[];var fileId="";var fileName="";var types="";var fileListArr=[];$(".add-lecture-tb tbody tr").each(function(i,n){fileId=$(n).find('.file-span-id').val();fileName=$(n).find('.fileName').text();var fileList={fileId:fileId,fileName:fileName,types:2};fileListArr.push(fileList)});var fileListJson=JSON.stringify(fileListArr);var opintion="";var dealingWithPeople=$('#nextPeople').val();var nextCode="submited";$.ajax({type:"post",url:$yt_option.base_path+"class/openHonors/addOrUpdateBean",data:{pkId:pkId,types:operateType,projectCode:projectCode,startTime:startTime,orderList:orderListJson,fileList:fileListJson,dataStates:dataStates,businessCode:businessCode,processInstanceId:processInstanceId,opintion:opintion,dealingWithPeople:dealingWithPeople,nextCode:nextCode},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("添加失败")})}projectList.init()}})},downloadOrder:function(){var typeName=$('.dd-open-span').text();var fileName="";var type;if(typeName=="新增开班式"){type=1;fileName="开班式模板"};if(typeName=="结业"){type=2;fileName="结业式模板"}$.ajaxDownloadFile({url:$yt_option.base_path+"class/openHonors/downloadOrder",types:type,fileName:fileName})},delFileTr:function(){$(".add-lecture-tb").on('click',".entry-del-icon",function(){var tr=$(this).parent();$yt_alert_Model.alertOne({haveAlertIcon:false,closeIconUrl:"",leftBtnName:"确定",rightBtnName:"取消",cancelFunction:"",alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove()}})})},addLineLecture:function(fileName,fileId){var num=$(".lecture tbody tr").length+1;var lineTrHtml='<tr class="file-tr-border-style"><input type="hidden" class="fileURL" value="http://10.2.1.249:7216/acl/api/tAscPortraitInfo/download?isDownload=true&pkId='+fileId+'"><td class="lecture-tds">【<span class="fileLineNum">'+num+'</span>】</td><td class="fileName"><input type="hidden" class="file-span-id" value="'+fileId+'" >'+fileName+'</td><td style="display:none;" class="lecture-tds"><img class="ioc-img" src="../../resources/images/open/yulan.png" /></td><td style="width: 40px; display:none;">预览</td><td class="lecture-tds" style="text-align:center;width:70px"><span class="down-file"><img class="ioc-img" src="../../resources/images/open/xiazai2.png" />下载</span></td><td class="lecture-tds" style="text-align:center;width:170px"><span class="entry-del-icon"><img class="ioc-img" src="../../resources/images/open/delete.png" />删除</span></td></tr>';$(".lecture").append(lineTrHtml)},getOutOpenHonors:function(){var pkId=$('#pkId').val();var types=$('#types').val();$.ajaxDownloadFile({url:$yt_option.base_path+"class/openHonors/exportOrder",pkId:pkId,types:types})},addAlineDelTabRwo:function(){$(".add-order-tb").on('click',".entry-del-icon",function(){var tr=$(this).parent().parent();$yt_alert_Model.alertOne({haveAlertIcon:false,closeIconUrl:"",leftBtnName:"确定",rightBtnName:"取消",cancelFunction:"",alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove()}})})},reorder:function(){$('.add-order-tb').tableDnD({onDragClass:"ondragclass",onDrop:function(table,row){var rows=table.tBodies[0].rows;var debugStr="拖拽结束后的行："+row.id;for(var i=0;i<rows.length;i+=1){debugStr+=rows[i].id+" "}console.log(debugStr)},onDragStart:function(table,row){console.log("当前拖拽的表格行："+row.id)}})},addLineInfo:function(){var num=$(".add-order-tb tbody tr").length+1;var lineTrHtml='<tr class="add-textList tr-border-style"><td style="text-align:center;" class="order-by">'+num+'</td><td class="td-input"><input style="width: 600px; float: left;" type="text" class="yt-input details" validform="{isNull:true,size:20,msg:\'请输入内容,不要超过20个字\'}"/><span class="valid-font z-style"></span></td><td  style="position: relative;"><input style="margin-left:10px" type="text" class="yt-input dateLength td-input-time" validform="{isNull:true,size:10,msg:\'请输入会序时长\'}"/> <span class="valid-font z-style"></span><p class="time-txt" style="float: left;margin: 4px;">分钟</p></td><td style="text-align: center;" class="td-img"><img class="orderBy-dele-img img-size" src="../../resources/images/open/tiaoxu.png"/></td><td style="text-align: center;" class="handle-td td-img"><span class="entry-del-icon" onclick=""><img class="orderBy-dele-img img-size" src="../../resources/images/open/delete.png"/></span></td></tr>';$(".add-order-tb tbody").append(lineTrHtml);projectList.reorder()},getClassLis:function(){var list=[];$.ajax({type:"post",url:$yt_option.base_path+"uniform/getClasslist",data:{types:'4'},async:false,success:function(data){list=data||[]}});return list},userInfo:function(){var userRealName="";$.ajax({async:false,type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){userRealName=data.data.userRealName}});return userRealName},getOneListInfo:function(){$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString("pkId");var types=$yt_common.GetQueryString("types");if(types==2){$(".class-title").text("结业式");$('.order-title').text("结业式会序");$(".file-title").text("结业式讲稿");$(".approve-title").text("结业式审批")}$.ajax({type:"post",url:$yt_option.base_path+"class/openHonors/getBeanById",async:false,data:{pkId:pkId,types:types},objName:'data',success:function(data){if(data.flag==0){$('#processInstanceId').val(data.data.processInstanceId);$('#projectCode').text(data.data.projectName);$('#projectUserName').text(data.data.projectUserName);$('#startTime').text(data.data.startTime);$('#traineeCount').text(data.data.traineeCount);$('#createTimeString').text(data.data.createTimeString);$('#createUser').text(data.data.createUserName);$('#types').val(data.data.types);$('#pkId').val(data.data.pkId);var orderList=data.data.orderList;var orderListObj=$.parseJSON(orderList);$.each(orderListObj,function(i,v){var num=$(".add-order-tb tbody tr").length+1;var lineTrHtml='<tr class="add-textList"><td class="order-by"> <input type="hidden" class="orderBy" value="'+v.orderBy+'"/>'+num+'</td><td class="td-input details">'+v.details+'</td><td class="dateLength">'+v.dateLength+'</td><td style="text-align:left;padding-left:10px;">分钟</td></tr>';$(".add-order-tb tbody").append(lineTrHtml)});var fileList=data.data.fileList;var fileListObj=$.parseJSON(fileList);$.each(fileListObj,function(i,v){var num=$(".lecture tbody tr").length+1;var lineTrHtml='<tr class="file-tr-border-style"><input type="hidden" class="fileURL" value="http://10.2.1.249:7216/acl/api/tAscPortraitInfo/download?isDownload=true&pkId='+v.fileId+'"><td class="lecture-tds">【<span class="fileLineNum">'+num+'</span>】</td><td class="fileName"><input type="hidden" class="file-span-id" value="'+v.fileId+'" >'+v.fileName+'</td><td style="display:none;" class="lecture-tds"><img class="ioc-img" src="../../resources/images/open/yulan.png" /></td><td style="width: 40px; display:none;">预览</td><td class="lecture-tds" style="text-align:center;width:70px"><span style="cursor: pointer;" class="down-file"><img class="ioc-img" src="../../resources/images/open/xiazai2.png" />下载</span></td><td class="lecture-tds" style="text-align:center;width:170px"><span style="cursor: pointer;" class="entry-del-icon"><img class="ioc-img" src="../../resources/images/open/delete.png" />删除</span></td></tr>';$(".lecture").append(lineTrHtml)});var flowLog=data.data.flowLog;if(flowLog.length>0){$(".approve-title-box").show();$(".approve-content-box").show()}var middleStepHtml;var length=flowLog.length;var deleteReasons="";var tastName;$.each(flowLog,function(i,v){if(v.deleteReason=="completed"){deleteReasons="同意"};if(v.deleteReason=="returnedSubmit"){deleteReasons="退回到申请人"};if(v.deleteReason=="refusedToApproval"){deleteReasons="拒绝"}tastName=v.taskName+deleteReasons;if(i==length-1){$('.first-step-order').text(1);$('.first-step-operate-person-userName').text(v.userName);$('.first-step-taskName').text("申请提交");$('.first-step-commentTime').text(v.commentTime)};if(i<length-1){if(v.deleteReason=="returnedSubmit"){tastName="申请待提交"}if(i<length-1&&v.tastKey=="activitiStartTask"&&v.deleteReason=="submited"){tastName="申请再次提交"}var order=length-i;middleStepHtml='<div><div style="height: 150; "><div class="number-name-box"><span class="number-box-span middle-step-order middle-a-index" >'+order+'</span><span class="name-box-span middle-step-userName middle-a-index" >'+v.userName+'</span><img src="../../resources/images/open/openFlow.png" class="order-img" /></div></div><div class="middle-step-box-div"><ul class="middle-step-box-ul"><li style="height: 30px;"><span  class="middle-step-taskName view-taskName-span"  style="float: left;">'+tastName+'</span></li><li class="view-time-li middle-step-commentTime" >'+v.commentTime+'</li><li class="operate-view-box-li"><div class="operate-view-title-li">操作意见：</div><div class="operate-view-text-li middle-step-comment">'+v.comment+'</div></li></ul></div></div>';$('.last-step').append(middleStepHtml)}});$yt_baseElement.hideLoading()}else{$yt_baseElement.hideLoading(function(){$yt_alert_Model.prompt("查询失败")})}}})}};$(function(){projectList.init()});
var expenApplApprList={thisPopData:'',advanceId:'',inits:function(){$("#expenApplApprList").css("min-height",$(window).height()-12);$(".dis").show();expenApplApprList.events();expenApplApprList.searchList();expenApplApprList.thisPopData=$("#startDate").val()},events:function(){$('.search').on('keydown',function(){if($('.search').val()!=''||$('.search').val()!=null){$('.clearImg').show()}});$('.clearImg').on('click',function(){$('.search').val('');$(this).hide();expenApplApprList.searchList()});$("#resetBtn").off().on("click",function(){$('.search').val('');$('.clearImg').hide();expenApplApprList.searchList()});$("#searchBtn").off().on("click",function(){expenApplApprList.searchList()});$(".tab-header button.print-btn").on("click",function(){var selTrLen=$(".tab-div .tab-content:visible tbody tr.yt-table-active").length;var thisTrData=$(".tab-div .tab-content:visible tbody tr.yt-table-active").data("dataStr");console.log(thisTrData);if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var pageUrl="";pageUrl="view/projectManagement/expensesReim/module/print/finalStatement.html?finalAppId="+thisTrData.finalAppId+'&costType='+thisTrData.costType;$yt_baseElement.openNewPage(2,pageUrl)}});$(".pop-add-bill .face-money").blur(function(){$(this).val($(this).val()==''?'':$yt_baseElement.fmMoney($(this).val()))});$(".pop-add-bill .face-money").focus(function(){$(this).val($(this).val()==''?'':$yt_baseElement.rmoney($(this).val()))});$(".to-budget-dia").click(function(){var selTrLen=$(".tab-div .pending2 tbody tr.yt-table-active").length;var thisTr=$(".pending2 .yt-tbody tr.yt-table-active");var advanceAppId=$('.yt-table-active').find('.hid-advance-id').val();var costType=$('.yt-table-active').find('.costType').val();var thisBtn=$(this);if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var prjId=$(this).parent('td').parent('tr').find('.prjId').val();var pageUrl="view/projectManagement/expensesReim/module/payment/budgetAuditReduce.html?advanceAppId="+advanceAppId+"&costType="+costType;;$yt_baseElement.openNewPage(2,pageUrl)}});$('.pending1,.pending2').on('click','.apprv-btn',function(){var fun=$(this).attr('fun');var advanceAppId=$(this).parents('tr').find('.hid-advance-id').val();var taskKey=$(this).attr('taskKey');if(taskKey=='activitiStartTask'){var pageUrl="view/projectManagement/expensesReim/module/reimApply/expenseAccount.html?appId="+advanceAppId+"&fun="+fun;window.location.href=$yt_option.websit_path+pageUrl}else{var pageUrl="view/projectManagement/expensesReim/module/reimApply/finalExamine.html?appId="+advanceAppId+"&fun="+fun;window.location.href=$yt_option.websit_path+pageUrl}});$('.pending1,.pending2').on('click','.to-detail',function(){var fun=$(this).attr('fun');var thisTr=$(this).parents("tr");var advanceAppId=thisTr.find('.hid-advance-id').val();var processInstanceId=thisTr.find(".processInstanceId").val();var pageUrl="view/projectManagement/expensesReim/module/reimApply/finalDetail.html?appId="+advanceAppId;$yt_baseElement.openNewPage(2,pageUrl)});$(".pending2 .yt-tbody").on("click",'tr',function(){var thisTr=$(this);var thisState=thisTr.find(".actualizar-state-td").text();if(thisState=="未补登"){$(".add-bill").attr("disabled",false).removeClass("yt-btn-disabled")}else{$(".add-bill").attr("disabled",true).addClass("yt-btn-disabled")}if($(this).hasClass('yt-table-active')){$(this).removeClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('uncheck')}else{$(this).addClass('yt-table-active');$(this).find('input[type=checkbox]').setCheckBoxState('check')}return false});$(".pending2").on('click','.process-state',function(){var processInstanceId=$(this).parents("tr").find(".processInstanceId").val();sysCommon.processStatePop(processInstanceId)});$('.screen input').change(function(){var stateCode="WF_PASS_QUERY_SQL_PARAMS";var signState=function(){var states=$('.screen .check');if($(states).length>=2||$(states).length<=0){return '2'}else if($(states).length<2){return $(states).find('input').val()}return ''};var sta='';if($(this).parent().hasClass('check')){$(this).setCheckBoxState("uncheck");sta=signState()}else{$(this).setCheckBoxState("check");sta=signState()}expenApplApprList.getProcessingAndFinishList(stateCode,sta)});var check=true;$('.all-checked').click(function(){if(check){$('.pending2 tbody').setCheckBoxState("checkAll");$('.pending2 tbody tr').addClass('yt-table-active')}else{$('.pending2 tbody').setCheckBoxState("unCheckAll");$('.pending2 tbody tr').removeClass('yt-table-active')}check=!check});$('.already-printed').click(function(){var ids='';$('.pending2 tbody .check').each(function(i,n){ids+=$(n).find('input').val()+(i<$('.pending2 tbody .check').length-1?',':'')});if(ids){expenApplApprList.updateFinalIsPrintStateYes(ids);check=true}else{$yt_alert_Model.prompt('请选择数据进行操作')}});$('.non-printing').click(function(){var ids='';$('.pending2 tbody .check').each(function(i,n){ids+=$(n).find('input').val()+(i<$('.pending2 tbody .check').length-1?',':'')});if(ids){expenApplApprList.updateFinalIsPrintStateNo(ids);check=true}else{$yt_alert_Model.prompt('请选择数据进行操作')}});$(".pending2 .yt-tbody").on('change','input[type=checkbox]',function(){if($(this)[0].checked){$(this).parents('tr').addClass('yt-table-active')}else{$(this).parents('tr').removeClass('yt-table-active')}return false})},updateFinalIsPrintStateYes:function(ids){$.ajax({type:"post",url:"sz/finalApp/updateFinalIsPrintStateYes",async:false,data:{ids:ids},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);expenApplApprList.searchList()}else{$yt_alert_Model.prompt(data.message)}}})},updateFinalIsPrintStateNo:function(ids){$.ajax({type:"post",url:"sz/finalApp/updateFinalIsPrintStateNo",async:false,data:{ids:ids},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);expenApplApprList.searchList()}else{$yt_alert_Model.prompt(data.message)}}})},searchList:function(){expenApplApprList.getProcessingAndFinishList('WF_PASS_QUERY_SQL_PARAMS','2')},getProcessingAndFinishList:function(stateCode,printState){var queryParams=$('#keywordInput').val();$('.page2').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:'sz/finalApp/getUserFinalAppInfoBusinessListToPageByParams',data:{queryStateParams:stateCode,queryParams:queryParams,printState:printState},objName:'data',success:function(data){var datas=data.data.rows;var htmlTbody=$('.pending2 .yt-tbody');htmlTbody.empty();var trStr="";if(data.flag==0){if(datas.length>0){$('.page2').show();var actualizarState='';$.each(datas,function(i,n){if(n.actualizarState==0){actualizarState='--'};if(n.actualizarState==1){actualizarState='未补登'}if(n.actualizarState==2){actualizarState='已补登'}trStr+='<tr><td><label class="check-label yt-checkbox"><input type="checkbox" name="test" value="'+n.finalAppId+'"/></label></td><td><a class="yt-link to-detail">'+n.finalAppNum+'</a><input type="hidden" class="hid-advance-id" value="'+n.finalAppId+'"/><input type="hidden" class="processInstanceId" value="'+n.processInstanceId+'"/><input type="hidden" class="costType" value="'+n.costType+'"/></td><td class="tl" style="text-align:left;">'+(n.finalAppReason==""?"--":n.finalAppReason)+'</td><td style="text-align: right;">'+(n.expenditureTotal==""?"--":$yt_baseElement.fmMoney(n.expenditureTotal))+'</td><td style="text-align: right;">'+(n.incomeTotal==""?"--":$yt_baseElement.fmMoney(n.incomeTotal))+'</td>';trStr+='<td>'+n.applicantUserName+'</td>'+'<td><span>'+n.applicantDeptName+'</span></td>';if(stateCode=='WF_PASS_QUERY_SQL_PARAMS'){trStr+='<td>'+n.applicantTime+'</td>'}if(stateCode=='WF_SOLVED_QUERY_SQL_PARAMS'){trStr+='<td style="text-align:left;"><span class="yt-link process-state">'+n.nodeNowState+'</span></td>';}trStr+='<td class="print-state" style="color: '+(n.isPrint==0?'#333333':'#417095')+';">'+(n.isPrint==0?'未打印':'已打印')+'</td><td>'+(stateCode!='WF_SUSPENDING_QUERY_SQL_PARAMS'?'':'<a class="yt-link apprv-btn" taskKey="'+n.taskKey+'">'+(n.taskKey=='activitiStartTask'?'处理':'审批')+'</a><span class="center-line">|</span>')+'<a class="yt-link log-mod">日志</a></td></tr>';trStr=$(trStr).data("dataStr",n);htmlTbody.append(trStr)});sysCommon.initQtip($(".log-mod"));}else{htmlTbody.html("");$('.page2').hide();htmlTbody.append(expenApplApprList.noDataTrStr(10))}}},isSelPageNum:true })},noDataTrStr:function(trNum){var noDataStr='<tr style="border:0px;background-color:#fff !important;"><td  colspan="'+trNum+'" align="center"style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';return noDataStr},count:function(){var sumNum=0;var sumMoney=0;$(".bill-num").each(function(i,n){sumNum+= +$(n).text()});$(".bill-money").each(function(i,n){sumMoney+= +$yt_baseElement.rmoney($(n).text())});$(".sum-td").text(sumNum);$(".sum-money").text($yt_baseElement.fmMoney(sumMoney))},showAddBillPop:function(){$("#startDate").val(expenApplApprList.thisPopData);expenApplApprList.count();$(".yt-edit-alert.pop-add-bill").show();$yt_alert_Model.getDivPosition($(".yt-edit-alert.pop-add-bill"));$.ajax({type:"post",url:"sz/expenditureApp/findActualizarInfoByExpenditureAppId",async:true,data:{expenditureAppId:expenApplApprList.advanceId,},success:function(data){if(data.flag==0){var datas=data.data;if(datas){var expenditureAppNum=datas.expenditureAppNum;var actualizarAmount=datas.actualizarAmount;$(".pop-add-bill .expenditure-app-num").text(expenditureAppNum);$(".pop-add-bill .actualizar-amount").text($yt_baseElement.fmMoney(actualizarAmount))}}else{$yt_alert_Model.prompt(data.message)}}});$(".pop-add-bill").off().on("click",".add-to-list",function(){var isTrue=$yt_valid.validForm($(".pop-add-bill"));if(isTrue){var billTypeVue=$(".pop-add-bill .radio-input-list input:checked").val();var billType='';if(billTypeVue=='INVOICE'){billType='发票'}else if(billTypeVue=='RECEIPT'){billType='收据'}else{billType='其他'}var billMoney=$(".pop-add-bill .face-money").val();var billComment=$(".pop-add-bill .comment").val();$(".pop-add-bill .pop-add-bill-table tbody tr").eq(-1).before('<tr class="bill-detail"><td><input type="hidden" class="bill-type" value="'+billTypeVue+'"/>'+billType+'</td><td><span class="bill-num">1</span></td><td style="text-align: right;"><span class="bill-money">'+$yt_baseElement.fmMoney(billMoney)+'</span></td><td style="text-align: left;"><span class="bill-comment">'+(billComment||'--')+'</span></td><td><a class="del-icon"><img src="../../../../../resources-sasac/images/common/del-icon.png"></a></td></tr>');$(".pop-add-bill .radio-input-list input").eq(0).setRadioState("check");$(".pop-add-bill .face-money").val("");$(".pop-add-bill .comment").val("");expenApplApprList.count()}});$('.yt-edit-alert .yt-eidt-model-bottom .yt-model-sure-btn').off().on("click",function(advanceId){var expenditureAppId=expenApplApprList.advanceId;var actualizarTime=$("#startDate").val();var billDetailList=$(".pop-add-bill .pop-add-bill-table .bill-detail");var actualizarInfoList=[];$(billDetailList).each(function(i,n){var billNum=$(n).find(".bill-num").text();var billType=$(n).find(".bill-type").val();var billMoney=$yt_baseElement.rmoney($(n).find(".bill-money").text());var billComment=$(n).find(".bill-comment").text();actualizarInfoList.push({"billNum":billNum,"billType":billType,"billAmount":billMoney,"remarks":billComment})});var actualizarAmount=$yt_baseElement.rmoney($(".pop-add-bill .actualizar-amount").text());var sumMoney=$yt_baseElement.rmoney($(".pop-add-bill .sum-money").text());if(actualizarAmount<=sumMoney){$.ajax({type:"post",url:"sz/expenditureApp/saveActualizarInfo",async:true,data:{expenditureAppId:expenditureAppId,actualizarTime:actualizarTime,actualizarInfoList:JSON.stringify(actualizarInfoList)},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);$(".pop-add-bill .radio-input-list input").eq(0).setRadioState("check");$(".pop-add-bill .face-money").val("").removeClass("valid-hint");$(".pop-add-bill .comment").val("");$(".pop-add-bill .valid-font").text("");$(".pop-add-bill .pop-add-bill-table .yt-tbody").html('<tr><td>合计</td><td class="sum-td">0</td><td class="sum-money" style="text-align: right;">'+$yt_baseElement.fmMoney(0)+'</td><td></td><td></td></tr>');$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide();expenApplApprList.getProcessingAndFinishList('WF_PASS_QUERY_SQL_PARAMS')}else{$yt_alert_Model.prompt(data.message)}}})}else{$yt_alert_Model.prompt("欠票金额未完全冲销，请核对后提交")}});$('.yt-edit-alert .yt-eidt-model-bottom .yt-model-canel-btn').off().on("click",function(){$(".pop-add-bill .radio-input-list input").eq(0).setRadioState("check");$(".pop-add-bill .face-money").val("").removeClass("valid-hint");$(".pop-add-bill .comment").val("");$(".pop-add-bill .valid-font").text("");$(".pop-add-bill .pop-add-bill-table .yt-tbody").html('<tr><td>合计</td><td class="sum-td">0</td><td class="sum-money" style="text-align: right;">'+$yt_baseElement.fmMoney(0)+'</td><td></td><td></td></tr>');$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})},showBillRecordPop:function(){$(".yt-edit-alert.pop-bill-record").show();$yt_alert_Model.getDivPosition($(".yt-edit-alert.pop-bill-record"));$.ajax({type:"post",url:"sz/expenditureApp/findActualizarInfoByExpenditureAppId",async:true,data:{expenditureAppId:expenApplApprList.advanceId,},success:function(data){if(data.flag==0){var datas=data.data;if(datas){var expenditureAppId=datas.expenditureAppId;var expenditureAppName=datas.expenditureAppName;var expenditureAppNum=datas.expenditureAppNum;var actualizarNum=datas.actualizarNum;var actualizarTime=datas.actualizarTime;var actualizarAmount=datas.actualizarAmount;var actualizarInfoList=datas.actualizarInfoList;$(".pop-bill-record .actualizar-num").text((actualizarNum==''?'--':actualizarNum));$(".pop-bill-record .actualizar-time").text((actualizarTime==''?'--':actualizarTime));var actualizarInfoHtml='';var billAmountTotle=0;var billNumTotle=0;$(actualizarInfoList).each(function(i,n){var billType='';if(n.billType=='INVOICE'){billType='发票'}else if(n.billType=='RECEIPT'){billType='收据'}else{billType='其他'}actualizarInfoHtml+='<tr><td>'+billType+'</td><td>'+n.billNum+'</td><td style="text-align: right;">'+$yt_baseElement.fmMoney((n.billAmount==''?0:n.billAmount))+'</td><td style="text-align: left;">'+(n.remarks==''?'--':n.remarks)+'</td></tr>';billAmountTotle+=(n.billAmount==''?0:n.billAmount);billNumTotle+=n.billNum});actualizarInfoHtml+='<tr><td>合计</td><td>'+billNumTotle+'</td><td style="text-align: right;">'+$yt_baseElement.fmMoney(billAmountTotle)+'</td><td></td></tr>';$(".pop-bill-record .actualizar-info-table .yt-tbody").html(actualizarInfoHtml)}}else{$yt_alert_Model.prompt(data.message)}}});$('.yt-edit-alert .yt-eidt-model-bottom .yt-model-sure-btn').off().on("click",function(){$(".yt-edit-alert,#heard-nav-bak").hide();$("#pop-modle-alert").hide()})}};$(function(){expenApplApprList.inits()});
var teaching={init:function(){teaching.userInfo();$(".yt-select").niceSelect();$(".time-receipt").calendar({speed:200,complement:true,readonly:true,lowerLimit:"NaN",nowData:true,dateFmt:"yyyy-MM-dd",callback:function(){}});$(".feedback-time").calendar({speed:200,complement:true,readonly:true,lowerLimit:"NaN",nowData:true,dateFmt:"yyyy-MM-dd",callback:function(){}});$(".btn-teach-plan-save").click(function(){var dataStates=0;teaching.teachPlanDesignRequirements(dataStates)});},userInfo:function(){$.ajax({type:"post",url:$yt_option.base_path+"uniform/user/getUsersDetails",data:{},success:function(data){$('.user-real-name').val(data.data.userRealName)}})},getProjectInf:function(){$yt_baseElement.showLoading();var pkId=$yt_common.GetQueryString('pkId');$.ajax({type:"post",url:$yt_option.base_path+"project/getBeanById",data:{pkId:pkId},success:function(data){if(data.flag==0){$yt_baseElement.hideLoading()}else{$yt_alert_Model.prompt("获取失败");$yt_baseElement.hideLoading()}teaching.getTeachPlanDesignRequirements()}})},getTeachPlanDesignRequirements:function(){debugger;$yt_baseElement.showLoading();var projectId=$yt_common.GetQueryString('pkId');$.ajax({type:"post",url:$yt_option.base_path+"project/getTeachingScheme",data:{projectId:projectId},success:function(data){if(data.flag==0&&data.data!=null){$('.teach-plan-table-info').show();$('.trainee-level-info input[value="'+data.data.traineeLevel+'"]').setCheckBoxState("check");$('.scheme-requirement-info input[value="'+data.data.schemeRequirement+'"]').setCheckBoxState("check");var notChecked=$(".trainee-level-info input:checkbox").not("input:checked");if(userRealName==projectHead){}else{}var teacherUl=$(".file-id");var teacherLi="";var fileIdsArr=$.parseJSON(data.data.teachingSchemeFile);if(fileIdsArr.length>0){$.each(fileIdsArr,function(i,v){teacherLi+='<p style="width:870px;height:40px;border:1px dashed #e6e6e6;line-height:40px;"><span class="file-name" style="margin-right: 50px;color:blue;cursor: pointer"><input type="hidden" class="file-span-id" value="'+v.pkId+'" >'+v.fileName+'</span><span class="del-file-p" style="float:right;cursor: pointer;"><img src="../../resources/images/icons/teach-plan-del.png" alt="" />删除</span><span class="down-load-file-index" style="float:right;cursor: pointer;"><img src="../../resources/images/icons/down-load-teach-plan.png" alt="" />下载</span><span style="float:right;"><img src="../../resources/images/icons/preview.png" alt="" />预览</span></p>';teacherUl.html(teacherLi)})}$yt_baseElement.hideLoading();var flowLog=data.data.flowLog;if(flowLog==""){$('.approval-process-module').hide()}else{var flowLogArr=$.parseJSON(flowLog);$('.hid-process-instance-id-teach').val(data.data.processInstanceId);var middleStepHtml;var length=flowLogArr.length;var deleteReasons="";var tastName;$.each(flowLogArr,function(i,n){if(n.deleteReason=="completed"){deleteReasons="同意"};if(n.deleteReason=="returnedSubmit"){deleteReasons="退回到审批人"};if(n.deleteReason=="refusedToApproval"){deleteReasons="拒绝"}tastName=n.taskName+deleteReasons;$('.tast-key-teach').val(n.tastKey);if(n.tastKey=="activitiEndTask"){$('.next-operate-person-tr').hide()}if(i==0){if(n.taskName=="审批"){$('.last-step-div-teach').show()}else{$('.last-step-div-teach').hide()}if(n.tastKey=="activitiEndTask"){$('.hid-tast-key').val(n.tastKey);$('.next-operate-person-teach-tr').hide();$('.last-step-order-teach').text(length);$('.last-step-operate-person-userName-teach').text(n.userName);$('.last-step-operationState-teach').text(n.taskName);$('.last-step-commentTime-teach').text(n.commentTime)}else{var order=length-i;middleStepHtml='<div><div style="height: 150; "><div class="number-name-box"><span class="number-box-span middle-step-order middle-a-index" >'+order+'</span><span class="name-box-span middle-step-userName middle-a-index" >'+n.userName+'</span><img src="../../resources/images/open/openFlow.png" class="order-img" /></div></div><div class="middle-step-box-div"><ul class="middle-step-box-ul"><li style="height: 30px;"><span  class="middle-step-taskName view-taskName-span"  style="float: left;">'+tastName+'</span></li><li class="view-time-li middle-step-commentTime" >'+n.commentTime+'</li><li class="operate-view-box-li"><div class="operate-view-title-li">操作意见：</div><div class="operate-view-text-li middle-step-comment" style="padding-left:10px;">'+n.comment+'</div></li></ul></div></div>';$('.last-step-add-teach').append(middleStepHtml)}};if(i==length-1){$('.first-step-order-teach').text(1);$('.first-step-operate-person-username-teach').text(n.userName);$('.first-step-taskName-teach').text(tastName);$('.first-step-commentTime-teach').text(n.commentTime);};if(i!=0&&i!=length-1){var order=length-i;middleStepHtml='<div><div style="height: 150; "><div class="number-name-box"><span class="number-box-span middle-step-order middle-a-index" >'+order+'</span><span class="name-box-span middle-step-userName middle-a-index" >'+n.userName+'</span><img src="../../resources/images/open/open-sp.png" class="order-img" /></div></div><div class="middle-step-box-div"><ul class="middle-step-box-ul"><li style="height: 30px;"><span  class="middle-step-taskName view-taskName-span"  style="float: left;">'+tastName+'</span></li><li class="view-time-li middle-step-commentTime" >'+n.commentTime+'</li><li class="operate-view-box-li"><div class="operate-view-title-li">操作意见：</div><div class="operate-view-text-li middle-step-comment">'+n.comment+'</div></li></ul></div></div>';$('.last-step-add-teach').append(middleStepHtml)}})}}else{$yt_baseElement.hideLoading()}}})},teachPlanDesignRequirements:function(dataStates){var projectId=$yt_common.GetQueryString('pkId');var pkId=$(".teach-plan-table .pk-id").val();var traineeLevel=$(".trainee-level>input:checkbox:checked").val();var estimatedTransactionPrice=$(".teach-plan-table .estimated-transaction-price").val();var timeReceipt=$(".teach-plan-table .time-receipt").val();var feedbackTime=$(".teach-plan-table .feedback-time").val();var schemeRequirement=$('.scheme-requirement>input:checkbox:checked').val();var linkman=$(".teach-plan-table .linkman").val();var phone=$(".teach-plan-table .phone").val();var adDetails=$(".teach-plan-table .ad-details").val();var teachingsSchemeLevel=$(".teach-plan-table .teachings-scheme-level").val();$.ajax({type:"post",url:$yt_option.base_path+"project/addOrUpdateTeachingScheme",data:{projectId:projectId,pkId:pkId,traineeLevel:traineeLevel,estimatedTransactionPrice:estimatedTransactionPrice,timeReceipt:timeReceipt,feedbackTime:feedbackTime,schemeRequirement:schemeRequirement,linkman:linkman,phone:phone,adDetails:adDetails,teachingsSchemeLevel:teachingsSchemeLevel,dataStates:dataStates},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("操作成功")}else{$yt_alert_Model.prompt("操作失败")}}})},firstDraftByProjectDirector:function(){var projectId=$yt_common.GetQueryString('pkId');var businessCode=$(".teach-plan-table .teachings-scheme-level").val();var dealingWithPeople=$('.next-people').val();var files="";var filesArr=[];$(".file-id p").each(function(i,n){fileName=$(n).find(".file-name").text();fileId=$(n).find(".file-name .file-span-id").val();var arrFile={fileName:fileName,fileId:fileId};filesArr.push(arrFile)});var files=JSON.stringify(filesArr);$.ajax({type:"post",url:$yt_option.base_path+"project/addOrUpdateTeachingSchemeFile",data:{projectId:projectId,fileType:1,files:files,businessCode:businessCode,dealingWithPeople:dealingWithPeople,opintion:"",processInstanceId:"",nextCode:"submited"},success:function(data){if(data.flag==0){$yt_alert_Model.prompt("操作成功")}else{$yt_alert_Model.prompt("操作失败")}}})}};$(function(){teaching.init()});
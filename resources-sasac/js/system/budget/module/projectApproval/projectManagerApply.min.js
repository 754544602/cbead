var apply={budgetPrjAppId:"",selectList:[],formData:"",arr:[],processInstanceId:"",midGoalId:"",yearGoalId:"",draCode:"",init:function(){$("#approvalDiv").append(sysCommon.createFlowApproveMode());var requerParameter=$yt_common.GetRequest();apply.budgetPrjAppId=requerParameter.budgetPrjAppId;apply.draCode=requerParameter.draCode;if(apply.budgetPrjAppId!=""&&apply.budgetPrjAppId!=undefined&&apply.budgetPrjAppId!=null){apply.applicationApply()}else{sysCommon.getLoginUserInfo();apply.getSelectListData("#midPerformance");apply.getSelectListData("#yearPerformance")}sysCommon.getApproveFlowData("BUDGET_PRJ_APP",apply.processInstanceId);$("#demandApply").css("min-height",$(window).height()-32);$("select").niceSelect();apply.moneyFormat();apply.events();apply.uploadFile();apply.validate()},moneyFormat:function(){$(".top-money,.bottom-money").on("focus",function(e){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()});$(".top-money,.bottom-money").on("blur",function(){if($(this).val()!=""){$(this).val($yt_baseElement.fmMoney($(this).val()))}})},events:function(){$('.file-box').on('click','.del-file',function(){var ithis=$(this);var parent=ithis.parent();$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){parent.remove()}})});$('#approveCanelBtn').on("click",function(){if(apply.draCode){var pageUrl='view/system-sasac/budget/module/projectApproval/budgetDraftsList.html';parent.parent.$yt_baseElement.showLoading();window.location.href=$yt_option.websit_path+pageUrl}else{apply.clearPageData()}});$("#approveSubBtn,#approveSaveBtn").on("click",function(){var thisBtn=$(this);$(this).attr('disabled',true).addClass('btn-disabled');var ajaxUrl="";var validFlag=true;var fromUrl='';if(thisBtn.hasClass("sub-btn")){ajaxUrl="budget/prjApp/submitBudgetPrjAppInfo";validFlag=$yt_valid.validForm($("#newProjectApply"));var totalAmount=$yt_baseElement.rmoney($("#totalAmount").val());var financeAmount=$("#financeAmount").val();var otherAmount=$("#otherAmount").val();if(totalAmount!=($yt_baseElement.rmoney(financeAmount)+$yt_baseElement.rmoney(otherAmount))){$yt_alert_Model.prompt("中期资金总额应等于财政拨款和其他资金总和");$(thisBtn).attr('disabled',false).removeClass('btn-disabled');return false}var yearTotalAmount=$yt_baseElement.rmoney($("#yearTotalAmount").val());var yearFinanceAmount=$("#yearFinanceAmount").val();var yearOtherAmount=$("#yearOtherAmount").val();if(yearTotalAmount!=($yt_baseElement.rmoney(yearFinanceAmount)+$yt_baseElement.rmoney(yearOtherAmount))){$yt_alert_Model.prompt("年度资金总额应等于财政拨款和其他资金总和");$(thisBtn).attr('disabled',false).removeClass('btn-disabled');return false}fromUrl='view/system-sasac/budget/module/projectApproval/budgetProjectList.html'};if(thisBtn.hasClass("save-btn")){ajaxUrl="budget/prjApp/saveBudgetPrjAppInfoToDrafts"};if(validFlag){var formDatas=apply.getFormData();$.ajax({type:"post",url:ajaxUrl,async:false,data:formDatas,success:function(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){var appId='';appId=data.data;if(thisBtn.hasClass("save-btn")){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/projectApproval/budgetDraftsList.html'}})}if(appId!=''&&appId!=undefined&&appId!=null){if(thisBtn.hasClass("sub-btn")){$.ajax({type:"post",url:'budget/prjApp/submitWorkFlow',async:false,data:{appId:appId,parameters:'',dealingWithPeople:$("#approve-users").val(),opintion:$("#opintion").val(),processInstanceId:'',nextCode:$("#operate-flow").val(),},success:function(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:fromUrl }})}}})}}$(thisBtn).attr('disabled',false).removeClass('btn-disabled')}},error:function(e){$(thisBtn).attr('disabled',false).removeClass('btn-disabled')}})}else{sysCommon.pageToScroll($("#newProjectApply .valid-font"));$(thisBtn).attr('disabled',false).removeClass('btn-disabled')}});$(".mid-apply-table,.all-apply-table").on("click",".operate-edit",function(){var thisBtn=$(this);var thisTr=thisBtn.parents("tr");var thisTrHtml=thisTr.html();var targetOneCode=thisTr.find(".target-td-one").find(".firstCode").text();var targetTwoCode=thisTr.find(".target-td-two").find(".secondCode").text();var targetThreeCode=thisTr.find(".target-td-three").find(".threeCode").text();var selectFirstData=apply.getSelectText("0");var selectSecondData=apply.getSelectText(targetOneCode);var selectThirdData=apply.getSelectText(targetTwoCode);var inputVal=thisTr.find(".target-td-four").text();var tdText=thisTr.find(".target-td-five").text();var selectHtml1='<div style="float: left;display:inline;width: 100%;"><select  class="yt-select select-width target-item-one"><option value="">请选择</option>';$.each(selectFirstData,function(index,data){selectHtml1+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});selectHtml1+='</select></div>';var selectHtml2='<div style="float: left;display:inline;width: 100%;"><select  class="yt-select select-width target-item-two"><option value="">请选择</option>';$.each(selectSecondData,function(index,data){selectHtml2+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});selectHtml2+='</select></div>';var selectHtml3='<div style="float: left;display:inline;width: 100%;"><select  class="yt-select select-width target-item-three"><option value="">请选择</option>';$.each(selectThirdData,function(index,data){selectHtml3+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});selectHtml3+='</select></div>';thisTr.find(".target-td-one").html(selectHtml1);thisTr.find(".target-td-two").html(selectHtml2);thisTr.find(".target-td-three").html(selectHtml3);thisTr.find(".target-td-four").html('<input type="text" class="yt-input input-val" value="'+inputVal+'" placeholder="请输入" style="text-align: right;width: 95%;padding-right: 4px;" />');thisTr.find(".target-td-five").html(tdText);thisTr.find(".target-td-six").html('<span class="operate-save"><img src="../../../../../resources-sasac/images/common/save-icon.png"></span><span class="operate-canel" style="margin-left: 15px;"><img src="../../../../../resources-sasac/images/common/canel-icon.png"></span>');$("tbody select").niceSelect();thisTr.find('select.target-item-one option[value="'+targetOneCode+'"]').attr("selected",true);thisTr.find('select.target-item-two option[value="'+targetTwoCode+'"]').attr("selected",true);thisTr.find('select.target-item-three option[value="'+targetThreeCode+'"]').attr("selected",true);$("tbody select").niceSelect();apply.setSelectOption();thisTr.find(".operate-canel").click(function(){thisTr.html(thisTrHtml)})});$(".mid-apply-table,.all-apply-table").on("click",".operate-del",function(){var thisBtn=$(this);var thisTr=thisBtn.parents("tr");$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){thisTr.remove()}})});$(".mid-apply-table,.all-apply-table").on("click",".operate-save",function(){var thisBtn=$(this);var thisTr=thisBtn.parents("tr");var targetOneText=thisTr.find("select.target-item-one option:selected").text();var targetOneCode=thisTr.find("select.target-item-one option:selected").val();var targetTwoText=thisTr.find("select.target-item-two option:selected").text();var targetTwoCode=thisTr.find("select.target-item-two option:selected").val();var targetThreeText=thisTr.find("select.target-item-three option:selected").text();var targetThreeCode=thisTr.find("select.target-item-three option:selected").val();var inputVal=thisTr.find(".input-val").val();var tdText=thisTr.find(".target-td-five").text();if(targetOneText=="请选择"||targetTwoText=="请选择"||targetThreeText=="请选择"||inputVal==""){$yt_alert_Model.prompt("请输入完整数据")}else{var targetOneHtml='<span class="firstCode" style="display:none;">'+targetOneCode+'</span><span>'+targetOneText+'</span>';var targetTwoHtml='<span class="secondCode" style="display:none;">'+targetTwoCode+'</span><span>'+targetTwoText+'</span>';var targetThreeHtml='<span class="threeCode" style="display:none;">'+targetThreeCode+'</span><span>'+targetThreeText+'</span>';thisTr.find(".target-td-one").html(targetOneHtml);thisTr.find(".target-td-two").html(targetTwoHtml);thisTr.find(".target-td-three").html(targetThreeHtml);thisTr.find(".target-td-four").html(inputVal);thisTr.find(".target-td-five").html(tdText);thisTr.find(".target-td-six").html('<span class="operate-edit"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span>')}});$(".mid-apply-table,.all-apply-table").on("click",".operate-canel",function(){var thisBtn=$(this);var thisTr=thisBtn.parents("tr");thisTr.remove()});$("#newMidTr").on("click",function(){apply.getSelectListData("#midPerformance")});$("#newYearTr").on("click",function(){apply.getSelectListData("#yearPerformance")})},validate:function(){$("#midMoney").find("input.totalMoney,input.financeMoney,input.otherMoney").blur(function(){var totalAmount=$yt_baseElement.rmoney($("#totalAmount").val());var financeAmount=$("#financeAmount").val();var otherAmount=$("#otherAmount").val();if($("#financeAmount").val()!=''||$("#otherAmount").val()!=''){financeAmount=(financeAmount==''?0:$yt_baseElement.rmoney(financeAmount));otherAmount=(otherAmount==''?0:$yt_baseElement.rmoney(otherAmount));if(financeAmount==0&&otherAmount==0){$yt_alert_Model.prompt("中期资金总额应等于财政拨款和其他资金总和");return false}else if(financeAmount>0||otherAmount>0){if(totalAmount!=financeAmount+otherAmount){$yt_alert_Model.prompt("中期资金总额应等于财政拨款和其他资金总和");return false}}}});$("#yearMoney").find("input.totalMoney,input.financeMoney,input.otherMoney").blur(function(){var totalAmount=$yt_baseElement.rmoney($("#yearTotalAmount").val());var financeAmount=$("#yearFinanceAmount").val();var otherAmount=$("#yearOtherAmount").val();if($("#yearFinanceAmount").val()!=''||$("#yearOtherAmount").val()!=''){financeAmount=(financeAmount==''?0:$yt_baseElement.rmoney(financeAmount));otherAmount=(otherAmount==''?0:$yt_baseElement.rmoney(otherAmount));if(financeAmount==0&&otherAmount==0){$yt_alert_Model.prompt("年度资金总额应等于财政拨款和其他资金总和");return false}else if(financeAmount>0&&otherAmount>0){if(totalAmount!=financeAmount+otherAmount){$yt_alert_Model.prompt("年度资金总额应等于财政拨款和其他资金总和");return false}}}})},getSelectListData:function(id){var datas=apply.getSelectText("0");var str='';str+='<tr><td class="target-td-one"><div style="float: left;width: 100%;"><select  class="yt-select select-width target-item-one"><option value="">请选择</option>';$.each(datas,function(index,data){str+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});str+='</select></div></td><td class="target-td-two"><div style="float: left;width: 100%;"><select  class="yt-select select-width target-item-two"><option value="">请选择</option></select></div></td><td class="target-td-three"><div style="float: left;width: 100%;"><select  class="yt-select select-width target-item-three"><option value="">请选择</option></select></div></td><td class="target-td-four"><input type="text" class="yt-input input-val" placeholder="请输入" style="text-align: right;width: 95%;padding-right: 4px;" /></td><td class="target-td-five"></td><td class="target-td-six"><span class="operate-save"><img src="../../../../../resources-sasac/images/common/save-icon.png"></span><span class="operate-canel"><img src="../../../../../resources-sasac/images/common/canel-icon.png"></span></td></tr>';$(id).append(str);apply.setSelectOption();$("select").niceSelect()},setSelectOption:function(){$("#midPerformance .target-item-one,#yearPerformance .target-item-one").on("change",function(){var thisSelect=$(this);var thisTr=thisSelect.parents("tr");thisTr.find("select.target-item-two").html('<option value="">请选择</option>');thisTr.find("select.target-item-three").html('<option value="">请选择</option>');var prjTargetCode=$(this).children("option:selected").val();var datas=apply.getSelectText(prjTargetCode);var optionStr='';$.each(datas,function(index,data){optionStr+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});thisTr.find("select.target-item-two").append(optionStr);$("select.target-item-two").niceSelect()});$("#midPerformance .target-item-two,#yearPerformance .target-item-two").on("change",function(){var thisSelect=$(this);var thisTr=thisSelect.parents("tr");thisTr.find("select.target-item-three").html('<option value="">请选择</option>');var prjTargetCode=$(this).children("option:selected").val();var datas=apply.getSelectText(prjTargetCode);var optionStr='';$.each(datas,function(index,data){optionStr+='<option value="'+data.prjTargetCode+'">'+data.prjTargetName+'</option>'});thisTr.find("select.target-item-three").append(optionStr);$("select.target-item-three").niceSelect()});$("#midPerformance .target-item-three,#yearPerformance .target-item-three").on("change",function(){var thisSelect=$(this);var thisTr=thisSelect.parents("tr");var threeSelect=thisTr.find("select.target-item-three option:selected").val();var datas=apply.selectList;for(var i=0;i<datas.length;i+=1){if(datas[i].prjTargetCode==threeSelect){thisTr.find(".target-td-five").text(datas[i].units);}}})},getSelectText:function(code){$.ajax({type:"post",url:"budget/prjApp/getPrjTargetListByParentCode",async:false,data:{parentCode:code},success:function(respond){if(respond.flag==0){apply.selectList=respond.data;}}});return apply.selectList},getFormData:function(){var midGoalInfo={goalId:apply.midGoalId,totalAmount:$yt_baseElement.rmoney($("#totalAmount").val()||'0'),financeAmount:$yt_baseElement.rmoney($("#financeAmount").val()||'0'),otherAmount:$yt_baseElement.rmoney($("#otherAmount").val()||'0'),goalContent:$("#goalContent").val(),midKpiInfoList:apply.tableText("#midPerformance")};var midGoalInfoStr=JSON.stringify(midGoalInfo);var yearGoalInfo={goalId:apply.yearGoalId,totalAmount:$yt_baseElement.rmoney($("#yearTotalAmount").val()||'0'),financeAmount:$yt_baseElement.rmoney($("#yearFinanceAmount").val()||'0'),otherAmount:$yt_baseElement.rmoney($("#yearOtherAmount").val()||'0'),goalContent:$("#yearGoalContent").val(),yearKpiInfoList:apply.tableText("#yearPerformance")};var yearGoalInfoStr=JSON.stringify(yearGoalInfo);var attrIdStr='';if($("#attIdStr .li-div").length>0){$("#attIdStr .li-div").each(function(){attrIdStr+=$(this).attr("fid")+","})}return{processInstanceId:apply.processInstanceId,budgetPrjAppId:apply.budgetPrjAppId,prjName:$("#prjName").val(),prjUnitName:$("#prjUnitName").val(),compUnitName:$("#compUnitName").val(),implUnitName:$("#implUnitName").val(),prjClassifyName:$("#prjClassifyName").val(),prjAttrName:$("#prjAttrName").val(),prjStartYear:$("#prjStartYear").val(),prjCycle:$("#prjCycle").val(),prjBasisContent:$("#prjBasisContent").val(),implPlanFeasContent:$("#implPlanFeasContent").val(),attrIdStr:attrIdStr,midGoalInfo:midGoalInfoStr,yearGoalInfo:yearGoalInfoStr,}},clearPageData:function(){$("#newProjectApply input,#newProjectApply textarea").val('');$("#newProjectApply select").each(function(i,n){$(this).find("option:eq(0)").attr("selected","selected")});$("#newProjectApply select").niceSelect()},tableText:function(id){arr=[];var len=$(id).children().length;var arrTemp=[];var json={};for(var i=0;i<len;i+=1){for(var j=0;j<3;j+=1){arrTemp.push($(id).children().eq(i).children().eq(j).children().eq(0).text());}arrTemp.push($(id).children().eq(i).children().eq(3).text());if(arrTemp[0]==""||arrTemp[1]==""||arrTemp[2]==""||arrTemp[3]==""){arr=[]}else{json={oneTargetCode:arrTemp[0],twoTargetCode:arrTemp[1],threeTargetCode:arrTemp[2],prjTargetValue:arrTemp[3]};arr.push(json);arrTemp=[];json={};}}return arr;},uploadFile:function(){$(".file-up-div").off().on('change','.cont-file',function(obj){var fileElementId=this.id;var ithisParent=$('#attIdStr');var url=$yt_option.base_path+"/fileUpDownload/upload?ajax=1&modelCode=REIM_APP";var imgUlr='';$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:fileElementId,success:function(data,textStatus){if(data.flag==0){var attaElement=$('<div fId="'+data.data.pkId+'" class="li-div"><span>'+data.data.naming+'</span><span class="del-file">x</span></div>');ithisParent.append(attaElement)}else{$yt_alert_Model.prompt(data.message)}$('#attIdStr .file-pv img').showImg()},error:function(data,status,e){$yt_alert_Model.prompt(data.message)}})})},showFileList:function(list){if(list.length>0){var ls='';$.each(list,function(i,n){ls+='<div fid="'+n.attId+'" class="li-div"><span>'+n.attName+'</span><span class="del-file">x</span></div>'});$('#attIdStr').html(ls)}},applicationApply:function(){if(apply.budgetPrjAppId!=""&&apply.budgetPrjAppId!=undefined&&apply.budgetPrjAppId!=null){$.ajax({type:"post",url:'budget/prjApp/getBudgetPrjAppInfoByAppId',async:false,data:{budgetPrjAppId:apply.budgetPrjAppId},success:function(respond){var data=respond.data;if(respond.flag==0){apply.formData=respond.data;apply.processInstanceId=data.processInstanceId;apply.midGoalId=data.midGoalInfo.goalId;apply.yearGoalId=data.yearGoalInfo.goalId;apply.showFileList(data.attrList);$("#formNum").text(data.budgetPrjAppNum==""?"提交自动生成":data.budgetPrjAppNum);$("#applyDate").text(data.applicantTime==""?"--":data.applicantTime);$("#busiUsers").text(data.applicantUserName);$("#deptName").text(data.applicantUserDeptName);$("#jobName").text(data.applicantUserPositionName);$("#telPhone").text(data.applicantUserPhone);$("#prjName").val(data.prjName);$("#prjUnitName").val(data.prjUnitName);$("#compUnitName").val(data.compUnitName);$("#prjClassifyName").val(data.prjClassifyName);$("#prjStartYear").val(data.prjStartYear);$("#prjCycle").val(data.prjCycle);$("#implUnitName").val(data.implUnitName);$("#prjAttrName").val(data.prjAttrName);$("#prjBasisContent").val(data.prjBasisContent);$("#implPlanFeasContent").val(data.implPlanFeasContent);$("#implUnitName").val(data.implUnitName);if(data.midGoalInfo!=''&&data.midGoalInfo!=undefined&&data.midGoalInfo!=null){$("#totalAmount").val($yt_baseElement.fmMoney(data.midGoalInfo.totalAmount));$("#financeAmount").val($yt_baseElement.fmMoney(data.midGoalInfo.financeAmount));$("#otherAmount").val($yt_baseElement.fmMoney(data.midGoalInfo.otherAmount));$("#goalContent").val(data.midGoalInfo.goalContent);var targetHtml='';if(data.midGoalInfo.midKpiInfoList&&data.midGoalInfo.midKpiInfoList.length>0){$.each(data.midGoalInfo.midKpiInfoList,function(index,data){targetHtml+='<tr><td class="target-td-one"><span class="firstCode" style="display:none;">'+data.oneTargetCode+'</span><span>'+data.oneTargetName+'</span></td><td class="target-td-two"><span class="secondCode" style="display:none;">'+data.twoTargetCode+'</span><span>'+data.twoTargetName+'</span></td><td class="target-td-three"><span class="threeCode" style="display:none;">'+data.threeTargetCode+'</span><span>'+data.threeTargetName+'</span></td><td class="target-td-four">'+data.prjTargetValue+'</td><td class="target-td-five">'+data.units+'</td><td class="target-td-six"><span class="operate-edit"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span></td></tr>'});$("#midPerformance").html(targetHtml)}else{apply.getSelectListData("#midPerformance")}};if(data.yearGoalInfo!=''&&data.yearGoalInfo!=undefined&&data.yearGoalInfo!=null){$("#yearTotalAmount").val($yt_baseElement.fmMoney(data.yearGoalInfo.totalAmount));$("#yearFinanceAmount").val($yt_baseElement.fmMoney(data.yearGoalInfo.financeAmount));$("#yearOtherAmount").val($yt_baseElement.fmMoney(data.yearGoalInfo.otherAmount));$("#yearGoalContent").val(data.yearGoalInfo.goalContent);var targetYearHtml='';if(data.yearGoalInfo.yearKpiInfoList!=null&&data.yearGoalInfo.yearKpiInfoList.length>0){$.each(data.yearGoalInfo.yearKpiInfoList,function(index,data){targetYearHtml+='<tr><td class="target-td-one"><span class="firstCode" style="display:none;">'+data.oneTargetCode+'</span><span>'+data.oneTargetName+'</span></td><td class="target-td-two"><span class="secondCode" style="display:none;">'+data.twoTargetCode+'</span><span>'+data.twoTargetName+'</span></td><td class="target-td-three"><span class="threeCode" style="display:none;">'+data.threeTargetCode+'</span><span>'+data.threeTargetName+'</span></td><td class="target-td-four">'+data.prjTargetValue+'</td><td class="target-td-five">'+data.units+'</td><td class="target-td-six"><span class="operate-edit"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span></td></tr>'});$("#yearPerformance").html(targetYearHtml)}else{apply.getSelectListData("#yearPerformance")}}}}})}}};$(function(){apply.init()});
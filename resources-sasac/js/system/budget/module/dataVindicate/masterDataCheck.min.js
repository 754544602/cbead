var masterData={seldatas:'',init:function(){$('select').niceSelect();masterData.leftLiClick();$('.single-btn').click(function(){masterData.clickSingleButton()});masterData.ulPage();$('.disable-btn').off().on("click",function(){var liCheck=$(".master-data-ul .master-check").data("ulData");var tableKey=liCheck.tableKey;var funAllUrl=liCheck.funAllUrl;var dictCode=liCheck.dictCode;masterData.setClassifyMenuToDisable(dictCode,liCheck.state)});$('.a-update').off().on("click",function(){$(".master-data-name").hide();$(".a-update").hide();$(".master-data-name-input").show();$(".a-save").show();$(".a-clear").show();$(".master-data-name-input").val($(".master-data-name").text());$('.a-save').off().on("click",function(){masterData.updateClassifyMenuName()});$('.a-clear').off().on("click",function(){$(".master-data-name").show();$(".a-update").show();$(".master-data-name-input").hide();$(".a-save").hide();$(".a-clear").hide();$(".master-data-name-input").val('')})});$("button.upload-btn").click(function(){window.location.href=$yt_option.base_path+'budget/dictExcel/downloadExcelFile'})},leftLiClick:function(){$(".master-data-ul li").click(function(){$(".master-data-ul li").removeClass('master-check');$(".master-data-ul li").addClass('master-noCheck');$(this).removeClass('master-noCheck');$(this).addClass('master-check');masterData.getUlCheck()})},updateClassifyMenuName:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");var disvalue=$(".master-data-name-input").val();$.ajax({type:"post",url:'budget/dict/updateClassifyMenuName',async:false,data:{dictCode:liCheck.dictCode,disvalue:disvalue},success:function(data){$yt_alert_Model.prompt(data.message);$(".master-data-name").show();$(".a-update").show();$(".master-data-name-input").hide();$(".a-save").hide();$(".a-clear").hide();$(".master-data-name-input").val('');masterData.ulPage()}})},ulPage:function(){$.ajax({type:"post",url:"budget/dict/getClassifyMenuList",async:false,data:{},success:function(data){var datas=data.data;var htmlUl=$('.master-data-ul');htmlUl.empty();var dStr="";if(data.flag==0){var datas=data.data;$.each(datas,function(i,n){dStr+='<li>'+n.disvalue+'</li>';dStr=$(dStr).data("ulData",n);htmlUl.append(dStr)});$('.master-data-ul li').first().addClass('master-check');masterData.leftLiClick();masterData.getUlCheck()}}})},getUlCheck:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");var tableKey=liCheck.tableKey;var funAllUrl=liCheck.funAllUrl;var dictCode=liCheck.dictCode;$(".master-data-state").text(liCheck.state==1?'启用':'停用');$(".master-data-name").text(liCheck.disvalue);if(liCheck.isChangeState==1){$(".disable-btn").show();if($(".master-data-state").text()=='启用'){$(".disable-btn img").attr('src','../../../../../resources-sasac/images/common/block-up.png');$(".disable-btn img").attr('title','停用');}else{$(".disable-btn img").attr('src','../../../../../resources-sasac/images/common/using-icon.png');$(".disable-btn img").attr('title','启用');}}else{$(".disable-btn").hide()}masterData.getAllBudgetClassifyDataByParams(tableKey,funAllUrl);masterData.getBudgetYear(dictCode)},setClassifyMenuToDisable:function(dictCode,state){var dataUrl='';if(state==1){dataUrl='budget/dict/setClassifyMenuToDisable'}else{dataUrl='budget/dict/setClassifyMenuToEnable'}$.ajax({type:"post",url:dataUrl,async:true,data:{dictCode:dictCode},success:function(data){$yt_alert_Model.prompt(data.message);masterData.ulPage()}})},getBudgetYear:function(dictCode,subId){subId=(subId==undefined?"":subId);$.ajax({type:"post",url:"budget/dict/getParentDataInfo",async:false,data:{dictCode:dictCode,subId:subId,queryParams:''},success:function(data){var datas=data.data;masterData.seldatas=data.data;if(data.flag==0){masterData.setBudgetYearSelect()}}})},setBudgetYearSelect:function(code){var html='';$.each(masterData.seldatas,function(i,n){html+='<option '+(code==n.subCode?'selected':'')+' value="'+n.subCode+'">'+(n.subNum==""?"":'('+n.subNum+')')+''+n.subName+'</option>'});$("#parentSubCode").html(html).niceSelect({search:true,backFunction:function(text){var opt="";$("#parentSubCode option").remove();if(text==""){$("#parentSubCode").append('<option value="">请选择</option>')}var selNum=0;$.each(masterData.seldatas,function(i,n){if(n.subName.indexOf(text)!=-1){selNum+=1;$("#parentSubCode").append('<option value="'+n.subCode+'">'+(n.subNum==""?"":'('+n.subNum+')')+''+n.subName+'</option>')}else if(n.subNum.indexOf(text)!=-1){selNum+=1;$("#parentSubCode").append('<option value="'+n.subCode+'">'+(n.subNum==""?"":'('+n.subNum+')')+''+n.subName+'</option>')}});if(selNum==0){$("#parentSubCode").html('<option value="" disabled="disabled">无匹配数据</option>')}}})},getAllBudgetClassifyDataByParams:function(tableKey,funAllUrl){$('.page1').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:funAllUrl,type:'post',data:{queryParams:''},objName:'data',success:function(data){var htmlTbody=$('.wait-table tbody');htmlTbody.empty();var dStr="";if(data.flag==0){var datas=data.data.rows;if(datas.length>0){$('.page1').show();$.each(datas,function(i,n){dStr+='<tr parentSubCode="'+n.parentSubCode+'" parentSubName="'+n.parentSubName+'"><td class="text-overflow" style="text-align: left;" title="'+n.subNum+'">'+n.subNum+'</td><td class="text-overflow" style="text-align: left;" title="'+n.subName+'">'+n.subName+'</td><td>'+(n.source==1?'标准':'单位自定义')+'</td><td class="text-overflow" style="text-align: left;" title="'+n.describe+'">'+(n.describe||'无')+'</td><td style="text-align: left;">'+(n.parentSubNum==""?"":'('+n.parentSubNum+')')+(n.parentSubName||'--')+'</td><td class="'+(n.state==1?'state-color-green':'state-color-red')+'">'+(n.state==1?'启用':'停用')+'</td><td><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span>';if(n.state==1){dStr+='<span class="operate-dis mar-left" title="停用"><img src="../../../../../resources-sasac/images/common/block-up.png" /></span>';}else{dStr+='<span class="operate-ena mar-left" title="启用"><img src="../../../../../resources-sasac/images/common/using-icon.png" /></span>';}dStr+='<span class="operate-del mar-left"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span>'+'</td></tr>';dStr=$(dStr).data("waitData",n);htmlTbody.append(dStr)})}else{$('.page1').hide();htmlTbody.append(sysCommon.noDataTrStr(7))}masterData.deleteClassifyData();masterData.updateClassifyDataInfo();masterData.setClassifyDataToEnable();masterData.setClassifyDataToDisable()}else{$('.page1').hide();htmlTbody.append(sysCommon.noDataTrStr(7))}},isSelPageNum:true })},deleteClassifyData:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");$('.operate-del').click(function(){var waitData=$(this).parents('tr').data('waitData');$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){$.ajax({type:"post",url:'budget/dict/deleteClassifyData',async:true,data:{dictCode:liCheck.dictCode,subCode:waitData.subCode},success:function(data){$yt_alert_Model.prompt(data.message);masterData.getUlCheck()}})}})})},setClassifyDataToEnable:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");$('.operate-ena').click(function(){var waitData=$(this).parents('tr').data('waitData');$.ajax({type:"post",url:'budget/dict/setClassifyDataToEnable',async:true,data:{dictCode:liCheck.dictCode,subCode:waitData.subCode},success:function(data){$yt_alert_Model.prompt(data.message);masterData.getUlCheck()}})})},setClassifyDataToDisable:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");$('.operate-dis').click(function(){var waitData=$(this).parents('tr').data('waitData');$.ajax({type:"post",url:'budget/dict/setClassifyDataToDisable',async:true,data:{dictCode:liCheck.dictCode,subCode:waitData.subCode},success:function(data){$yt_alert_Model.prompt(data.message);masterData.getUlCheck()}})})},updateClassifyDataInfo:function(code){if(code){$(".table-box").off().on("click",".operate-update",function(){var ithis=$(this);var tr=ithis.parents('tr');var table=ithis.parents('table');var liCheck=$(".master-data-ul .master-check").data("ulData");var dictCode=liCheck.dictCode;sysCommon.showModel($("#classifyDataInfoAlert"));$('#classifyDataInfoAlert .yt-model-canel-btn').off().on("click",function(){masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"));sysCommon.closeModel($("#classifyDataInfoAlert"))});$('.master-name-alert').text(liCheck.disvalue);$('.add-or-update').text('零星编辑');$('.subCode').val(tr.attr('subNum'));$('.subCode').attr("sub-code",tr.attr('subCode'));$('.subName').val(tr.attr('subName'));masterData.setBudgetYearSelect(tr.attr('parentSubCode'));$('.describe').val(tr.attr('describe'));var source=tr.attr('source');source=(source==""?"":source);$('.source-div .check-label input[value="'+source+'"]').setRadioState('check');$('#classifyDataInfoAlert .yt-model-sure-btn').off().on('click',function(){var parentSubCode=$(".parentSubCode option:selected").val();var parentSubName=$(".parentSubCode option:selected").text();parentSubName=(parentSubName=='请选择'?'':parentSubName);var subCode=$('.subCode').attr("sub-code");var subNum=$('.subCode').val();var subName=$(".subName").val();var source=$(".source-div .yt-radio.check input").val();var describe=$(".describe").val();var html='<tr class="is-update" subCode="'+subCode+'" subNum="'+subNum+'" subName="'+subName+'" source="'+source+'" parentSubCode="'+parentSubCode+'" describe="'+describe+'"><td class="font-l" title="'+subNum+'"><span class="sub-code" sub-code='+subCode+'>'+subNum+'</span></td><td class="font-l"  title="'+subName+'"><span class="sub-name">'+subName+'</span></td><td><span source="'+source+'" class="td-source">'+(source=="1"?"标准":"单位自定义")+'</span></td><td class="font-l" title="'+parentSubName+'"><span parent-code="'+parentSubCode+'" class="parent-name">'+parentSubName+'</span></td><td class="font-l"  title="'+describe+'"><span class="describe">'+(describe==""?"无":describe)+'</span></td><td><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del mar-left"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span></td></tr>';tr.replaceWith(html);sysCommon.closeModel($("#classifyDataInfoAlert"));masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"))})})}else{$(".wait-table").off().on("click",".operate-update",function(){var ithis=$(this);var tr=ithis.parents('tr');var liCheck=$(".master-data-ul .master-check").data("ulData");var dictCode=liCheck.dictCode;sysCommon.showModel($("#classifyDataInfoAlert"));var waitData=$(this).parents('tr').data('waitData');masterData.setBudgetYearSelect(tr.attr('parentSubCode'));$('#classifyDataInfoAlert .yt-model-canel-btn').off().on("click",function(){masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"));sysCommon.closeModel($("#classifyDataInfoAlert"))});$('.master-name-alert').text(liCheck.disvalue);$('.add-or-update').text('零星编辑');var parent=$(".parentSubCode option:selected").text();parent=(parent=='请选择'?'':parent);$('.subCode').attr("sub-code",waitData.subCode);$('.subCode').val(waitData.subNum);$(".subName").val(waitData.subName);$('.source-div input.sourceRadio[value="'+waitData.source+'"]').setRadioState('check');$(".describe").val(waitData.describe);$('#classifyDataInfoAlert .yt-model-sure-btn').off().on('click',function(){var valid=$yt_valid.validForm($("#classifyDataInfoAlert"));if(valid){var parent=$(".parentSubCode option:selected").val();parent=(parent=='请选择'?'':parent);var subCode=$('.subCode').attr("sub-code");var subNum=$('.subCode').val();var subName=$(".subName").val();var source=$(".source-div .yt-radio.check input").val();var describe=$(".describe").val();var parentSubCode=parent;$.ajax({type:"post",url:"budget/dict/updateClassifyDataInfo",async:true,data:{dictCode:liCheck.dictCode,subCode:subCode,subNum:subNum,subId:waitData.subId,subName:subName,source:source,state:waitData.state,parentSubCode:parentSubCode,describe:describe},success:function(data){var datas=data.data;if(data.flag==0){masterData.getUlCheck()}$yt_alert_Model.prompt(data.message);sysCommon.closeModel($("#classifyDataInfoAlert"));masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"))}})}})})}},clickSingleButton:function(){var liCheck=$(".master-data-ul .master-check").data("ulData");var dictCode=liCheck.dictCode;sysCommon.showModel($("#classifyDataInfoAlert"));masterData.getBudgetYear(dictCode);$('#classifyDataInfoAlert .yt-model-canel-btn').off().on("click",function(){masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"));sysCommon.closeModel($("#classifyDataInfoAlert"))});$('.master-name-alert').text(liCheck.disvalue);$('.add-or-update').text('零星添加');$('#classifyDataInfoAlert .yt-model-sure-btn').off().on('click',function(){var valid=$yt_valid.validForm($("#classifyDataInfoAlert"));if(valid){var parent=$(".parentSubCode option:selected").val();parent=(parent=='请选择'?'':parent);var subCode=$('.subCode').val();var subName=$(".subName").val();var source=$(".source-div .yt-radio.check input").val();var describe=$(".describe").val();var parentSubCode=parent;$.ajax({type:"post",url:"budget/dict/addClassifyDataInfo",async:true,data:{dictCode:liCheck.dictCode,subNum:subCode,subName:subName,source:source,parentSubCode:parentSubCode,describe:describe},success:function(data){var datas=data.data;if(data.flag==0){masterData.getUlCheck()}$yt_alert_Model.prompt(data.message);masterData.clearAlert($("#classifyDataInfoAlert"));sysCommon.clearValidInfo($(".subCode"));sysCommon.clearValidInfo($(".subName"))}})}})},clearAlert:function(obj){var inputs=obj.find('input:not(input[type="radio"],input[type="checkbox"])');inputs.val('');var radios=obj.find('input[type="radio"]:eq(0)').setRadioState("check");var textareas=obj.find('textarea');textareas.val('')}};var dataBox={invalidNumFlag:0,init:function(){dataBox.events()},events:function(){$("button.batch-btn").on("click",function(){sysCommon.showModel($("#fileDiv"))});$("body").undelegate("#reimFile").delegate("#reimFile","change",function(obj){var arr=$("#reimFile").val().split('\\');var filesName=arr[arr.length-1];var filesType=filesName.split('.');if(filesType[1]!="xls"&&filesType[1]!="xlsx"){$(".file-msg").text("请选择Excel文件").css("color","#999");$yt_alert_Model.prompt("请选择Excel文档");return false}else{$(".file-msg").text(filesName).css("color","#333333");$yt_alert_Model.prompt("正在导入...");dataBox.importFiles($("#reimFile"));sysCommon.closeModel($("#fileDiv"));$("#dataUpBox").css("display","block")}});$(".canel-btn").on("click",function(){sysCommon.closeModel($("#fileDiv"));$(".file-msg").text("请选择Excel文件").css("color","#999")});$(".close-btn").on("click",function(){sysCommon.closeModel($("#dataUpBox"));$(".table-box .listNoData").remove();$(".invalid-data .data-nav").removeClass("native").siblings().css("display","none");$(".un-update .data-nav").addClass("native").siblings().css("display","block");$('.table-box').find("tbody").html("")});$(".table-box").on("click",".operate-del",function(){var thisBtn=$(this);var thisTr=thisBtn.parents("tr");$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){thisTr.remove()}})});var code="1";masterData.updateClassifyDataInfo(code);$(".un-update,.invalid-data").on("click",".data-nav",function(){var thisDiv=$(this);if(thisDiv.hasClass("native")){thisDiv.removeClass("native").siblings().css("display","none")}else{thisDiv.addClass("native").siblings().css("display","block")}});$("#saveImportBtn").click(function(){var thisBtn=$(this);$(thisBtn).attr("disabled",true);var saveData=dataBox.getImportTableData();if(dataBox.invalidNumFlag>0){$(".un-update .data-nav").removeClass("native").siblings().css("display","none");$(".invalid-data .data-nav").addClass("native").siblings().css("display","block");$yt_alert_Model.alertOne({alertMsg:"列表中存在无效的数据，请检查列表数据，确定要继续保存吗？",confirmFunction:function(){dataBox.doSaveData(thisBtn,saveData)},cancelFunction:function(){$(thisBtn).attr("disabled",false)}})}else{dataBox.doSaveData(thisBtn,saveData)}})},doSaveData:function(thisBtn,saveData){var saveData=dataBox.getImportTableData();$.ajax({type:'post',url:'budget/dictExcel/improtSaveLotClassifyByExcel',async:false,data:saveData,success:function(data){$yt_alert_Model.prompt(data.message);$(thisBtn).attr("disabled",false);if(data.flag==0){$('.table-box').find("tbody").html("");$(".invalid-data .data-nav").removeClass("native").siblings().css("display","none");$(".un-update .data-nav").addClass("native").siblings().css("display","block");$(".table-box .listNoData").remove();masterData.getUlCheck();sysCommon.closeModel($("#dataUpBox"))}else{$yt_alert_Model.prompt(data.message)}},error:function(e){$(thisBtn).attr("disabled",false)}})},importFiles:function(thisFile){var liCheck=$(".master-data-ul .master-check").data("ulData");var dictCode=liCheck.dictCode;var thisFile=$(thisFile);var fileId=$("#reimFile").attr("id");var url=$yt_option.base_path+"budget/dictExcel/improtClassifyByExcel";var params="?dictCode="+dictCode;$.ajaxFileUpload({url:url+params,type:"post",dataType:'JSON',fileElementId:fileId,success:function(data,textStatus){if(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){masterData.getUlCheck();$(".file-msg").text("请选择Excel文件").css("color","#999");$("#reimFile").val('');sysCommon.closeModel($("#fileDiv"));var datas=data.data;$("#dataUpBox .data-name").text($(".master-data-name").text());$(".data-num").text(datas.insertCount);$(".upd-num").text(datas.updateCount);$(".invalid-num").text(datas.invalidCount);$('.table-box table').hide();$(".table-box").append('<div class="listNoData"></div>');if(datas.updateCount>0||datas.invalidCount>0){$("#dataUpBox").css("display","block");dataBox.createTableData(datas.updateList,$(".un-update"));dataBox.createTableData(datas.invalidList,$(".invalid-data"))}}}},error:function(data,status,e){console.log(data)}})},createTableData:function(dataList,tableObj){if(dataList.length>0){$(tableObj).find("tbody").html('');$(tableObj).find("table").show();$(tableObj).find(".table-box .listNoData").remove();var trStr="";$.each(dataList,function(i,v){var parentName="";if(v.parentSubCode==0||v.parentSubCode==""){parentName="--"}else if(v.parentSubName==""&&v.parentSubCode!=0){parentName="--"}else if(v.parentSubName==""&&v.parentSubCode==0){parentName="--"}else{parentName="("+v.parentSubNum+")"+v.parentSubName}trStr+='<tr subCode="'+v.subCode+'" subNum="'+v.subNum+'" subName="'+v.subName+'" source="'+v.source+'" parentSubCode="'+v.parentSubCode+'" describe="'+v.describe+'"><td class="font-l" title="'+v.subNum+'"><span class="sub-code" sub-code='+v.subCode+'>'+v.subNum+'</span></td><td class="font-l"  title="'+v.subName+'"><span class="sub-name">'+v.subName+'</span></td><td><span source="'+v.source+'" class="td-source">'+(v.source=="1"?"标准":v.source=="2"?"单位自定义":"")+'</span></td><td class="font-l" title="'+v.parentSubName+'"><span parent-code="'+v.parentSubCode+'" class="parent-name">'+parentName+'</span></td><td class="font-l"  title="'+v.describe+'"><span class="describe">'+(v.describe==""?"无":v.describe)+'</span></td><td><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del mar-left"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span></td></tr>'});$(tableObj).find("tbody").html(trStr)}},getImportTableData:function(){var updateList=[];var invalidList=[];var updateListJson="";var invalidListJson="";$(".un-update tbody tr").each(function(){updateList.push({subCode:$(this).find(".sub-code").attr("sub-code"),subNum:$(this).find(".sub-code").text(),subName:$(this).find(".sub-name").text(),source:$(this).find(".td-source").attr("source"),parentSubCode:$(this).find(".parent-name").attr("parent-code"),parentSubName:$(this).find(".parent-name").text(),describe:$(this).find(".describe").text()})});if(updateList.length>0){updateListJson=JSON.stringify(updateList)}var subCode="";var subName="";var source="";var parentCode="";$(".invalid-data tbody tr").each(function(){subCode=$(this).find(".sub-code").text();subName=$(this).find(".sub-name").text();source=$(this).find(".td-source").text();parentCode=$(this).find(".parent-name").attr("parent-code");if(!$(this).hasClass("is-update")){$(this).css("border-color","red");dataBox.invalidNumFlag+=1}else{invalidList.push({subCode:$(this).find(".sub-code").attr("sub-code"),subNum:$(this).find(".sub-code").text(),source:$(this).find(".td-source").attr("source"),parentSubCode:$(this).find(".parent-name").attr("parent-code"),parentSubName:$(this).find(".parent-name").text(),describe:$(this).find(".describe").text()})}});if(invalidList.length>0){invalidListJson=JSON.stringify(invalidList)}var liCheck=$(".master-data-ul .master-check").data("ulData");var dictCode=liCheck.dictCode;return{dictCode:dictCode,updateList:updateListJson,invalidList:invalidListJson }}};$(function(){dataBox.init();masterData.init();$("#masterDiv,#dataUpBox").css("min-height",$(window).height()-12)});
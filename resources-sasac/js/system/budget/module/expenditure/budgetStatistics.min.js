var budgetObj={configData:[],tableId:"",tableObj:"",publishId:'',processInstanceId:"",businessCode:"",init:function(){$(".flow-approve-model").html(sysCommon.createFlowApproveMode());$("select").niceSelect();var requerParameter=$yt_common.GetRequest();if(requerParameter){budgetObj.tableId=requerParameter.tableId;budgetObj.publishId=requerParameter.publishId;budgetObj.getTableDataStart();if(budgetObj.tableObj.budgetType=="A02"){budgetObj.businessCode="JBZC_APP_FLOW"}if(budgetObj.tableObj.budgetType=="A03"){budgetObj.businessCode="XMZC_APP_FLOW"}sysCommon.getApproveFlowData(budgetObj.businessCode,budgetObj.processInstanceId)}},eventFun:function(){$(".edit-btn").off().on("click",function(){var thisSelTable=$(".rule-table");thisSelTable.find("tbody tr:not(.disable-sty) td:not(.disable-sty) .money-text").hide();thisSelTable.find("tbody tr td .yt-input").each(function(){$(this).val($(this).parent().find(".money-text").text())});$(this).hide();$(".submit-btn").hide();thisSelTable.find("tr:not(.disable-sty) td:not(.disable-sty) .yt-input").show();$(".init-calculate-btn,.init-cancel-btn,.init-save-btn").show();$(".approve-stat-model").hide()});$(".init-calculate-btn").off().on("click",function(){budgetObj.calculateTableData()});$(".init-save-btn").off().on("click",function(){budgetObj.doSaveEvent()});$(".submit-btn").off().on("click",function(){$yt_alert_Model.alertOne({leftBtnName:"确定提交",rightBtnName:"暂不提交",alertMsg:"提交成功后，填写数据将被锁定,无法修改,如需要修改，请先联系预算处解除锁定！",confirmFunction:function(){$(this).attr("disabled","disabled");$.ajax({type:"post",url:'budget/report/setRreportBudgetTable',data:{publishTableId:budgetObj.publishId},async:false,success:function(data){$(this).attr("disabled",false);$yt_alert_Model.prompt(data.message,2000);if(data.flag=="0"){if(budgetObj.checkPrjFalg()){$yt_alert_Model.alertOne({leftBtnName:"前往填写",rightBtnName:"我已填写（稍后处理）",alertMsg:"当前预算包含财政项目预算，需完善项目信息。",confirmFunction:function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/projectApproval/projectApplyApproval.html'}})},cancelFunction:function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/budgetReport.html'}})}})}else{$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/budgetReport.html'}});$yt_alert_Model.prompt(data.message,2000)}if($(".approve-stat-model").is(":visible")){budgetObj.subApproval()}}},error:function(e){$(this).attr("disabled",false)}})}})});$(".init-cancel-btn").on("click",function(){budgetObj.initHeardBtn()});budgetObj.priceInputEvent();budgetObj.fileUpEvent()},doSaveEvent:function(validFlag){var selTabData=budgetObj.tableObj;var tabDatas="";var tableDatas=budgetObj.getSaveTableInfo();if(budgetObj.verifySaveData(tableDatas,validFlag)){$.ajax({type:"post",url:'budget/main/saveBudgetDataDetailInfo',data:{budgetDataJson:tableDatas,tableId:selTabData.tableId,publishTableId:budgetObj.publishId},async:false,success:function(data){if(data.flag=="0"){budgetObj.initHeardBtn();$(".approve-stat-model").show()}else{$yt_alert_Model.prompt(data.message,2000)}}})}},fileUpEvent:function(){$(".file-up-div").off().on('change','.cont-file',function(obj){var fileElementId=this.id;var ithisParent=$('#attIdStr');var url=$yt_option.base_path+"/fileUpDownload/upload?ajax=1&modelCode=REIM_APP";var imgUlr='';$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:fileElementId,success:function(data,textStatus){if(data.flag==0){$('#fileId').val(data.data.pkId);$('#fileName').val(data.data.naming)}else{$yt_alert_Model.prompt(data.message)}},error:function(data,status,e){$yt_alert_Model.prompt(data.message)}})});$('#fileUp').on('click',function(){var fid=$('#fileId').val();if(fid){if($yt_valid.validForm('.file-content')){budgetObj.saveFileInfo()}}else{$yt_alert_Model.prompt('请选择附件')}});$('#attIdStr').on('click','.file-dw',function(){var id=$(this).parents('.file-lable').attr('fid');window.location.href=$yt_option.base_path+'fileUpDownload/download?pkId='+id+'&isDownload=true'});$('#attIdStr').on('click','.del-file',function(){var ithis=$(this);var parent=ithis.parents('.file-lable');var id=parent.attr('fid');$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){budgetObj.deleteFileInfoById(id,function(){parent.remove()})}})})},priceInputEvent:function(){$("#createConfigTableDiv tbody tr td input").each(function(){if($(this).hasClass(".character-inpu")){}});$("#createConfigTableDiv").on("keyup",'.money-input',function(){if(!$(this).hasClass("character-inpu")){$(this).val($(this).val().replace(/[^\d.]/g,''))}});$("#createConfigTableDiv").on("focus",'.money-input',function(){if($(this).val()!=""&&$(this).val()!=null&&!$(this).hasClass("character-inpu")){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()}});$("#createConfigTableDiv").on("blur",'.money-input',function(){if(!$(this).hasClass("character-inpu")){if($(this).val()!=""&&$(this).val()!=null){$(this).val($yt_baseElement.fmMoney($(this).val()));$(this).parent().find(".money-text").text($(this).val())}else{$(this).parent().find(".money-text").text("0.00")}}})},initHeardBtn:function(){$(".edit-btn,.submit-btn,.rule-table tbody tr td .money-text").show();$(".init-save-btn,.init-cancel-btn,.init-calculate-btn,.rule-table tbody tr td .yt-input").hide();$(".rule-table tbody tr td .yt-input").val('');$(".rule-table tbody tr td .money-text").text('');budgetObj.getTableInfoList()},addTdHtml:function(tableObj){var thisTable=$('table.config-table[table-code="'+tableObj.tableCode+'"]');var tdNum=thisTable.find("tbody tr.flag-tr td:not(.flag-td)").length;var noDataTdFlag=thisTable.find("tbody tr.flag-tr td.flag-td").length;var tdStr="";if(tableObj.tableCode!="T26"&&tableObj.tableCode!="T28"&&tableObj.tableCode!="T29"&&tableObj.tableCode!="T30"&&tableObj.tableCode!="T31"&&tableObj.tableCode!="T32"&&tableObj.tableCode!="T33"){for(var i=0;i<tdNum;i+=1){tdStr+='<td class="right-td c'+(i+1)+'" fieldFlag=c'+(i+1)+'><span class="money-text"></span><input type="text" value="" class="yt-input money-input"/></td>'}if(noDataTdFlag==1){thisTable.find("tbody tr:gt(0)").each(function(){$(this).find('td:eq(0)').nextAll("td").remove();$(this).addClass('r'+$(this).index()+'');$(this).attr("fieldFlag",'r'+$(this).index()+'');$(this).find('td:eq(0)').after(tdStr)})}else{thisTable.find("tbody tr:gt(0)").each(function(){$(this).find('td:gt('+(noDataTdFlag-2)+')').nextAll("td").remove();$(this).addClass('r'+$(this).index()+'');$(this).attr("fieldFlag",'r'+$(this).index()+'');$(this).find('td:gt('+(noDataTdFlag-2)+')').after(tdStr)})}}budgetObj.priceInputEvent()},getTableInfoList:function(){$.ajax({type:"post",url:'budget/main/getBudgetDataDetailInfo',async:false,data:{"tableId":budgetObj.tableId,"publishTableId":budgetObj.publishId},success:function(data){if(data.flag==0){if(data.data.length>0){var tbody=$('.rule-table .yt-tbody');$.each(data.data,function(i,n){$(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".yt-input").val(n.crValue)}}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}});$("button.page-retun-btn").click(function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/budgetReport.html'}})})},calculateTableData:function(){var selTabData=budgetObj.tableObj;var getTableDatas=budgetObj.getSaveTableInfo();$.ajax({type:"post",url:'budget/main/calcBudgetData',async:false,data:{"tableId":selTabData.tableId,"budgetDataJson":getTableDatas,"publishTableId":budgetObj.publishId},success:function(data){if(data.flag==0){if(data.data.length>0){$.each(data.data,function(i,n){$(".rule-table tbody tr").each(function(i,r){if($(r).attr("fieldflag")==n.rowNum){$.each($(r).find("td"),function(i,c){if($(c).attr("fieldflag")==n.cellNum){if(n.crValue=="#VALUE!"||n.crValue==undefined||n.crValue==""||n.crValue==null){n.crValue=0}$(c).find(".money-text").html($yt_baseElement.fmMoney(n.crValue));$(c).find(".money-input").val($yt_baseElement.fmMoney(n.crValue))}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},totalMoney:function(obj){var thisTrConfig="";var thisTdConfig="";var thisTd="";var tdVal="";var thisTr="";var price=0;var useConfigData=[];var cFieldflag=$(obj).attr("fieldflag");var rFieldflag=$(obj).parent().attr("fieldflag");for(var n=0;n<budgetObj.configData.length;n+=1){var calvValue=budgetObj.configData[n].calcValue;calvValue=calvValue.replace(/\+/g,'#');calvValue=calvValue.replace(/\-/g,'#');calvValue=calvValue.replace(/\*/g,'#');calvValue=calvValue.replace(/\//g,'#');calvValue=calvValue.replace(/\(/g,'#');calvValue=calvValue.replace(/\)/g,'#');calvValue="#"+calvValue+"#";if(calvValue.indexOf("#"+cFieldflag+"#")!=-1||calvValue.indexOf("#"+rFieldflag+"#")!=-1){useConfigData.push(budgetObj.configData[n])}}$.each(useConfigData,function(i,n){if(n.type=="c"){budgetObj.totalMoneyFun($(obj).parent().find("td[fieldflag='"+n.crNum+"']"))}else{budgetObj.totalMoneyFun($(".rule-table tr[fieldflag='"+n.crNum+"']").find("td[fieldflag='"+cFieldflag+"']"))}})},totalMoneyFun:function(ele){var configData;var thisTrConfig="";var thisTdConfig="";var thisTd="";var tdVal="";var tdNum=0;var repStr="";var thisTr="";var price=0;$.each(ele,function(i,r){try{thisTdConfig=$(this).data("configData");thisTrConfig=$(this).parent().data("configData");thisTd=$(this).index();thisTr=$(this).parent();if(thisTrConfig&&thisTrConfig.calcItem=="1"){tdVal=thisTrConfig.calcValue;configData=thisTrConfig}else{tdVal=thisTdConfig.calcValue;configData=thisTdConfig}if(tdVal!=""&&tdVal!=undefined){tdNum=$(".rule-table tbody tr").length;repStr="r";if(configData.type=="c"){tdNum=$(".rule-table tbody tr:eq(0) td").length;repStr="c"}for(var j=tdNum;j>0;j-=1){var re=new RegExp(repStr+j,"g");price=0;if(configData.type=="c"){var re=new RegExp("c"+j,"g");if($(thisTr).find("td").eq(j+2).find("span").text()==""){price=0}else{price=$yt_baseElement.rmoney($(thisTr).find("td").eq(j+2).find("span").text())}}else{if($(".rule-table .r"+j).find("td").eq(thisTd).find("span").text()==""){price=0}else{price=$yt_baseElement.rmoney($(".rule-table .r"+j).find("td").eq(thisTd).find("span").text())}}tdVal=tdVal.replace(re,price)}if(isNaN(eval(tdVal))){$(this).find("span").text("error")}else{$(this).find("span").text($yt_baseElement.fmMoney(eval(tdVal)))}}}catch(e){$(this).find("span").text("error")}})},getSaveTableInfo:function(){var tableList=[];var tableJson="";var thisTableTbody=$(".rule-table tbody");var rowConfig;var colConfig;var price=0;var budgetMainId="";thisTableTbody.find("tr").each(function(i,n){if(!$(n).hasClass("disable-sty")){$(n).find("td").each(function(v,c){if(!$(c).hasClass("disable-sty")){price='';if($(c).find(".yt-input").hasClass("money-input")){price=$yt_baseElement.rmoney($(c).find(".yt-input").val())}else{price=$(c).find(".yt-input").val()}budgetMainId="";if($(c).attr("budgetMainId")!=undefined&&$(c).attr("budgetMainId").length>0){budgetMainId=$(c).attr("budgetMainId")}var propertyInfo={};propertyInfo["cellNum"]=$(this).attr("fieldflag");propertyInfo["rowNum"]=$(this).parent().attr("fieldflag");propertyInfo["crNum"]=$(this).attr("fieldflag")+$(this).parent().attr("fieldflag");propertyInfo["crValue"]=price;propertyInfo["budgetMainId"]=budgetMainId;tableList.push(propertyInfo)}})}});if(tableList.length>0){tableJson=JSON.stringify(tableList)}return tableJson},getConfigInfo:function(selTabData){budgetObj.configData=[];$.ajax({type:"post",url:'budget/confg/getTableAllCongfigByTableId',async:false,data:{tableId:budgetObj.tableId},success:function(data){var crNums="";if(data.flag==0){if(data.data.length>0){budgetObj.configData=data.data;$.each(data.data,function(i,n){if(n.type=="c"){$(".rule-table tbody tr td").each(function(v,c){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty")}if(n.calcItem=="2"){$(this).find("input").addClass("character-inpu").removeClass('money-input').show()}else{$(this).find("input").removeClass('character-inpu').addClass("money-input")}if(n.editorItem==1){$(this).addClass("priori-td")}$(this).data("configData",n)}})}});$.each(data.data,function(i,n){if(n.type=="r"){$(".rule-table tbody tr").each(function(i,r){if(n.crNum==$(this).attr("fieldFlag")&&n.calcItem!="5"&&n.editorItem!="1"){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty").find('td:not(.priori-td)').addClass("disable-sty")}if(n.calcItem=="2"){$(this).find("td:not(.priori-td) input").addClass("character-inpu").removeClass('money-input').show()}else{$(this).find("td:not(.priori-td) input").removeClass('character-inpu').addClass("money-input")}$(this).data("configData",n)}})}});$.each(data.data,function(i,n){if(n.type=="cr"){crNums=n.crNum.split("-");var inpt=$('.rule-table tbody td.'+crNums[0]+''+crNums[1]+' input');if(n.calcItem=="1"||n.calcItem=="4"){$('.rule-table tbody td.'+crNums[0]+''+crNums[1]).addClass("disable-sty")}if(n.calcItem&&n.calcItem=="2"){inpt.addClass("character-inpu").removeClass('money-input').show()}else{inpt.removeClass('character-inpu').addClass("money-input")}}});$('.rule-table tbody tr td.disable-sty .yt-input').hide()}}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableDataStart:function(){budgetObj.getBudgetTableDetailByTableId(budgetObj.publishId);$('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();html='<span class="money-text">'+html+'</span><input class="yt-input money-input" value="" />';$(this).html(html)});$(this).addClass("yt-table-active").siblings().removeClass("yt-table-active");$(".no-select-table").hide();$('.config-table').removeClass("select-table").hide();$('table[table-code="'+budgetObj.tableObj.tableCode+'"]').show().addClass("select-table");$(".tab-content:eq(1)").show().siblings().hide();$(".btn-group-model").show();budgetObj.addTdHtml(budgetObj.tableObj);budgetObj.initHeardBtn();budgetObj.getConfigInfo(budgetObj.tableObj);if(budgetObj.tableObj.submitState==1){$(".edit-btn,.submit-btn").addClass("yt-btn-disabled").attr("disabled","disabled");$(".rule-table").find("tbody tr:not(.disable-sty) td:not(.disable-sty) input").hide()}else{var thisSelTable=$(".rule-table");thisSelTable.find("tbody tr:not(.disable-sty) td:not(.disable-sty) .money-text").hide();thisSelTable.find("tbody tr td .money-input").each(function(){$(this).val($(this).parent().find(".money-text").text())});$(".edit-btn,.submit-btn").removeClass("yt-btn-disabled").removeAttr("disabled").hide();thisSelTable.find("tr:not(.disable-sty) td:not(.disable-sty) .money-input").show();$(".init-calculate-btn,.init-cancel-btn,.init-save-btn").show()}},getBudgetTableDetailByTableId:function(publishId){$.ajax({type:'post',url:'budget/main/getBudgetTableDetailByPublishTableId',async:false,data:{publishTableId:publishId},success:function(data){var dataObj=data.data||{};budgetObj.tableObj=dataObj;budgetObj.getFileInfoList(budgetObj.tableId,data.deptId);var budgetState="";switch(dataObj.budgetStage){case "1":budgetState='一上阶段';break;case "2":budgetState='';break;case "3":budgetState='二上阶段';break}$(".budget-state").text(budgetState);$(".dept-name").text(dataObj.deptName);$("#tableDescribe").text(dataObj.tagging);$(".btn-group-model .tab-name").text(dataObj.tableName);$('#createConfigTableDiv').html('').newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:false});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('disable-sty')})}else if(proper.type=='r'){$('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('disable-sty')}}$('.rule-table').data('tableData',dataObj);$('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1)).addClass('c'+(j+1)+'r'+(i+1))})})}})},getFileInfoList:function(tableId,deptId){$.ajax({type:'post',url:'budget/files/getFileInfoList',data:{tableId:tableId,deptId:$yt_common.user_info.deptId,budgetStage:''},success:function(data){if(data.flag==0){var html='';$.each(data.data,function(i,n){html+='<div class="file-lable" fid="'+n.attId+'"><div class=""><a class="yt-link file-dw">'+n.attName+'</a><label class="del-file">x</label></div><div class=""><span>文件说明：</span><span class="">'+n.attRemarks+'</span></div></div>'});$('#attIdStr').html(html)}}})},deleteFileInfoById:function(id,callback){$.ajax({type:'post',url:'budget/files/deleteFileInfoById',data:{attId:id},success:function(data){if(data.flag==0){if(callback){callback()}}$yt_alert_Model.prompt(data.message)}})},subApproval:function(){var dealingWithPeople=$("#approve-users").val();var nextCode=$("#operate-flow").val();var opintion=$("#opintion").val();var processInstanceId=$("#processInstanceId").val();$.ajax({type:'post',url:'budget/report/submitWorkFlow',data:{appId:budgetObj.publishId,businessCode:budgetObj.businessCode,parameters:"",dealingWithPeople:dealingWithPeople,opintion:opintion,processInstanceId:"",nowPersion:"",nextCode:nextCode},success:function(data){if(data.flag==0){$yt_alert_Model.prompt(data.message);$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/budgetFill.html'}})}else{$yt_alert_Model.prompt(data.message)}}})},verifySaveData:function(data,verifySaveData){var verify=true;var flagFlag=budgetObj.checkThreePublicFalg();if(flagFlag&&false!=verifySaveData){verify=false;$yt_alert_Model.alertOne({leftBtnName:"返回填写",rightBtnName:"我已上传相关附件",alertMsg:"当前“三公经费”及会议费的测算依据（备注）尚未填写，请填写后再提交。",confirmFunction:function(){},cancelFunction:function(){budgetObj.doSaveEvent(false)}});if($('.file-up-list .file-lable').length<=0){$('.yt-alert-one .yt-model-canel-btn').attr('disabled',true).addClass('yt-btn-disabled').unbind('click')}return false}return verify},saveFileInfo:function(){$.ajax({type:'post',url:'budget/files/saveFileInfo',data:{tableId:budgetObj.tableId,budgetStage:budgetObj.tableObj.budgetStage,attId:$('#fileId').val(),attRemarks:$('#fileRemark').val()},success:function(data){if(data.flag==0){$('#fileId').val('');$('#fileName').val('');$('#fileRemark').val('');budgetObj.getFileInfoList(budgetObj.tableId,budgetObj.tableObj.deptId)}$yt_alert_Model.prompt(data.message)}})},checkThreePublicFalg:function(){var verify=false;$.ajax({type:'post',url:'budget/main/checkThreePublicFalg',async:false,data:{tableId:budgetObj.tableId},success:function(data){if(data.flag==0){if(data.data.checkFalg==1){$.each(data.data.cellList,function(i,n){if($('#createConfigTableDiv tr.'+n.rowNum+' td.'+n.colNum).text()&&$yt_baseElement.rmoney($('#createConfigTableDiv tr.'+n.rowNum+' td.'+n.colNum).text()||'0')!=0){if(n.relationCellList&&n.relationCellList.length>0){$.each(n.relationCellList,function(j,m){if(!$('#createConfigTableDiv td.'+m+' .yt-input').val()){verify=true;return false}})}else{verify=true;return false}}})}}}});return verify},checkPrjFalg:function(){var verify=false;$.ajax({type:'post',url:'budget/main/checkPrjFalg',async:false,data:{tableId:budgetObj.tableId},success:function(data){if(data.flag==0){if(data.data.checkFalg==1){verify=true}}}});return verify}};$(function(){$(".easyui-layout:not(.fun-btn-model)").css("height",$(window).height()+"px");$(".easyui-layout:not(.fun-btn-model)").layout("resize",{width:"100%",height:($(window).height()-10)+"px"});budgetObj.init();budgetObj.eventFun();$('#mainLayout').layout({onCollapse:function(){}})});$(window).resize(function(){redraw()});window.customResize=function(){var width=$(window).width();var height=$(window).height();var panelHeight=parseInt(height/2);$('#centerPanel').panel('resize',{width:width,height:panelHeight});$('#bottomPanel').panel('resize',{width:width,height:panelHeight});$('#mainLayout').layout('resize',{width:width,height:height})};function redraw(){if(window.customResize){customResize();}else{var width=$(window).width();var height=$(window).height();$('.easyui-panel').panel('resize',{width:width,height:height});$('.easyui-layout').layout('resize',{width:width,height:height});$('.easyui-treegrid').treegrid('resize',{width:width,height:height});$('.easyui-datagrid').datagrid('resize',{width:width,height:height})}}
var prepareObj={configData:[],tableId:'',budgetStage:'',initDeptData:{},init:function(){var requerParameter=$yt_common.GetRequest();if(requerParameter){prepareObj.tableId=requerParameter.tableId;prepareObj.budgetStage=requerParameter.budgetStage;prepareObj.getBudgetTableDetail()}prepareObj.handleEvent()},handleEvent:function(){$("button.page-retun-btn").click(function(){$(this).addClass("check");if($("body #bottomPanel").length>0){prepareObj.dataIsUpdate(1)}else{$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/prepareSummaryList.html'}})}});$("button.report-btn").click(function(){$yt_baseElement.openNewPage(2,"view/system-sasac/budget/module/expenditure/summaryReport.html?tableId="+prepareObj.tableId+'&budgetStage='+prepareObj.budgetStage)})},getBudgetTableDetail:function(){$.ajax({type:'post',url:'budget/main/getTotalBudgetTableDetailInfo',async:false,data:{tableId:prepareObj.tableId,budgetStage:prepareObj.budgetStage},success:function(data){var dataObj=data.data||{};var tableStyle=dataObj.tableStyle;var budgetData=dataObj.budgetData;$(".table-name").text(tableStyle.tableName);$(".stage").text(tableStyle.budgetStageName);$(".label-msg").text(tableStyle.tagging);$('#createConfigTableDiv').html('').newRuleTable({theads:tableStyle.theads,tbodys:tableStyle.tbodys,propertyList:tableStyle.propertyList,eventCheck:false,serialNumber:false});var propertyList=tableStyle.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('disable-sty')})}else if(proper.type=='r'){$('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('disable-sty')}}$('.rule-table').data('tableData',tableStyle);$('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();html='<span class="money-text">'+html+'</span>';$(this).html(html)});var disLen=$('.rule-table thead th.dis').length;var width=parseInt($(window).width())/(tableStyle.totalColsNum);width=width>140?140:parseInt(width);$('.rule-table thead th:not(.dis)').css("min-width",(width-15)+"px");prepareObj.getConfigInfo();prepareObj.getTableInfoList(budgetData)}})},getConfigInfo:function(){prepareObj.configData=[];$.ajax({type:"post",url:'budget/confg/getTableAllCongfigByTableId',async:false,data:{tableId:prepareObj.tableId},success:function(data){var crNums="";if(data.flag==0){if(data.data.length>0){prepareObj.configData=data.data;$.each(data.data,function(i,n){if(n.type=="cr"){crNums=n.crNum.split("-");$(".rule-table tbody tr").each(function(i,r){if(crNums[1]==$(this).attr("fieldFlag")){if(n.calcItem&&n.calcItem=="2"){$(r).find("input.money-input").addClass("character-inpu")}$.each($(r).find("td"),function(i,c){if(crNums[0]==$(c).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(c).addClass("disable-sty")}$(c).data("configData",n)}})}})}else{$(".rule-table tbody tr").each(function(i,r){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty").find('td').addClass("disable-sty")}if(n.calcItem=="2"){$(this).find("input.money-input").addClass("character-inpu")}$(this).data("configData",n)}});$(".rule-table tbody tr td").each(function(v,c){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty")}$(this).data("configData",n)}})}})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableInfoList:function(budgetData){if(budgetData!=undefined&&budgetData!=null&&budgetData.length>0){var tbody=$('.rule-table .yt-tbody');$.each(budgetData,function(i,n){$(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}$(c).data("cellData",n)}})}})});prepareObj.cellEvent()}},cellEvent:function(){$('.rule-table .yt-tbody tr td:not(.disable-sty)').click(function(){var thisCell=$(this);var cellData=$(this).data("cellData");var cellConfigData=$(this).data("configData");if(cellConfigData==undefined||cellConfigData==null){if(cellData!=undefined&&cellData.aliasCellNum!=""&&cellData.aliasCellNum!=null){cellConfigData=$(this).parent().find('td[fieldflag='+cellData.aliasCellNum+']').data("configData")}}if(cellData!=undefined&&cellConfigData!=undefined&&cellConfigData.calcItem!="1"&&cellConfigData.calcItem!="4"){$('.rule-table .yt-tbody tr td').removeClass("cell-shadow");$(this).addClass("cell-shadow");var unitText=($(".label-msg").text()!=""?'('+$(".label-msg").text()+')':"");$('#mainLayout').layout('add',{region:'south',width:180,title:'编制明细'+unitText,id:"bottomPanel",split:true});prepareObj.setLayoutPanelHeader();var colNum="";if(cellData.aliasCellNum==""||cellData.aliasCellNum==null||cellData.aliasCellNum==undefined){colNum=cellData.cellNum}else{colNum=cellData.aliasCellNum}$.ajax({type:"post",url:'budget/editor/getDpetDataByCells',async:false,data:{tableId:prepareObj.tableId,budgetStage:prepareObj.budgetStage,colNum:colNum,rowNum:cellData.rowNum },success:function(data){var datas=data.data;if(data.flag==0){var botStr="";botStr='<div code="detail" class="tab-panel"><table class="yt-table prepare-table" style="width: 100%;margin-top: 20px;"><thead class="yt-thead"><tr><th>编制处室</th><th>编制金额</th>';if(datas.tableTitleList&&datas.tableTitleList.length>0){$.each(datas.tableTitleList,function(i,n){botStr+='<th>'+n.titleName+'</th>'})}botStr+='<th>调整后金额</th><th>备注</th></tr>';+'</thead>';botStr+='<tbody class="yt-tbody"><tr><td style="text-align: left;">合计<input type="hidden" class="total-tab-id" value="'+datas.totalInfoId+'"/></td><td class="prepare-money sum-money" style="text-align: right;">'+(datas.amount==""?"0.00":$yt_baseElement.fmMoney(datas.amount))+'</td>';if(datas.tableTitleList&&datas.tableTitleList.length>0){$.each(datas.tableTitleList,function(i,n){botStr+='<td></td>'})}botStr+='<td class="adjust-money" style="text-align: right;"><span class="adjust-sum">'+(datas.adjustedAmount==""?"0.00":$yt_baseElement.fmMoney(datas.adjustedAmount))+'</span></td><td><input style="text-align: left;" class="yt-input sum-prepare-remark"  value="'+datas.remark+'" placeholder="请输入"/></td>';botStr+='</tr>';if(datas.deptBudgetList!=""&&datas.deptBudgetList!=undefined&&datas.deptBudgetList.length>0){$.each(datas.deptBudgetList,function(i,n){botStr+='<tr class="'+(cellData.deptId==n.deptId?"selBak":"")+'"><td style="text-align: left;" dept-id-data="'+n.deptId+'">'+n.deptName+'</td><td class="prepare-money" style="text-align: right;">'+(n.amount==""?"0.00":$yt_baseElement.fmMoney(n.amount))+'</td>';if(n.tableTitleDataList&&n.tableTitleDataList.length>0){$.each(n.tableTitleDataList,function(j,m){botStr+='<td>'+m.crValue+'</td>'})}botStr+='<td class="adjust-money"><input class="yt-input adjust-inpu" type="text" value="'+(n.adjustedAmount==""?"0.00":$yt_baseElement.fmMoney(n.adjustedAmount))+'"/></td><td><input class="yt-input prepare-remark"  value="'+n.remark+'" placeholder="请输入"/></td>';botStr+='</tr>'})}botStr+='</tbody></table><div class="handle-model" style="text-align: center;margin-top: 20px;"><button class="yt-option-btn yt-common-btn prepare-save-btn" style="margin-right: 20px;">保存</button><button class="yt-option-btn yt-cancel-btn prepare-cancel-btn">取消</button></div></div>';botStr+=prepareObj.getGistFileHtml();botStr=$(botStr);botStr.find('.prepare-table').data("cellData",cellData);$("#bottomPanel").html(botStr);customResize();prepareObj.panleEvent();prepareObj.initDeptData=prepareObj.getCellDeptData();prepareObj.fileUpEvent();prepareObj.getFileInfoList(prepareObj.tableId);$(".prepare-table input").focus(function(){$(".prepare-table tr").removeClass("selBak");$(this).parents("tr").addClass("selBak");var deptId=$(this).parents("tr").find("td").attr("dept-id-data");$.each($(thisCell).parents("tr").find("td"),function(i,n){if($(n).data("cellData")!=undefined&&$(n).data("cellData")!=null){if($(n).data("cellData").deptId==deptId){$(".rule-table td").removeClass("cell-shadow");$(n).addClass("cell-shadow")}}})})}else{$yt_alert_Model.prompt(data.message);$("#mainLayout").layout('remove','south')}}})}})},panleEvent:function(){$('#mainLayout').layout({onCollapse:function(){$("#mainLayout").layout('remove','south');$('.rule-table .yt-tbody tr td').removeClass("cell-shadow")}});$(".prepare-table").on("focus",".adjust-inpu",function(){$(this).select();if($(this).val()!=""&&$(this).val()!="0.00"&&$(this).val()!=null){$(this).val($yt_baseElement.rmoney($(this).val()))}else{$(this).val("0.00")}});$(".prepare-table").on("blur",".adjust-inpu",function(){if($(this).val()!=""&&$(this).val()!="0.00"&&$(this).val()!=null){$(this).val($yt_baseElement.fmMoney($(this).val()))}else{$(this).val("0.00")}var adjustSum="0.00";adjustSum=$yt_baseElement.rmoney(adjustSum);$(".prepare-table .adjust-inpu").each(function(i,n){adjustSum+=$yt_baseElement.rmoney($(n).val())});$(".adjust-sum").text($yt_baseElement.fmMoney(adjustSum))});$(".prepare-table").on("keyup",'.adjust-inpu',function(){$(this).val($(this).val().replace(/[^\d.]/g,''))});$("button.prepare-save-btn").click(function(){var thisBtn=$(this);$(thisBtn).attr("disabled","disabled");var onceObj=prepareObj.getOnceControlData();if(onceObj&&onceObj.controlAmount!=""&&onceObj.controlAmount!=undefined&&onceObj.controlAmount!=null){if(($yt_baseElement.rmoney(onceObj.controlAmount))!=($yt_baseElement.rmoney($(".adjust-sum").text()))){$yt_alert_Model.alertOne({leftBtnName:"确定",cancelFunction:"",alertMsg:'一下控制数是：'+onceObj.controlAmount+',调整后金额合计应等于一下控制数',cancelFunction:function(){}});$(thisBtn).attr("disabled",false);return false}else{prepareObj.executeSave(thisBtn)}}else{prepareObj.executeSave(thisBtn)}});$("button.prepare-cancel-btn").click(function(){prepareObj.dataIsUpdate(0)})},dataIsUpdate:function(isBtn){var saveData=JSON.stringify(!!prepareObj?prepareObj.getCellDeptData():{});var initData=JSON.stringify(!!prepareObj?prepareObj.initDeptData:{});if(saveData!=initData){isUpdate=true;$yt_alert_Model.alertOne({leftBtnName:"保存",rightBtnName:"不保存",alertMsg:"当前页面有调整数据尚未保存，是否放弃保存？点击“保存”保存页面调整数，或点击“不保存”继续。",confirmFunction:function(){var onceObj=prepareObj.getOnceControlData();if(onceObj&&onceObj.controlAmount!=""&&onceObj.controlAmount!=undefined&&onceObj.controlAmount!=null){if(($yt_baseElement.rmoney(onceObj.controlAmount))!=($yt_baseElement.rmoney($(".adjust-sum").text()))){$yt_alert_Model.prompt("调整后金额合计应等于一下控制数");return false}else{prepareObj.executeSave()}}else{prepareObj.executeSave()}},cancelFunction:function(){$("#mainLayout").layout('remove','south');$('.rule-table .yt-tbody tr td').removeClass("cell-shadow");if(isBtn==1){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/prepareSummaryList.html'}})}}})}else{$("#mainLayout").layout('remove','south');$('.rule-table .yt-tbody tr td').removeClass("cell-shadow");if(isBtn==1){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/prepareSummaryList.html'}})}}},getOnceControlData:function(){var cellData=$(".rule-table tbody .cell-shadow").data("cellData");var datas="";$.ajax({type:"post",url:"budget/editor/getBudgetStageResolveNum",async:false,data:{tableId:prepareObj.tableId,colNum:cellData.cellNum,rowNum:cellData.rowNum },success:function(data){if(data.flag==0){datas=data.data}}});return datas},executeSave:function(thisBtn){var saveDatas=prepareObj.getCellDeptData();$.ajax({type:"post",url:"budget/editor/saveDpetDataByCells",data:saveDatas,async:false,success:function(data){$yt_alert_Model.prompt(data.message);if(thisBtn!=undefined&&thisBtn!=""){$(thisBtn).attr("disabled",false)}if(data.flag==0){prepareObj.getBudgetTableDetail();if(thisBtn==undefined&&$("button.page-retun-btn").hasClass("check")){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/expenditure/prepareSummaryList.html'}})}$("#mainLayout").layout('remove','south');$('.rule-table .yt-tbody tr td').removeClass("cell-shadow")}},error:function(e){if(thisBtn!=undefined&&thisBtn!=""){$(thisBtn).attr("disabled",false)}}})},getCellDeptData:function(){var preTableObj=$(".prepare-table");var totalTabId=$(preTableObj).find(".total-tab-id").val();var cellData=$(preTableObj).data("cellData");var amount=$(preTableObj).find(".sum-money").text();amount=$yt_baseElement.rmoney(amount);var adjustedAmount=$(preTableObj).find(".adjust-sum").text();adjustedAmount=$yt_baseElement.rmoney(adjustedAmount);var deptBudgetList=[];var deptBudgetJson="";$(preTableObj).find("tbody tr:gt(0)").each(function(i,n){deptBudgetList.push({deptId:$(n).find("td").attr("dept-id-data"),amount:($yt_baseElement.rmoney($(n).find(".prepare-money").text())),adjustedAmount:($yt_baseElement.rmoney($(n).find(".adjust-inpu").val())),remark:$(n).find(".prepare-remark").val()})});if(deptBudgetList!=""&&deptBudgetList.length>0){deptBudgetJson=JSON.stringify(deptBudgetList)}var colNum="";if(cellData.aliasCellNum==""||cellData.aliasCellNum==null||cellData.aliasCellNum==undefined){colNum=cellData.cellNum}else{colNum=cellData.aliasCellNum}return{tableId:prepareObj.tableId,budgetStage:prepareObj.budgetStage,colNum:colNum,rowNum:cellData.rowNum,totalInfoId:totalTabId,amount:amount,adjustedAmount:adjustedAmount,remark:$(preTableObj).find(".sum-prepare-remark").val(),deptBudgetList:deptBudgetJson }},setLayoutPanelHeader:function(){$('.layout-panel-south .panel-title').html('<label code="detail" class="tab-item check">编制明细（单位：万元）</label><label code="gist" class="tab-item">编制依据（文件）</label>');$('.layout-panel-south .tab-item').on('click',function(){$('.layout-panel-south .tab-item').removeClass('check');$(this).addClass('check');var code=$(this).attr('code');$('.tab-panel').hide();$('.tab-panel[code="'+code+'"]').show()})},getGistFileHtml:function(){var html='<div style="display:none;" class="file-content tab-panel" code="gist"><div class="file-update"><div class="file-cont-row"><span><span style="color: #fff;">*</span><span style="letter-spacing: 5px;">上传附</span>件：</span><div class="file-up-div"><div class="dib" style="vertical-align: middle;"><input class="yt-input file-msg" id="fileName" readonly="readonly"></div><div class="file-input-but"><input name="file" class="cont-file" id="fileInput" type="file"><input type="hidden" id="fileId" value=""><button class="yt-option-btn yt-common-btn file-upload-btn" id="" style="margin: 0;">请上传</button></div></div></div><div class="file-cont-row"><div style="float: left;"><label><span class="not-null">*</span><span style="letter-spacing: 5px;">文件说</span>明：</label></div><div style="overflow: hidden;position: relative;padding-bottom: 20px;"><textarea class="yt-textarea" id="fileRemark" validform="{isNull:true,blurFlag:true,msg:\'请输入文件说明\'}"></textarea><div class="valid-font" style="left: 0;"></div></div></div><div class="file-cont-row" style="text-align: center;"><button class="yt-option-btn yt-common-btn" id="fileUp">上传</button></div></div><div class="file-up-list" id="attIdStr"></div><div style="clear: both;"></div></div>';return html},fileUpEvent:function(){$(".file-up-div").off().on('change','.cont-file',function(obj){var fileElementId=this.id;var ithisParent=$('#attIdStr');var url=$yt_option.base_path+"/fileUpDownload/upload?ajax=1&modelCode=REIM_APP";var imgUlr='';$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:fileElementId,success:function(data,textStatus){if(data.flag==0){$('#fileId').val(data.data.pkId);$('#fileName').val(data.data.naming)}else{$yt_alert_Model.prompt(data.message)}},error:function(data,status,e){$yt_alert_Model.prompt(data.message)}})});$('#fileUp').on('click',function(){var fid=$('#fileId').val();if(fid){if($yt_valid.validForm('.file-content')){prepareObj.saveFileInfo()}}else{$yt_alert_Model.prompt('请选择附件')}});$('#attIdStr').on('click','.file-dw',function(){var id=$(this).parents('.file-lable').attr('fid');window.location.href=$yt_option.base_path+'fileUpDownload/download?pkId='+id+'&isDownload=true'});$('#attIdStr').on('click','.del-file',function(){var ithis=$(this);var parent=ithis.parents('.file-lable');var id=parent.attr('fid');$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){prepareObj.deleteFileInfoById(id,function(){parent.remove()})}})})},getFileInfoList:function(tableId){$.ajax({type:'post',url:'budget/files/getFileInfoList',data:{tableId:tableId,deptId:'',budgetStage:''},success:function(data){if(data.flag==0){var html='';$.each(data.data,function(i,n){html+='<div class="file-lable" fid="'+n.attId+'"><div class=""><a class="yt-link file-dw">'+n.attName+'</a><label class="del-file">x</label></div><div class=""><span>文件说明：</span><span class="">'+n.attRemarks+'</span></div><div class=""><span>上传人：</span><span class="">'+n.createUserName+'</span></div></div>'});$('#attIdStr').html(html)}}})},deleteFileInfoById:function(id,callback){$.ajax({type:'post',url:'budget/files/deleteFileInfoById',data:{attId:id},success:function(data){if(data.flag==0){if(callback){callback()}}$yt_alert_Model.prompt(data.message)}})},saveFileInfo:function(){$.ajax({type:'post',url:'budget/files/saveFileInfo',data:{tableId:prepareObj.tableId,budgetStage:prepareObj.budgetStage,attId:$('#fileId').val(),attRemarks:$('#fileRemark').val()},success:function(data){if(data.flag==0){$('#fileId').val('');$('#fileName').val('');$('#fileRemark').val('');prepareObj.getFileInfoList(prepareObj.tableId)}$yt_alert_Model.prompt(data.message)}})}};$(function(){prepareObj.init();redraw()});$(window).resize(function(){redraw()});window.customResize=function(){var width=$(window).width();var height=$(window).height();var panelHeight=parseInt(height/2);$('#centerPanel').panel('resize',{width:width,height:panelHeight});$('#bottomPanel').panel('resize',{width:width,height:panelHeight});$('#mainLayout').layout('resize',{width:width,height:height})};function redraw(){if(window.customResize){customResize();}else{var width=$(window).width();var height=$(window).height();$('.easyui-panel').panel('resize',{width:width,height:height});$('.easyui-layout').layout('resize',{width:width,height:height});$('.easyui-treegrid').treegrid('resize',{width:width,height:height});$('.easyui-datagrid').datagrid('resize',{width:width,height:height})}}
var breakDownReport={tableId:"",budgetStage:"",configData:[],init:function(){var requerParameter=$yt_common.GetRequest();if(requerParameter!=null&&requerParameter!=""){breakDownReport.tableId=requerParameter.tableId;breakDownReport.budgetStage=requerParameter.budgetStage;breakDownReport.getBudgetTableDetail()}breakDownReport.events()},events:function(){$("#printBtn").off().on("click",function(){breakDownReport.doPrint()});$("#downLoadBtn").click(function(){var yitianSSODynamicKey=$yt_baseElement.getToken();window.location.href=$yt_option.base_path+'budget/main/exportResolveAdjustReport?tableId='+breakDownReport.tableId+'&budgetStage='+breakDownReport.budgetStage+"&yitianSSODynamicKey="+yitianSSODynamicKey+"&ajax=1"})},getBudgetTableDetail:function(){$.ajax({type:'post',url:'budget/main/getResolveAdjustReport',async:false,data:{tableId:breakDownReport.tableId,budgetStage:breakDownReport.budgetStage},success:function(data){var dataObj=data.data||{};var tableStyle=dataObj.tableStyle;var budgetData=dataObj.budgetData;$(".table-name").text(tableStyle.tableName);$(".stage").text(tableStyle.budgetStageName);$(".label-msg").text(tableStyle.tagging);$('#createConfigTableDiv').html('').newRuleTable({theads:tableStyle.theads,tbodys:tableStyle.tbodys,propertyList:tableStyle.propertyList,eventCheck:false,serialNumber:false});var propertyList=tableStyle.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('disable-sty')})}else if(proper.type=='r'){$('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('disable-sty')}}$('.rule-table').data('tableData',tableStyle);$('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();html='<span class="money-text">'+html+'</span>';$(this).html(html)});var disLen=$('.rule-table thead th.dis').length;var width=parseInt($(window).width())/(tableStyle.totalColsNum);width=width>130?130:parseInt(width);$('.rule-table thead th:not(.dis)').css("min-width",(width-15)+"px");breakDownReport.getConfigInfo();breakDownReport.getTableInfoList(budgetData);breakDownReport.getMoneyDetail(dataObj)}})},getMoneyDetail:function(dataObj){var subAdjustList=dataObj.subAdjustList;var deptAdjustList=dataObj.deptAdjustList;if(dataObj.subAdjustTotalVal!=undefined&&dataObj.subAdjustTotalVal!=""&&dataObj.subAdjustTotalVal!=null){if($yt_baseElement.fmMoney(dataObj.subAdjustTotalVal)<0){$(".course-info  .money-flag").addClass("font-green").text("调减")}else if($yt_baseElement.fmMoney(dataObj.subAdjustTotalVal)==0){$(".course-info  .money-flag").addClass("hui-col").text("调整")}else{$(".course-info  .money-flag").addClass("font-red").text("调增")}$(".course-info .little-money").text($yt_baseElement.fmMoney(dataObj.subAdjustTotalVal))}else{$(".course-info .little-money").text("0.00");$(".course-info  .money-flag").addClass("hui-col").text("调整")}if(dataObj.deptAdjustTotalVal!=undefined&&dataObj.deptAdjustTotalVal!=""&&dataObj.deptAdjustTotalVal!=null){if($yt_baseElement.fmMoney(dataObj.deptAdjustTotalVal)<0){$(".department-info .money-flag").addClass("font-green").text("调减")}else if($yt_baseElement.fmMoney(dataObj.deptAdjustTotalVal)==0){$(".department-info .money-flag").addClass("hui-col").text("调整")}else{$(".department-info .money-flag").addClass("font-red").text("调增")}$(".department-info .little-money").text($yt_baseElement.fmMoney(dataObj.deptAdjustTotalVal))}else{$(".department-info .little-money").text("0.00");$(".department-info .money-flag").addClass("hui-col").text("调整")}$(".course-info .other-list-info ul li").empty();if(subAdjustList!=undefined&&subAdjustList!=null&&subAdjustList.length>0){var liStr="";$.each(subAdjustList,function(i,n){if($yt_baseElement.fmMoney(n.crValue)<0){liStr+='<li><label>'+n.text+'</label><label class="font-green">调减<span class="add-money">'+($yt_baseElement.fmMoney(n.crValue*-1))+'</span></label></li>'}else{liStr+='<li><label>'+n.text+'</label><label class="font-red">调增<span class="add-money">'+($yt_baseElement.fmMoney(n.crValue))+'</span></label></li>'}});$(".course-info .other-list-info ul").html(liStr)}$(".department-info .other-list-info ul li").empty();if(deptAdjustList!=undefined&&deptAdjustList!=null&&deptAdjustList.length>0){var liStr="";$.each(deptAdjustList,function(i,n){if($yt_baseElement.fmMoney(n.crValue)<0){liStr+='<li><label>'+n.text+'</label><label class="font-green">调减<span class="add-money">'+($yt_baseElement.fmMoney(n.crValue*-1))+'</span></label></li>'}else{liStr+='<li><label>'+n.text+'</label><label class="font-red">调增<span class="add-money">'+($yt_baseElement.fmMoney(n.crValue))+'</span></label></li>'}});$(".department-info .other-list-info ul").html(liStr)}},getConfigInfo:function(){breakDownReport.configData=[];$.ajax({type:"post",url:'budget/confg/getTableAllCongfigByTableId',async:false,data:{tableId:breakDownReport.tableId},success:function(data){var crNums="";if(data.flag==0){if(data.data.length>0){breakDownReport.configData=data.data;$.each(data.data,function(i,n){if(n.type=="cr"){crNums=n.crNum.split("-");$(".rule-table tbody tr").each(function(i,r){if(crNums[1]==$(this).attr("fieldFlag")){if(n.calcItem&&n.calcItem=="2"){$(r).find("input.money-input").addClass("character-inpu")}$.each($(r).find("td"),function(i,c){if(crNums[0]==$(c).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(c).addClass("disable-sty")}$(c).data("configData",n)}})}})}else{$(".rule-table tbody tr").each(function(i,r){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty").find('td').addClass("disable-sty")}if(n.calcItem=="2"){$(this).find("input.money-input").addClass("character-inpu")}$(this).data("configData",n)}});$(".rule-table tbody tr td").each(function(v,c){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty")}$(this).data("configData",n)}})}})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableInfoList:function(budgetData){if(budgetData!=undefined&&budgetData!=null&&budgetData.length>0){var tbody=$('.rule-table .yt-tbody');$.each(budgetData,function(i,n){$(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}if(n.adjustValue!=""&&n.adjustValue!=null&&n.adjustValue!=undefined&&n.adjustValue!="0.00"&&n.adjustValue!=0.00){if(!isNaN(n.adjustValue)){n.adjustValue=$yt_baseElement.fmMoney(n.adjustValue)}if(n.adjustValue<0){$(c).find(".adjust-money").remove();$(c).append('<span class="adjust-money font-green">'+n.adjustValue+'</span>')}else{$(c).append('<span class="adjust-money font-red">+'+n.adjustValue+'</span>')}}$(c).data("cellData",n)}})}})})}},doPrint:function(){bdhtml=window.document.body.innerHTML;startBreakDownPasting="<!--startBreakDownPasting-->";endBreakDownPasting="<!--endBreakDownPasting-->";prnhtml=bdhtml.substr(bdhtml.indexOf(startBreakDownPasting));prnhtml=prnhtml.substring(0,prnhtml.indexOf(endBreakDownPasting));window.document.body.innerHTML=prnhtml;window.focus();if(breakDownReport.isIE()){document.body.className+=' ext-ie';document.execCommand('print',false,null)}else{window.print()}window.document.body.innerHTML=bdhtml;window.location.reload()},isIE:function(){if(!!window.ActiveXObject||"ActiveXObject"in window){return true}else{return false}}};$(function(){breakDownReport.init()});
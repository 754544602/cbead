var budgetReport={booksId:'',booksObj:'',deptNum:0,init:function(){$("select").niceSelect();var requerParameter=$yt_common.GetRequest();budgetReport.booksId=requerParameter.booksId;if(budgetReport.booksId&&budgetReport.booksId!=undefined&&budgetReport.booksId!=""){budgetReport.getBudgetYearInfoById(budgetReport.booksId)}$('#endTop').calendar({speed:0,readonly:true,nowData:false,hmsDefVal:true,dateFmt:"yyyy-MM-dd HH:mm:ss",callback:function(){$("#endTop").removeClass("valid-hint");$("#endTop").next().next().text("")}});budgetReport.getPublishTableList()},initEvent:function(){$("#submitPayment").click(function(){var thisBtn=$(this);var validFlag=$yt_valid.validForm($("#budgetReport"));if(validFlag){$(this).attr('disabled',true);var publishDatas=budgetReport.getPublishInfo();$.ajax({type:'post',url:'budget/publish/savePublishBudgetInfo',data:publishDatas,async:false,success:function(data){$(thisBtn).attr('disabled',true);$yt_alert_Model.prompt(data.message);if(data.flag==0){$(thisBtn).attr('disabled',true);window.location.href=$yt_option.websit_path+'view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+budgetReport.booksObj.booksId}},error:function(e){$(thisBtn).attr('disabled',true)}})}else{$yt_alert_Model.prompt("请选择编制提交截止时间")}});$("select.budget-year").change(function(){budgetReport.getPublishTableList()});$("#cancelBtn").click(function(){window.location.href=$yt_option.websit_path+'view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+budgetReport.booksObj.booksId})},getPublishInfo:function(){var addDataList=[];var addDataJson="";var updateDataList=[];var updateDataJson="";var deletePublishTableIdStr="";$(".publish-table tbody tr").each(function(){$(this).find(".check-label-div ul li .yt-checkbox:not(.last-parent-check)").each(function(){var thisChecobox=$(this);if($(this).hasClass("check")){if($(this).data("checkDept")&&$(this).data("checkDept")!=undefined&&$(this).data("checkDept")!=""){updateDataList.push({publishTableId:$(thisChecobox).data("checkDept").publishTableId,deptId:$(thisChecobox).find("input").val(),tableId:$(thisChecobox).parents("tr").data("tableInfo").tableId })}else{addDataList.push({deptId:$(thisChecobox).find("input").val(),tableId:$(thisChecobox).parents("tr").data("tableInfo").tableId})}}else{if($(this).data("checkDept")&&$(this).data("checkDept")!=undefined&&$(this).data("checkDept")!=""){deletePublishTableIdStr+=$(thisChecobox).data("checkDept").publishTableId+","}}})});if(addDataList.length>0){addDataJson=JSON.stringify(addDataList)}if(updateDataList.length>0){updateDataJson=JSON.stringify(updateDataList)}if(deletePublishTableIdStr!=""){deletePublishTableIdStr=deletePublishTableIdStr.substring(deletePublishTableIdStr.length-1,0)}return{budgetStage:$("select.budget-year").val(),submitDeadline:$("#endTop").val(),booksId:budgetReport.booksId,deletePublishTableIdStr:deletePublishTableIdStr,addDataJson:addDataJson,updateDataJson:updateDataJson }},getPublishTableList:function(){var budgetStage=$("select.budget-year").val();$.ajax({type:'post',url:'budget/publish/getPublishBudgetTableList',data:{booksId:budgetReport.booksId,budgetStage:budgetStage},async:false,success:function(data){if(data.flag==0){$("table.publish-table tbody").empty();var trStr="";if(data.data.length>0){var allDeptInfoList=budgetReport.getDeptInfoListFun();$.each(data.data,function(i,n){trStr='<tr><td style="text-align: left;" class="first"><span>'+n.tableCode+'</span></td><td class="table-name"><div>'+n.tableName+'</div></td><td style="text-align: left;">'+n.budgetTypeName+'</td><td class="last"><div class="check-label-div"><ul><li><label class="check-label yt-checkbox last-parent-check"><input class="last-all-check" type="checkbox" name="test" value=""/>全部</label></li>';if(allDeptInfoList.length>0){var deptStrCheck="";var deptStrDef="";$.each(allDeptInfoList,function(i,d){if(d.type==2){trStr+='<li><label class="check-label yt-checkbox"><input class="" type="checkbox" name="test" value="'+d.id+'"/>'+d.text+'</label></li>'}})}trStr+='</ul></div></td>';trStr=$(trStr).data("tableInfo",n);$("table.publish-table tbody").append(trStr)});budgetReport.setTdAllCheck();budgetReport.checkDeptSel()}else{$("table.publish-table tbody").append(sysCommon.noDataTrStr(4))}}}})},checkDeptSel:function(){$("table.publish-table tbody tr").each(function(i,n){if($(n).data("tableInfo").checkDeptList.length==budgetReport.deptNum){$(n).find('.yt-checkbox.last-parent-check input').prop("checked","checked").parent().addClass("check")}$.each($(n).data("tableInfo").checkDeptList,function(i,t){$(n).find('.yt-checkbox input[value ='+t.deptId+']').prop("checked","checked").parent().data("checkDept",t).addClass("check")})})},getDeptInfoListFun:function(){var allDeptInfoList="";$.ajax({type:'post',url:'user/userInfo/getAllDeptsInfo',async:false,success:function(data){if(data.flag==0){allDeptInfoList=data.data;$.each(data.data,function(i,n){if(n.type=="2"){budgetReport.deptNum+=1}})}}});return allDeptInfoList},setTdAllCheck:function(){$(".last-parent-check").change(function(){if($(this).hasClass("check")){$(this).parents(".check-label-div").setCheckBoxState("unCheckAll");$(this).parents("tr").find("input.budget-check").setCheckBoxState("unCheck")}else{$(this).parents(".check-label-div").setCheckBoxState("checkAll")}});var tableCheckLen=$(this).parent("label.yt-checkbox").length;$(".check-label-div").find(".yt-checkbox:not(.last-parent-check)").off().on("change",function(){if($(this).hasClass("check")){$(this).find("input").setCheckBoxState("unCheck");$(this).parents(".check-label-div").find(".last-all-check").prop("checked",false).setCheckBoxState("uncheck")}else{$(this).find("input").setCheckBoxState("check");if($(this).parents(".check-label-div").find("label.yt-checkbox.check").length==tableCheckLen){$(this).parents(".check-label-div").find(".last-all-check").prop("checked",true).setCheckBoxState("check")}}})},getBudgetYearInfoById:function(booksId){$.ajax({type:'post',url:'budget/bm/getBooksInfo',data:{booksId:booksId},async:false,success:function(data){if(data.flag==0){if(data.data){budgetReport.booksObj=data.data;$(".year").text(data.data.booksYear)}}}})}};$(function(){budgetReport.init();budgetReport.initEvent()});
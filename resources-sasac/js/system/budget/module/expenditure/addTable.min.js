var addTable={tableId:"",booksId:'',init:function(){$("#addTable select").niceSelect();var requerParameter=$yt_common.GetRequest();addTable.tableId=requerParameter.tableId==undefined?"":requerParameter.tableId;addTable.booksId=requerParameter.booksId==undefined?"":requerParameter.booksId;addTable.generateBtn();if(addTable.tableId!=""&&addTable.tableId!=null){addTable.getBudgetTableDetailByTableId()};addTable.getBudType();$("#addTable").css("min-height",$(window).height()-35+"px")},generateBtn:function(){$("#generateBtn").off().on("click",function(){if($yt_valid.validForm($(".bud-total"))){var budgetCols= +$('#budgetCols').val();var budgetRows= +$('#budgetRows').val();var budgetBodyCols= +$('#budgetBodyCols').val();if($('#createTable .rule-table').length>0){$yt_alert_Model.alertOne({alertMsg:'重新生成会清空原有列表中的数据，确定继续吗？',confirmFunction:function(){$('#createTable').newRuleTable({rowNum:budgetRows,colNum:budgetCols,headRow:budgetBodyCols,callback:function(obj){$('#budgetCols').val(obj.cols);$('#budgetRows').val(obj.rows);$('#budgetBodyCols').val(obj.headRows)}})}})}else{$('#createTable').newRuleTable({rowNum:budgetRows,colNum:budgetCols,headRow:budgetBodyCols,callback:function(obj){$('#budgetCols').val(obj.cols);$('#budgetRows').val(obj.rows);$('#budgetBodyCols').val(obj.headRows)}})}}});$("#saveBtn,#saveBtnConfig").off().on("click",function(){var isBtnFlag=$(this).attr("isBtnflag");if($yt_valid.validForm($(".start-name"))){addTable.saveOrUpdateBudgetTableInfo(isBtnFlag)}});$('#approveCanelBtn').on("click",function(){window.location.href=$yt_option.websit_path+'view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+addTable.booksId})},getLoanFormData:function(){var theadCellsList=function(){var list=[];$('#createTable .yt-thead tr').each(function(i){$(this).find('th:not(.tab-indicate)').each(function(j,m){list.push({colNum:'c'+(j+1),rowNum:'r'+(i+1),contents:$(m).html(),rowspan:$(m).attr('rowspan')||'',colspan:$(m).attr('colspan')||'',style:$(m).attr('style')||''})})});return JSON.stringify(list)};var tbodyCellsList=function(){var list=[];$('#createTable .yt-tbody tr').each(function(i){$(this).find('td').each(function(j,m){list.push({colNum:'c'+(j+1),rowNum:'r'+(i+1),contents:$(m).html(),rowspan:$(m).attr('rowspan')||'',colspan:$(m).attr('colspan')||'',style:$(m).attr('style')||''})})});return JSON.stringify(list)};var propertyList=function(){var list=[];$('#createTable .indicate-head th.dis').each(function(i){list.push({crNum:'c'+($(this).index()),property:'READ_ONLY',type:'c'})});$('#createTable .yt-tbody th.dis').each(function(i){list.push({crNum:'r'+($(this).parent().index()+1),property:'READ_ONLY',type:'r'})});return JSON.stringify(list)};return{tableId:addTable.tableId,tableName:$("#budgetTableName").val(),tableDescribe:$("#budgetTableDescribe").val(),budgetType:$('#budType option:selected').val(),drawTableId:$("#draw").val(),booksId:addTable.booksId,tagging:$("#budgetCalibration").val(),totalColsNum:$("#budgetCols").val(),theadRowsNum:$("#budgetRows").val(),tbodyRowsNum:$("#budgetBodyCols").val(),theadCellsList:theadCellsList(),tbodyCellsList:tbodyCellsList(),propertyList:propertyList()}},getBudgetTableDetailByTableId:function(){$.ajax({type:"post",url:"budget/tStyle/getBudgetTableDetailByTableId",data:{tableId:addTable.tableId},success:function(data){if(data.flag==0){var dataObj=data.data;if(dataObj&&dataObj!=""&&dataObj!=undefined){$("#budgetTableName").val(dataObj.tableName);$("#budgetTableDescribe").val(dataObj.tableDescribe);$("#budgetCalibration").val(dataObj.tagging);$("#budgetCols").val(dataObj.totalColsNum);$("#budgetRows").val(dataObj.theadRowsNum);$("#budgetBodyCols").val(dataObj.tbodyRowsNum);$('#budType option[value="'+dataObj.budgetType+'"]').attr("selected","selected");$('#budType').niceSelect();$("#draw").val(dataObj.drawTableId);$('#createTable').newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,callback:function(obj){$('#budgetCols').val(obj.cols);$('#budgetRows').val(obj.rows);$('#budgetBodyCols').val(obj.headRows)}})}}}})},saveOrUpdateBudgetTableInfo:function(isBtnFlag){var formDatas=addTable.getLoanFormData();var urlStr="";if(addTable.tableId&&addTable.tableId!=""&&addTable.tableId!=undefined){urlStr="budget/tStyle/updateBudgetTableInfo"}else{urlStr="budget/tStyle/saveBudgetTableInfo"}$.ajax({type:'post',url:urlStr,data:formDatas,success:function(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){var pageUrl="";if(isBtnFlag==0){pageUrl='view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+addTable.booksId}else{pageUrl='view/system-sasac/budget/module/expenditure/configDefinition.html?tableId='+data.data}window.location.href=$yt_option.websit_path+pageUrl}}})},getBudType:function(code){$.ajax({type:"post",url:$yt_option.base_path+'/budget/table/getBudgetClassifyDataByParams?tableKey=coso_classify_budget_type',async:false,data:{pageIndex:1,pageNum:9999,pageSize:10,params:''},success:function(data){var datas=data.data.rows;if(data.flag==0){var numOptions='<option value="">请选择</option>';$('#budType').empty();if(datas.length>0&&datas!=undefined&&datas!=null){$.each(datas,function(i,n){numOptions+='<option value="'+n.code+'" sel-val="'+n.name+'">'+n.name+'</option>'});$('#budType').append(numOptions)}$('#budType').niceSelect()}}})}};$(function(){addTable.init()});
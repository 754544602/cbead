var budgetReport={init:function(){$("#budgetReport").css("min-height",$(window).height()-12);$("select").niceSelect();$(".budget-radio .yt-radio input").change(function(){budgetReport.tablePage($(".budget-year").val())});$(".yt-table .yt-tbody").on("click"," tr",function(){$(".yt-table .yt-tbody tr.yt-table-active").removeClass("yt-table-active");$(this).addClass("yt-table-active");var trData=$(this).data("tableData");if(trData.budgetType=="A04"){$("button.budget-organ").attr("disabled","disabled").addClass("yt-btn-disabled")}else{$("button.budget-organ").attr("disabled",false).removeClass("yt-btn-disabled")}});budgetReport.getBudgetYear();budgetReport.clickBudgetOrgan()},clickBudgetOrgan:function(){$(".budget-organ").click(function(){var thisTr=$(".publish-table tbody tr.yt-table-active");var selTrLen=$(".publish-table tbody tr.yt-table-active").length;if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var validFalg=budgetReport.checkEditorStateByTable();if(validFalg){var tableId=$(thisTr).data("tableData").tableId;var budgetStage=$(thisTr).data("tableData").budgetStage;window.location.href=$yt_option.websit_path+"view/system-sasac/budget/module/expenditure/budgetPrepare.html?tableId="+tableId+"&budgetStage="+budgetStage}}});$("button.preview-btn").click(function(){var thisTr=$(".publish-table tbody tr.yt-table-active");var selTrLen=$(".publish-table tbody tr.yt-table-active").length;if(selTrLen==0){$yt_alert_Model.prompt("请选择一行数据进行操作")}else{var tableId=$(thisTr).data("tableData").tableId;var budgetStage=$(thisTr).data("tableData").budgetStage;$yt_baseElement.openNewPage(2,"view/system-sasac/budget/module/expenditure/summaryPreview.html?tableId="+tableId+'&budgetStage='+budgetStage)}});$("button.export-budget-organ").on('click',function(){if($("tr.yt-table-active").length==0){$yt_alert_Model.prompt("请选择一行数据进行操作");return false}else{var validFalg=budgetReport.checkEditorStateByTable();if(validFalg){var trData=$("tr.yt-table-active").data("tableData");var yitianSSODynamicKey=$yt_baseElement.getToken();window.location.href=$yt_option.base_path+'gzw/budget/excel/exportTotalAuditToExcel?tableId='+trData.tableId+'&budgetStage='+trData.budgetStage+"&yitianSSODynamicKey="+yitianSSODynamicKey+"&ajax=1"}}});$("button.export-dept-organ").click(function(){if($("tr.yt-table-active").length==0){$yt_alert_Model.prompt("请选择一行数据进行操作");return false}else{var trData=$("tr.yt-table-active").data("tableData");var validFalg=budgetReport.checkEditorStateByTable();if(trData.budgetType=="A04"){$yt_alert_Model.prompt("该表格为查询表，无法导出各处室预算表");return false}else{if(validFalg){var yitianSSODynamicKey=$yt_baseElement.getToken();window.location.href=$yt_option.base_path+'gzw/budget/excel/exportOfficeBudgetToExcel?tableId='+trData.tableId+'&budgetStage='+trData.budgetStage+"&yitianSSODynamicKey="+yitianSSODynamicKey+"&ajax=1"}}}})},checkEditorStateByTable:function(){var validFlag=false;var budgetStage=$(".budget-radio .yt-radio input:checked").val();var tableData=$(".publish-table tbody tr.yt-table-active").data("tableData");$.ajax({type:"post",url:"budget/editor/checkEditorStateByTable",async:false,data:{budgetStage:budgetStage,tableId:tableData.tableId},success:function(data){if(data.flag==0){validFlag=true}else{$yt_alert_Model.prompt(data.message)}}});return validFlag},getBudgetYear:function(){$.ajax({type:"post",url:"budget/appMain/getBudgetYearInfo",async:true,success:function(data){var datas=data.data;if(data.flag==0){$.each(datas,function(i,n){$('select.budget-year').append('<option value="'+n.budgetYear+'">'+n.budgetYear+'</option>')});$("select.budget-year").niceSelect();budgetReport.tablePage($(".budget-year").val());$("select.budget-year").change(function(){var thisYear=$(this).val();budgetReport.tablePage(thisYear)})}}})},imgLockClick:function(){$(".check-input-div").on("click",".img-lock-click",function(){var stage=$(this).attr('stage');if(stage=='1'){var publishTableId=$(this).attr('publishTableId');var tableId=$(this).attr('tableId');budgetReport.setLockStateByDisable(tableId,publishTableId,$(this))}else{$yt_alert_Model.prompt("已解锁，无法重复解锁")}})},setLockStateByDisable:function(tableId,publishTableId,thisImg){var budgetStage=$(".budget-radio .yt-radio input:checked").val();$.ajax({type:"post",url:"budget/editor/setLockStateByDisable",async:true,data:{budgetStage:budgetStage,tableId:tableId,publishTableId:publishTableId},success:function(data){if(data.flag==0){thisImg.attr("src",'../../../../../resources-sasac/images/common/unlock.png');thisImg.attr("stage",'2');$yt_alert_Model.prompt(data.message)}$yt_alert_Model.prompt(data.message)}})},getDeptInfoListFun:function(){var allDeptInfoList="";$.ajax({type:'post',url:'user/userInfo/getAllDeptsInfo',async:false,success:function(data){if(data.flag==0){allDeptInfoList=data.data;$.each(data.data,function(i,n){if(n.type=="2"){}})}}});return allDeptInfoList},tablePage:function(budgetYear){var budgetStage=$(".budget-radio .yt-radio input:checked").val();$.ajax({type:"post",url:"budget/editor/getTotalPublishBudgetTableList",async:true,data:{budgetStage:budgetStage,budgetYear:budgetYear},success:function(data){var htmlTbody=$('.publish-table .yt-tbody');htmlTbody.empty();var trStr="";if(data.flag==0){var datas=data.data;var allDeptInfoList=budgetReport.getDeptInfoListFun();if(datas.length>0){$.each(datas,function(i,n){trStr+='<tr><td class="first">'+n.tableCode+'</td><td style="">'+n.budgetTypeName+'</td><td style="text-align: left;">'+n.tableName+'</td><td class="last"><div class="check-label-div">';if(allDeptInfoList.length>0){$.each(allDeptInfoList,function(i,d){if(d.type==2){trStr+='<div class="check-input-div"><label class="check-label yt-checkbox"><input class="" type="checkbox" name="test" value="'+d.id+'" disabled="disabled"/>'+d.text+'</label></div>'}})}trStr+='</div></td><td style="text-align: right;" title="'+n.submitRemainTime+'">'+(n.submitRemainTimeShort==""?"--":n.submitRemainTimeShort)+'</td><td>'+(n.lastOperatorDateTime.substring(0,n.lastOperatorDateTime.length-3)||'--')+'</td><td lastOperatorUserCode="'+n.lastOperatorUserCode+'">'+(n.lastOperatorUserName||'--')+'</td></tr>';trStr=$(trStr).data("tableData",n);htmlTbody.append(trStr)});budgetReport.imgLockClick();budgetReport.checkDeptSel()}else{$('.before-table-page').hide();htmlTbody.html(sysCommon.noDataTrStr(9))}}else{$('.before-table-page').hide();htmlTbody.html(sysCommon.noDataTrStr(9));$yt_alert_Model.prompt(data.message)}}})},checkDeptSel:function(){$("table.publish-table tbody tr").each(function(i,n){$.each($(n).data("tableData").checkDeptList,function(i,d){$(n).find('.yt-checkbox input[value ='+d.deptId+']').prop("checked","checked").parent().data("checkDept",d).addClass("check")})});$("table.publish-table tbody tr .check-input-div .yt-checkbox.check").each(function(i,n){var checkDept=$(n).data("checkDept");var imgSrc="";if(checkDept.lockState=="1"){imgSrc="../../../../../resources-sasac/images/common/lock.png";}else{imgSrc="../../../../../resources-sasac/images/common/unlock.png"}var imgLabel='<img publishTableId="'+checkDept.publishTableId+'" tableId="'+checkDept.tableId+'" stage="'+(checkDept.lockState=="1"?"1":"2")+'" class="img-lock-click" src="'+imgSrc+'"/>';$(n).after(imgLabel)});budgetReport.imgLockClick()}};$(function(){budgetReport.init()});
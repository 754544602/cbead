var approveObj={budgetAppId:"",processInstanceId:"",init:function(){approveObj.budgetAppId=$yt_common.GetQueryString('budgetAppId');$(".bottom-btn-model").before(sysCommon.createFlowApproveMode());if(approveObj.budgetAppId&&approveObj.budgetAppId!=undefined&&approveObj.budgetAppId!=""){approveObj.getBudgetApplyDetailInfo();sysCommon.getApproveFlowData("BUDGET_DATA_APP",approveObj.processInstanceId);approveObj.getTableModelInfo()}approveObj.initEvent()},getBudgetApplyDetailInfo:function(){$.ajax({type:'post',url:'budget/appMain/getBudgetAppInfoByAppId',async:false,data:{"budgetAppId":approveObj.budgetAppId},success:function(data){if(data.flag==0){if(data.data){var datas=data.data;$(".apply-main-model").setDatas(datas);$(".apply-main-model").data("applyData",datas);approveObj.processInstanceId=datas.processInstanceId;$("#busiUsers").text(datas.applicantUserName);$("#deptName").text(datas.applicantUserDeptName);$("#jobName").text(datas.applicantUserJobName==""?"--":datas.applicantUserJobName);$("#telPhone").text(datas.applicantUserPhone==""?"--":datas.applicantUserPhone)}}else{$yt_alert_Model.prompt(data.message)}}})},initEvent:function(){$("#submitBtn").click(function(){var thisBtn=$(this);$(thisBtn).attr("disabled","disabled");var validFlag=$yt_valid.validForm($(".apply-main-model"));if(validFlag){var applyData=$(".apply-main-model").data("applyData");var subDataObj={appId:applyData.budgetAppId,parameters:"",dealingWithPeople:$("#approve-users").val(),opintion:$("#opintion").val(),processInstanceId:applyData.processInstanceId,nextCode:$("#operate-flow").val()};$.ajax({type:'post',url:'budget/appMain/submitWorkFlow',async:false,data:subDataObj,success:function(data){$(thisBtn).attr("disabled",false);$yt_alert_Model.prompt(data.message);if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/approval/budgetApproveList.html'}})}},error:function(e){$(thisBtn).attr("disabled",false)}})}else{$(thisBtn).attr("disabled",false)}});$("#cancelBtn").click(function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/budget/module/approval/budgetApproveList.html'}})})},getTableModelInfo:function(){var applyData=$(".apply-main-model").data("applyData");$.ajax({type:'post',url:'budget/details/getTabInfoListByParams',data:{booksId:applyData.booksId,budgetStage:applyData.budgetStage,deptId:''},success:function(data){if(data.flag==0){if(data.data&&data.data.length>0){var contStr="";$('#tableTemplate').show();$(".listNoData").hide();$(".temp-model").html('<div id="tableTemplate"></div>');$.each(data.data,function(i,n){contStr='<div title="'+n.tableName+'"><input type="hidden" class="hid-table-id" value="'+n.tableId+'"/><input type="hidden" class="hid-table-code" value="'+n.tableCode+'"/></div>';$("#tableTemplate").append(contStr)});$('#tableTemplate').tabs({onSelect:function(title,index){var tableId=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-id").val();var tableCode=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-code").val();var tabIndex=index;var thisSelPanel=$(".tabs-panels .panel").eq(tabIndex).find(".panel-body");approveObj.getBudgetTableDetailByTableId(tableId,thisSelPanel);approveObj.getTableInfoList(tableId,thisSelPanel);$(".tabs-panels .panel").eq(tabIndex).find(".panel-body .tab-table-title").remove();var tableTitle='<div class="tab-table-title">'+tableCode+'--'+title+'</div>';$(".tabs-panels .panel").eq(tabIndex).find(".panel-body table").before(tableTitle)}});$('#tableTemplate').tabs('select',0)}else{$('#tableTemplate').hide();$(".listNoData").show()}}else{$('#tableTemplate').hide();$(".listNoData").show();$yt_alert_Model.prompt(data.message)}}})},getBudgetTableDetailByTableId:function(tableId,creatTableAreaObj){$.ajax({type:'post',url:'budget/table/getBudgetTableDetailByTableId',async:false,data:{tableId:tableId},success:function(data){var dataObj=data.data||{};$(creatTableAreaObj).newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:false});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$(creatTableAreaObj).find('.rule-table .indicate-head tr .indicate').eq(index-1).addClass('dis');$(creatTableAreaObj).find('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('dis')})}else if(proper.type=='r'){$(creatTableAreaObj).find('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('dis')}}$('.rule-table').data('tableData',dataObj);$(creatTableAreaObj).find('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$(creatTableAreaObj).find('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();if(!isNaN(html)){html='<span class="money-text">'+html+'</span>'}else{html='<span>'+html+'</span>'}$(this).html(html)})}})},getTableInfoList:function(tableId,thisPanel){var applyData=$(".apply-main-model").data("applyData");$.ajax({type:"post",url:'budget/details/getBudgetDataDetailInfoByTable',async:false,data:{tableId:tableId,booksId:applyData.booksId,budgetStage:applyData.budgetStage,deptId:''},success:function(data){if(data.flag==0){if(data.data.length>0){var tbody=$('.rule-table .yt-tbody');$.each(data.data,function(i,n){$(thisPanel).find(".rule-table .yt-tbody tr").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}})}};$(function(){approveObj.init()});
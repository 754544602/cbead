(function($,window){var serveExamine={appId:'',costType:'',processInstanceId:'',unitActual:0,parActual:0,otherActual:0,payDetail:'',parCode:'',init:function(){var ts=this;$('#approveDiv').html(sysCommon.createFlowApproveMode());var advanceAppId=$yt_common.GetQueryString('appId');var fun=$yt_common.GetQueryString('fun');serveExamine.appId=advanceAppId;serveExamine.getReimAppInfoDetailByReimAppId(advanceAppId);ts.start();ts.events()},start:function(){$('select').niceSelect();$('#payDate').calendar({speed:0,nowData:false})},events:function(){var me=this;if($("#costTypeName").text()!="差旅费"){$("#budgetPprojectDetailsTd").hide()}else if($("#specialName").text().split("-")[0]=="基本支出"){$("#budgetPprojectDetailsTd").hide()}else{$("#budgetPprojectDetailsTd").show()}if($("#costTypeName").text()=="培训费"){$("#budgetPprojectDetailsTd").hide();$("#budgetPprojectDetailsTd").prev("td").show();$("#budgetPprojectDetailsTd").prev("td").find("label").text("预算项目：");$(".advance-relevance label").text("预算项目可用余额：")}$('.file-box').on('click','.del-file',function(){var ithis=$(this);var parent=ithis.parent();$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){parent.remove()}})});$('#advanceAppNum').click(function(){var pageUrl="";if($("#costTypeName").text()=="培训费"){pageUrl="view/projectManagement-sasac/expensesReim/module/beforehand/beforeApplyDetail.html?advanceId="+$("#advanceAppNumHiddenInput").val()}else{pageUrl="view/system-sasac/expensesReim/module/beforehand/beforeApplyDetail.html?advanceId="+$("#advanceAppNumHiddenInput").val()}$yt_baseElement.openNewPage(2,pageUrl)});$('.budget-project').click(function(){var pageUrl="view/projectManagement-sasac/expensesReim/module/beforehand/beforeApplyDetail.html?advanceId="+$("#hiddenBudgetProject").val();$yt_baseElement.openNewPage(2,pageUrl)});$('.money-input').on('focus',function(){var ts=$(this);if(ts.val()!=""){ts.val($yt_baseElement.rmoney(ts.val()))}});$('.money-input').on('blur',function(){var ts=$(this);if(ts.val()!=''){ts.val($yt_baseElement.fmMoney(ts.val()))}});$('.money-input').on('keyup',function(){var ts=$(this);if(ts.val()!=''){ts.val(ts.val().replace(/[^\d.]/g,''))}});$('#printBills').on('click',function(){var type='';var urlStr='';if(type=='TRAVEL_APPLY'){urlStr=$yt_option.websit_path+'view/system-sasac/expensesReim/module/print/printTravelExpenses.html'}else{urlStr=$yt_option.websit_path+'view/system-sasac/expensesReim/module/print/printSpendingForm.html'}var pageUrl=urlStr;var goPageUrl="view/system-sasac/expensesReim/module/approval/expenApplApprList.html";window.open($yt_option.websit_path+"index.html?pageUrl="+encodeURIComponent(pageUrl)+'&goPageUrl='+goPageUrl)});$('.pay-detail-tabel').on('blur','.money-input',function(){var ts=$(this);if(ts.val()!=''){ts.val($yt_baseElement.fmMoney(ts.val()))}var tr=$(this).parents('tr');var cash=me.rmoney(tr.find('.cash').val());var offica=me.rmoney(tr.find('.offica').val());var trans=me.rmoney(tr.find('.trans').val());tr.find('.row-total').text(me.fmMoney(cash+offica+trans));me.countDetailTotal()});$('table.payee-personal').on('click','.to-data',function(){var tr=$(this).parents('tr');$('#perPayeeName').text(tr.attr('payeename')||'--');$('#perPersonalTotal').text(tr.attr('personalTotal')||'0.00');var choiceLoan=tr.attr('choiceLoan');if(choiceLoan&&choiceLoan!='请选择'){$('.personal-payment .display-loan').show();$('#perChoiceLoan').text(tr.attr('choiceLoan')||'--');$('.per-arrears-money').text(tr.attr('arrearsmoney')||'0.00');$('.per-reverse-money').text(tr.attr('thereversemoney')||'0.00')}else{$('.personal-payment .display-loan').hide();$('#perChoiceLoan').text('');$('.per-arrears-money').text('0.00');$('.per-reverse-money').text('0.00')}$('#perWiteOffPersonal').text(tr.find('td').eq(2).text()||'无');if(tr.attr('witeOffPersonal')){$('.personal-payment .display-loan').show()}else{$('.personal-payment .display-loan').hide()}$('.per-writeoff-money').text(tr.attr('personalWriteoff')||'0.00');$('#perCash').text(tr.attr('cash')||'0.00');$('#perOfficialCard').text(tr.attr('officialCard')||'0.00');$('#perTransferAccounts').text(tr.attr('transferAccounts')||'0.00');$('#perIdCarkno').text(tr.attr('idCarkno')||'--');$('#perPayeeBank').text(tr.attr('payeeBank')||'--');$('#perPerank').text(tr.attr('personalUnit')||'--');$('#perBankName').text(tr.attr('bankName')||'--');$('#perPhoneNum').text(tr.attr('phoneNum')||'--');$('#perOffOpenBank').text(tr.attr('offOpenBank')||'--');$('#perOffAccounts').text(tr.attr('offAccounts')||'--');var payeeRadio=tr.attr('payeeRadio');$('#payeeRadio').text(payeeRadio==1?'有':'无');$('#perSpecial').text(tr.attr('personalSpecial'));$('#personalPayment').show();$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition($('#personalPayment'));$('#pop-modle-alert').show();$('#personalPayment').show()});$('#personalPayment .model-bottom-btn .yt-cancel-btn,#personalPayment .closed-span').on('click',function(){$yt_baseElement.hideMongoliaLayer();$('#pop-modle-alert').hide();$('#personalPayment').hide();$('#perPayeeName').text('--');$('#perPersonalTotal').text('0.00');$('.personal-payment .display-loan').hide();$('#perChoiceLoan').text('--');$('.per-arrears-money').text('0.00');$('.per-arrears-money').text('0.00');$('#perWiteOffPersonal').text('--');$('.per-writeoff-money').text('0.00');$('#perCash').text('0.00');$('#perOfficialCard').text('0.00');$('#perTransferAccounts').text('0.00');$('#perIdCarkno').text('--');$('#perPerank').text('--');$('#perPayeeBank').text('--');$('#perBankName').text('--');$('#perPhoneNum').text('--');$('#payeeRadio').text('--');$('#perSpecial').text('--')});$('#submitPayment').on('click',function(){var thisBtn=$(this);thisBtn.attr('disabled',true).addClass('btn-disabled');var type='';if($yt_valid.validForm($('.approve-div'))){var verifyPayDateilDiff=serveExamine.verifyPayDateilDiff();if(verifyPayDateilDiff){var d=serveExamine.getSaveData();var actualTotal=$yt_baseElement.fmMoney(serveExamine.unitActual+serveExamine.parActual+serveExamine.otherActual);actualTotal=$yt_baseElement.rmoney(actualTotal);if(d.taskKey=='activitiEndTask'){var payDetail=$('.pay-detail-tabel .total-money').text();if($yt_baseElement.rmoney(payDetail)==actualTotal){serveExamine.saveLotPayDetailInfo(d,thisBtn)}else{$yt_alert_Model.prompt('财务支付金额与实际收款总金额不符');thisBtn.attr('disabled',false).removeClass('btn-disabled')}}else{serveExamine.saveLotPayDetailInfo(d,thisBtn)}}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}});$("#printExpend").on("click",function(){var pageUrl="view/system-sasac/expensesReim/module/print/expenditureVoucher.html?expenditureAppId="+serveExamine.appId;$yt_baseElement.openNewPage(2,pageUrl)});$("#printExpendDetail").on("click",function(){var pageUrl="view/system-sasac/expensesReim/module/print/expenditureVoucherDetailed.html?expenditureAppId="+serveExamine.appId+"&costType="+serveExamine.costType;$yt_baseElement.openNewPage(2,pageUrl)});me.tallyListEvent();$('.yt-table tbody').on('click','tr',function(){var ts=$(this);var trs=ts.siblings();trs.removeClass('yt-table-active');ts.addClass('yt-table-active')});me.financialPayment();me.selectCheck();$('.payee-unit,.payee-other,.payee-personal').on('click','.to-detail',function(){var loanAppId=$(this).parents('tr').attr('loanAppId');var pageUrl="view/system-sasac/expensesReim/module/loanApply/loanApplyDetail.html?loanId="+loanAppId;$yt_baseElement.openNewPage(2,pageUrl)})},verifyPayDateilDiff:function(){var trs=$('.pay-detail-tabel .pay-row');var verify=true;if(trs.length>0){trs.each(function(i,n){n=$(n);var pkId=n.attr('pkId');var ctype=n.attr('ctype');var count=serveExamine.rmoney(n.find('.row-total').text());var money=0;if(ctype=='GATHERING_UNIT'){money=serveExamine.rmoney($('table.payee-unit td[pid="'+pkId+'"]').parent().find('.unitTotal').text())}else if(ctype=='GATHERING_PERSON'){money=serveExamine.rmoney($('table.payee-personal td[pid="'+pkId+'"]').parent().find('.personalTotal').text());money=money-(serveExamine.rmoney($('table.payee-personal td[pid="'+pkId+'"]').parent().find('td').eq(3).text()))}else if(ctype=='GATHERING_OTHER'){money=serveExamine.rmoney($('table.payee-other td[pid="'+pkId+'"]').parent().find('.unitTotal').text())}})}return verify},workEndSubmitEvent:function(){var me=this;$('#submitPayment').off().on('click',function(){var thisBtn=$(this);thisBtn.attr('disabled',true).addClass('btn-disabled');var type='';if($yt_valid.validForm($('.approve-div'))){var verifyPayDateilDiff=serveExamine.verifyPayDateilDiff();if(verifyPayDateilDiff){var d=serveExamine.getSaveData();serveExamine.saveLotPayDetailInfo(d,thisBtn)}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}})},fmMoney:function(str){return $yt_baseElement.fmMoney(str||'0')},rmoney:function(str){return $yt_baseElement.rmoney(str||'0')},paymentListEvent:function(){var me=this;$('#addProcuList').on('click',function(){me.showPaymentAlert()});$('#paymentList').on('click','.operate-del',function(){var ithis=$(this);var tr=ithis.parents('tr');$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove()}})});$('#paymentList').on('click','.operate-update',function(){var ithis=$(this);var tr=ithis.parents('tr');me.showPaymentAlert()});$('#paymentCanelBtn').on('click',function(){me.hidePaymentAlert()})},showPaymentAlert:function(){var alert=$('#createDetali');$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition(alert);$('#pop-modle-alert').show();alert.show()},hidePaymentAlert:function(){var alert=$('#createDetali');$yt_baseElement.hideMongoliaLayer();alert.hide();$('#pop-modle-alert').hide()},serveExamineEvent:function(){$('.prior-approval').click(function(){$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition($('.prior-alert'));$('#pop-modle-alert').show();$('.prior-alert').show()});$('.prior-common').click(function(){var code=$('.prior-approval-list .yt-table-active').attr('code');if(code){$('.prior-approval').val(code);$yt_baseElement.hideMongoliaLayer();$('.prior-alert').hide();$('#pop-modle-alert').hide()}else{$yt_alert_Model.prompt('请选择一条数据')}});$('.prior-cancel').click(function(){$yt_baseElement.hideMongoliaLayer();$('.prior-alert').hide();$('#pop-modle-alert').hide()})},tallyListEvent:function(){var me=this;$('.add-tally').click(function(){me.showMsgAlert();$('.tally-common').off().on('click',function(){me.appendMsgList()}).text('添加到列表')});$('.tally-cancel').click(function(){me.hideMsgAlert();me.clearAlert($('.msg-alert'))});$('.tally-list').on('click','.operate-del',function(){var ithis=$(this);var tr=ithis.parents('tr');$yt_alert_Model.alertOne({alertMsg:"数据删除将无法恢复,确认删除吗?",confirmFunction:function(){tr.remove()}})});$('.tally-list').on('click','.operate-update',function(){var ithis=$(this);var tr=ithis.parents('tr');var loanType=$('#loanType option[value="'+tr.attr('loanCode')+'"]').attr('selected',true);var abstract=$('#abstract').val(tr.attr('abstract'));var totalSubject=$('#totalSubject').val(tr.attr('totalSubject'));var detailSubject=$('#detailSubject').val(tr.attr('detailSubject'));var tallyMoney=$('#tallyMoney').val(tr.attr('tallyMoney'));$('#loanType').niceSelect();me.showMsgAlert();$('.tally-common').off().on('click',function(){me.appendMsgList(tr)}).text('确定')})},appendMsgList:function(tr){var me=this;if($yt_valid.validForm($('.tally-alert'))){var loanType=$('#loanType option:selected').text();var loanCode=$('#loanType option:selected').val();var abstract=$('#abstract').val();var totalSubject=$('#totalSubject').val();var detailSubject=$('#detailSubject').val();var tallyMoney=$('#tallyMoney').val();var totalText='';var detailText='';if(loanType=='DEBIT_ENTRY'){totalText=tallyMoney}else{detailText=tallyMoney}var html='<tr pid="" class="" loanCode="'+loanCode+'" loanType="'+loanType+'" abstract="'+abstract+'" totalSubject="'+totalSubject+'" detailSubject="'+detailSubject+'" tallyMoney="'+tallyMoney+'"><td>'+abstract+'</td><td>'+totalSubject+'</td><td>'+detailSubject+'</td><td>'+totalText+'</td><td>'+detailText+'</td><td><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"></span></td></tr>';if(tr){tr.replaceWith(html)}else{$('.tally-list').append(html)}me.hideMsgAlert();me.clearAlert($('.tally-alert'))}else{}},showMsgAlert:function(){var alert=$('.tally-alert');$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition(alert);$('#pop-modle-alert').show();alert.show()},hideMsgAlert:function(){$yt_baseElement.hideMongoliaLayer();$('.tally-alert').hide();$('#pop-modle-alert').hide()},clearAlert:function(obj){var selects=obj.find('select');$.each(selects,function(i,n){$(n).find('option:first-child').attr('selected',true)});selects.niceSelect();var inputs=obj.find('input');inputs.val('')},getReimAppInfoDetailByReimAppId:function(advanceAppId){var me=this;$.ajax({type:"post",url:"sz/expenditureApp/getExpenditureAppInfoByAppId",async:false,data:{expenditureAppId:advanceAppId},success:function(data){var d=data.data;me.saveData=d;serveExamine.processInstanceId=d.processInstanceId;serveExamine.costType=d.costType;sysCommon.getApproveFlowData("SZ_EXPENDITURE_APP",d.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}');if(d.jsFun){me[d.jsFun]()}$("#advanceAppNumHiddenInput").val(d.advanceAppId);$("#hiddenBudgetProject").val(d.budgetAppId);me.showDetail(d);if(d.costType=='ACCRUED_TAX'||d.costType=='SOCIAL_SECURITY_FEE'){$('.pay-detail').hide();$('#approve-users').attr("validform","{isNull:false,msg:'请选择审批人'}");if(d.taskKey=='activitiEndTask'){$('#submitPayment').text('提交')}else{$('#submitPayment').text('提交')}}else{if(d.taskKey=='activitiEndTask'){$('.pay-detail').show();$('#approve-users').attr("validform","{isNull:false,msg:'请选择审批人'}");$('#submitPayment').text('提交');me.gatheringUnitDetail(d.payReceivablesData.gatheringUnitList);me.gatheringPersonDetail(d.payReceivablesData.gatheringPersonList);me.gatheringOtherDetail(d.payReceivablesData.gatheringOtherList);me.countDetailTotal();}else{$('.pay-detail').hide();$('#submitPayment').text('提交')}}if(d.costType=='TRAIN_APPLY'){$("#predictCostDiv").hide();$("#payTaxesDiv").show();}else{$("#doAdvanceBox").hide()}$('.check-label').off('click');$('.check-label input').attr('disabled',true).off('click');if(data.data.validateType=="UNIT"){$("#deptBudgetBalanceAmount").hide();$("#deptBudgetBalanceAmount").prev().hide();$("#deptBudgetBalanceAmount").next().hide()}if(data.data.validateType=="DEPT"){$("#budgetBalanceAmount").hide();$("#budgetBalanceAmount").prev().hide()}}})},gatheringUnitDetail:function(list){var html='';$.each(list,function(i,n){$('.pay-detail-tabel .last').before('<tr class="pay-row" pkId="'+n.unitId+'" ctype="GATHERING_UNIT" reverseLoanAmount="'+$yt_baseElement.rmoney(n.reverseLoanAmount)+'"><td>'+n.unitName+'</td><td><input id="unitDate'+n.unitId+'" class="calendar-input pay-date" style="width: 198px;" value="" placeholder="请选择日期" type="text" readonly="readonly"></td><td><input class="yt-input money-input cash" placeholder="请输入" value="0.00"></td><td><input class="yt-input money-input offica" placeholder="请输入" value="0.00"></td><td><input class="yt-input money-input trans" placeholder="请输入" value="'+(serveExamine.fmMoney(n.actualCollectionAmount))+'"></td><td class="row-total">'+(serveExamine.fmMoney(n.actualCollectionAmount))+'</td></tr>');$('#unitDate'+n.unitId).calendar({speed:0})})},gatheringPersonDetail:function(list){var html='';$.each(list,function(i,n){$('.pay-detail-tabel .last').before('<tr class="pay-row" pkId="'+n.personalId+'" ctype="GATHERING_PERSON" reverseLoanAmount="'+$yt_baseElement.rmoney(n.writeOffAmount)+'"><td>'+n.personalName+'</td><td><input id="personalDate'+n.personalId+'" class="calendar-input pay-date" style="width: 198px;" value="" placeholder="请选择日期" type="text" readonly="readonly"></td><td><input class="yt-input money-input cash" placeholder="请输入" value="'+(serveExamine.fmMoney(n.cash))+'"></td><td><input class="yt-input money-input offica" placeholder="请输入" value="'+(serveExamine.fmMoney(n.officialCard))+'"></td><td><input class="yt-input money-input trans" placeholder="请输入" value="'+(serveExamine.fmMoney(n.transfer))+'"></td><td class="row-total">'+(serveExamine.fmMoney(Number(n.cash)+Number(n.officialCard)+Number(n.transfer)))+'</td></tr>');$('#personalDate'+n.personalId).calendar({speed:0})})},gatheringOtherDetail:function(list){var html='';$.each(list,function(i,n){$('.pay-detail-tabel .last').before('<tr class="pay-row" pkId="'+n.otherId+'" ctype="GATHERING_OTHER" reverseLoanAmount="'+$yt_baseElement.rmoney(n.reverseLoanAmount)+'"><td>'+n.otherName+'</td><td><input id="otherDate'+n.otherId+'" class="calendar-input pay-date" style="width: 198px;" value="" placeholder="请选择日期" type="text" readonly="readonly"></td><td><input class="yt-input money-input cash" placeholder="请输入" value="0.00"></td><td><input class="yt-input money-input offica" placeholder="请输入" value="0.00"></td><td><input class="yt-input money-input trans" placeholder="请输入" value="'+(serveExamine.fmMoney(n.actualCollectionAmount))+'"></td><td class="row-total">'+(serveExamine.fmMoney(n.actualCollectionAmount))+'</td></tr>');$('#otherDate'+n.otherId).calendar({speed:0})})},countDetailTotal:function(){var total=0;$('.pay-detail-tabel .row-total').each(function(){total+=serveExamine.rmoney($(this).text())});$('.pay-detail-tabel .last .total-money').text(serveExamine.fmMoney(total))},getCostAppInfoDetailByParams:function(appId,costType){var me=this;$.ajax({type:"post",url:"sz/reimApp/getCostAppInfoDetailByParams",async:true,data:{appId:appId,costType:costType},success:function(data){me.showCostDetail(data.data)}})},getReimPreviewDetailByReimAppId:function(reimAppId,previewFalg,qrCodeContext){var me=this;$.ajax({type:"post",url:"sz/reimApp/getCostAppInfoDetailByParams",async:true,data:{reimAppId:reimAppId,previewFalg:previewFalg,qrCodeContext:qrCodeContext},success:function(data){}})},getSubData:function(){var getFileList=function(){var str='';var list=$('#attIdStr .li-div');$.each(list,function(i,n){str+=$(n).attr('fid')+(i<list.length?',':'')});return str};var costReceptionistList=function(){var list=[];var trs=$('.msg-list tbody tr');var tr=null;$.each(trs,function(i,n){tr=$(n);list.push({costReceptionistId:tr.attr('pkId'),name:tr.find('.name-text').text(),jobName:tr.find('.job-text').text(),unitName:tr.find('.unit-text').text(),})});return list};var costDetailsList=function(){var list=[];var trs=$('#paymentList tbody tr:not(.last)');var tr=null;$.each(trs,function(i,n){tr=$(n);list.push({costDetailsId:tr.attr('pkId'),publicServiceProCode:tr.attr('budgetcode'),activityDate:tr.find('.act-date').text(),placeName:tr.find('.place-name').text(),costType:tr.attr('costcode'),standardAmount:tr.find('.stan-money').attr('money'),activityAmount:tr.find('.money').attr('money'),peopleNum:tr.find('.people-num').text(),setMethod:''})});return list};var tripPlanList=function(){var list=[];var trs=$('#tripList tbody tr:not(.last)');var tr=null;$.each(trs,function(i,n){tr=$(n);list.push({travelType:tr.attr('busicode'),travelAddress:tr.find('.address').attr('val'),travelAddressName:tr.find('.address').text(),startTime:tr.find('.sdate').text(),endTime:tr.find('.edate').text(),travelPersonnels:tr.attr('usercode'),receptionCostItem:tr.attr('rececode'),setMethod:''})});return list};var carfareList=function(){var costCarfareList=[];var costCarfareJson="";var cityDatas;if($("#traffic-list-info tbody tr:not(.total-last-tr)").length>0){$("#traffic-list-info tbody tr:not(.total-last-tr)").each(function(i,n){cityDatas=$(this).getDatas();cityDatas.crafare=$yt_baseElement.rmoney(cityDatas.crafare);cityDatas.setMethod='';if($(this).find(".hid-child-code").val()=="null"||$(this).find(".hid-child-code").val()==""){cityDatas.vehicle="."+$(this).find(".hid-vehicle").val()+"."}else{cityDatas.vehicle="."+$(this).find(".hid-vehicle").val()+"."+$(this).find(".hid-child-code").val()+"."}costCarfareList.push(cityDatas)})}return costCarfareList};var hotelList=function(){var costHotelList=[];var costHotelJson="";var hotelDatas;if($("#hotel-list-info tbody tr:not(.total-last-tr)").length>0){$("#hotel-list-info tbody tr:not(.total-last-tr)").each(function(i,n){hotelDatas=$(this).getDatas();hotelDatas.hotelExpense=$yt_baseElement.rmoney(hotelDatas.hotelExpense);hotelDatas.setMethod='';costHotelList.push(hotelDatas)});if(costHotelList.length>0){costHotelJson=JSON.stringify(costHotelList)}}return costHotelList};var otherList=function(){var costOtherList=[];var costOtherJson="";var otherDatas;if($("#other-list-info tbody tr:not(.total-last-tr)").length>0){$("#other-list-info tbody tr:not(.total-last-tr)").each(function(i,n){otherDatas=$(this).getDatas();otherDatas.reimAmount=$yt_baseElement.rmoney(otherDatas.reimAmount);otherDatas.setMethod='';costOtherList.push(otherDatas)});if(costOtherList.length>0){costOtherJson=JSON.stringify(costOtherList)}}return costOtherList};var costSubsidyList=function(){var list=[];var trs=$('#subsidy-list-info tbody tr:not(.last)');var tr=null;$.each(trs,function(i,n){tr=$(n);list.push({travelPersonnel:tr.find('.user').attr('code'),subsidyDays:tr.find('.subsidy-num').text(),subsidyFoodAmount:tr.find('.food').attr('num'),carfare:tr.find('.traffic').attr('num'),setMethod:''})});return list};var costData=function(){return JSON.stringify({costReceptionistList:costReceptionistList(),costDetailsList:costDetailsList(),travelRouteList:tripPlanList(),costCarfareList:carfareList(),costHotelList:hotelList(),costOtherList:otherList(),costSubsidyList:costSubsidyList()})};var billingVoucherJson=function(){var list=[];var trs=$('#tally-list tbody tr');var tr=null;$.each(trs,function(i,n){tr=$(n);list.push({billingVoucherId:tr.attr('pid'),toLoanType:tr.attr('loancode'),abstracts:tr.attr('abstract'),ledger:tr.attr('totalsubject'),detailed:tr.attr('detailsubject'),amount:tr.attr('tallymoney')})});return JSON.stringify(list)};return{advanceAppId:$('#advanceAppId').val(),loanAppId:$('#loanAppId').val(),reimAppId:$('#reimAppId').val(),reimAppNum:$('#reimAppNum').val(),reimAppName:$('#reimAppName').attr('val'),costType:$('#costTypeName').attr('val'),specialCode:$('#specialName').attr('val'),invoiceNum:$('#invoiceNum').text(),totalAmount:$('#totalAmount').attr('num'),writeOffAmount:$yt_baseElement.rmoney($('#writeOffAmount').text()),officialCard:$yt_baseElement.rmoney($('#officialCard').text()),cash:$yt_baseElement.rmoney($('#cash').text()),cheque:$yt_baseElement.rmoney($('#cheque').text()),transfer:0,attIdStr:getFileList(),paymentDate:$('#paymentDate').val(),paymentAmount:$yt_baseElement.rmoney($('#paymentAmount').val()||'0'),cmTotalAmount:$yt_baseElement.rmoney($('#cmTotalAmount').text()||'0'),cmWriteOffAmount:$yt_baseElement.rmoney($('#cmWriteOffAmount').text()||'0'),cmOfficialCard:$yt_baseElement.rmoney($('#cmOfficialCard').val()||'0'),cmCash:$yt_baseElement.rmoney($('#cmCash').val()||'0'),cmCheque:$yt_baseElement.rmoney($('#cmCheque').val()||'0'),cmTransfer:0,applicantUser:$('#applicantUser').val(),parameters:'{posCode:"'+serveFunds.parCode+'"}',dealingWithPeople:$('#approve-users option:selected').val(),opintion:$('#opintion').val(),processInstanceId:$('#processInstanceId').val(),nextCode:$('#operate-flow option:selected').val(),costData:[],billingVoucherJson:billingVoucherJson(),}},showDetail:function(d){var me=this;var fMoney=$yt_baseElement.fmMoney;$('#reimAppName').text(d.expenditureAppName);$('#specialName').text(d.specialName||'--');$('#advanceAppNum').text(d.advanceAppNum||'--');$('#costTypeName').text(d.costTypeName).attr('val',d.costType);if(d.costType=="TRAIN_APPLY"){$("#noContain").show()}else{$("#noContain").hide()}$('#formNum').text(d.expenditureAppNum);$(".ordinary-div").setDatas(d);$('#busiUsers').text(d.applicantUserName);$('#deptName').text(d.applicantUserDeptName);$('#jobName').text(d.applicantUserPositionName==""?"--":d.applicantUserPositionName);$("#telPhone").text(d.applicantUserPhone==""?"--":d.applicantUserPhone);$('#advanceAppId').val(d.advanceAppId);$('#loanAppId').val(d.loanAppId);$('#loanAmount').text(d.arrearsAmount?(fMoney(d.arrearsAmount)):'0.00');var outWriteAmount= +d.totalAmount<= +d.arrearsAmount?d.totalAmount:d.arrearsAmount;$('#outWriteAmount').text(fMoney(outWriteAmount||'0'));$('#reimAppId').val(d.reimAppId);if(d.advanceAppNum){$('.advance-relevance').show();$('#advanceAppBalance').text(d.advanceAppBalance?(fMoney(d.advanceAppBalance)+'元'):'--');$('.advance-relevance').append('<span>（不包含冻结金额'+d.frozenMount+'元）</span>')}var specialValArr=d.specialCode.split('-');if(specialValArr[0]=='395'){$('.prj-name-tr').show();$('#prjName').text(d.prjName);}else{$('.prj-name-tr').hide();}if(specialValArr[0]=='402'){$(".deptBudgetBalanceAmount").hide()}else{$(".deptBudgetBalanceAmount").show()}$('#reimAppNum').val(d.reimAppNum);$('#formNum').text(d.reimAppNum).attr('val',d.reimAppNum);$('#budgetBalanceAmount').text(d.budgetBalanceAmount?fMoney(d.budgetBalanceAmount)+'万元':'--');$('#deptBudgetBalanceAmount').text(d.deptBudgetBalanceAmount?fMoney(d.deptBudgetBalanceAmount)+'万元':'--');$('#invoiceNum').text(d.invoiceNum);$('#mustMoney').text(fMoney(d.totalAmount||'0'));$('#totalAmount').text(fMoney(d.totalAmount||'0')).attr('num',d.totalAmount);$("#deductBudgetTotalMoney").text(fMoney(d.deductBudgetAmount||'0')).attr('num',d.deductBudgetAmount);$('#totalMoneyUpper').text(arabiaToChinese(d.totalAmount+''||'0'));$('#amountTotalMoney').text(fMoney(d.totalAmount||'0')).attr('num',d.totalAmount);$('#paymentList .total-money').text(fMoney(d.totalAmount||'0')).attr('num',d.totalAmount);$('#writeOffAmount,#outWriteAmount').text(fMoney(d.writeOffAmount||'0')).attr('num',d.writeOffAmount);var balanceMoney=d.totalAmount<d.arrearsAmount?d.arrearsAmount-d.totalAmount:'0';$('#balanceMoney').text(fMoney(balanceMoney));$('#officialCard').text(fMoney(d.officialCard||'0')).attr('num',d.officialCard);$('#cash').text(fMoney(d.cash||'0')).attr('num',d.cash);$('#cheque').text(fMoney(d.cheque||'0')).attr('num',d.cheque);var body=$('#applyTable tbody');var total= +d.officialCard+ +d.cash+ +d.cheque+0;var rtotal=fMoney(total||'0');body.find('.total').text(rtotal).attr('num',total);var replaceMoney=total;$('#replaceMoney').text(fMoney(replaceMoney));$('#loanAppNum').text(d.loanAppNum?d.loanAppNum:'--');$('#invoiceNum').text(d.invoiceNum);$('#paymentDate').val(d.paymentDate);$('#paymentAmount,#alreadyMoney').text(fMoney(d.paymentAmount));$('#notMoney').text(fMoney(d.paymentBalanceAmount));var cmTotalAmount=d.cmTotalAmount?d.cmTotalAmount:d.totalAmount;$('#cmTotalAmount').text(fMoney(cmTotalAmount||'0')).attr('num',cmTotalAmount);$('#cmWriteOffAmount').text(fMoney(d.writeOffAmount||'0')).attr('num',d.writeOffAmount);$('#cmReplaceMoney').text(fMoney(replaceMoney)).attr('num',replaceMoney);$('#cmOfficialCard').val(fMoney(d.cmOfficialCard||'0'));$('#cmCash').val(fMoney(d.cmCash||'0'));$('#cmCheque').val(fMoney(d.cmCheque||'0'));if(replaceMoney<=0){$('.payroll-working .amount-table tbody input').attr('disabled',true)}$('#applicantUser').val(d.applicantUser);$('#applicantTime').text(d.applicantTime);$('#operate-flow option[value="'+d.nodeNowState+'"]').attr('selected',true);$('#processInstanceId').val(d.processInstanceId);$('#approve-users option[value="'+d.currentAssignee+'"]').attr('selected',true);$('#operate-flow,#approve-users').niceSelect();me.showFileList(d.attList);me.showAdvanceFileList(d.advanceAppAttList);if(d.payReceivablesData.gatheringUnitList==0&&d.payReceivablesData.gatheringPersonList==0&&d.payReceivablesData.gatheringOtherList==0){$(".payment-information").html('<table style="width:100%"><tr style="border:0px;background-color:#fff !important;"><td align="center"style="border:0px;"><div class="no-data" style="width: 280px;padding:0;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding:10px 0;"></div></td></tr></table>')}else{me.showGatheringUnitList(d.payReceivablesData);me.showGatheringPersonList(d.payReceivablesData);me.showGatheringOtherList(d.payReceivablesData)}me.showCostDetail(d.costData);if(d.payReceivablesData.paymentSet){var payLoanMapObj={};$.each(d.payReceivablesData.paymentSet,function(i,n){n["loanTotalAmount"]=0;payLoanMapObj[n.loanAppNum]=n});var trLoanAppNum="";var loanTotal="";$('.payee-unit .yt-tbody tr:not(:last),.payee-personal .yt-tbody tr:not(:last),.payee-other .yt-tbody tr:not(:last)').each(function(i,n){trLoanAppNum=$(n).attr('loanAppNum');loanTotal=0;if(payLoanMapObj[trLoanAppNum]){loanTotal=payLoanMapObj[trLoanAppNum].loanTotalAmount;if($(this).attr('reverseLoanAmount')){loanTotal+=$yt_baseElement.rmoney($(this).attr('reverseLoanAmount'));payLoanMapObj[trLoanAppNum].loanTotalAmount=loanTotal}}});var orTrRed=true;var trNum='';$.each(payLoanMapObj,function(i,n){if(n.loanTotalAmount>$yt_baseElement.rmoney(n.loanAmount)){orTrRed=false;trNum=n.loanAppNum;$yt_alert_Model.alertOne({haveCloseIcon:true,leftBtnName:"确定",cancelFunction:"",alertMsg:"该支出申请审批过程中，借款单欠款金额已发生变化，现少于冲销借款金额，须退回申请人修改后，重新提交",cancelFunction:function(){}});return}});if(orTrRed==false){$('.payee-unit .yt-tbody tr:not(:last),.payee-personal .yt-tbody tr:not(:last),.payee-other .yt-tbody tr:not(:last)').each(function(i,n){if($(n).attr('loanAppNum')==trNum){$(n).find('.ready-red').css('color','red')}})}}},showCostDetail:function(data){var me=this;var fMoney=$yt_baseElement.fmMoney;var costReceptionistList=data.costReceptionistList;var costDetailsList=data.costDetailsList;var receHtml='';$.each(costReceptionistList,function(i,n){receHtml+='<tr pkId="'+n.costReceptionistId+'" class="" nameVal="'+n.name+'" dutyVal="'+n.jobName+'" deptVal="'+n.unitName+'"><td><span class="num">1</span></td><td><span class="name-text">'+n.name+'</span></td><td><span class="job-text">'+n.jobName+'</span></td><td><span class="unit-text">'+n.unitName+'</span></td></tr>'});$('.msg-list tbody').append(receHtml);me.resetNum($('.msg-list'));var detaHtml='';var costDetaClose=$('#paymentList').next().find('.check-label input');var fmTotal=0;$.each(costDetailsList,function(i,n){detaHtml+='<tr pkId="'+n.costDetailsId+'" budgetCode="'+n.publicServiceProCode+'" costCode="'+n.costType+'" budgetProject="'+n.publicServiceProName+'" applyDate="'+n.activityDate+'" siteVal="'+n.placeName+'" costBreakdown="'+n.costTypeName+'" standardMoney="'+n.standardAmount+'" budgetMoney="'+n.activityAmount+'" accompanyNum="'+n.peopleNum+'"><td><span class="">'+n.publicServiceProName+'</span></td><td><span class="act-date">'+n.activityDate+'</span></td><td><span class="place-name">'+n.placeName+'</span></td><td><span>'+n.costTypeName+'</span></td>'+'<td style="text-align: right;"><div class="money" money='+n.activityAmount+'>'+fMoney(n.activityAmount||'0')+'</div></td><td><span class="people-num">'+n.peopleNum+'</span></td></tr>';if(costDetaClose.length>0&&n.setMethod){costDetaClose.setCheckBoxState('check')}fmTotal+= +n.activityAmount});$('#paymentList tbody .last').before(detaHtml);$('#paymentList tbody .total-money').text(serveExamine.fmMoney(fmTotal));var tripPlanList=data.travelRouteList;var tripHtml='';var travelPersonnelsList=[];var getUserNames=function(list){var str='';$.each(list,function(i,n){str+=n.travelPersonnelName+(i<list.length-1?'、':'')});return str};var costItem=function(str){switch(str){case '1':return '住宿费';break;case '2':return '伙食费';break;case '3':return '市内交通费';break;default:return '';break}};var getCostItemName=function(str){var txt='';if(str){var list=str.split(',');$.each(list,function(i,n){if(n){txt+=costItem(n)+(i<list.length-1?'、':'')}});return txt}return ''};$.each(tripPlanList,function(i,n){var dateFrom=new Date(n.startTime);var dateTo=new Date(n.endTime);var diff=dateTo.valueOf()-dateFrom.valueOf();var diff_day=parseInt(diff/(1000*60*60*24));tripHtml+='<tr busicode="'+n.travelType+'" usercode="'+n.travelPersonnels+'" rececode="'+n.receptionCostItem+'" ><td><input type="hidden" class="hid-user-code" value="'+n.travelPersonnels+'" /> <span class="name">'+n.travelTypeName+'</span></td><td class="sdate">'+n.startTime+'</td><td class="edate">'+n.endTime+'</td><td class="day">'+diff_day+'</td><td class="address" val="'+n.travelAddress+'">'+n.travelAddressName+'</td><td class="uname">'+getUserNames(n.travelPersonnelsList)+'</td><td class="numof">'+n.travelPersonnelsList.length+'</td><td class="reception">'+getCostItemName(n.receptionCostItem)+'</td></tr>'});$('#tripList tbody').html(tripHtml);if(data.expenseClassDetails.length==0&&data.costTrainApplyInfoList.length==0&&data.costTeachersFoodApplyInfoList.length==0&&data.costTeachersLectureApplyInfoList.length==0&&data.costTeachersTravelApplyInfoList.length==0&&data.costTeachersHotelApplyInfoList.length==0&&data.costNormalList.length==0){$(".hide-div").html('<table style="width:100%"><tr style="border:0px;background-color:#fff !important;"><td align="center"style="border:0px;"><div class="no-data" style="width: 280px;padding:0;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding:10px 0;"></div></td></tr></table>')}else{me.setCostTrainApplyInfoList(data.costTrainApplyInfoList);me.setTeacherClassExpenseDetails(data.expenseClassDetails);me.setTeacherTrainDetails(data.expenseDetails)}me.setTrainApplyInfoList(data.trainApplyInfoList)},setCostTrainApplyInfoList:function(list){var html='';var total=0;if(list!=0){$.each(list,function(i,n){html+='<tr pid="'+n.trainAppId+'" trainType="'+n.trainType+'"><td class="trainTypeName">'+n.trainTypeName+'</td><td class="standard">'+$yt_baseElement.fmMoney(n.standard)+'</td><td class="trainOfNum">'+n.trainOfNum+'</td><td class="moneyText averageMoney">'+$yt_baseElement.fmMoney(n.averageMoney)+'</td><td style="text-align: center" class="trainingPerNumber">'+(n.remark||'')+'</td></tr>';total+= +n.averageMoney});$('#trainingFeeTable tbody .last').before(html);$('#trainingFeeTable .costTotal').text(serveExamine.fmMoney(total))}else{$('#trainingFeeTable').hide();$('.other-title-back').hide()}},setTrainApplyInfoList:function(list){var html='';var me=this;$.each(list,function(i,n){me.initProjectSelect(n.projectCode,n.projectId);$('.from-table-detail').setDatas(n)});$('#trainingPopTable tbody').html(html)},showFileList:function(list){var ls='';var src='';if(list&&list.length>0){$.each(list,function(i,n){var imgType=n.attName.split('.');if(imgType.length>1&&(imgType[1]=='png'||imgType[1]=='jpeg'||imgType[1]=='bmp'||imgType[1]=='jpg')){src=$yt_option.base_path+'fileUpDownload/download?pkId='+n.attId+'&isDownload=false';ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pv">预览<img src="'+src+'" ></label></div>'}else{ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pvno">预览</label></div>'}});$('#attIdStr').html(ls);$('#attIdStr .file-dw').on('click',function(){var id=$(this).parent().attr('fid');window.location.href=$yt_option.base_path+'fileUpDownload/download?pkId='+id+'&isDownload=true'});$('#attIdStr .file-pv img').showImg()}else{$('#attIdStr').html('暂无附件')}},showAdvanceFileList:function(list){var ls='';var src='';if(list&&list.length>0){$.each(list,function(i,n){var imgType=n.attName.split('.');if(imgType.length>1&&(imgType[1]=='png'||imgType[1]=='jpeg'||imgType[1]=='bmp'||imgType[1]=='jpg')){src=$yt_option.base_path+'fileUpDownload/download?pkId='+n.attId+'&isDownload=false';ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pv">预览<img src="'+src+'" ></label></div>'}else{ls+='<div fid="'+n.attId+'" class="li-div"><span class="file-name" >'+n.attName+'</span><label class="file-dw">下载</label><label class="file-pvno">预览</label></div>'}});$('#advanceIdStr').html(ls);$('#advanceIdStr .file-dw').on('click',function(){var id=$(this).parent().attr('fid');window.location.href=$yt_option.base_path+'fileUpDownload/download?pkId='+id+'&isDownload=true'});$('#advanceIdStr .file-pv img').showImg()}else{$('#advanceIdStr').html('暂无附件')}},showGatheringUnitList:function(list){var html='';var total=0;if(list.gatheringUnitList!=0){$.each(list.gatheringUnitList,function(i,n){html+='<tr class="payee-unit-tr" loanAppNum="'+n.loanAppNum+'" loanAppId="'+n.loanAppId+'" reverseLoanAmount="'+n.reverseLoanAmount+'" theReverseMoney="'+$yt_baseElement.rmoney(n.reverseLoanAmount)+'" actualMoney="'+$yt_baseElement.rmoney(n.actualCollectionAmount)+'"><td class="com" value="Company" pid="'+n.unitId+'" >'+n.unitName+'</td><td style="text-align: right;" class="unitTotal">'+($yt_baseElement.fmMoney(n.amount))+'</td><td>'+n.openBank+'</td><td>'+n.accounts+'</td><td value="1">'+(n.isContract==1?'有':'无')+'</td><td >'+(n.isSettlement==1?'汇款':'支票')+'</td><td style="text-align:right;">'+($yt_baseElement.fmMoney(n.paidAmount))+'</td><td>'+(n.remarks||'')+'</td></tr>';total+= +n.amount;serveExamine.unitActual+= +n.actualCollectionAmount});$('table.payee-unit .payee-unit-total').before(html).find('.payee-unit-money').text($yt_baseElement.fmMoney(total))}else{$('table.payee-unit').hide();$(".unit-div").hide()}},showGatheringPersonList:function(list){var html='';var total=0;if(list.gatheringPersonList!=0){$.each(list.gatheringPersonList,function(i,n){html+='<tr class="payee-personal-tr" pkid="" loanAppNum="'+n.loanAppNum+'" reverseLoanAmount="'+n.writeOffAmount+'" loanAppId="'+n.loanAppId+'" personalUnit="'+n.personalUnit+'" payeeval="'+n.personalCode+'" payeename="'+n.personalName+'" pedepartment="'+n.personalDept+'" perank="'+n.personalJobLevelName+'" personaltotal="'+n.amount+'" witeoffpersonal="'+n.reverseTheWay+'" personalwriteoff="'+n.replaceAmount+'" cash="'+n.cash+'" officialcard="'+n.officialCard+'" transferaccounts="'+n.transfer+'" payeeradio="'+n.isContract+'" personalspecial="'+n.remarks+'" idcarkno="'+n.idCard+'" payeebank="'+n.accounts+'" bankname="'+n.openBank+'" phonenum="'+n.phoneNum+'" choiceloan="'+n.loanAppNum+'" choiceloanval="'+n.loanAppId+'" arrearsmoney="'+n.loanAppArrearsAmount+'" thereversemoney="'+n.writeOffAmount+'" offOpenBank="'+n.offOpenBank+'" offAccounts="'+n.offAccounts+'"><td class="per" value="personal" pid="'+n.personalId+'">'+n.personalName+'</td><td style="text-align: right;" class="personalTotal">'+serveExamine.fmMoney(n.amount)+'</td><td style="text-align: right;">'+(serveExamine.fmMoney(n.cash))+'</td><td style="text-align: right;">'+(serveExamine.fmMoney(n.officialCard))+'</td><td style="text-align: right;">'+(serveExamine.fmMoney(n.transfer))+'</td><td><a class="yt-link to-data">详情</a></td><td>'+(n.isContract==1?'有':'无')+'</td><td style="text-align:right;">'+($yt_baseElement.fmMoney(n.paidAmount))+'</td><td>'+(n.remarks||'')+'</td></tr>';total+= +n.amount;serveExamine.parActual+= +n.replaceAmount});$('table.payee-personal .payee-personal-total').before(html).find('.payee-personal-money').text($yt_baseElement.fmMoney(total))}else{$('table.payee-personal').hide();$(".personal-div").hide()}},showGatheringOtherList:function(list){var html='';var total=0;if(list.gatheringOtherList!=0){var goDel='';$.each(list.gatheringOtherList,function(i,n){goDel='';if(n.reverseTheWayName=='借款单冲销'){goDel='to-detail'}html+='<tr class="payee-unit-tr"  loanAppNum="'+n.loanAppNum+'" reverseLoanAmount="'+n.reverseLoanAmount+'" loanAppId="'+n.loanAppId+'" theReverseMoney="'+$yt_baseElement.rmoney(n.reverseLoanAmount)+'" actualMoney="'+$yt_baseElement.rmoney(n.actualCollectionAmount)+'"><td class="oth" pid="'+n.otherId+'">'+n.otherName+'</td><td style="text-align: right;" class="unitTotal">'+($yt_baseElement.fmMoney(n.amount))+'</td><td value="1">'+(n.isContract==1?'有':'无')+'</td><td style="text-align:right;">'+($yt_baseElement.fmMoney(n.paidAmount))+'</td><td>'+(n.remarks||'')+'</td></tr>';total+= +n.amount;serveExamine.otherActual+= +n.actualCollectionAmount});$('table.payee-other .payee-other-total').before(html).find('.payee-other-total-money').text($yt_baseElement.fmMoney(total))}else{$('table.payee-other').hide();$(".other-div").hide()}},showBillingVoucherList:function(list){var totalText='';var detailText='';var html='';$.each(function(i,n){if(n.toLoanType=='DEBIT_ENTRY'){totalText=n.amount}else{detailText=n.amount}html+='<tr pid="'+n.billingVoucherId+'" class="" loanCode="'+n.toLoanType+'" loanType="'+n.toLoanTypeName+'" abstract="'+n.abstracts+'" totalSubject="'+n.ledger+'" detailSubject="'+n.detailed+'" tallyMoney="'+n.amount+'"><td>'+n.abstracts+'</td><td>'+n.ledger+'</td><td>'+n.detailed+'</td><td>'+totalText+'</td><td>'+detailText+'</td></tr>'});$('.tally-list').append(html)},getDictInfoByTypeCode:function(){$.ajax({type:"post",url:"basicconfig/dictInfo/getDictInfoByTypeCode",async:true,data:{dictTypeCode:'TO_LOAN_TYPE'},success:function(data){var list=data.data||[];var optone='<option value="">请选择</option>';$.each(list,function(i,n){optone+='<option value="'+n.value+'">'+n.disvalue+'</option>'});$('#loanType').html(optone).niceSelect();}})},resetNum:function(obj){var trs=obj.find('tbody tr');$.each(trs,function(i,n){$(n).find('.num').text(i+1)})},submitReimAppInfo:function(subData,thisBtn,flowEnd){$.ajax({type:"post",url:"sz/expenditureApp/submitWorkFlow",async:true,data:subData,success:function(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/expensesReim/module/approval/expenApplApprList.html'}});}thisBtn.attr('disabled',false).removeClass('btn-disabled')}})},getTotleMoney:function(){var tds=$('#paymentList tbody .money');var total=0;$.each(tds,function(i,n){total+= +$(n).attr('money')});var fmTotal=$yt_baseElement.fmMoney(total||'0');$('#paymentList tbody .total-money').text(fmTotal);$('#applyTotalMoney').text(fmTotal).attr('num',total);$('#amountTotalMoney').text(fmTotal).attr('num',total);$('#TotalMoneyUpper').text(arabiaToChinese(fmTotal+''));var writeOffAmount= +($('#writeOffAmount').attr('num'));var num=total-writeOffAmount;if(num>=0){$('#replaceMoney').text($yt_baseElement.fmMoney(num))}else{$('#balanceMoney').text($yt_baseElement.fmMoney(num))}},getSaveData:function(){var me=this;var d=me.saveData;costData={};costData=d.costData;payReceivablesData={};payReceivablesData=d.payReceivablesData;d.costData=typeof(costData)=='string'?costData:JSON.stringify(costData);d.payReceivablesData=typeof(payReceivablesData)=='string'?payReceivablesData:JSON.stringify(payReceivablesData);d.appId=d.expenditureAppId;d.parameters='{totalAmount:'+$('#totalAmount').attr('num')+'}';d.dealingWithPeople=$('#approve-users option:selected').val();d.opintion=$('#opintion').val();d.processInstanceId=d.processInstanceId;d.nextCode=$('#operate-flow option:selected').val();d.appType='EXPENDITURE_APP';d.payDetailList=me.getPayDetailList();return d},getPayDetailList:function(){var list=[];$('.pay-detail-tabel .pay-row').each(function(i,n){n=$(n);list.push({receivablesId:n.attr('pkId'),receivablesType:n.attr('ctype'),writeOffAmount:serveExamine.rmoney(n.find('.write').text()),cash:serveExamine.rmoney(n.find('.cash').val()),officialCard:serveExamine.rmoney(n.find('.offica').val()),transfer:serveExamine.rmoney(n.find('.trans').val()),paymentDate:n.find('.pay-date').val(),writeOffAmount:n.attr('reverseloanamount'),paymentAmount:serveExamine.rmoney(n.find('.row-total').text()),})});return JSON.stringify(list)},getFileList:function(){var str='';var list=$('#attIdStr .li-div');$.each(list,function(i,n){str+=$(n).attr('fid')+(i<list.length?',':'')});return str},showBusinessFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.dottom-div,.approve-div').show();$('.grod-div').show();$('.index-main-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/hospitalitySpendingDetail.html');$("#doAdvanceBox").hide()},showGeneralFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.dottom-div,.approve-div').show();$('.grod-div').show();$('.index-main-div').show();$(".rece-msg").hide();$("#doAdvanceBox").hide();$(".advance-file-div").hide();$("#advanceApplication").hide();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetailApproval.html')},showTravelFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.dottom-div,.approve-div').show();$('.grod-div').show();$('.index-main-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/travelSpendingDetails.html')},showTrainFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.dottom-div,.approve-div').show();$('.grod-div').show();$('.index-main-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/busiTripApply/trainApproval.html');$("#doAdvanceBox").show()},showMettingFun:function(){$('.qtip-text-div').hide();$('.mod-div').hide();$('.dottom-div,.approve-div').show();$('.grod-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/beforehand/meetingCostApplyDetails.html');$("#doAdvanceBox").hide()},showSheBaoFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("SBJF_APP_FLOW");sysCommon.getApproveFlowData("SZ_SBJF_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},showYingJiaoFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("YJSF_APP_FLOW");sysCommon.getApproveFlowData("SZ_YJSF_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},showYiLiaoFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("YYF_APP_FLOW");sysCommon.getApproveFlowData("SZ_YYF_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},showGongHuiFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("GHJF_APP_FLOW");sysCommon.getApproveFlowData("SZ_GHJF_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},showDangJianFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("DJJF_APP_FLOW");sysCommon.getApproveFlowData("SZ_DJJF_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},showWithMoneyFun:function(){$('.index-main-div').html('');$('.qtip-text-div').hide();$('.mod-div').hide();$('.approve-div,.else-div').show();sysCommon.loadingWord('view/system-sasac/expensesReim/module/reimApply/costDetail.html');$(".rece-msg").hide();$("#doAdvanceBox").hide();$("#deductBudgetDiv").show();$(".advance-file-div").hide();$("#advanceApplication").hide();$("#costSpending").hide();$("#payeeInformation").hide();$("#socialSecurity").show();$(".special-btn").hide();$("table .operation").hide();$("#workflowCode").val("WLKX_APP_FLOW");sysCommon.getApproveFlowData("SZ_WLKX_APP",serveExamine.processInstanceId,'{posCode:"'+serveExamine.parCode+'"}')},clearexamine:function(){$("#clearBtn").off().on("click",function(){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:'view/system-sasac/expensesReim/module/approval/expenApplApprList.html'}})})},financialPayment:function(){var me=this;$('#payAddBtn').click(function(){var notMoney=$yt_baseElement.rmoney($('#notMoney').text());if(notMoney>0){me.showCrateDetaliAlert();$('#lpaymentAddBtn').off().on('click',function(){var notMoney=$yt_baseElement.rmoney($('#notMoney').text());var money=$yt_baseElement.rmoney($('#createDetaTotalMoney').text());var isNull=$yt_valid.validForm($("#addObjInfo"));if(money>notMoney){$yt_alert_Model.prompt('金额不能大于未付款金额')}else if(isNull){$yt_alert_Model.alertOne({alertMsg:"确定已支付后不可修改，确定所填写的支付明细并提交吗？",confirmFunction:function(){me.appendDetaliList();me.hideCrateDetaliAlert()}})}}).text('确定已支付')}else{$yt_alert_Model.prompt('已支付所有应付款金额')}});$('#paymentCanelBtn').on('click',function(){$yt_baseElement.hideMongoliaLayer();$('#createDetali').hide();$('#pop-modle-alert').hide();serveExamine.clearAlert($('.create-detali'))})},showCrateDetaliAlert:function(){$yt_baseElement.showMongoliaLayer();$yt_alert_Model.getDivPosition($('#createDetali'));$('#pop-modle-alert').show();$('#createDetali').show()},hideCrateDetaliAlert:function(){$yt_baseElement.hideMongoliaLayer();$('#createDetali').hide();$('#pop-modle-alert').hide();serveExamine.clearAlert($('.create-detali'));$('#createDetaTotalMoney').text('0.00')},appendDetaliList:function(tr){var me=this;var type=$('#firstSelect option:selected').text();var typeVal=$('#firstSelect option:selected').val();var budgetProject=$('#budgetProject option:selected').text();var budgetProjectCode=$('#budgetProject option:selected').val();var payDate=$('#payDate').val();var cash=$('#cash').val();var officialCard=$('#officialCard').val();var transfer=$('#transfer').val();var createDetaTotalMoney=$('#createDetaTotalMoney').text();$.ajax({type:"post",url:"sz/payDetailBillingVoucher/savePaymentDetailInfo",async:true,data:{appId:serveExamine.saveData.expenditureAppId,appType:'EXPENDITURE_APP',receivablesId:budgetProjectCode,receivablesType:typeVal,paymentDate:payDate,cash:cash,officialCard:officialCard,transfer:transfer,paymentAmount:serveExamine.rmoney(createDetaTotalMoney),},success:function(data){if(data.flag==0){var d=data.data;var html='<tr pid="" type="'+typeVal+'" payee="'+budgetProjectCode+'" payment="'+payDate+'" paymentmoney="'+createDetaTotalMoney+'"> <td class="payee" style="width: 100px;">'+budgetProject+'</td> <td class="payment" style="width: 100px;">'+payDate+'</td> <td class="cash" >'+cash+'</td> <td class="card" >'+officialCard+'</td> <td class="trans" >'+transfer+'</td> <td class="paymentmoney" style="text-align: right;">'+createDetaTotalMoney+'</td></tr>';me.hideMsgAlert();me.clearAlert($('#createDetali'));me.getPaymentAmountInfoList(serveExamine.saveData.expenditureAppId)}$yt_alert_Model.prompt(data.message)}})},getPaymentAmountInfoList:function(appId){$.ajax({type:"post",url:"sz/payDetailBillingVoucher/getPaymentAmountInfoList",async:true,data:{appId:appId},success:function(data){if(data.flag==0){var d=data.data;$('#mustMoney').text(serveExamine.fmMoney(d.totalAmount));var paymentAmount=d.paymentAmount;$('#alreadyMoney').text(serveExamine.fmMoney(paymentAmount));var paymentBalanceAmount=d.paymentBalanceAmount;$('#notMoney').text(serveExamine.fmMoney(paymentBalanceAmount));var payDetailList=d.payDetailList||[];serveExamine.setPayDetailList(payDetailList)}}})},setPayDetailList:function(list){var html='';var total=0;$('.pay-detail-tabel tbody tr:not(.pay-detail-tabel-total)').remove();if(list&&list.length>0){$.each(list,function(i,n){html+='<tr pid="'+n.receivablesId+'" type="'+n.receivablesType+'" payee="'+n.receivablesId+'" payment="'+n.paymentDate+'" paymentmoney="'+n.paymentAmount+'"> <td class="payee" style="width: 100px;">'+n.receivablesName+'</td> <td class="payment" style="width: 100px;">'+n.paymentDate+'</td> <td class="">'+serveExamine.fmMoney(n.cash)+'</td> <td class="">'+serveExamine.fmMoney(n.officialCard)+'</td> <td class="">'+serveExamine.fmMoney(n.transfer)+'</td> <td class="paymentmoney" style="text-align: right;">'+serveExamine.fmMoney(n.paymentAmount)+'</td></tr>';total+= +n.paymentAmount})}$('.pay-detail-tabel .pay-detail-tabel-total').before(html);$('.pay-detail-tabel .payee-other-total-money').text(serveExamine.fmMoney(total))},selectCheck:function(){$("#firstSelect").change(function(){var selvalue=$(this).val();if(selvalue=='GATHERING_UNIT'){var comcod='<option value="">请选择</option>';$(".payee-unit tbody tr:not(.payee-unit-total)").each(function(x,n){var comtext=$(this).find(".com").text();var id=$(this).find(".com").attr('pid');comcod+="<option value='"+id+"'>"+comtext+"</option>"});$("#budgetProject").html(comcod).niceSelect()}else if(selvalue=='GATHERING_PERSON'){var percod='<option value="">请选择</option>';$(".payee-personal tbody tr:not(.payee-personal-total)").each(function(x,n){var pertext='';var id=$(this).find(".per").attr('pid');pertext=$(this).find(".per").text();percod+="<option value='"+id+"'>"+pertext+"</option>"});$("#budgetProject").html(percod).niceSelect()}else if(selvalue=='GATHERING_OTHER'){var othcod='<option value="">请选择</option>';$(".payee-other tbody tr:not(.payee-other-total)").each(function(x,n){var othtext=$(this).find(".oth").text();var id=$(this).find(".oth").attr('pid');othcod+="<option value='"+id+"'>"+othtext+"</option>"});$("#budgetProject").html(othcod).niceSelect()}})},saveLotPayDetailInfo:function(subData,thisBtn){$.ajax({type:"post",url:"sz/payDetailBillingVoucher/saveLotPayDetailInfo",async:true,data:subData,success:function(data){if(data.flag==0){serveExamine.submitReimAppInfo(subData,thisBtn)}else{thisBtn.attr('disabled',false).removeClass('btn-disabled')}}})},setTeacherClassExpenseDetails:function(list){var tBody=$('#expenseDetails tbody');tBody.find('tr:not(.end-tr)').remove();var tr='';$.each(list,function(i,n){var rowspan=n.courseDateJson.length;tr='<tr teacherId="'+n.teacherId+'" class="expenseTr"><td rowspan="'+rowspan+'"><a class="teacherName">'+n.teacherName+'</a></td><td>'+(n.courseDateJson.length>0?n.courseDateJson[0].courseDate:"")+'</td><td>'+(n.courseDateJson[0].courseName?n.courseDateJson[0].courseName:"")+'</td><td rowspan="'+rowspan+'" class="expenseMoney moneyText">'+$yt_baseElement.fmMoney(n.expenseMoney)+'</td><td rowspan="'+rowspan+'" class="surrenderPersonal moneyText">'+$yt_baseElement.fmMoney(n.surrenderPersonal)+'</td><td rowspan="'+rowspan+'" class="moneyText" style="height:28px"><span class="afterTax desc-text">'+$yt_baseElement.fmMoney(n.afterTax)+'</span></td></tr>';tr=$(tr).data('data',n);tBody.find('.end-tr').before(tr);$.each(n.courseDateJson,function(x,y){if(x!=0){tr='<tr teacherId="'+n.teacherId+'"><td>'+y.courseDate+'</td><td>'+(y.courseName?y.courseName:"")+'</td></tr>';tBody.find('.end-tr').before(tr)}})});serveExamine.sumExpenseDetails()},sumExpenseDetails:function(){var expenseMoney=0;var surrenderPersonal=0;var afterTax=0;$.each($('#expenseDetails tbody .expenseMoney:visible'),function(i,n){expenseMoney+=$yt_baseElement.rmoney($(n).text())});$.each($('#expenseDetails tbody .surrenderPersonal:visible'),function(i,n){surrenderPersonal+=$yt_baseElement.rmoney($(n).text())});$.each($('#expenseDetails tbody .afterTax:visible'),function(i,n){afterTax+=$yt_baseElement.rmoney($(n).text())});$('#payTeacherAll').text($yt_baseElement.fmMoney(surrenderPersonal));$('#expenseDetails tbody .costTotal-before').text($yt_baseElement.fmMoney(expenseMoney));$('#expenseDetails tbody .costTotal').text($yt_baseElement.fmMoney(surrenderPersonal));$('#expenseDetails tbody .costTotal-after').text($yt_baseElement.fmMoney(afterTax))},setTeacherTrainDetails:function(list){var tBody=$('#carFeeTable tbody');tBody.find('tr:not(.end-tr)').remove();var tr='';$.each(list,function(i,n){n.costSum=Number(n.salesPrice)+Number(n.insurance)+Number(n.refundSigningFee);if(!n.bookingRecord){n.bookingRecord=[]}tr='<tr teacherId="'+n.teacherId+'" class="teachertravelTr"><td>'+n.teacherName+'</td><td>'+n.startEndTime.split('至')[0]+'</td><td>'+(n.startEndTime.split('至')[1]?n.startEndTime.split('至')[1]:"")+'</td><td>'+n.placeDeparture+'</td><td>'+n.bourn+'</td><td>'+n.flighttrainNumber+'</td><td class="moneyText" style="height:28px"><span class="salesPrice desc-text">'+$yt_baseElement.fmMoney(n.salesPrice)+'</span></td><td class="moneyText" style="height:28px"><span class="insurance desc-text">'+$yt_baseElement.fmMoney(n.insurance)+'</span></td><td class="moneyText" style="height:28px"><span class="refundSigningFee desc-text">'+$yt_baseElement.fmMoney(n.refundSigningFee)+'</span></td><td class="costSum moneyText">'+$yt_baseElement.fmMoney(n.costSum)+'</td><td class="teacherStatementDetailsId" teacherStatementDetailsId="'+n.bookingRecord.map(function(x){return x.teacherStatementDetailsId}).join(",")+'">'+n.bookingRecord.map(function(x){return x.teacherStatementDetails}).join("</br>")+'</td><td>'+(n.warehousePositionDetails?n.warehousePositionDetails:"")+'</td></tr>';tr=$(tr).data('data',n);tBody.find('.end-tr').before(tr)});serveExamine.sumTeacherTrainDetails()},sumTeacherTrainDetails:function(){var salesPrice=0;var insurance=0;var refundSigningFee=0;var costSum=0;$.each($('#carFeeTable tbody .salesPrice'),function(i,n){salesPrice+=$yt_baseElement.rmoney($(n).text())});$.each($('#carFeeTable tbody .insurance'),function(i,n){insurance+=$yt_baseElement.rmoney($(n).text())});$.each($('#carFeeTable tbody .refundSigningFee'),function(i,n){refundSigningFee+=$yt_baseElement.rmoney($(n).text())});$.each($('#carFeeTable tbody .costSum'),function(i,n){costSum+=$yt_baseElement.rmoney($(n).text())});$('#carFeeTable tbody .sumSalesPrice').text($yt_baseElement.fmMoney(salesPrice));$('#carFeeTable tbody .sumInsurance').text($yt_baseElement.fmMoney(insurance));$('#carFeeTable tbody .sumRefundSigningFee').text($yt_baseElement.fmMoney(refundSigningFee));$('#carFeeTable tbody .costTotal').text($yt_baseElement.fmMoney(costSum))},initProjectSelect:function(projectCode,projectId){if(projectCode){$.ajax({type:"post",url:"finance/budget/lookForProjectListBudget",async:false,data:{projectCode:projectCode,projectId:projectId},beforeSend:function(){},success:function(data){if(data.flag==0){var datas=data.data[0];datas.projectTypeName=$yt_baseElement.setProjectTypeName(datas.projectType);$('.from-table-detail').setDatas(datas)}},error:function(){$yt_alert_Model.prompt('网络异常')}})}}};$(function(){serveExamine.init();serveExamine.clearexamine()})})(jQuery,window);
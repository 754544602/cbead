var busiTripApply={trObject:"",selUsersName:"",selUsersCode:"",usersInfoList:"",usersInfoJson:"",riskExcMark:"../../../../../resources-sasac/images/common/war-red.png",riskWarImg:"../../../../../resources-sasac/images/common/risk-war.png",riskViaImg:"../../../../../resources-sasac/images/common/risk-via.png",init:function(){sysCommon.getLoginUserInfo();$("#busiTripApply select").niceSelect();busiTripApply.getFunDatas();busiTripApply.bodyDateInit();$yt_baseElement.numberInput($(".yt-numberInput-box"));busiTripApply.funBtnOperateEvent();busiTripApply.getFileUploadName($("#trip-file"),$(".travel-plan-form-model .file-div .file-msg"));busiTripApply.showFormListModelEvent();sysCommon.getRiskData("busiTripApply")},getFunDatas:function(){$.ajax({type:"post",url:"basicconfig/dictInfo/getDictInfoByTypeCode",async:false,data:{dictTypeCode:"TRAVEL_TYPE,VEHICIE_CODE,HOTEL_ADDRESS,COST_TYPE,AMOUNT_NATURE"},success:function(data){if(data.flag==0){var optionText='<option value="">请选择</option>';if(data.data.length>0){$.each(data.data,function(i,n){if(n.dictTypeCode=="TRAVEL_TYPE"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$("#busi-trip-type").append(optionText);$("#modelBusiType").append(optionText);$("#busi-trip-type,#modelBusiType").niceSelect();$("#busi-trip-type").on("change",function(){if($(this).find("option:selected").text()=="培训"){$(".file-btn-div .risk-model").show()}else{if($(".file-msg").text()!=""){$(".file-btn-div .risk-model .risk-img").attr("src",busiTripApply.riskViaImg)}else{$(".file-btn-div .risk-model .risk-img").attr("src",busiTripApply.riskExcMark)}$(".file-btn-div .risk-model").hide()}})}if(n.dictTypeCode=="VEHICIE_CODE"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$(".vehicle-sel").append(optionText);$(".vehicle-sel").niceSelect();$(".vehicle-sel").on("change",function(){var selVal=$(this).val();sysCommon.vechicleChildData(selVal)})}if(n.dictTypeCode=="HOTEL_ADDRESS"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$("#hotel-address").append(optionText);$("#hotel-address").niceSelect()}if(n.dictTypeCode=="COST_TYPE"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$("#cost-type").append(optionText);$("#cost-type").niceSelect();$("#cost-type").on("change",function(){if($(this).val()!=""){$(this).parent().find(".risk-img").attr("src",busiTripApply.riskViaImg)}else{$(this).parent().find(".risk-img").attr("src",busiTripApply.riskWarImg)}})}if(n.dictTypeCode=="AMOUNT_NATURE"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$("#moneyQuality").append(optionText);$("#moneyQuality").niceSelect();$("#moneyQuality").on("change",function(){busiTripApply.getProjectList($("#keywordInpu").val(),$(this).val())})}})}}}});sysCommon.getApproveFlowData("SZ_TRAVEL_APP")},getProjectList:function(keyword,moneyQuality){var fromPrjTbody=$("#fromPrjModel .appro-list-model tbody");$('.prj-page').pageInfo({pageIndex:1,pageNum:10,pageSize:2,url:$yt_option.websit_path+"resources-sasac/js/testJsonData/projectData.json",type:"get",async:false,data:{keyword:keyword,moneyQuality:moneyQuality},objName:'data',success:function(data){fromPrjTbody.empty();if(data.flag==0){var prjStr="";if(data.data.rows.length>0){$('.prj-page').show();$.each(data.data.rows,function(i,n){prjStr='<tr><td>'+n.prjNum+'<input type="hidden" class="hid-prj-id" value="'+n.prjId+'"/><input type="hidden" class="hid-dept" value="'+n.deptSource+'"/></td><td>'+n.prjName+'</td><td style="text-align: right;">'+(n.budgetPrice==""?"--":$yt_baseElement.fmMoney(n.budgetPrice))+'</td><td style="text-align: right;">'+(n.availablePrice==""?"--":$yt_baseElement.fmMoney(n.availablePrice))+'</td></tr>';fromPrjTbody.append(prjStr)})}else{$('.prj-page').hide();var noTr='<tr class="model-no-data-tr"><td colspan="4"><div class="no-data"><img src="../../../../../resources-sasac/images/common/no-data.png" alt=""></div></td></tr>';fromPrjTbody.append(noTr)}}}})},getBusiTripUsersList:function(keyword){var userTbody=$("#busiTripUserModel .user-list table tbody");$('.user-list-page').pageInfo({pageIndex:1,pageNum:5,pageSize:2,url:'user/userInfo/getAllUserInfoToPage',type:"post",async:false,data:{params:keyword},objName:'data',success:function(data){userTbody.empty();if(data.flag==0){var usersStr="";if(data.data.rows.length>0){$('.user-list-page').show();$.each(data.data.rows,function(i,n){usersStr='<tr><td>'+n.userName+'<input type="hidden" class="hid-user-code" value="'+n.userItcode+'"/></td><td>'+(n.deptName==""?"--":n.deptName)+'</td><td>'+(n.jobName==""?"--":n.jobName)+'</td><td>'+(n.jobLevelName==""?"--":n.jobLevelName)+'</td></tr>';userTbody.append(usersStr)})}else{$('.user-list-page').hide();var noTr='<tr class="model-no-data-tr"><td colspan="4"><div class="no-data"><img src="../../../../../resources-sasac/images/common/no-data.png" alt=""></div></td></tr>';userTbody.append(noTr)}}}})},funBtnOperateEvent:function(){$("#add-list-btn").off().on("click",function(){var validFlag=$yt_valid.validForm($(".travel-plan-form-model"));if(validFlag){busiTripApply.doAddBusiInfo()}else{sysCommon.pageToScroll($(".travel-plan-form-model .valid-font"))}});$("#add-cost-apply-btn").off().on("click",function(){busiTripApply.showCostDetailModel()});$("#approve-submit-btn,#apply-save-btn").off().on("click",function(){var thisBtnObj=$(this);var btnFlag;var ajaxUrl="";if($(this).hasClass("busi-sub-btn")){btnFlag=0;ajaxUrl="sz/travelApp/submitTravelAppInfo"}if($(this).hasClass("busi-save-btn")){btnFlag=1;ajaxUrl="sz/travelApp/saveTraveAppInfoToDrafts"}var validFlag=$yt_valid.validForm($(".base-info-form-modle"));var validFlowFlag=$yt_valid.validForm($(".flow-approve-model"));if(validFlag&&validFlowFlag){var busiTripDatas=busiTripApply.getSubmitSaveDatas();$.ajax({type:"post",url:ajaxUrl,async:false,data:busiTripDatas,success:function(data){if(data.flag==0){busiTripApply.clearPageData()}else{}$yt_alert_Model.prompt(data.message,2000)}})}else{sysCommon.pageToScroll($(".base-info-form-modle .valid-font"))}})},getSubmitSaveDatas:function(){var busiTripPlanList=[];var travelAppTripPlanJson="";if($(".travel-list-tab-model table tbody tr:not(.not-date-tr)").length>0){$(".travel-list-tab-model table tbody tr").each(function(i,n){busiTripPlanList.push($(this).getDatas())});if(busiTripPlanList.length>0){travelAppTripPlanJson=JSON.stringify(busiTripPlanList)}}var costCarfareList=[];var costCarfareJson="";var cityDatas;if($("#traffic-list-info tbody tr:not(.total-last-tr)").length>0){$("#traffic-list-info tbody tr:not(.total-last-tr)").each(function(i,n){cityDatas=$(this).getDatas();cityDatas.crafare=$yt_baseElement.rmoney(cityDatas.crafare);if($(this).find(".hid-child-code").val()=="null"||$(this).find(".hid-child-code").val()==""){cityDatas.vehicle="."+$(this).find(".hid-vehicle").val()+"."}else{cityDatas.vehicle="."+$(this).find(".hid-vehicle").val()+"."+$(this).find(".hid-child-code").val()+"."}costCarfareList.push(cityDatas)});if(costCarfareList.length>0){costCarfareJson=JSON.stringify(costCarfareList)}}var costHotelList=[];var costHotelJson="";var hotelDatas;if($("#hotel-list-info tbody tr:not(.total-last-tr)").length>0){$("#hotel-list-info tbody tr:not(.total-last-tr)").each(function(i,n){hotelDatas=$(this).getDatas();hotelDatas.hotelExpense=$yt_baseElement.rmoney(hotelDatas.hotelExpense);costHotelList.push(hotelDatas)});if(costHotelList.length>0){costHotelJson=JSON.stringify(costHotelList)}}var costOtherList=[];var costOtherJson="";var otherDatas;if($("#other-list-info tbody tr:not(.total-last-tr)").length>0){$("#other-list-info tbody tr:not(.total-last-tr)").each(function(i,n){otherDatas=$(this).getDatas();otherDatas.reimAmount=$yt_baseElement.rmoney(otherDatas.reimAmount);costOtherList.push(otherDatas)});if(costOtherList.length>0){costOtherJson=JSON.stringify(costOtherList)}}var costSubsidyList=[];var costSubsidyJson="";if($("#subsidy-list-info tbody tr:not(.total-last-tr)").length>0){$("#subsidy-list-info tbody tr:not(.total-last-tr)").each(function(i,n){costSubsidyList.push($(this).getDatas())});if(costSubsidyList.length>0){costSubsidyJson=JSON.stringify(costSubsidyList)}}return{travelAppId:'',travelAppNum:'',travelAppName:$("#out-reason").val(),planGoTime:$("#start-time").val(),planReturnTime:$("#end-time").val(),busiTripDays:$("#out-day-num").text(),prjId:$("#prjId").val(),applicantUser:$yt_common.user_info.userName,parameters:"",dealingWithPeople:$("#approve-users").val(),opintion:$("#operate-msg").val(),processInstanceId:"",nextCode:$("#operate-flow").val(),totalAmount:($("#applySumMoney").text()=="0.00"?"":$yt_baseElement.rmoney($("#applySumMoney").text())),travelAppTripPlanJson:travelAppTripPlanJson,costCarfareJson:costCarfareJson,costHotelJson:costHotelJson,costOtherJson:costOtherJson,costSubsidyJson:costSubsidyJson }},clearPageData:function(){$("#busiTripFormModel input:not(.checkbox-inpu,.hid-risk-code)").val('');$(".auto-font").show();$(".auto-font").next().hide();$("#out-day-num,.users-num").text("0");$("#busiTripFormModel select option:eq(0)").attr("selected","selected");$("#busiTripFormModel select").niceSelect();$(".file-msg").text("");$("#dept-pps-from").text("--");$("#busiTripFormModel label.check-label").removeClass("check");$("#busiTripFormModel .risk-img").attr("src",busiTripApply.riskExcMark);$("#fileId").next(".risk-model").hide();$(".travel-list-tab-model table tbody").empty();var noDataTr='<tr class="not-date-tr"><td colspan="9"><div class="no-data"><img src="../../../../../resources-sasac/images/common/no-data.png" alt=""></div></td></tr>';$(".travel-list-tab-model table tbody").append(noDataTr);$(".cost-apply-model,.flow-approve-model").hide();$(".traffic-cost-model table tbody,.hotel-list-model table tbody,.other-cost-model table tbody,.subsidy-model table tbody").empty();$(".cost-apply-model .risk-img").attr("src",busiTripApply.riskExcMark);sysCommon.updateApplyMeonySum();$("#applyMoneyLower").text("--");$(".flow-approve-model input,.flow-approve-model textarea").val('');$(".flow-approve-model select").each(function(i,n){$(n).find("option:eq(0)").attr("selected","selected")});$(".flow-approve-model select").niceSelect()},showFormListModelEvent:function(){$("#fromPrjInpu").off().on("click",function(){var fromPrjModel=$("#fromPrjModel");busiTripApply.getProjectList($("#keywordInpu").val(),$("#moneyQuality").val());sysCommon.showModel(fromPrjModel);busiTripApply.projectListModelEvent()});$(".busi-trip-user").off().on("click",function(){var busiTripUserModel=$("#busiTripUserModel");busiTripApply.getBusiTripUsersList($("#busiUserKeyWord").val());sysCommon.showModel(busiTripUserModel);busiTripApply.busiTripUserModelEvent($(".busi-trip-user"),$(".user-td .auto-font"),$(".users-num-show"))})},projectListModelEvent:function(){var fromPrjModel=$("#fromPrjModel");$("#aproSearchBtn").off().on("click",function(){busiTripApply.getProjectList($("#keywordInpu").val(),$("#moneyQuality").val())});$("#aproRestBtn").off().on("click",function(){busiTripApply.closeProjectModel();busiTripApply.getProjectList($("#keywordInpu").val(),$("#moneyQuality").val())});$("#fromPrjModel tbody").on('click','tr',function(){$('#busiTripTab tbody tr').removeClass("yt-table-active");$(this).addClass("yt-table-active")});$("#fromPrjModel tbody:not(.page-info table tbody)").on('dblclick','tr',function(){$("#fromPrjInpu").val($(this).find("td:eq(1)").text());$("#prjId").val($(this).find(".hid-prj-id").val());$("#dept-pps-from").text($(this).find(".hid-dept").val()==""?"--":$(this).find(".hid-dept").val());$("#fromPrjInpu").parent().find(".risk-img").attr("src",busiTripApply.riskViaImg);busiTripApply.closeProjectModel();sysCommon.clearValidInfo($("#fromPrjInpu"))});$("#aproSureBtn").off().on("click",function(){var selTr=$("#fromPrjModel tbody tr.yt-table-active");if(selTr!=""&&selTr.length>0){$("#fromPrjInpu").val(selTr.find("td:eq(1)").text());$("#prjId").val(selTr.find(".hid-prj-id").val());$("#dept-pps-from").text(selTr.find(".hid-dept").val()==""?"--":selTr.find(".hid-dept").val());$("#fromPrjInpu").parent().find(".risk-img").attr("src",busiTripApply.riskViaImg);sysCommon.clearValidInfo($("#fromPrjInpu"))}else{$("#fromPrjInpu").val('');$("#prjId").val('');$("#dept-pps-from").text('--');$("#fromPrjInpu").parent().find(".risk-img").attr("src",busiTripApply.riskWarImg);$("#fromPrjInpu").next(".valid-font").text("请选择所属预算项目");$("#fromPrjInpu").addClass("valid-hint")}busiTripApply.closeProjectModel()});$("#aproCanelBtn").off().on("click",function(){busiTripApply.closeProjectModel()})},closeProjectModel:function(){var fromPrjModel=$("#fromPrjModel");var fromPrjModel=$("#fromPrjModel");$("#keywordInpu").val('');$("#moneyQuality option:eq(0)").attr("selected","selected");$("#moneyQuality").niceSelect();sysCommon.closeModel(fromPrjModel)},busiTripUserModelEvent:function(busiInputObj,autoFontObj,userNumObj,clickFlag){var busiTripUserModel=$("#busiTripUserModel");$("#busiSearchBtn").off().on("click",function(){busiTripApply.getBusiTripUsersList($("#busiUserKeyWord").val())});$("#busiResetBtn").off().on("click",function(){$("#busiUserKeyWord").val('');busiTripApply.getBusiTripUsersList($("#busiUserKeyWord").val())});$("#busiTripUserModel .users-table tbody").off("click").on('click','tr',function(){if($(this).hasClass("tr-check")&&$(this).hasClass("yt-table-active")){$(this).removeClass("tr-check");$(this).removeClass("yt-table-active");busiTripApply.selUsersName="";busiTripApply.selUsersCode="";busiTripApply.usersInfoList="";busiTripApply.usersInfoJson="";$("#busiTripUserModel .users-table tbody tr.tr-check").each(function(i,n){busiTripApply.selUsersName+=$(this).find("td:eq(0)").text()+"、";busiTripApply.selUsersCode+=$(this).find(".hid-user-code").val()+",";var userLevel=$(this).find("td:eq(4)").text()=="--"?"":$(this).find("td:eq(4)").text();busiTripApply.usersInfoList=busiTripApply.usersInfoList+'{"userItcode":"'+$(this).find(".hid-user-code").val()+'","jobLevelName":"'+userLevel+'","userName":"'+$(this).find("td:eq(0)").text()+'"},'})}else{$(this).addClass("tr-check");busiTripApply.selUsersName+=$(this).find("td:eq(0)").text()+"、";busiTripApply.selUsersCode+=$(this).find(".hid-user-code").val()+",";var userLevel=$(this).find("td:eq(4)").text()=="--"?"":$(this).find("td:eq(4)").text();busiTripApply.usersInfoList=busiTripApply.usersInfoList+'{"userItcode":"'+$(this).find(".hid-user-code").val()+'","jobLevelName":"'+userLevel+'","userName":"'+$(this).find("td:eq(0)").text()+'"},'}});$("#busiTripUserModel .users-table tbody:not(.page-info table tbody)").off("dblclick").on('dblclick','tr',function(){var userLevel=$(this).find("td:eq(4)").text()=="--"?"":$(this).find("td:eq(4)").text();busiTripApply.usersInfoList=busiTripApply.usersInfoList+'{"userItcode":"'+$(this).find(".hid-user-code").val()+'","jobLevelName":"'+userLevel+'","userName":"'+$(this).find("td:eq(0)").text()+'"},';busiTripApply.getModelUsersInfo();busiTripApply.usersInfoList="";busiTripApply.usersInfoJson="";$(busiInputObj).val($(this).find("td:eq(0)").text());$(busiInputObj).prev("input[type=hidden]").val($(this).find(".hid-user-code").val());$("#busiUserKeyWord").val('');sysCommon.closeModel(busiTripUserModel);$(autoFontObj).hide();$(userNumObj).show();$(userNumObj).find(".users-num").text(1);busiTripUserModel.find("tr").removeClass("tr-check");sysCommon.clearValidInfo($(busiInputObj));if(clickFlag!=undefined){sysCommon.showModel($("#busiPlanEditModel"))}});$("#busiSureBtn").off().on("click",function(){var selTr=$("#busiTripUserModel .users-table tbody tr.tr-check");if(selTr!=""&&selTr.length>0){var selUser="";var userCode="";selUser=busiTripApply.selUsersName.substring(0,busiTripApply.selUsersName.length-1);userCode=busiTripApply.selUsersCode.substring(0,busiTripApply.selUsersCode.length-1);busiTripApply.getModelUsersInfo();$(busiInputObj).val(selUser);$(busiInputObj).prev("input[type=hidden]").val(userCode);$(autoFontObj).hide();$(userNumObj).show();var userNums=selUser.split("、");$(userNumObj).find(".users-num").text(userNums.length);sysCommon.clearValidInfo(busiInputObj)}else{$(busiInputObj).val('');$(busiInputObj).prev("input[type=hidden]").val('');$(autoFontObj).show();$(userNumObj).hide();$(userNumObj).find(".users-num").text(0);$(busiInputObj).next(".valid-font").text("请选择出差人");$(busiInputObj).addClass("valid-hint");busiTripApply.selUsersName="";busiTripApply.selUsersCode="";busiTripApply.usersInfoList="";busiTripApply.usersInfoJson="";var optionText='<option value="">请选择</option>';$("#model-trip-user,#hotel-trip-user").empty().append(optionText);$("#model-trip-user,#hotel-trip-user").niceSelect()}$("#busiUserKeyWord").val('');sysCommon.closeModel(busiTripUserModel);busiTripUserModel.find("tr").removeClass("tr-check");if(clickFlag!=undefined){sysCommon.showModel($("#busiPlanEditModel"))}});$("#busiCanelBtn").off().on("click",function(){$("#busiUserKeyWord").val('');sysCommon.closeModel(busiTripUserModel);busiTripUserModel.find("tr").removeClass("tr-check");if(clickFlag!=undefined){sysCommon.showModel($("#busiPlanEditModel"))}})},getModelUsersInfo:function(){if(busiTripApply.usersInfoList!=""&&busiTripApply.usersInfoList!=null){busiTripApply.usersInfoJson="["+busiTripApply.usersInfoList+"]";busiTripApply.usersInfoJson=busiTripApply.usersInfoJson.substr(0,busiTripApply.usersInfoJson.length-2);busiTripApply.usersInfoJson+="]"}var optionText='<option value="">请选择</option>';$("#model-trip-user,#hotel-trip-user").empty().append(optionText);if(busiTripApply.usersInfoJson!=""&&busiTripApply.usersInfoJson.length>0){busiTripApply.usersInfoJson=eval("("+busiTripApply.usersInfoJson+")");$.each(busiTripApply.usersInfoJson,function(i,n){optionText='<option value="'+n.userItcode+'" data-level="'+n.jobLevelName+'">'+n.userName+'</option>';$("#model-trip-user,#hotel-trip-user").append(optionText)})}$("#model-trip-user,#hotel-trip-user").niceSelect()},doAddBusiInfo:function(){var tarvelBody=$(".travel-list-tab-model table tbody");var busiType=$("#busi-trip-type option:selected").text();var busiTypeCode=$("#busi-trip-type").val();var receptionMoney="";var receptionMoneyCode="";if($(".reception-money .check-label.check").length>0){$(".reception-money .check-label.check").each(function(i,n){receptionMoney+=$(n).find("span").text()+"、";receptionMoneyCode+=$(n).find("input").val()+","});receptionMoney=receptionMoney.substring(0,receptionMoney.length-1);receptionMoneyCode=receptionMoneyCode.substring(0,receptionMoneyCode.length-1)}else{receptionMoney="--"}var tripFile=($(".file-msg").text()==""?"--":$(".file-msg").text());if(tarvelBody.find("tr.not-date-tr")){tarvelBody.find("tr.not-date-tr").remove()}var busiTripStr="";busiTripStr='<tr><td><span>'+(busiType=="请选择"?"--":busiType)+'</span><input type="hidden" data-val="travelType" class="hid-type-code" value="'+busiTypeCode+'"/></td><td data-text="startTime">'+$("#busi-start-date").val()+'</td><td data-text="endTime">'+$("#busi-end-date").val()+'</td><td data-text="travelAddress">'+$(".busi-trip-address").val()+'</td><td><div class="text-overflow-sty" title='+$("input.busi-trip-user").val()+'>'+$("input.busi-trip-user").val()+'</div><input type="hidden" data-val="travelPersonnels" class="hid-user-code" value="'+$("#userCodes").val()+'"/></td><td data-text="busiTripUserNum">'+$(".users-num-show .users-num").text()+'</td><td><div class="text-overflow-sty" title='+tripFile+'>'+tripFile+'<input type="hidden" data-val="attachmentId" class="hid-file-id" value="'+$("#fileId").val()+'"/></div></td><td><div class="text-overflow-sty" title='+receptionMoney+'>'+receptionMoney+'</div><input type="hidden" data-val="receptionCostItem" class="hid-reception-code" value="'+receptionMoneyCode+'"/></td><td><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"/></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"/></span></td></tr>';$(".travel-list-tab-model table tbody").append(busiTripStr);if(tarvelBody.find("tr:not(.not-date-tr)").length>0){$(".cost-apply-model,.flow-approve-model").show()}busiTripApply.tripListOperateEvent()},tripListOperateEvent:function(){$(".travel-list-tab-model table tr td .operate-update").off().on("click",function(){var planModel=$("#busiPlanEditModel");sysCommon.showModel(planModel);busiTripApply.planBusiEditModelEvent(planModel,$(this).parents("tr"));busiTripApply.getBusiPlanInfoData($(this).parents("tr"))});$(".travel-list-tab-model table tr td .operate-del").off().on("click",function(){var thisObj=$(this);$yt_alert_Model.alertOne({alertMsg:"确定要删除此条数据吗?",leftBtnName:"确定",confirmFunction:function(){thisObj.parents("tr").remove();if($(".travel-list-tab-model table tbody tr").length==0){var noDataTr='<tr class="not-date-tr"><td colspan="9"><div class="no-data"><img src="../../../../../resources-sasac/images/common/no-data.png" alt=""></div></td></tr>';$(".travel-list-tab-model table tbody").append(noDataTr);$(".cost-apply-model,.flow-approve-model").hide();}}})})},getBusiPlanInfoData:function(thisTr){var trObj=$(thisTr);$('#modelBusiType option[value="'+trObj.find("td:eq(0) .hid-type-code").val()+'"]').attr("selected","selected");if(trObj.find("td:eq(0) .hid-type-code").val()==3){$("#modelFileBtn").next(".risk-model").show();$("#modelFileBtn").css("float","left");$("#busiPlanEditModel .file-div").css("width","270px")}else{$("#modelFileBtn").next(".risk-model").hide();$("#busiPlanEditModel .file-div").css("width","295px");$("#modelFileBtn").css("float","right")}$("#modelBusiType").niceSelect();$("#tdStartDate").val(trObj.find("td:eq(1)").text());$("#tdEndDate").val(trObj.find("td:eq(2)").text());$("#modelBusiAddres").val(trObj.find("td:eq(3)").text());$("#modelBusiUser").val(trObj.find("td:eq(4) div").text());$("#busiPlanEditModel .auto-font").hide();$(".model-user-num-show").show();$(".model-user-num-show .users-num").text(trObj.find("td:eq(5)").text());$("#busiPlanEditModel .file-msg").text((trObj.find("td:eq(6) div").text()=="--"?"":trObj.find("td:eq(6) div").text()));$("#modelFileId").val(trObj.find(".hid-file-id").val());var receptionCode=trObj.find("td:eq(7) .hid-reception-code").val();if(receptionCode!=""){receptionCode=receptionCode.split(",");$.each(receptionCode,function(i,n){$('#busiPlanEditModel .yt-checkbox input[value="'+n+'"]').parent().addClass("check")})}},planBusiEditModelEvent:function(planModel,trObj){$("#modelBusiType").on("change",function(){if($(this).val()==3){$("#modelFileBtn").next(".risk-model").show();$("#modelFileBtn").css("float","left");$("#busiPlanEditModel .file-div").css("width","270px")}else{$("#modelFileBtn").next(".risk-model").hide();$("#busiPlanEditModel .file-div").css("width","295px");$("#modelFileBtn").css("float","right")}});busiTripApply.getFileUploadName($("#modelFile"),$("#busiPlanEditModel .file-div .file-msg"));$("#modelBusiUser").off().on("click",function(){var busiTripUserModel=$("#busiTripUserModel");sysCommon.showModel(busiTripUserModel);busiTripApply.busiTripUserModelEvent($("#modelBusiUser"),$("#busiPlanEditModel .auto-font"),$(".model-user-num-show"),1);$("#busiPlanEditModel").hide()});$("#planSaveBtn").off().on("click",function(){var validFlag=$yt_valid.validForm($("#busiPlanEditModel"));if(validFlag){busiTripApply.saveUpdatePlanBusiInfo(planModel,trObj);sysCommon.closeModel($("#busiPlanEditModel"))}});$("#planCanelBtn").off().on("click",function(){busiTripApply.clearPlanBusiEditData(planModel)})},saveUpdatePlanBusiInfo:function(planModel,trObj){var thisTr=$(trObj);thisTr.find("td:eq(0) span").text(($("#modelBusiType option:selected").text()=="请选择"?"--":$("#modelBusiType option:selected").text()));thisTr.find("td:eq(0) .hid-type-code").val($("#modelBusiType").val());thisTr.find("td:eq(1)").text($("#tdStartDate").val());thisTr.find("td:eq(2)").text($("#tdEndDate").val());thisTr.find("td:eq(3)").text($("#modelBusiAddres").val());thisTr.find("td:eq(4) div").text($("#modelBusiUser").val());thisTr.find("td:eq(4) .hid-user-code").val($("#modelUserCodes").val());thisTr.find("td:eq(5)").text($(".model-user-num-show .users-num").text());thisTr.find("td:eq(6) div").text(($("#busiPlanEditModel .file-msg").text()==""?"--":$("#busiPlanEditModel .file-msg").text()));thisTr.find(".hid-file-id").val($("#modelFileId"));var receptionMoney="";var receptionMoneyCode="";if(planModel.find(".check-label.check").length>0){planModel.find(".check-label.check").each(function(i,n){receptionMoney+=$(n).find("span").text()+"、";receptionMoneyCode+=$(n).find("input").val()+","});receptionMoney=receptionMoney.substring(0,receptionMoney.length-1);receptionMoneyCode=receptionMoneyCode.substring(0,receptionMoneyCode.length-1)}else{receptionMoney="--"}thisTr.find("td:eq(7) div").text(receptionMoney);thisTr.find("td:eq(7) .hid-reception-code").val(receptionMoneyCode)},clearPlanBusiEditData:function(planModel){$("#busiPlanEditModel input:not(.check-label input,.hid-risk-code)").val("");$("#busiPlanEditModel .yt-checkbox").removeClass("check");$("#busiPlanEditModel select option:eq(0)").attr("selected","selected");$("#busiPlanEditModel select").niceSelect();$(planModel).find(".auto-font").show();$(".model-user-num-show").hide();$(".model-user-num-show .users-num").text('');$("#busiPlanEditModel .file-msg").html('');sysCommon.closeModel(planModel)},getFileUploadName:function(fileBtn,fileTextObj,fileId){$(fileBtn).change("click",function(){if($(fileBtn).val()!=""){var arr=$(fileBtn).val().split('\\');var my=arr[arr.length-1];$(fileTextObj).text(my);$(fileTextObj).css("color","#333333");$(fileBtn).next().val(fileId);$(this).parents("td").find(".risk-img").attr("src",busiTripApply.riskViaImg)}else{$(fileBtn).next().val("");$(this).parents("td").find(".risk-img").attr("src",busiTripApply.riskWarImg)}})},getCostDetailData:function(tabFlag){if(tabFlag==0){busiTripApply.getTrafficCostFormInfo()}if(tabFlag==1){busiTripApply.getHotelFormInfo()}if(tabFlag==2){busiTripApply.getOtherCostFormInfo()}},getTrafficCostFormInfo:function(){var trabfficObj=$(".traffic-form");sysCommon.createSumTr(0);var tripUser=trabfficObj.find("#model-trip-user option:selected").text();var level=trabfficObj.find("#model-trip-user option:selected").attr("data-level");var vehicle="";var vehicleCode="";vehicleCode=trabfficObj.find(".vehicle-sel").val();var vehicleChildCode="";vehicleChildCode=trabfficObj.find(".vehicle-two-sel").val();if($(".vehicle-two-sel").val()!=""&&$(".vehicle-two-sel").val()!=null){vehicle=trabfficObj.find(".vehicle-two-sel option:selected").text()}else{vehicle=trabfficObj.find(".vehicle-sel option:selected").text()}var cityMoney=trabfficObj.find(".city-cost-input").val();var trafficCostStr='<tr><td><span>'+tripUser+'</span><input type="hidden" data-val="travelPersonnel" class="hid-traf-users" value="'+trabfficObj.find("#model-trip-user").val()+'"/></td><td>'+level+'</td><td data-text="goTime">'+$("#traffic-start-time").val()+'</td><td data-text="goAddress">'+$("#fromcity").val()+'</td><td data-text="arrivalTime">'+$("#traffic-end-time").val()+'</td><td data-text="arrivalAddress">'+$("#tocity").val()+'</td><td><span data-text="vehicle">'+vehicle+'</span><input type="hidden" class="hid-vehicle" value="'+vehicleCode+'"/><input type="hidden" class="hid-child-code" value="'+vehicleChildCode+'"/></td><td class="font-right money-td" data-text="crafare">'+(cityMoney==""?"--":cityMoney)+'</td><td class="text-overflow-sty" data-text="remarks" title="'+$("#special-remark").val()+'">'+($("#special-remark").val()==""?"--":$("#special-remark").val())+'</td><td><input type="hidden" class="hid-cost-type" value="0"/><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"/></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"/></span></td></tr>';$("#traffic-list-info tbody .total-last-tr").before(trafficCostStr);sysCommon.updateMoneySum(0);busiTripApply.costApplyTabOperateEvent();sysCommon.clearFormData();$("#traffic-list-info").parent().find(".cost-list-title .risk-img").attr("src",busiTripApply.riskViaImg)},getHotelFormInfo:function(){var hotelObj=$(".hotel-form");sysCommon.createSumTr(1);var tripUser=hotelObj.find("select.hotel-trip-user-sel option:selected").text();var level=hotelObj.find("select.hotel-trip-user-sel option:selected").attr("data-level");var hotelAddress=hotelObj.find("#hotel-address option:selected").text();var hotelCostStr='<tr><td><span>'+tripUser+'</span><input type="hidden" data-val="travelPersonnel" value="'+hotelObj.find("select.hotel-trip-user-sel").val()+'"/></td><td>'+level+'</td><td class="font-right">'+$("#peoDayMoney").html()+'</td><td data-text="hotelDays">'+hotelObj.find(".yt-numberInput").val()+'</td><td class="font-right money-td" data-text="hotelExpense">'+hotelObj.find(".cost-detail-money").val()+'</td><td><span>'+hotelAddress+'</span><input type="hidden" data-val="hotelAddress" value="'+hotelObj.find("#hotel-address").val()+'"</td><td class="text-overflow-sty" data-text="remarks" title="'+hotelObj.find(".hotel-msg").val()+'">'+(hotelObj.find(".hotel-msg").val()==""?"--":hotelObj.find(".hotel-msg").val())+'</td><td><input type="hidden" class="hid-cost-type" value="1"/><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"/></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"/></span></td></tr>';$("#hotel-list-info tbody .total-last-tr").before(hotelCostStr);sysCommon.updateMoneySum(1);busiTripApply.costApplyTabOperateEvent();sysCommon.clearFormData();$("#hotel-list-info").parent().find(".cost-list-title .risk-img").attr("src",busiTripApply.riskViaImg)},getOtherCostFormInfo:function(){var otherObj=$(".other-form");sysCommon.createSumTr(2);var costType=otherObj.find("#cost-type option:selected").text();var otherCostStr='<tr><td><span>'+costType+'</span><input type="hidden" data-val="costType" value="'+otherObj.find("#cost-type").val()+'"/></td><td class="font-right money-td" data-text="reimAmount">'+otherObj.find(".other-money").val()+'</td><td class="text-overflow-sty" data-text="remarks" title="'+otherObj.find(".other-msg").val()+'">'+(otherObj.find(".other-msg").val()==""?"--":otherObj.find(".other-msg").val())+'</td><td><input type="hidden" class="hid-cost-type" value="2"/><span class="operate-update"><img src="../../../../../resources-sasac/images/common/edit-icon.png"/></span><span class="operate-del"><img src="../../../../../resources-sasac/images/common/del-icon.png"/></span></td></tr>';$("#other-list-info tbody .total-last-tr").before(otherCostStr);sysCommon.updateMoneySum(2);busiTripApply.costApplyTabOperateEvent();sysCommon.clearFormData();$("#other-list-info").parent().find(".cost-list-title .risk-img").attr("src",busiTripApply.riskViaImg)},costDetailModelEvent:function(){var costApplyModel=$("#cost-apply-model");costApplyModel.find("#model-add-list-btn").off().on("click",function(){var tabFlag=$(".cost-type-tab li.tab-check .hid-tab").val();var validModel="";if(tabFlag==0){validModel=$(".traffic-form")}else if(tabFlag==1){validModel=$(".hotel-form")}else if(tabFlag==2){validModel=$(".other-form")}var validFlag=$yt_valid.validForm(validModel);if(validFlag){busiTripApply.getCostDetailData(tabFlag);sysCommon.closeModel(costApplyModel)}});costApplyModel.find("#model-sure-btn").off().on("click",function(){var costType=busiTripApply.trObject.find(".hid-cost-type").val();var validModel="";if(costType==0){validModel=$(".traffic-form")}else if(costType==1){validModel=$(".hotel-form")}else if(costType==2){validModel=$(".other-form")}var validFlag=$yt_valid.validForm(validModel);if(validFlag){if(costType==0){var trabfficObj=$(".traffic-form");var tripUser=trabfficObj.find("#model-trip-user option:selected").text();var level=trabfficObj.find("#model-trip-user option:selected").attr("data-level");var vehicle="";if($(".vehicle-two-sel").val()!=""&&$(".vehicle-two-sel").val()!=null){vehicle=trabfficObj.find(".vehicle-two-sel option:selected").text()}else{vehicle=trabfficObj.find(".vehicle-sel option:selected").text()}var cityMoney=trabfficObj.find(".city-cost-input").val();busiTripApply.trObject.find("td:eq(0) span").text(tripUser);busiTripApply.trObject.find("td:eq(1)").text(level);busiTripApply.trObject.find("td:eq(0) input").val(trabfficObj.find("#model-trip-user").val());busiTripApply.trObject.find("td:eq(2)").text($("#traffic-start-time").val());busiTripApply.trObject.find("td:eq(3)").text($("#fromcity").val());busiTripApply.trObject.find("td:eq(4)").text($("#traffic-end-time").val());busiTripApply.trObject.find("td:eq(5)").text($("#tocity").val());busiTripApply.trObject.find("td:eq(6) span").text(vehicle);busiTripApply.trObject.find("td:eq(6) input:eq(0)").val(trabfficObj.find(".vehicle-sel").val());busiTripApply.trObject.find("td:eq(6) .hid-child-code").val($(".vehicle-two-sel").val());busiTripApply.trObject.find("td:eq(7)").text(cityMoney);busiTripApply.trObject.find("td:eq(8)").text(($("#special-remark").val()==""?"--":$("#special-remark").val()));sysCommon.updateMoneySum(0)}if(costType==1){var hotelObj=$(".hotel-form");var tripUser=hotelObj.find("select.hotel-trip-user-sel option:selected").text();var level=hotelObj.find("select.hotel-trip-user-sel option:selected").attr("data-level");var hotelAddress=hotelObj.find("#hotel-address option:selected").text();busiTripApply.trObject.find("td:eq(0) span").text(tripUser);busiTripApply.trObject.find("td:eq(1)").text(level);busiTripApply.trObject.find("td:eq(0) input").val(hotelObj.find("select.hotel-trip-user-sel").val());busiTripApply.trObject.find("td:eq(2)").text($("#peoDayMoney").text());busiTripApply.trObject.find("td:eq(3)").text(hotelObj.find(".yt-numberInput").val());busiTripApply.trObject.find("td:eq(4)").text(hotelObj.find(".hotel-money").val());busiTripApply.trObject.find("td:eq(5) span").text(hotelAddress);busiTripApply.trObject.find("td:eq(5) input").val(hotelObj.find("select.hotel-trip-user-sel").val());busiTripApply.trObject.find("td:eq(6)").text((hotelObj.find(".hotel-msg").val()==""?"--":hotelObj.find(".hotel-msg").val()));sysCommon.updateMoneySum(1)}if(costType==2){var otherObj=$(".other-form");var costType=otherObj.find("#cost-type option:selected").text();busiTripApply.trObject.find("td:eq(0) span").text(costType);busiTripApply.trObject.find("td:eq(0) input").val(otherObj.find("#cost-type").val());busiTripApply.trObject.find("td:eq(1)").text(otherObj.find(".other-money").val());busiTripApply.trObject.find("td:eq(2)").text((otherObj.find(".other-msg").val()==""?"--":otherObj.find(".other-msg").val()));sysCommon.updateMoneySum(2)}sysCommon.closeModel(costApplyModel);sysCommon.clearFormData()}});costApplyModel.find("#model-canel-btn").off().on("click",function(){sysCommon.closeModel(costApplyModel);sysCommon.clearFormData()});$("#addres-icon").off().on("click",function(){var startCity=$("#fromcity").val();var endCity=$("#tocity").val();$("#tocity").val(startCity);$("#fromcity").val(endCity)});$(".yt-spin").click(function(){var hotelDay=$(".hotel-form .yt-numberInput").val();if(hotelDay<1){hotelDay=$(".hotel-form .yt-numberInput").val(1)}var hotelMoney=$(".cost-detail-money").val();if(hotelDay>0&&hotelMoney!=""){$("#peoDayMoney").html($yt_baseElement.fmMoney(($yt_baseElement.rmoney(hotelMoney))/hotelDay))}});$(".yt-numberInput").on("blur",function(){var hotelMoney=$(".cost-detail-money").val();if($(this).val()>0&&hotelMoney!=""){$("#peoDayMoney").html($yt_baseElement.fmMoney(hotelMoney/$(this).val()))}});$(".city-cost-input,.cost-detail-money").on("focus",function(){if($(this).val()!=""&&$(this).val()!=null){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()}});$(".city-cost-input,.cost-detail-money").off("blur").on("blur",function(){if($(this).hasClass("cost-detail-money")){var hotelDay=$(".hotel-form .yt-numberInput").val();$("#peoDayMoney").html($yt_baseElement.fmMoney($(this).val()/hotelDay))}busiTripApply.formartMoney($(this))})},costApplyTabOperateEvent:function(){$(".operate-update").off().on("click",function(){var thisTr=$(this).parents("tr");busiTripApply.trObject=thisTr;busiTripApply.showCostDetailModel();$("#model-add-list-btn").hide();$("#model-sure-btn").show();var costType=thisTr.find(".hid-cost-type").val();$(".cost-type-tab ul li").removeClass("tab-check");$('.cost-type-tab ul li input[value="'+costType+'"]').parent().addClass("tab-check");if(costType==0){$(".traffic-form").show();$(".traffic-form .risk-img").attr("src",busiTripApply.riskViaImg)}if(costType==1){$(".hotel-form").show();$(".traffic-form").hide();$(".hotel-form .risk-img").attr("src",busiTripApply.riskViaImg)}if(costType==2){$(".other-form").show();$(".traffic-form").hide();$(".other-form .risk-img").attr("src",busiTripApply.riskViaImg)}busiTripApply.getTrCostInfoToForm(thisTr)});$(".operate-del").off().on("click",function(){var thisObj=$(this);var tableModel=thisObj.parents("table").prev();var costType=thisObj.parent().find(".hid-cost-type").val();$yt_alert_Model.alertOne({alertMsg:"确定要删除此条数据吗?",leftBtnName:"确定",confirmFunction:function(){if(thisObj.parents("tbody").find("tr:not(.total-last-tr)").length==1){thisObj.parents("tbody").empty();tableModel.find(".risk-img").attr("src",busiTripApply.riskExcMark)}thisObj.parents("tr").remove();sysCommon.updateMoneySum(costType,thisObj.parents("tr").find(".money-td").text())}})})},getTrCostInfoToForm:function(thisTr){var costType=$(thisTr).find(".hid-cost-type").val();if(costType==0){var busiUser=$(thisTr).find("td:eq(0) .hid-traf-users").val();var startDate=$(thisTr).find("td:eq(2)").text();var startAddre=$(thisTr).find("td:eq(3)").text();var endDate=$(thisTr).find("td:eq(4)").text();var endAddre=$(thisTr).find("td:eq(5)").text();var vehicle=$(thisTr).find("td:eq(6) input:eq(0)").val();var vehicleChildCode=$(thisTr).find("td:eq(6) .hid-child-code").val();var cityMoney=$(thisTr).find("td:eq(7)").text();var cityMsg=$(thisTr).find("td:eq(8)").text();$('#model-trip-user option[value="'+busiUser+'"]').attr("selected","selected");$("#traffic-start-time").val(startDate);$("#traffic-end-time").val(endDate);$("#fromcity").val(startAddre);$("#tocity").val(endAddre);$('.traffic-form .vehicle-sel option[value="'+vehicle+'"]').attr("selected","selected");if(vehicleChildCode!=""){$("#vehicleTwoDiv").show();sysCommon.vechicleChildData(vehicle);$('.traffic-form .vehicle-two-sel option[value="'+vehicleChildCode+'"]').attr("selected","selected")}$(".traffic-form .city-cost-input").val(cityMoney);$("#special-remark").val((cityMsg=="--"?"":cityMsg));$('#model-trip-user,.traffic-form .vehicle-sel,.traffic-form .vehicle-two-sel').niceSelect()}if(costType==1){var busiUser=$(thisTr).find("td:eq(0) input").val();var dayMoney=$(thisTr).find("td:eq(2)").text();var hotelDay=$(thisTr).find("td:eq(3)").text();var hotelMoney=$(thisTr).find("td:eq(4)").text();var hotelAddress=$(thisTr).find("td:eq(5) input").val();var textareMsg=$(thisTr).find("td:eq(6)").text();$('#hotel-trip-user option[value="'+busiUser+'"]').attr("selected","selected");$(".hotel-form .yt-numberInput").val(hotelDay);$('#hotel-address option[value="'+hotelAddress+'"]').attr("selected","selected");$(".hotel-form .hotel-money").val(hotelMoney);$("#peoDayMoney").text(dayMoney);$(".hotel-form .hotel-msg").val((textareMsg=="--"?"":textareMsg));$('#hotel-trip-user,#hotel-address').niceSelect()}if(costType==2){var costType=$(thisTr).find("td:eq(0) input").val();var costMoney=$(thisTr).find("td:eq(1)").text();var textareMsg=$(thisTr).find("td:eq(2)").text();$('#cost-type option[value="'+costType+'"]').attr("selected","selected");$(".other-form .other-money").val(costMoney);$(".other-form .other-msg").val((textareMsg=="--"?"":textareMsg));$('#cost-type').niceSelect()}},showCostDetailModel:function(){var costApplyModel=$("#cost-apply-model");sysCommon.showModel(costApplyModel);busiTripApply.costDetailModelEvent();sysCommon.costDetailModelTabEvent()},bodyDateInit:function(){$("#traffic-start-time").calendar({controlId:"trafficStartTime",nowData:false,upperLimit:$("#traffic-end-time"),speed:0,callback:function(){sysCommon.clearValidInfo($("#traffic-start-time"))}});$("#traffic-end-time").calendar({controlId:"trafficEndTime",nowData:false,lowerLimit:$("#traffic-start-time"),speed:0,callback:function(){sysCommon.clearValidInfo($("#traffic-end-time"))}});$("#start-time").calendar({controlId:"startTime",nowData:false,upperLimit:$("#end-time"),speed:0,callback:function(){var days=sysCommon.calculateDays($("#start-time").val(),$("#end-time").val());$(".date-td .auto-font").hide();$(".busi-day-show").show();$("#out-day-num").html(days);sysCommon.clearValidInfo($("#start-time"))}});$("#end-time").calendar({controlId:"endTime",nowData:false,lowerLimit:$("#start-time"),speed:0,callback:function(){var days=sysCommon.calculateDays($("#start-time").val(),$("#end-time").val());$(".date-td .auto-font").hide();$(".busi-day-show").show();$("#out-day-num").html(days);sysCommon.clearValidInfo($("#end-time"))}});$("#busi-start-date").calendar({controlId:"busiStartDate",nowData:false,upperLimit:$("#busi-end-date"),speed:0,callback:function(){sysCommon.clearValidInfo($("#busi-start-date"))}});$("#busi-end-date").calendar({controlId:"busiEndDate",nowData:false,lowerLimit:$("#busi-start-date"),speed:0,callback:function(){sysCommon.clearValidInfo($("#busi-end-date"))}});$("#tdStartDate").calendar({controlId:"planStartDate",nowData:false,upperLimit:$("#tdEndDate"),speed:0,callback:function(){sysCommon.clearValidInfo($("#tdStartDate"))}});$("#tdEndDate").calendar({controlId:"planEndDate",nowData:false,lowerLimit:$("#tdStartDate"),speed:0,callback:function(){sysCommon.clearValidInfo($("#tdEndDate"))}})},formartMoney:function(thisObj){if($(thisObj).val()!=""&&$(thisObj).val()!=null){$(thisObj).val($yt_baseElement.fmMoney($(thisObj).val()))}}};$(".travel-plan-form-model").undelegate().delegate(".cont-file","change",function(obj){var thisFile=$(this);var fileId=$(".file-btn-div input[type='file']").attr("id");var url=$yt_option.base_path+"fileUpDownload/upload?modelCode=SZ_TRAVEL_APP";$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:fileId,success:function(data,textStatus){console.log(data);$("#trip-file").val(data.pkId);busiTripApply.getFileUploadName(fileId,$(thisFile).parent().prev().find(".file-msg"))},error:function(data,status,e){$yt_alert_Model.prompt(data.msg,2000)}})});$(function(){busiTripApply.init()});
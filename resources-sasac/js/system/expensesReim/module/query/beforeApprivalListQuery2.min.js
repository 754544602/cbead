var pmPlanQueryObj={orderDef:'../../../../../resources-sasac/images/module/order-def.png',orderAsc:'../../../../../resources-sasac/images/module/order-acs.png',orderDesc:'../../../../../resources-sasac/images/module/order-desc.png',userList:[],init:function(){$("select").niceSelect();pmPlanQueryObj.getCostTypeList();pmPlanQueryObj.getUserList();pmPlanQueryObj.getDeptList();$("#startDate").calendar({controlId:"startTime",nowData:false,upperLimit:$("#endDate"),speed:0,callback:function(){}});$("#endDate").calendar({controlId:"endTime",nowData:false,lowerLimit:$("#startDate"),speed:0,callback:function(){}});$(".plan-list-model").css("min-height",$(window).height()-52-$(".heard-query-model").height());$(window).resize(function(){$(".plan-list-model").css("min-height",$(window).height()-52-$(".heard-query-model").height())});pmPlanQueryObj.getBeforehandList("")},eventFun:function(){$('#keyWord').on('keydown',function(){if($(this).val()!=''){$('.clearImg').show()}});$('.clearImg').on('click',function(){$('#keyWord').val('');$(this).hide()});$('.checkbox-state').change(function(){pmPlanQueryObj.getBeforehandList()});$('.checkbox-quota').change(function(){pmPlanQueryObj.getBeforehandList()})},switchtimeclick:function(){$(".sort-span").on("click",function(){var img=$(this).find('img');var src=img.attr("src");var code=$(this).attr('code');$(".sort-span img").attr('src',pmPlanQueryObj.orderDef);if(src==pmPlanQueryObj.orderAsc){img.attr("src",pmPlanQueryObj.orderDesc);pmPlanQueryObj.getBeforehandList('DESC',code)}else if(src==pmPlanQueryObj.orderDesc||src==pmPlanQueryObj.orderDef){img.attr("src",pmPlanQueryObj.orderAsc);pmPlanQueryObj.getBeforehandList('ASC',code)}})},switchapplymoneyclick:function(){$(".applymoney-img").on("click",function(){var src=$(".applymoney-img").attr("src");if(src=="../../../../../resources-sasac/images/module/order-acs.png"){$(".applymoney-img").attr("src","../../../../../resources-sasac/images/module/order-desc.png")}else if(src=="../../../../../resources-sasac/images/module/order-desc.png"){$(".applymoney-img").attr("src","../../../../../resources-sasac/images/module/order-acs.png")}})},moneyFormat:function(){$(".top-money,.bottom-money").on("focus",function(){if($(this).val()!=""){$(this).val($yt_baseElement.rmoney($(this).val()))}});$(".top-money,.bottom-money").on("blur",function(){if($(this).val()!=""){$(this).val($yt_baseElement.fmMoney($(this).val()))}})},multiSelection:function(){var str='';$('.checkbox-state').each(function(i,n){if(n.checked){var s=$(n).val();str+=s+','}});return str},quotaCheck:function(){var str='';$('.checkbox-quota').each(function(i,n){if(n.checked){var s=$(n).val();str+=s+','}});return str},queryBeforehand:function(){$("#heardSearchBtn").on("click",function(){pmPlanQueryObj.getBeforehandList()})},getBeforehandList:function(order,property){order=order||'DESC';property=property||'m.APPLICANT_TIME';var queryParams=$('.keyword-input').val();var userCode=$('select.user-name-sel option:selected').val();var costType=$('select.pm-type-sel option:selected').val();var deptId=$('select.org-way-sel option:selected').val();var startAmount=$('.top-money').val()==''?'':$yt_baseElement.rmoney($('.top-money').val());var endAmount=$('.bottom-money').val()==''?'':$yt_baseElement.rmoney($('.bottom-money').val());var startDate=$('.top-date').val();var endDate=$('.bottom-date').val();var queryStateParams=pmPlanQueryObj.multiSelection();$('.before-table-page').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:"sz/advanceApp/getTotalAdvanceAppQueryByParams",type:"post",data:{queryParams:queryParams,userCode:userCode,costType:costType,deptId:deptId,startAmount:startAmount,endAmount:endAmount,startDate:startDate,endDate:endDate,queryStateParams:queryStateParams,property:property,direction:order},success:function(data){var datas=data.data.rows;var sumMoney=data.data.allAmount;$("#allAmount").text($yt_baseElement.fmMoney(sumMoney));var htmlTbody=$('.before-apply-table .yt-tbody');htmlTbody.empty();var trStr="";if(data.flag==0){if(datas.length>0){$('.before-table-page').show();$.each(datas,function(i,n){trStr+='<tr><input class="appId" type="hidden" value="'+n.appId+'"/><input class="processInstanceId" type="hidden" value="'+n.processInstanceId+'"/><td>'+n.applicateTime+'</td><td>'+n.appNum+'</td><td><input class="applicantUser" type="hidden" value="'+n.applicantUser+'"/>'+n.applicantUserName+'</td><td>'+n.applicantUserDeptName+'</td><td style="text-align: left;">'+n.appName+'</td><td><input class="costType" type="hidden" value="'+n.costType+'"/>'+n.costTypeName+'</td><td style="text-align: left;"><input class="specialCode" type="hidden" value="'+n.specialCode+'"/>'+n.specialName+'</td><td style="text-align: right;">'+$yt_baseElement.fmMoney(n.totalAmount)+'</td><td>'+n.workFlowState+'</td><td><a class="yt-link log-mod">查看</a></td></tr>'});htmlTbody.html(trStr);pmPlanQueryObj.initQtip();}else{$('.before-table-page').hide();htmlTbody.html(pmPlanQueryObj.noDataTrStr(10))}}},isSelPageNum:true })},noDataTrStr:function(trNum){var noDataStr='<tr style="border:0px;background-color:#fff !important;"><td  colspan="'+trNum+'" align="center"style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt="" style="padding: 35px 0 20px;"></div></td></tr>';return noDataStr},clearBtn:function(){$('#resetBtn').on('click',function(){pmPlanQueryObj.clearAlert($(".pmPlanQuery"));pmPlanQueryObj.getBeforehandList()})},clearAlert:function(obj){var selects=obj.find('select:not(.user-name-sel)');$.each(selects,function(i,n){$(n).find('option:first-child').attr('selected',true)});selects.niceSelect();pmPlanQueryObj.getUserList();var check1=obj.find('.checkbox-state');$.each(check1,function(i,n){$(n).setCheckBoxState("uncheck")});var check2=obj.find('.checkbox-quota');$.each(check2,function(i,n){$(n).setCheckBoxState("uncheck")});var inputs=obj.find('input:not(input[type="checkbox"])');inputs.val('')},getCostTypeList:function(code){$.ajax({type:"post",url:"basicconfig/dictInfo/getCostTypeList",async:true,data:{dictTypeCode:'COST_TYPE'},success:function(data){var list=data.data||[];var opts='<option value="">请选择</option>';$.each(list,function(i,n){if(code&&code==n.costCode){opts+='<option selected="selected" fun="'+n.jsFun+'" value="'+n.costCode+'">'+n.costName+'</option>'}else{opts+='<option fun="'+n.jsFun+'" value="'+n.costCode+'">'+n.costName+'</option>'}});$('#pmType').html(opts).niceSelect()}})},getDeptList:function(code){$.ajax({type:"post",url:"user/userInfo/getAllDeptsInfo",async:true,success:function(data){var list=data.data||[];var opts='<option value="">请选择</option>';$.each(list,function(i,n){if(n.type==2){if(code&&code==n.id){opts+='<option selected="selected" value="'+n.id+'">'+n.text+'</option>'}else{opts+='<option value="'+n.id+'">'+n.text+'</option>'}}});$('.org-way-sel').html(opts).niceSelect()}})},getUserList:function(){pmPlanQueryObj.userList=sysCommon.getUserAllInfo("","","");$("select.user-name-sel").html('<option value="">请选择</option>').niceSelect({search:true,backFunction:function(data){$("select.user-name-sel option").remove();$.each(pmPlanQueryObj.userList,function(i,n){if(n.userName.indexOf(data)!=-1){$("select.user-name-sel").append('<option value="'+n.userItcode+'">'+n.userName+'</option>')}})}})},initQtip:function(){$('.log-mod').qtip({content:{text:function(event,api){var txt='';var WorkFlowLogList=[];var thisTr=$(this).parents("tr");var processInstanceId=thisTr.find('.processInstanceId').val();$.ajax({type:"post",url:"basicconfig/workFlow/getWorkFlowLog",async:false,data:{processInstanceId:processInstanceId},success:function(data){if(data.data!=undefined&&data.data!=null){WorkFlowLogList=data.data}if(WorkFlowLogList==null||WorkFlowLogList==undefined){return}shomd="";shomd='<div class="suspension" >';var WorkFlowLog;for(var i=0;i<WorkFlowLogList.length;i+=1){WorkFlowLog=WorkFlowLogList[i];if(i==0){shomd+='<div class="log-msg-model"><div><div class="first-log-msg"><span class="log-num">'+(WorkFlowLogList.length-i)+'</span></div><span class="user-name">'+(WorkFlowLog.userName==""?'无':WorkFlowLog.userName)+'</span><div style="clear:both;"></div></div><div class="log-line-div" style="'+(i==(WorkFlowLogList.length-1)?"padding-bottom: 0px;":"padding-bottom: 10px;")+''+(WorkFlowLogList.length==1?"border:0px;":"")+'"><div style="'+(WorkFlowLogList.length==1?"border:0px;":"border-bottom: 1px solid #D6E6F3;")+'"><div class="oper-status-model"><label class="log-label-text">操作状态</label><span>：</span><span>'+(WorkFlowLog.taskName==""?"无":WorkFlowLog.taskName)+'</span></div><div class="oper-time-model"><label class="log-label-text">操作时间</label><span>：</span><span>'+(WorkFlowLog.commentTime==""?"无":WorkFlowLog.commentTime)+'</span></div>';if(WorkFlowLog.comment!=""&&WorkFlowLog.comment!=null&&WorkFlowLog.comment!=" "){shomd+='<div class="log-comment-model"><label class="log-label-text">操作意见</label><span>：</span><div class="oper-comment-msg">'+WorkFlowLog.comment+'</div></div>'}shomd+='</div></div>'}else{shomd+='<div class="log-msg-model"><div><div class="log-msg-def-bak"><span class="log-num">'+(WorkFlowLogList.length-i)+'</span></div><span class="user-name" style="top:0px;">'+(WorkFlowLog.userName==""?'无':WorkFlowLog.userName)+'</span><div style="clear:both;"></div></div><div class="log-line-div" style="'+(i==(WorkFlowLogList.length-1)?"padding-bottom: 0px;":"padding-bottom: 10px;")+''+(i==(WorkFlowLogList.length-1)?"border:0px;":"")+'"><div style="'+(i==(WorkFlowLogList.length-1)?"border:0px;":"border-bottom: 1px solid #D6E6F3;")+'"><div class="oper-status-model"><label class="log-label-text">操作状态</label><span>：</span><span>'+(WorkFlowLog.taskName==""?"无":WorkFlowLog.taskName)+'</span></div><div class="oper-time-model"><label class="log-label-text">操作时间</label><span>：</span><span>'+(WorkFlowLog.commentTime==""?"无":WorkFlowLog.commentTime)+'</span></div>';if(WorkFlowLog.comment!=""&&WorkFlowLog.comment!=null&&WorkFlowLog.comment!=" "){shomd+='<div class="log-comment-model"><label class="log-label-text">操作意见</label><span>：</span><div class="oper-comment-msg">'+WorkFlowLog.comment+'</div></div>'}shomd+='</div></div>'}shomd+='</div>'}}});return(WorkFlowLogList.length<1?'<span style="color:#999">暂无数据</span>':shomd);}},position:{my:'right top',at:'left top',container:false,viewport:$('body'),adjust:{x:0,y:0,mouse:true,resize:true,method:'flip flip'}},hide:{fixed:true,},style:{classes:'showmod',tip:{corner:true,mimic:false,width:10,height:10,border:true,offset:0}},events:{show:function(data){$(data.target).find(".qtip-content").css("max-height",$('#frame-right-model').height()-200)}}})}};$(function(){pmPlanQueryObj.init();pmPlanQueryObj.eventFun();pmPlanQueryObj.switchtimeclick();pmPlanQueryObj.moneyFormat();pmPlanQueryObj.queryBeforehand();pmPlanQueryObj.clearBtn()});
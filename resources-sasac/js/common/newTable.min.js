;(function($,window){var thisObj=this.thisObj=null,startTd=this.startTd=null,startIndex=this.startIndex=null,endTd=this.endTd=null,endIndex=this.endIndex=null,options=this.options={},tTD;function objLen(o){var count=0;for(var i in o){count+=1}return count};function init(obj,opt){setRuleTable(obj,opt);if(options.eventCheck){setInteractive();events(obj,opt)}if(options.resize){resizeFun(obj,opt)}};function events(obj,opt){obj.on('selectstart',function(){return false});obj.on('contextmenu',function(e){e.preventDefault();});obj.find('.yt-thead,.indicate-head').on('mousedown','th',function(e){var btnNum=e.button;var me=$(this);if(btnNum==2){var tds=thisObj.find('th.cell-check');if(me.hasClass('cell-check')){if(tds.length>1){$('#rightButCon .merge').removeClass('dis').attr('disabled',false);$('#rightButCon .split').addClass('dis').attr('disabled',true)}else{$('#rightButCon .merge').addClass('dis').attr('disabled',true);var colspan=tds.attr('colspan');var rowspan=tds.attr('rowspan');if((colspan&& +colspan>1)||(rowspan&& +rowspan>1)){$('#rightButCon .split').removeClass('dis').attr('disabled',false)}else{$('#rightButCon .split').addClass('dis').attr('disabled',true)}}}else{$('#rightButCon .merge,#rightButCon .split').addClass('dis').attr('disabled',true)}if(me.hasClass('indicate')&&me.hasClass('td-shadow')){$('#rightButCon .readonly').removeClass('dis').attr('disabled',false);if(me.hasClass('dis')){$('#rightButCon .readonly').text('取消只读').off().on('click',function(){me.removeClass('dis').text(me.text().split('[')[0]);thisObj.find('.yt-thead .td-shadow').removeClass('dis')})}else{$('#rightButCon .readonly').text('只读').off().on('click',function(){me.addClass('dis').text(me.text()+'[只读]');thisObj.find('.yt-thead .td-shadow').addClass('dis')})}}else{$('#rightButCon .readonly').addClass('dis').attr('disabled',true)}rightButConPosition(e);$(document).one('click',function(){$('#rightButCon').hide()});setInterEvent(me,'.yt-thead','thead');console.log(startIndex,endIndex)}else if(btnNum==0){startTd=$(this);var y=$(this).index();var x=$(this).parent().index();startIndex={x:x,y:y};thisObj.find("td,th").removeClass('cell-check');thisObj.find('.yt-tbody tr').removeClass('tr-shadow');thisObj.find('td,th').removeClass('td-shadow');obj.find('.yt-thead').find('th:not(.indicate)').removeClass('cell-check').on('mouseover',function(){endTd=$(this);var y=$(this).index();var x=$(this).parent().index();endIndex={x:x,y:y};selectTd(startIndex,endIndex,'th:not(.indicate)','.yt-thead')});$(this).addClass('cell-check')}else if(btnNum==1){}});obj.find('.yt-tbody').on('mousedown','td,th',function(e){var btnNum=e.button;var me=$(this);if(options.callBackTdClick){options.callBackTdClick(me)}if(btnNum==2){var tds=thisObj.find('td.cell-check');if($(this).hasClass('cell-check')){if(tds.length>1){$('#rightButCon .merge').removeClass('dis').attr('disabled',false);$('#rightButCon .split').addClass('dis').attr('disabled',true)}else{$('#rightButCon .merge').addClass('dis').attr('disabled',true);var colspan=tds.attr('colspan');var rowspan=tds.attr('rowspan');if((colspan&& +colspan>1)||(rowspan&& +rowspan>1)){$('#rightButCon .split').removeClass('dis').attr('disabled',false)}else{$('#rightButCon .split').addClass('dis').attr('disabled',true)}}}else{$('#rightButCon .merge,#rightButCon .split').addClass('dis').attr('disabled',true)}if(me.hasClass('indicate')&&me.parent().hasClass('tr-shadow')){$('#rightButCon .readonly').removeClass('dis').attr('disabled',false);if(me.hasClass('dis')){$('#rightButCon .readonly').text('取消只读').off().on('click',function(){me.removeClass('dis').text(me.text().split('[')[0])})}else{$('#rightButCon .readonly').text('只读').off().on('click',function(){me.addClass('dis').text(me.text()+'[只读]')})}}else{$('#rightButCon .readonly').addClass('dis').attr('disabled',true)}rightButConPosition(e);setInterEvent(me,'.yt-tbody','tbody');$(document).one('click',function(){$('#rightButCon').hide()});console.log(startIndex,endIndex)}else if(btnNum==0){startTd=$(this);var y=$(this).index()-1;var x=$(this).parent().index();startIndex={x:x,y:y};console.log(startIndex,endIndex);thisObj.find("td,th").removeClass('cell-check');thisObj.find('.yt-tbody tr').removeClass('tr-shadow');thisObj.find('td,th').removeClass('td-shadow');obj.find('.yt-tbody').find('td').removeClass('cell-check').on('mouseover',function(){endTd=$(this);var y=$(this).index()-1;var x=$(this).parent().index();endIndex={x:x,y:y};selectTd(startIndex,endIndex,'td','.yt-tbody')});$(this).addClass('cell-check')}else if(btnNum==1){}});obj.on('mouseup','td,th',function(){obj.find('td,th').off('mouseover')});obj.find('.yt-tbody').on('click','th.indicate',function(){var me=$(this);obj.find('.yt-tbody,.yt-thead').find('td,th:not(.indicate)').removeClass('cell-check');obj.find('.yt-tbody tr').removeClass('tr-shadow');obj.find('.yt-tbody td').removeClass('td-shadow');me.parent().addClass('tr-shadow')});obj.find('thead.indicate-head').on('click','th.indicate',function(){var me=$(this).addClass('td-shadow');obj.find('.yt-tbody,.yt-thead').find('td,th:not(.indicate)').removeClass('cell-check');obj.find('.yt-tbody tr').removeClass('cell-mark');obj.find('.yt-tbody td').removeClass('td-shadow');var index=$(this).index();obj.find("tbody td,.yt-thead th").each(function(){if($(this).index()==index){$(this).addClass("td-shadow")}})});obj.on('dblclick','td,th:not(.indicate)',function(){var me=$(this);var txt=me.text();var posi=me.position();var width=me.outerWidth();var height=me.outerHeight();txt=getFormatCode(txt);$('#tableInputHolder').css({left:posi.left,top:posi.top}).show();$('#handtableInput').css({width:width,height:height}).val(txt).off().focus().on('blur',function(){var val=$(this).val();me.html(getFormatHtml(val));$('#tableInputHolder').hide();$(this).val('')})})};function resizeFun(obj,opt){obj.find('.indicate-head').on('mousedown','.indicate',function(){tTD=this;if(event.offsetX>tTD.offsetWidth-10){tTD.mouseDown=true;tTD.oldX=event.x;tTD.oldWidth=tTD.offsetWidth}});obj.find('.indicate-head').on('mouseup','.indicate',function(){if(tTD==undefined){tTD=this}tTD.mouseDown=false;tTD.style.cursor='default'});obj.find('.indicate-head').on('mousemove','.indicate',function(){if(event.offsetX>this.offsetWidth-10){$(this).css('cursor','col-resize')}else{$(this).css('cursor','default')}if(tTD==undefined){tTD=this}if(tTD.mouseDown!=null&&tTD.mouseDown==true){tTD.style.cursor='default';if(tTD.oldWidth+(event.x-tTD.oldX)>0){tTD.width=tTD.oldWidth+(event.x-tTD.oldX-10)}$(tTD).css({'min-width':tTD.width+'px','cursor':'col-resize'});$(tTD).parents('.rule-table').find('.yt-thead tr').each(function(i,n){$(n).find('th').eq(tTD.cellIndex).css('min-width',tTD.width+'px')})}});obj.find('.yt-tbody').on('mousedown','.indicate',function(){tTD=this;if(event.offsetY>tTD.offsetHeight-10){tTD.mouseDown=true;tTD.oldY=event.y;tTD.oldHeight=tTD.offsetHeight}});obj.find('.yt-tbody').on('mouseup','.indicate',function(){if(tTD==undefined){tTD=this}tTD.mouseDown=false;tTD.style.cursor='default'});obj.find('.yt-tbody').on('mousemove','.indicate',function(){if(event.offsetY>this.offsetHeight-10){$(this).css('cursor','row-resize')}else{$(this).css('cursor','default')}if(tTD==undefined){tTD=this}if(tTD.mouseDown!=null&&tTD.mouseDown==true){tTD.style.cursor='default';if(tTD.oldHeight+(event.y-tTD.oldY)>0){tTD.height=tTD.oldHeight+(event.y-tTD.oldY-20)}$(tTD).css({'height':tTD.height+'px','cursor':'row-resize'});$(tTD).nextAll().css('height',tTD.height+'px')}})}var getFormatCode=function(strValue){return strValue.replace(/\r\n/g,'<br/>').replace(/\n/g,'<br/>').replace(/\s/g,' ')};var getFormatHtml=function(str){var newString=str.replace(/\n/g,'_@').replace(/\r/g,'_#');newString=newString.replace(/_#_@/g,'<br/>');newString=newString.replace(/_@/g,'<br/>');newString=newString.replace(/\s/g,'&nbsp;');return newString};function rightButConPosition(e){var left=e.clientX;var top=e.clientY;console.log(e);var rightButCon=$('#rightButCon');var width=rightButCon.width();var height=rightButCon.height();var w=$(window);var winWidth=w.width();var winHeight=w.height();left=width+left>winWidth?left-width:left;top=height+top>winHeight?top-height:top;rightButCon.show().css({left:left,top:top})}function setRuleTable(obj,opt){if((opt.theads&&objLen(opt.theads)>0)||(opt.tbodys&&objLen(opt.tbodys)>0)){createItemTable(obj,opt)}else if(opt.rowNum||opt.colNum){createSimpleTable(obj,opt)}else{thisObj.html('')}obj.addClass('rule-table-div')};function createSimpleTable(obj,opt){var row=opt.rowNum?opt.rowNum:1;var headRow=opt.headRow?opt.headRow:1;var col=opt.colNum?opt.colNum:1;var width=1200/opt.colNum;width=width>90?parseInt(width):90;var table='<table class="yt-table rule-table">';table+='<thead class="indicate-head">';if(options.serialNumber){table+='<th class="tab-indicate"></th>'}for(var s=0;s<col;s+=1){table+='<th class="indicate">C'+(s+1)+'</th>'}table+='</thead>';table+='<thead class="yt-thead">';for(var e=0;e<headRow;e+=1){table+='<tr>';if(options.serialNumber){table+='<th class="tab-indicate"></th>'}for(var j=0;j<col;j+=1){table+='<th style="min-width:'+width+'px;"></th>'}table+='</tr>'}table+='</thead>';table+='<tbody class="yt-tbody">';for(var i=0;i<row;i+=1){table+='<tr>';table+='<th class="indicate">R'+(i+1)+'</th>';for(var j=0;j<col;j+=1){table+='<td></td>'}table+='</tr>'}table+='</tbody></table>';if(obj.find('.rule-table').length>0){obj.find('.rule-table').replaceWith(table)}else{obj.append(table)}}function createItemTable(obj,opt){var theads=opt.theads;var tbodys=opt.tbodys;var disSend=opt.disSend?opt.disSend:{};var disX=disSend.x?disSend.x:0;var disY=disSend.y?disSend.y:0;var table='<table class="yt-table rule-table">';if(options.serialNumber){table+='<thead class="indicate-head">';if(options.serialNumber){table+='<th class="tab-indicate"></th>'}for(var s=0;s<objLen(tbodys['r1']);s+=1){if(s<disY){table+='<th class="dis"></th>'}else{table+='<th class="indicate">C'+(s+1-disY)+'</th>'}}table+='</thead>'}table+='<thead class="yt-thead">';for(var s=1;s<=objLen(theads);s+=1){table+='<tr>';if(options.serialNumber){table+='<th class="tab-indicate"></th>'}var tr=theads['r'+s];for(var m=1;m<=objLen(tr);m+=1){table+=getTrChild(tr['c'+m],'th')}table+='</tr>'}table+='</thead>';table+='<tbody class="yt-tbody">';for(var i=1;i<=objLen(tbodys);i+=1){table+='<tr>';if(opt.serialNumber){table+='<th class="indicate">R'+(i)+'</th>'}var tr=tbodys['r'+i];for(var j=1;j<=objLen(tr);j+=1){table+=getTrChild(tr['c'+j],'td')}table+='</tr>'}table+='</tbody></table>';if(obj.find('.rule-table').length>0){obj.find('.rule-table').replaceWith(table)}else{obj.append(table)}if(opt.propertyList&&opt.propertyList.length>0){for(var i=0,len=opt.propertyList.length;i<len;i+=1){var proper=opt.propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){var th=thisObj.find('.indicate-head .indicate').eq(index-1);th.text(th.text()+'[只读]').addClass('dis');thisObj.find('.yt-thead tr').each(function(i,n){$(n).find('th').eq(index-1).addClass('dis')})}else if(proper.type=='r'){var th=thisObj.find('.yt-tbody tr').eq(index-1).find('.indicate');th.text(th.text()+'[只读]').addClass('dis')}}}}function getTrChild(o,t){var html='<'+t+' '+(o.rowspan?('rowspan="'+o.rowspan+'"'):'')+' '+(o.colspan?('colspan="'+o.colspan+'"'):'')+' '+(o.style?('style="'+o.style+'"'):'')+'>';if(o.contents){html+=o.contents}html+='</'+t+'>';return html}function selectTd(startIndex,endIndex,dom,box){var minX=null;var maxX=null;var minY=null;var maxY=null;if(startIndex.x<endIndex.x){minX=startIndex.x;maxX=endIndex.x}else{minX=endIndex.x;maxX=startIndex.x};if(startIndex.y<endIndex.y){minY=startIndex.y;maxY=endIndex.y}else{minY=endIndex.y;maxY=startIndex.y};startIndex={x:minX,y:minY};endIndex={x:maxX,y:maxY};console.log(startIndex,endIndex);thisObj.find("td,th").removeClass('cell-check');thisObj.find('.yt-tbody tr').removeClass('tr-shadow');thisObj.find('td,th').removeClass('td-shadow');for(var i=minX;i<=maxX;i+=1){var selectTr=thisObj.find(box).find("tr").eq(i);for(var j=minY;j<=maxY;j+=1){selectTr.find(dom).eq(j).addClass('cell-check')}}}function mergeCell(startIndex,endIndex,site){var colspan=null;var rowspan=null;rowspan=endIndex.x-startIndex.x+1;colspan=endIndex.y-startIndex.y+1;var indexTr=thisObj.find(site).find("tr").eq(startIndex.x);$("td,th:not(.indicate,.dis)",indexTr).eq(startIndex.y).attr("colspan",colspan).attr("rowspan",rowspan);for(var i=startIndex.x;i<=endIndex.x;i+=1){for(var j=startIndex.y;j<=endIndex.y;j+=1){if(i==startIndex.x&&j==startIndex.y){continue}var selectTr=thisObj.find(site).find("tr").eq(i);$("td,th:not(.indicate,.dis)",selectTr).eq(j).hide().text('').removeClass('cell-check')}}}function splitCell(startIndex,endIndex,site,obj){var colspan= +obj.attr("colspan")||0;var rowspan= +obj.attr("rowspan")||0;obj.attr("colspan",'').attr("rowspan",'');var endX=startIndex.x+rowspan;var endY=startIndex.y+colspan;for(var i=startIndex.x;i<=endX;i+=1){for(var j=startIndex.y;j<=endY;j+=1){if(i==startIndex.x&&j==startIndex.y){continue}var selectTr=thisObj.find(site).find("tr").eq(i);$("td,th:not(.indicate,.dis)",selectTr).eq(j).show()}}}function insertRowTr(e,type,site){var html='';if(type=='thead'){html+='<tr>';if(options.serialNumber){html+='<th class="tab-indicate"></th>'}for(var i=0,len=e.find('th:not(.tab-indicate)').length;i<len;i+=1){html+='<th></th>'}html+='</tr>';e.before(html);}else if(type=='tbody'){html+='<tr>';html+='<th class="indicate"></th>';for(var i=0,len=e.find('td').length;i<len;i+=1){html+='<td></td>'}html+='</tr>';e.before(html);resetRowItemKey()}}function delteRowTr(e,type,site){var html='';e.remove(html);resetRowItemKey()}function resetRowItemKey(){var o=thisObj;var trs=thisObj.find('.rule-table tbody tr .indicate');trs.each(function(i){if($(this).hasClass('dis')){$(this).text('R'+(i+1)+'[只读]')}else{$(this).text('R'+(i+1))}})}function resetColItemKey(){var o=thisObj;var tds=thisObj.find('.rule-table .indicate-head th.indicate');tds.each(function(i){if($(this).hasClass('dis')){$(this).text('C'+(i+1)+'[只读]')}else{$(this).text('C'+(i+1))}})}function insertCol(e,site){var index=e.index();var indicateTrs=thisObj.find('.indicate-head tr');indicateTrs.each(function(i,n){$(this).find('th').eq(index).before('<th class="indicate"></th>')});var headTrs=thisObj.find('.yt-thead tr');headTrs.each(function(i,n){$(this).find('th').eq(index).before('<th></th>')});var bodyTrs=thisObj.find('.yt-tbody tr');bodyTrs.each(function(i,n){$(this).find('td').eq(index-1).before('<td></td>')});resetColItemKey()}function delteCol(e,site){var index=e.index();var indicateTrs=thisObj.find('.indicate-head tr');indicateTrs.each(function(i,n){$(this).find('th').eq(index).remove()});var headTrs=thisObj.find('.yt-thead tr');headTrs.each(function(i,n){$(this).find('th').eq(index).remove()});var bodyTrs=thisObj.find('.yt-tbody tr');bodyTrs.each(function(i,n){$(this).find('td').eq(index-1).remove()});resetColItemKey()}function readOnlyRow(e,site){var ths=thisObj.find('.yt-tbody tr .indicate');ths.eq(0).text('').removeClass('indicate').addClass('dis');for(var i=1;i<ths.length;i+=1){ths.eq(i).text('C'+i)}}function readOnlyCol(e,site){var ths=thisObj.find('.indicate-head .indicate,.yt-thead .td-shadow');ths.eq(0).text('').removeClass('indicate');ths.addClass('dis');for(var i=1;i<ths.length;i+=1){ths.eq(i).text('C'+i)}}function setInteractive(){var html='<div id="rightButCon" class="right-button-context"><ul><li class="align-left">左对齐</li><li class="align-center">居中</li><li class="align-right">右对齐</li><li class="insert-row">插入一行</li><li class="insert-col">插入一列</li><li class="del-row">删除一行</li><li class="del-col">删除一列</li><li class="merge">合并单元格</li><li class="split dis">拆分单元格</li><li class="readonly">只读</li></ul></div>';html+='<div id="tableInputHolder" class="input-holder"><textarea id="handtableInput" class="hand-input"></textarea></div>';thisObj.append(html)}function setInterEvent(obj,site,type){$('#rightButCon .merge:not(.dis)').off().on('click',function(){mergeCell(startIndex,endIndex,site);$('#rightButCon').hide()});$('#rightButCon .split:not(.dis)').off().on('click',function(){splitCell(startIndex,endIndex,site,obj);$('#rightButCon').hide()});$('#rightButCon .align-left:not(.dis)').off().on('click',function(){thisObj.find('.yt-thead .cell-check:not(.indicate),.yt-thead .td-shadow,.yt-tbody .tr-shadow td').css({'text-align':'left'});thisObj.find('.yt-tbody .cell-check:not(.indicate),.yt-tbody .td-shadow,.yt-tbody .tr-shadow td').css({'text-align':'left'});$('#rightButCon').hide()});$('#rightButCon .align-center:not(.dis)').off().on('click',function(){thisObj.find('.cell-check:not(.indicate),.td-shadow,.tr-shadow td').css({'text-align':'center'});$('#rightButCon').hide()});$('#rightButCon .align-right:not(.dis)').off().on('click',function(){thisObj.find('.yt-thead .cell-check:not(.indicate),.yt-thead .td-shadow,.yt-tbody .tr-shadow td').css({'text-align':'right'});thisObj.find('.yt-tbody .cell-check:not(.indicate),.yt-tbody .td-shadow,.yt-tbody .tr-shadow td').css({'text-align':'right'});$('#rightButCon').hide()});$('#rightButCon .insert-row:not(.dis)').off().on('click',function(e){var tr=obj.parents('tr');insertRowTr(tr,type,'before');callback()});$('#rightButCon .insert-col:not(.dis)').off().on('click',function(e){var tr=obj;insertCol(tr,type,'before');callback()});$('#rightButCon .del-row:not(.dis)').off().on('click',function(e){var tr=obj.parents('tr');delteRowTr(tr,type,'before');callback()});$('#rightButCon .del-col:not(.dis)').off().on('click',function(e){var tr=obj;delteCol(tr,type,'before');callback()});$('#rightButCon .readonly-row:not(.dis)').off().on('click',function(e){var tr=obj;readOnlyRow(tr,type,'before')});$('#rightButCon .readonly-col:not(.dis)').off().on('click',function(e){var tr=obj;readOnlyCol(tr,type,'before')})}function callback(){var budgetCols=thisObj.find('.yt-tbody tr').eq(0).find('td').length;var budgetRows=thisObj.find('.yt-thead tr').length;var budgetBodyCols=thisObj.find('.yt-tbody tr').length;if(options.callback){options.callback({cols:budgetCols,rows:budgetBodyCols,headRows:budgetRows})}}function setTableWidth(){}$.fn.extend({'newRuleTable':function(opt){thisObj=this;options=$.extend({rowNum:0,colNum:0,eventCheck:true,serialNumber:true,resize:true},opt);this.newRuleTable={};this.initNewTable=init;this.initNewTable(this,options);return this}})})(jQuery,window);function getRuleTableData(obj){var table=obj.find('.rule-table');var theadTrs=table.find('.yt-thead tr');var tbodyTrs=table.find('.yt-tbody tr');var theads={},tbodys={};$.each(theadTrs,function(i,n){tbodys['r'+i]={};$.each($(n).find('th:not(.tab-indicate)'),function(j,m){theads['r'+i]['c'+j]={colNum:i,rowNum:j,contents:$(m).text(),rowspan:$(m).attr('rowspan')||'',cellspan:$(m).attr('cellspan')||'',style:$(m).attr('style')||''}})});$.each(tbodyTrs,function(i,n){tbodys['r'+i]={};$.each($(n).find('td'),function(j,m){tbodys['r'+i]['c'+j]={colNum:i,rowNum:j,contents:$(m).text(),rowspan:$(m).attr('rowspan')||'',cellspan:$(m).attr('cellspan')||'',style:$(m).attr('style')||''}})});var disX=obj.find('.yt-tbody .dis').length;var disY=obj.find('.indicate-head .dis').length;return{theadCellsList:theads,tbodyCellsList:tbodys,propertyList:{x:disX,y:disY}}};
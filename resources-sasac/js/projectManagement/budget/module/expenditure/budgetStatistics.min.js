var budgetObj={configData:[],booksId:"",budgetStage:"",init:function(){var requerParameter=$yt_common.GetRequest();if(requerParameter){budgetObj.booksId=requerParameter.booksId;budgetObj.budgetStage=requerParameter.budgetStage;var tableIdObj=requerParameter.tableOjbData;if(tableIdObj){budgetObj.tableIdObj=JSON.parse(tableIdObj);budgetObj.getTableDataStart()}}},eventFun:function(){$(".edit-btn").off().on("click",function(){var thisSelTable=$(".rule-table");thisSelTable.find("tbody tr:not(.disable-sty) td:not(.disable-sty) .money-text").hide();thisSelTable.find("tbody tr td .money-input").each(function(){$(this).val($(this).parent().find(".money-text").text())});$(this).hide();thisSelTable.find("tr:not(.disable-sty) td:not(.disable-sty) .money-input").show();$(".init-calculate-btn,.init-cancel-btn,.init-save-btn").show()});$(".init-calculate-btn").off().on("click",function(){budgetObj.calculateTableData()});$(".init-save-btn").off().on("click",function(){var selTabData=budgetObj.tableIdObj;var tabDatas="";var tableDatas=budgetObj.getSaveTableInfo();$.ajax({type:"post",url:'budget/main/saveBudgetDataDetailInfo',data:{budgetDataJson:tableDatas,tableId:selTabData.tableId},async:false,success:function(data){if(data.flag=="0"){budgetObj.initHeardBtn()}$yt_alert_Model.prompt(data.message,2000)}})});$(".init-cancel-btn").on("click",function(){budgetObj.initHeardBtn()});budgetObj.priceInputEvent()},priceInputEvent:function(){$("#createConfigTableDiv tbody tr td input").each(function(){if($(this).hasClass(".character-inpu")){}});$("#createConfigTableDiv").on("keyup",'.money-input',function(){if(!$(this).hasClass("character-inpu")){$(this).val($(this).val().replace(/[^\d.]/g,''))}});$("#createConfigTableDiv").on("focus",'.money-input',function(){if($(this).val()!=""&&$(this).val()!=null&&!$(this).hasClass("character-inpu")){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()}});$("#createConfigTableDiv").on("blur",'.money-input',function(){if(!$(this).hasClass("character-inpu")){if($(this).val()!=""&&$(this).val()!=null){$(this).val($yt_baseElement.fmMoney($(this).val()));$(this).parent().find(".money-text").text($(this).val())}else{$(this).parent().find(".money-text").text("0.00")}}})},initHeardBtn:function(){$(".edit-btn,.rule-table tbody tr td .money-text").show();$(".init-save-btn,.init-cancel-btn,.init-calculate-btn,.rule-table tbody tr td .money-input").hide();$(".rule-table tbody tr td .money-input").val('');$(".rule-table tbody tr td .money-text").text('');budgetObj.getTableInfoList()},addTdHtml:function(tableObj){var thisTable=$('table.config-table[table-code="'+tableObj.tableCode+'"]');var tdNum=thisTable.find("tbody tr.flag-tr td:not(.flag-td)").length;var noDataTdFlag=thisTable.find("tbody tr.flag-tr td.flag-td").length;var tdStr="";if(tableObj.tableCode!="T26"&&tableObj.tableCode!="T28"&&tableObj.tableCode!="T29"&&tableObj.tableCode!="T30"&&tableObj.tableCode!="T31"&&tableObj.tableCode!="T32"&&tableObj.tableCode!="T33"){for(var i=0;i<tdNum;i+=1){tdStr+='<td class="right-td c'+(i+1)+'" fieldFlag=c'+(i+1)+'><span class="money-text"></span><input type="text" value="" class="money-input"/></td>'}if(noDataTdFlag==1){thisTable.find("tbody tr:gt(0)").each(function(){$(this).find('td:eq(0)').nextAll("td").remove();$(this).addClass('r'+$(this).index()+'');$(this).attr("fieldFlag",'r'+$(this).index()+'');$(this).find('td:eq(0)').after(tdStr)})}else{thisTable.find("tbody tr:gt(0)").each(function(){$(this).find('td:gt('+(noDataTdFlag-2)+')').nextAll("td").remove();$(this).addClass('r'+$(this).index()+'');$(this).attr("fieldFlag",'r'+$(this).index()+'');$(this).find('td:gt('+(noDataTdFlag-2)+')').after(tdStr)})}}budgetObj.priceInputEvent()},getTableInfoList:function(){var selTabData=budgetObj.tableIdObj;$.ajax({type:"post",url:'budget/main/getBudgetDataDetailInfo',async:false,data:{"tableId":selTabData.tableId},success:function(data){if(data.flag==0){if(data.data.length>0){var tbody=$('.rule-table .yt-tbody');$.each(data.data,function(i,n){$(".rule-table .yt-tbody tr:gt(0)").each(function(i,v){if($(v).attr("fieldFlag")==n.rowNum){$(v).find("td").each(function(t,c){if($(c).attr("fieldFlag")==n.cellNum){$(c).attr("budgetMainId",n.budgetMainId);if(n.crValue!=""&&n.crValue!=null&&n.crValue!=undefined){if(!isNaN(n.crValue)){n.crValue=$yt_baseElement.fmMoney(n.crValue)}$(c).find(".money-text").html(n.crValue);$(c).find(".money-input").val(n.crValue)}}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}});$("button.page-retun-btn").click(function(){window.location.href=$yt_option.websit_path+'view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+budgetObj.booksId+'&budgetStage='+budgetObj.budgetStage})},calculateTableData:function(){var selTabData=budgetObj.tableIdObj;var getTableDatas=budgetObj.getSaveTableInfo();$.ajax({type:"post",url:'budget/main/calcBudgetData',async:false,data:{"tableId":selTabData.tableId,"budgetDataJson":getTableDatas},success:function(data){if(data.flag==0){if(data.data.length>0){$.each(data.data,function(i,n){$(".rule-table tbody tr:gt(0)").each(function(i,r){if($(r).attr("fieldflag")==n.rowNum){$.each($(r).find("td"),function(i,c){if($(c).attr("fieldflag")==n.cellNum){$(c).find(".money-text").html($yt_baseElement.fmMoney(n.crValue));$(c).find(".money-input").val($yt_baseElement.fmMoney(n.crValue))}})}})})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},totalMoney:function(obj){var thisTrConfig="";var thisTdConfig="";var thisTd="";var tdVal="";var thisTr="";var price=0;var useConfigData=[];var cFieldflag=$(obj).attr("fieldflag");var rFieldflag=$(obj).parent().attr("fieldflag");for(var n=0;n<budgetObj.configData.length;n+=1){var calvValue=budgetObj.configData[n].calcValue;calvValue=calvValue.replace(/\+/g,'#');calvValue=calvValue.replace(/\-/g,'#');calvValue=calvValue.replace(/\*/g,'#');calvValue=calvValue.replace(/\//g,'#');calvValue=calvValue.replace(/\(/g,'#');calvValue=calvValue.replace(/\)/g,'#');calvValue="#"+calvValue+"#";if(calvValue.indexOf("#"+cFieldflag+"#")!=-1||calvValue.indexOf("#"+rFieldflag+"#")!=-1){useConfigData.push(budgetObj.configData[n])}}$.each(useConfigData,function(i,n){if(n.type=="c"){budgetObj.totalMoneyFun($(obj).parent().find("td[fieldflag='"+n.crNum+"']"))}else{budgetObj.totalMoneyFun($(".rule-table tr[fieldflag='"+n.crNum+"']").find("td[fieldflag='"+cFieldflag+"']"))}})},totalMoneyFun:function(ele){var configData;var thisTrConfig="";var thisTdConfig="";var thisTd="";var tdVal="";var tdNum=0;var repStr="";var thisTr="";var price=0;$.each(ele,function(i,r){try{thisTdConfig=$(this).data("configData");thisTrConfig=$(this).parent().data("configData");thisTd=$(this).index();thisTr=$(this).parent();if(thisTrConfig&&thisTrConfig.calcItem=="1"){tdVal=thisTrConfig.calcValue;configData=thisTrConfig}else{tdVal=thisTdConfig.calcValue;configData=thisTdConfig}if(tdVal!=""&&tdVal!=undefined){tdNum=$(".rule-table tbody tr").length;repStr="r";if(configData.type=="c"){tdNum=$(".rule-table tbody tr:eq(0) td").length;repStr="c"}for(var j=tdNum;j>0;j-=1){var re=new RegExp(repStr+j,"g");price=0;if(configData.type=="c"){var re=new RegExp("c"+j,"g");if($(thisTr).find("td").eq(j+2).find("span").text()==""){price=0}else{price=$yt_baseElement.rmoney($(thisTr).find("td").eq(j+2).find("span").text())}}else{if($(".rule-table .r"+j).find("td").eq(thisTd).find("span").text()==""){price=0}else{price=$yt_baseElement.rmoney($(".rule-table .r"+j).find("td").eq(thisTd).find("span").text())}}tdVal=tdVal.replace(re,price)}if(isNaN(eval(tdVal))){$(this).find("span").text("error")}else{$(this).find("span").text($yt_baseElement.fmMoney(eval(tdVal)))}}}catch(e){$(this).find("span").text("error")}})},getSaveTableInfo:function(){var tableList=[];var tableJson="";var thisTableTbody=$(".rule-table tbody");var rowConfig;var colConfig;var price=0;var budgetMainId="";thisTableTbody.find("tr:gt(0)").each(function(i,n){if(!$(n).hasClass("disable-sty")){$(n).find("td").each(function(v,c){if(!$(c).hasClass("disable-sty")){price=0;if($(c).find(".money-input")!=undefined&&$(c).find(".money-input").length>0&&$(c).find(".money-input").val()!=""){if(!$(c).find(".money-input").hasClass("character-inpu")){price=$yt_baseElement.rmoney($(c).find(".money-input").val())}else{price=$(c).find(".money-input").val()}}budgetMainId="";if($(c).attr("budgetMainId")!=undefined&&$(c).attr("budgetMainId").length>0){budgetMainId=$(c).attr("budgetMainId")}var propertyInfo={};propertyInfo["cellNum"]=$(this).attr("fieldflag");propertyInfo["rowNum"]=$(this).parent().attr("fieldflag");propertyInfo["crNum"]=$(this).attr("fieldflag")+$(this).parent().attr("fieldflag");propertyInfo["crValue"]=price;propertyInfo["budgetMainId"]=budgetMainId;tableList.push(propertyInfo)}})}});if(tableList.length>0){tableJson=JSON.stringify(tableList)}return tableJson},getConfigInfo:function(selTabData){budgetObj.configData=[];$.ajax({type:"post",url:'budget/table/getTableAllCongfigByTableId',async:false,data:selTabData,success:function(data){var crNums="";if(data.flag==0){if(data.data.length>0){budgetObj.configData=data.data;$.each(data.data,function(i,n){if(n.type=="cr"){crNums=n.crNum.split("-");$(".rule-table tbody tr:gt(0)").each(function(i,r){if(crNums[1]==$(this).attr("fieldFlag")){if(n.calcItem&&n.calcItem=="2"){$(r).find("input.money-input").addClass("character-inpu")}$.each($(r).find("td"),function(i,c){if(crNums[0]==$(c).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(c).addClass("disable-sty")}$(c).data("configData",n)}})}})}else{$(".rule-table tbody tr").each(function(i,r){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty").find('td').addClass("disable-sty")}if(n.calcItem=="2"){$(this).find("input.money-input").addClass("character-inpu")}$(this).data("configData",n)}});$(".rule-table tbody tr td").each(function(v,c){if(n.crNum==$(this).attr("fieldFlag")){if(n.calcItem=="1"||n.calcItem=="4"){$(this).addClass("disable-sty")}$(this).data("configData",n)}})}})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},getTableData:function(){$.post("budget/table/getTableDetailListByParams",function(data){if(data.flag==0){var trDoc='';$.each(data.data,function(i,n){trDoc='<tr><td>'+n.tableCode+'</td><td>'+n.budgetTypeName+'</td><td style="text-align: left;">'+n.tableName+'</td><td>'+n.lastOperatorUserName+'</td><td>'+n.lastOperatorDateTime+'</td></tr>';$("#table-list tbody").append(trDoc);$("#table-list tbody tr").last().data("tableData",n).click(function(){$(this).addClass("yt-table-active").siblings().removeClass("yt-table-active");$(".table-config .no-select-table").hide();$('.table-config .config-table').removeClass("select-table").hide();$('.table-config table[table-code="'+n.tableCode+'"]').show().addClass("select-table");$(".table-config table").eq($(this).index()).show().addClass("select-table").siblings().removeClass("select-table").hide();$(".tab-content:eq(1)").show().siblings().hide();$(".btn-group-model").show();$(".btn-group-model .tab-name").text(n.tableName);budgetObj.getBudgetTableDetailByTableId(n.tableId);budgetObj.addTdHtml(n);budgetObj.getConfigInfo(n);budgetObj.initHeardBtn()})})}})},getTableDataStart:function(){var n=budgetObj.tableIdObj;$(this).addClass("yt-table-active").siblings().removeClass("yt-table-active");$(".no-select-table").hide();$('.config-table').removeClass("select-table").hide();$('table[table-code="'+n.tableCode+'"]').show().addClass("select-table");$(".tab-content:eq(1)").show().siblings().hide();$(".btn-group-model").show();$(".btn-group-model .tab-name").text(n.tableName);budgetObj.getBudgetTableDetailByTableId(n.tableId);budgetObj.addTdHtml(n);budgetObj.getConfigInfo(n);budgetObj.initHeardBtn()},getBudgetTableDetailByTableId:function(tableId){$.ajax({type:'post',url:'budget/table/getBudgetTableDetailByTableId',async:false,data:{tableId:tableId},success:function(data){var dataObj=data.data||{};$('#createConfigTableDiv').html('').newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:false});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('disable-sty')})}else if(proper.type=='r'){$('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('disable-sty')}}$('.rule-table').data('tableData',dataObj);$('.rule-table tbody tr').each(function(i){$(this).attr('fieldflag','r'+(i+1)).addClass('r'+(i+1)).find('td').each(function(j){$(this).attr('fieldflag','c'+(j+1)).addClass('c'+(j+1))})});$('.rule-table tbody tr td:not(.disable-sty)').each(function(){var html=$(this).html();html='<span class="money-text">'+html+'</span><input class="yt-input money-input" value="" />';$(this).html(html)})}})},setRuleTableToggle:function(){}};$(function(){$(".easyui-layout:not(.fun-btn-model)").css("height",$(window).height()+"px");$(".easyui-layout:not(.fun-btn-model)").layout("resize",{width:"100%",height:($(window).height()-10)+"px"});budgetObj.init();budgetObj.eventFun()});
var configCommonObj={cellImgDef:"../../../../../resources-sasac/images/common/defau-icon.png",cellImgCheck:"../../../../../resources-sasac/images/common/sure-icon.png",booksId:"",budgetStage:""};var tableIdObj="";$(function(){var requerParameter=$yt_common.GetRequest();if(requerParameter){tableIdObj=requerParameter.tableOjbData;configCommonObj.booksId=requerParameter.booksId;configCommonObj.budgetStage=requerParameter.budgetStage;if(tableIdObj){tableIdObj=JSON.parse(tableIdObj)}}switcherTab();getConfigData.getTableData();$(".datagrid-htable .datagrid-header-row:eq(0) td").addClass("td-num-sty");$(".easyui-layout:not(.fun-btn-model)").css("height",$(window).height()+"px");$(".easyui-layout:not(.fun-btn-model)").layout("resize",{width:"100%",height:($(window).height()-40)+"px"});$("button.page-retu-btn").click(function(){window.location.href=$yt_option.websit_path+'view/system-sasac/budget/module/expenditure/budgetTableStyle.html?booksId='+configCommonObj.booksId+'&budgetStage='+configCommonObj.budgetStage;});$("#createConfigTableDiv").on('click','th.indicate:not(.dis)',function(){$(".rule-table tr th").removeClass("select-btn");$(".tip-valid-sty").hide();var configData=$(this).data("configData");var configTable=$(".rule-table");configTable.find("tr").removeClass("sel-shadow");var tableData=configTable.data("tableData");var valText='';var configDoc="";var thisText=$(this).text().trim();$(".rule-table td").removeClass("td-shadow cell-shadow").removeAttr("style");if(thisText.indexOf("R")!=-1){$(this).parent().siblings().removeClass("tr-shadow");$(this).parent().addClass("tr-shadow");configDoc=$(".row-config-panel .model-content");$(".column-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','south');$(".row-config-panel .config-btngroup").show();$(".column-config-panel .config-btngroup").hide();$('#config-layout').layout('panel','south').panel({title:'列的配置'});$(".column-config-panel .no-select-table").show()}else{configDoc=$(".column-config-panel .model-content");var selThIndex=$(this).index();var activeTable=$("#createConfigTableDiv .rule-table");activeTable.find("tr").removeClass("tr-shadow");activeTable.find("tbody tr td").removeClass("td-shadow").removeAttr("style");activeTable.find("tbody tr td").each(function(){if($(this).index()==selThIndex){$(this).addClass("td-shadow");if($(this).parent().index()==activeTable.find("tbody tr").length-1){$(this).css("border-bottom","2px solid #417095")}}});$(".row-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','east');$(".row-config-panel .config-btngroup").hide();$(".column-config-panel .config-btngroup").show()}if($(this).parent().parent().hasClass("indicate-head")){$(".column-config-panel .no-select-table").hide();getConfigData.addBotConfigHtml("c");configDoc=$(".column-config-panel .model-content");var configIndex=$(this).parent().find(".config-btn:eq(0)").index();$(this).siblings().removeClass("select-btn");if($(this).siblings(".select-btn").length==0){$(this).addClass("select-btn")}else{$(this).addClass("select-btn").siblings().removeClass("select-btn")}$(".column-config-panel .model-content,.column-config-panel .config-btngroup").show();configDoc.find(".formual").hide().find("input").removeClass("valid-hint").val('').removeAttr("validform").next().html('');configDoc.find(".property-model .yt-radio:eq(0) input").setRadioState("check");configDoc.find(".property-val-model").hide();var valText=$(this).index();configDoc.find(".column-num").text(valText);$(".column-config-panel .attributes-list").empty();getConfigData.setFormData($(this),$(".column-config-panel"));$('#config-layout').layout('panel','south').panel({title:'列的配置'});if($('#config-layout').layout('panel','south').is(":hidden")){$('#config-layout').layout('expand','south')}}else{$(this).parent().parent().find(".select-btn").removeClass("select-btn");if($(this).parent().parent().find(".select-btn").length==0){$(this).addClass("select-btn")}else{$(this).parent().parent().find(".select-btn").removeClass("select-btn");$(this).addClass("select-btn")}configDoc.find(".formual").hide().find("input").removeClass("valid-hint").val('').removeAttr("validform").next().html('');configDoc.find(".property-model .yt-radio:eq(0) input").setRadioState("check");configDoc.find(".property-val-model").hide();configDoc=$(".row-config-panel .model-content");$(".row-config-panel .model-content").show().next().hide();var valText=$(this).parent().index()+1;configDoc.find(".row-num").text(valText);valText=$(this).parent().find("td").eq($(this).parents(".config-table").find(".config-thead tr th.subject-code").index()).text();configDoc.find(".subject").text((valText==""?"--":valText));valText=$(this).parent().find("td").eq($(this).parents(".config-table").find(".config-thead tr th.co-code").index()).text();configDoc.find(".co-code").text((valText==""?"--":valText));valText=$(this).parent().find("td").eq($(this).parents(".config-table").find(".config-thead tr th.co-name").index()).text();configDoc.find(".co-name").text((valText==""?"--":valText));$(".row-config-panel .attributes-list").empty();getConfigData.setFormData($(this),$(".row-config-panel"));if($('#config-layout').layout('panel','east').is(":hidden")){$('#config-layout').layout('expand','east')}}valText=tableData.tableName;configDoc.find(".table-name").text(valText);});getConfigData.rowTdCellConfigBtnEvent();$(".table-btn .save-config").click(function(){if(!$yt_valid.validForm($(".table-config-panel"))){return false}var tableId=tableIdObj.tableId;var tableConfigArr=[];$(".table-attr .attributes-list .box-row,.table-attr .attributes-list-append .box-row").each(function(i,n){if($(this).find("select").val()!="0"){var codeVal=$(this).find("select.attributes").val();var valueVal='';var disValue='';if($(this).find("input.word-code").length<=0||$(this).find("input.word-code").is(":hidden")){disValue=$(this).find("select.word-num-sel option:selected").attr("sel-val");valueVal=$(this).find("select.word-num-sel").val()}else{disValue=$(this).find(".word-code").val();valueVal=$(this).find(".hid-word-code").val()}var tableConfig={filterType:"t",code:codeVal,value:(valueVal==""?disValue:valueVal),disValue:disValue};tableConfigArr.push(tableConfig)}});$(".row-attr .attributes-list .box-row").each(function(i,n){if($(this).find("select").val()!="0"){var codeVal=$(this).find("select").val();var tableConfig={filterType:"r",code:codeVal};tableConfigArr.push(tableConfig)}});$(".column-attr .attributes-list .box-row").each(function(i,n){if($(this).find("select").val()!="0"){var codeVal=$(this).find("select").val();var tableConfig={filterType:"c",code:codeVal};tableConfigArr.push(tableConfig)}});$(".cell-attr .attributes-list .box-row").each(function(i,n){if($(this).find("select").val()!="0"){var codeVal=$(this).find("select").val();var tableConfig={filterType:"cr",code:codeVal};tableConfigArr.push(tableConfig)}});$(".row-config-panel .model-content,.column-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','south');$('#config-layout').layout('collapse','east');$(".rule-table tr th").removeClass("select-btn");$.ajax({type:"post",url:"budget/table/saveTableFilterInfo",async:false,data:{"tableId":tableId,"tableFilterJson":JSON.stringify(tableConfigArr)},success:function(data){if(data.flag=="0"){$yt_alert_Model.prompt("配置保存成功!");var configTab=$("#table-list .table-active");$(".table-config-panel .attributes-list").empty();getConfigData.getTableConfig(configTab,tableIdObj);$(".select-table tr").removeClass("tr-shadow");$(".select-table td").removeClass("td-shadow cell-shadow").removeAttr("style")}else{$yt_alert_Model.prompt(data.message)}}})});$("#code-list .yt-cancel-btn").click(function(){sysCommon.closeModel($("#code-list"));$(".attributes-list div,.attributes-list select").removeClass("select-code")});$(".code-list tr").click(function(){$(this).addClass("yt-table-active").siblings().removeClass("yt-table-active")});$("#code-list .yt-common-btn").click(function(){if($(".code-list .yt-table-active").length==0){$yt_alert_Model.prompt("请选择编码")}else{var thisSel=$("select.word-num-sel.select-code");var selCode=$(".code-list .yt-table-active td:eq(0)").text();var codeDatas=getConfigData.getSelValData(thisSel.parent().parent());var numOptions="";thisSel.empty();if(codeDatas.length>0&&codeDatas!=undefined&&codeDatas!=null){$.each(codeDatas,function(i,n){if(selCode!=""&&selCode==n.code){numOptions+='<option value="'+n.code+'" selected="selected" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}else{numOptions+='<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}});thisSel.append(numOptions)}thisSel.niceSelect({search:true,backFunction:function(text){thisSel.html('');if(text==""){thisSel.append('<option value="">请选择</option>')}if(codeDatas!=""&&codeDatas.length>0){$.each(codeDatas,function(i,n){if(n.name.indexOf(text)!=-1){thisSel.append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}else if(n.code.indexOf(text)!=-1){thisSel.append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}})}}});thisSel.attr("validform","{isNull:true,changeFlag:true,msg:'请选择编码'}");sysCommon.closeModel($("#code-list"))}$(".attributes-list div,.attributes-list select").removeClass("select-code")});getConfigData.getUnitOpts();});function switcherTab(){var index=1;$('.tab-content').eq(index).css("display",'block').siblings('.tab-content').hide()}function switcherTabCopy(){var index=1;$('.tab-content').eq(index).css("display",'block').siblings('.tab-content').hide();$(".table-config-panel select").niceSelect();$(".table-config-panel select").each(function(){$(this).find("option:eq(0)").prop("selected","selected")});$(".table-config-panel input").val("");if(tableIdObj){$(".table-config-panel .attributes-list").empty();getConfigData.getTableConfig("",tableIdObj)}}var getConfigData={configDatas:"",wordNumDatas:"",delIconUrl:"../../../../../resources-sasac/images/common/delc.png",addIconUrl:"../../../../../resources-sasac/images/common/addc.png",getTableData:function(){$.post("budget/table/getTableDetailListByParams",function(data){if(data.flag==0){var trDoc='';$.each(data.data,function(i,n){trDoc='<tr><td>'+n.tableCode+'</td><td>'+n.budgetTypeName+'</td><td style="text-align: left;">'+n.tableName+'</td><td>'+n.lastOperatorUserName+'</td><td>'+n.lastOperatorDateTime+'</td></tr>';$("#table-list tbody").append(trDoc);$("#table-list tbody tr").last().data("tableData",n).click(function(){$('#config-layout').layout('collapse','south');$('#config-layout').layout('collapse','east');$(this).addClass("table-active").siblings().removeClass("table-active");$(".tab-nav:eq(1)").addClass("active-nav").siblings().removeClass("active-nav");$(".table-config .no-select-table,.save-config,.canel-config").hide();$('.table-config table[table-code="'+n.tableCode+'"]').show().addClass("select-table").siblings().removeClass("select-table").hide();$(".tab-content:eq(1)").show().siblings().hide();$(".save-config,.canel-config").show();$(".tab-content:eq(1) .table-name").text(n.tableName);$(".table-config-panel").show().next().hide();$(".row-config-panel .model-content,.column-config-panel .model-content").hide().next().show();$(".table-attr .attributes-list,.column-attr .attributes-list,.row-attr .attributes-list,.cell-attr .attributes-list").empty();getConfigData.getBudgetTableDetailByTableId(n.tableId,$('#createConfigTableDiv'));var tableDoc=$(this);getConfigData.getTableConfig(tableDoc,n);getConfigData.cellEventFun()})})}});$(".table-config .no-select-table,.save-config,.canel-config").hide();$(".tab-content:eq(1)").show().siblings().hide();$(".save-config,.canel-config").show();$(".tab-content:eq(1) .table-name").text(tableIdObj.tableName);$(".table-config-panel").show().next().hide();$(".row-config-panel .model-content,.column-config-panel .model-content").hide().next().show();$(".table-attr .attributes-list,.column-attr .attributes-list,.row-attr .attributes-list,.cell-attr .attributes-list").empty();getConfigData.getBudgetTableDetailByTableId(tableIdObj.tableId,$('#createConfigTableDiv'));getConfigData.getTableConfig("",tableIdObj);getConfigData.cellEventFun()},createAttrList:function(obj,configData,haveVal){var attrLength=$(obj).find('.attributes-list').find(".box-row").length;var tableTest=$(obj).find(".attributes-list").attr("table-test");var attrDoc='<div class="box-row"><div class="box-content box-lable" style="letter-spacing: 1px;">'+(tableTest?tableTest:'引用字典/预算属性：')+'</div><div class="box-content box-content-read" style="position: relative;"><select name="" class="yt-select attributes"></select></div>'+(haveVal?('<div class="box-content box-lable1">字典编码：</div><div class="box-content box-lable2"><input type="text" value="" class="yt-input word-code" style="width: 130px;"/><select  name="" class="yt-select word-num-sel" placeholder="请选择"></select><span class="valid-font" style="top:35px;"></span><input type="hidden" class="hid-word-code" value=""></input></div>'):"")+'<div class="box-content box-button"><a onclick="getConfigData.attrEvent(this)" class="yt-link add-attr" ><img src="'+getConfigData.addIconUrl+'"/></a><a onclick="getConfigData.attrEvent(this)" style="margin-left: 30px;" class="yt-link del-attr"><img src="'+getConfigData.delIconUrl+'"/></a></div></div>';attrDoc=$(attrDoc);attrDoc.find(".yt-select.attributes").change(function(){var selData=$(this).find("option:selected").data("opData");if($(this).val()=="0"){$(this).parent().next().next().find("input.word-code").removeAttr("validform");$(this).parent().next().next().find("select.word-num-sel").removeAttr("validform")}else{$(this).parent().next().next().find("input.word-code").attr("validform","{isNull:true,msg:'请输入编码'}");$(this).parent().next().next().find("select.word-num-sel").attr("validform","{isNull:true,changeFlag:true,msg:'请选择编码'}")}if(selData&&selData.type.toUpperCase()=="SELECT"){var thisPar=attrDoc.parent().parent();if(!thisPar.hasClass("column-attr")&&!thisPar.hasClass("row-attr")&&!thisPar.hasClass("cell-attr")){var searchImg='<img src="../../../../../resources-sasac/images/common/search.png" class="search-img"/>';attrDoc.find(".box-button img.search-img").remove();attrDoc.find(".box-button a:eq(0)").before(searchImg);attrDoc.find(".box-button").css("width","105px")}getConfigData.selectCode(attrDoc);attrDoc.find(".word-code").hide();attrDoc.find(".word-num-sel").show();getConfigData.getSelValData(attrDoc);attrDoc.find("input.word-code").removeAttr("validform")}else{attrDoc.find(".word-code").unbind();attrDoc.find(".search-img").remove();attrDoc.find(".word-code").show();attrDoc.find(".word-num-sel").hide().empty().removeAttr("validform");attrDoc.find("input.word-code").attr("validform","{isNull:true,msg:'请输入编码'}")}$(this).parent().next().next().find("input").val("")});$(obj).find('.attributes-list').append(attrDoc);getConfigData.getAttrList(attrDoc.find(".yt-select.attributes"),configData?configData.property:"");attrDoc.find(".yt-select.attributes").niceSelect();var selAttrData=attrDoc.find("select.attributes option:selected").data("opData");if(selAttrData&&selAttrData.type!=undefined&&selAttrData.type.toUpperCase()=="INPUT"){attrDoc.find(".word-code").show();attrDoc.find(".word-code").val(configData.disValue);attrDoc.find(".hid-word-code").val(configData.value);attrDoc.find(".word-num-sel").hide().empty().removeAttr("validform")}else{getConfigData.selectCode(attrDoc);if(attrDoc.find("select.attributes").val()=="0"){attrDoc.find("select.word-num-sel").niceSelect({search:true,backFunction:function(text){attrDoc.find("select.word-num-sel").html('');attrDoc.find("select.word-num-sel").append('<option value="">请选择</option>')}});}else{getConfigData.getSelValData(attrDoc,configData)}}},attrEvent:function(obj){var operImgUrl="";if($(obj).hasClass("add-attr")){var thisPar=$(obj).parent().parent().parent().parent();var isAttFlag="";if(!thisPar.hasClass("column-attr")&&!thisPar.hasClass("row-attr")&&!thisPar.hasClass("cell-attr")){isAttFlag="t"}getConfigData.createAttrList($(obj).parent().parent().parent().parent(),null,isAttFlag)}else{var thisBoxLen=$(obj).parents(".attributes-list").find(".box-row").length;if(thisBoxLen!=1){$(obj).parent().parent().remove()}else{$yt_alert_Model.prompt("请至少保留一条预算属性",2000)}}},initWordNumData:function(codeDatas,attrDoc,configData){var numOptions='<option value="">请选择</option>';attrDoc.find("select.word-num-sel").empty();if(codeDatas.length>0&&codeDatas!=undefined&&codeDatas!=null){$.each(codeDatas,function(i,n){if(configData&&configData.value==n.code){numOptions+='<option value="'+n.code+'" selected="selected" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}else{numOptions+='<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}});attrDoc.find("select.word-num-sel").append(numOptions)}attrDoc.find("select.word-num-sel").niceSelect({search:true,backFunction:function(text){attrDoc.find("select.word-num-sel").html('');if(text==""){attrDoc.find("select.word-num-sel").append('<option value="">请选择</option>')}if(codeDatas!=""&&codeDatas.length>0){$.each(codeDatas,function(i,n){if(n.name.indexOf(text)!=-1){attrDoc.find("select.word-num-sel").append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}else if(n.code.indexOf(text)!=-1){attrDoc.find("select.word-num-sel").append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}})}}});},getSelValData:function(obj,configData){var configdatas="";var opData=$(obj).find("select.attributes option:selected").data("opData");var wordKey='';$.ajax({type:"post",url:$yt_option.base_path+opData.url,async:false,data:{pageIndex:1,pageNum:9999,pageSize:10,params:wordKey},success:function(data){var datas=data.data.rows;if(data.flag==0){if(datas.length>0){configdatas=datas;getConfigData.initWordNumData(datas,obj,configData)}}}});return configdatas},getAttrList:function(ele,selectData){var filterState=false;var optionStr='';if(ele.parents(".row-config-panel").length>0){filterState=true;var tableConfig=$(".table-config-panel .table-name").data("tableConfig");if(tableConfig.r){optionStr+=',';$.each(tableConfig.r,function(i,n){optionStr+=n.code+','})}}else if(ele.parents(".column-config-panel").length>0){filterState=true;var tableConfig=$(".table-config-panel .table-name").data("tableConfig");if(ele.parents(".column-config-panel").find(".hid-flag").val()=="cr"){if(tableConfig.cr){optionStr+=',';$.each(tableConfig.cr,function(i,n){optionStr+=n.code+','})}}else{if(tableConfig.c){optionStr+=',';$.each(tableConfig.c,function(i,n){optionStr+=n.code+','})}}}$(ele).empty();if(selectData=="0"||selectData==undefined||selectData==""){$(ele).parent().next().next().find("input").removeAttr("validform")}var selParent=$(ele).parent().parent();var searchImg='<img src="../../../../../resources-sasac/images/common/search.png" class="search-img"/>';var notChangeDict=[];var aowChangeDoctList=[];if(getConfigData.codeList==null){$.ajax({type:"post",url:"budget/table/getDictList",async:false,success:function(data){if(data.flag==0){var option=$('<option value="0">请选择</option>');$(ele).append(option);$.each(data.data,function(i,n){if(filterState){if(optionStr.indexOf(n.code)>=0){if(selectData==n.code){option=$('<option value="'+n.code+'" selected="selected">'+n.name+'</option>');if(n.type.toUpperCase()=="SELECT"){selParent.find(".box-button img.search-img").remove();selParent.find(".box-button a:eq(0)").before(searchImg);selParent.find(".box-button").css("width","105px")}}else{if(n.isChange==1){option=$('<option value="'+n.code+'">'+n.name+'</option>');aowChangeDoctList.push(n)}else{notChangeDict.push(n)}}option.data("opData",n);$(ele).append(option)}}else{if(selectData==n.code){option=$('<option value="'+n.code+'" selected="selected">'+n.name+'</option>');if(n.type.toUpperCase()=="SELECT"&&$(ele).parents(".attributes-list").parent().hasClass("table-attr")){selParent.find(".box-button img.search-img").remove();selParent.find(".box-button a:eq(0)").before(searchImg);selParent.find(".box-button").css("width","105px")}}else{if(n.isChange==1){option=$('<option value="'+n.code+'">'+n.name+'</option>');aowChangeDoctList.push(n)}else{notChangeDict.push(n)}}option.data("opData",n);$(ele).append(option)}});getConfigData.codeList=data.data;getConfigData.notChangeDoctList=notChangeDict;getConfigData.aowChangeDoctList=aowChangeDoctList}}})}else{var option=$('<option value="0">请选择</option>');$(ele).append(option);$.each(($(ele).parents('.table-attr').length>0)?getConfigData.aowChangeDoctList:getConfigData.codeList,function(i,n){if(filterState){if(optionStr.indexOf(n.code)>=0){if(selectData==n.code){option=$('<option value="'+n.code+'" selected="selected">'+n.name+'</option>');if(n.type.toUpperCase()=="SELECT"){selParent.find(".box-button img.search-img").remove();selParent.find(".box-button a:eq(0)").before(searchImg);selParent.find(".box-button").css("width","105px")}}else{option=$('<option value="'+n.code+'">'+n.name+'</option>')}option.data("opData",n);$(ele).append(option)}}else{if(selectData==n.code){option=$('<option value="'+n.code+'" selected="selected">'+n.name+'</option>');if(n.type.toUpperCase()=="SELECT"&&$(ele).parents(".attributes-list").parent().hasClass("table-attr")){selParent.find(".box-button img.search-img").remove();selParent.find(".box-button a:eq(0)").before(searchImg);selParent.find(".box-button").css("width","105px")}}else{option=$('<option value="'+n.code+'">'+n.name+'</option>')}option.data("opData",n);$(ele).append(option)}})}},selectCode:function(obj){$(obj).find(".search-img").unbind('click').bind("click",function(){if($(obj).find("select.attributes").val()=="0"){$yt_alert_Model.prompt("请选择引用字典/预算属性");return false}$(obj).find(".search-img").parent().prev().find(".word-num-sel").addClass("select-code");sysCommon.showModel($("#code-list"));$("#code-list .yt-search-btn").prev().val("");getConfigData.getCodeList(obj)});$("#code-list .yt-search-btn").prev().unbind().bind("keydown",function(e){if(e.keyCode==13){var thiObj=$("select.word-num-sel.select-code").parent().parent();getConfigData.getCodeList(thiObj)}});$("#code-list .yt-search-btn").unbind().bind("click",function(){var thiObj=$("select.word-num-sel.select-code").parent().parent();getConfigData.getCodeList(thiObj)})},getCodeList:function(obj,isSel){var opData=$(obj).find("select.attributes option:selected").data("opData");var wordKey=$("#code-list .yt-search-btn").prev().val();$('.page1').pageInfo({pageIndex:1,pageNum:15,pageSize:10,url:$yt_option.base_path+opData.url,type:"post",data:{params:wordKey},objName:'data',success:function(data){var datas=data.data.rows;var htmlTbody=$('.code-list .yt-tbody');htmlTbody.empty();var trStr="";if(data.flag==0){if(datas.length==0){$('.page1').hide();htmlTbody.append(getConfigData.noDataTrStr(2))}else{getConfigData.wordNumDatas=datas;$.each(datas,function(i,n){htmlTbody.append('<tr> <td>'+n.code+'</td> <td>'+n.name+'</td> </tr>')})}}},isSelPageNum:true })},noDataTrStr:function(trNum){var noDataStr='<tr style="border:0px;background-color:#fff !important;"><td  colspan="'+trNum+'" align="center"style="border:0px;"><div class="no-data" style="width: 280px;margin: 0 auto;"><img src="../../../../../resources-sasac/images/common/no-data.png" alt=""></div></td></tr>';return noDataStr},getcolumConfig:function(configBtn,type){var formData={};formData.type=type;var panleDoc;var val="";val=tableIdObj.tableId;formData.tableId=val;val="";formData.name=val;var tableCongfigId="";formData.crNum="";if(type=="r"){panleDoc=$(".row-config-panel");val=$(".row-config-panel").find(".row-num").text();tableCongfigId=$(".row-config-panel").find(".hid-config-id").val();formData.crNum="r"+val}else{panleDoc=$(".column-config-panel");val=$(".column-config-panel").find(".column-num").text();tableCongfigId=$(".column-config-panel").find(".hid-config-id").val();if(type=="cr"){formData.crNum="c"+val+"-r"+$(".column-config-panel").find(".row-num").text()}else{formData.crNum="c"+val}}formData.orderNum=val;formData.tableCongfigId=tableCongfigId;val=$(".property-model .yt-radio.check input").val();formData.calcItem=val;formData.editorItem=val;val=panleDoc.find(".formual input").val();formData.calcValue=val;formData.propertyList=[];formData.propertyListJson="";var propertyListJson="";var promptState=false;var value="";var disValue="";var formVal={};panleDoc.find(".attributes-list .box-row").each(function(i,n){if($(n).find("select.attributes").val()!="0"){if($(n).find("input.word-code").is(":hidden")){if($(n).find("select.word-num-sel").val()!=""&&$(n).find("select.word-num-sel").val()!=null){disValue=$(n).find("select.word-num-sel option:selected").attr("sel-val");value=$(n).find("select.word-num-sel").val()}}else{disValue=$(n).find("input.word-code").val();value=$(n).find(".hid-word-code").val()}formVal={property:$(n).find("select.attributes").val(),value:(value==""?disValue:value),disValue:disValue};formData.propertyList.push(formVal)}});if(formData.propertyList.length>0&&formData.propertyList!=null){formData.propertyListJson=JSON.stringify(formData.propertyList)}if($yt_valid.validForm(panleDoc)){getConfigData.configDatas=formData;configBtn.data("configData",formData).addClass("rtest");return true}else{getConfigData.configDatas=false;return false}},setFormData:function(obj,parent){var configData="";var configData=$(obj).data("configData");if(configData){if(configData.calcItem==1||configData.calcItem==4){$(".property-val-model").show();$(parent).find(".formual").css("display","table-cell");if(configData.calcItem==4){$(parent).find(".formual input").css("cursor","pointer").attr("readonly","readonly");$(parent).find(".formual input").click(function(){tableRelaCalcuObj.calcuTableInit($(parent).find(".formual input"))})}$(parent).find(".formual input").val(configData.calcValue).attr("validform","{isNull:true,blurFlag:true,msg:'请输入计算公式'}");}else{$(".property-val-model").hide()}$(parent).find('.property-model .yt-radio input[value="'+configData.calcItem+'"]').setRadioState("check");if(configData.propertyList.length>0){$.each(configData.propertyList,function(i,n){getConfigData.createAttrList($(parent),n,true)})}else{getConfigData.createAttrList($(parent),null,true)}$(parent).find(".hid-config-id").val(configData.id)}else{getConfigData.createAttrList($(parent),null,true);$(parent).find(".hid-config-id").val('')}},getTableConfig:function(tableDoc,configData){$.ajax({type:"post",url:"budget/table/getTableFilterMapByParams",async:false,data:{"tableId":configData.tableId},success:function(data){if(data.flag==0){$(".table-config-panel .table-name").data("tableConfig",data.data);var notChangeDistList=[];if(data.data.t){$.each(data.data.t,function(i,n){n.property=n.code;if(n.isChange==1){getConfigData.createAttrList($(".table-attr"),n,true)}else{notChangeDistList.push(n)}});if($('.table-attr .attributes-list .box-row').length<=0){getConfigData.createAttrList($(".table-attr"),null,true)}getConfigData.notChangeDistList=notChangeDistList}else{getConfigData.createAttrList($(".table-attr"),null,true)}if(data.data.r){$.each(data.data.r,function(i,n){n.property=n.code;getConfigData.createAttrList($(".row-attr"),n)})}else{getConfigData.createAttrList($(".row-attr"),null)}if(data.data.c){$.each(data.data.c,function(i,n){n.property=n.code;getConfigData.createAttrList($(".column-attr"),n)})}else{getConfigData.createAttrList($(".column-attr"),null)}if(data.data.cr){$.each(data.data.cr,function(i,n){n.property=n.code;getConfigData.createAttrList($(".cell-attr"),n)})}else{getConfigData.createAttrList($(".cell-attr"),null)}}}});getConfigData.getConfigDataList(configData);if(getConfigData.aowChangeDoctList.length>0){getConfigData.setNotChangeDict()}},getConfigDataList:function(configData){$.ajax({type:"post",url:"budget/table/getTableAllCongfigByTableId",data:configData,async:false,success:function(data){if(data.flag==0){if(data.data.length>0){$.each(data.data,function(i,n){if(n.type=="r"){$(".rule-table tbody tr .indicate").eq(n.orderNum-1).data("configData",n);$(".rule-table tbody .indicate").each(function(){if($(this).text()==n.crNum.toUpperCase()){$(this).addClass("config-th-sty")}})}else if(n.type=="cr"){var crNum=n.crNum.split("-");var configIndex=$(".rule-table .indicate-head .no-th-sty").length;var tdNum="";$(".rule-table tbody tr .indicate").each(function(i,r){if(crNum[1].toUpperCase()==$(this).text()){tdNum=crNum[0].charAt(1,1);var tickImg='<img src="../../../../../resources-sasac/images/common/config.png" alt="" class="tick-img">';var tdObj=$(r).parent().find('td').eq(tdNum-1).data("crConfigData",n).html(tickImg)}})}else{$(".rule-table .indicate-head .indicate").eq(n.orderNum-1).data("configData",n);$(".rule-table .indicate-head .indicate").each(function(){if($(this).text()==n.crNum.toUpperCase()){$(this).addClass("config-th-sty")}})}})}}else{$yt_alert_Model.prompt(data.message,2000)}}})},cellEventFun:function(){$(".rule-table tbody tr:not(.flag-tr) td:not(.config-btn,.config-th-sty,.no-cell,.dis)").click(function(){$(".rule-table tr th").removeClass("select-btn");$yt_common.eventStopPageaction();$(".rule-table tbody tr").removeClass("tr-shadow");$(".rule-table tbody td").removeClass("td-shadow cell-shadow").removeAttr("style");$(this).addClass("cell-shadow");$(".column-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','south');$(".row-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','east');var cellTdConfig=$('.rule-table .indicate-head th:eq('+$(this).index()+')').data("configData");var cellRowCofnig=$(this).parent().find(".indicate").data("configData");var cellTdText=$('.rule-table .indicate-head th:eq('+$(this).index()+')').text();var cellRowText=$(this).parent().find(".indicate").text();var configIndex=$('.rule-table .indicate-head .indicate:eq(0)').index();var cellTdName=$(".rule-table").find(".column-name"+($(this).index()-configIndex+1)).text();var thisCell=$(this);$('#config-layout').layout('panel','south').panel({title:'单元格的配置'});if($('#config-layout').layout('panel','south').is(":hidden")){$('#config-layout').layout('expand','south')}var configDoc=$(".column-config-panel");getConfigData.addBotConfigHtml("cell");configDoc.find(".model-content,.config-btngroup").show();$(".column-config-panel .no-select-table").hide();configDoc.find(".formual").hide().find("input").removeClass("valid-hint").val('').removeAttr("validform").next().html('');configDoc.find(".property-model .yt-radio:eq(0) input").setRadioState("check");configDoc.find(".property-val-model").hide();$(".column-config-panel .attributes-list").empty();var tableData=tableIdObj;configDoc.find(".table-name").text(tableData.tableName);var configIndex=$(".select-table .config-thead .config-btn:eq(0)").index();var valText=thisCell.index();var configData=thisCell.data("crConfigData");configDoc.find(".column-num").text(valText);configDoc.find(".row-num").text(thisCell.parent().index()+1);if(configData){if(configData.calcItem==1||configData.calcItem==4){$(".property-val-model").show();if(configData.calcItem==4){$(configDoc).find(".formual input").css("cursor","pointer").attr("readonly","readonly");$(configDoc).find(".formual input").click(function(){var configSelCell=cellTdText.toLocaleLowerCase()+cellRowText.toLocaleLowerCase();tableRelaCalcuObj.calcuTableInit($(configDoc).find(".formual input"),configSelCell)})}configDoc.find(".formual").css("display","table-cell");configDoc.find(".formual input").val(configData.calcValue).attr("validform","{isNull:true,blurFlag:true,msg:'请输入计算公式'}")}else{$(".property-val-model").hide()}configDoc.find('.property-model .yt-radio').removeClass("check");configDoc.find('.property-model .yt-radio input[value="'+configData.calcItem+'"]').parent().addClass("check");configDoc.find('.property-model .yt-radio input[value="'+configData.calcItem+'"]').prop("checked",true);if(configData.propertyList.length>0){$.each(configData.propertyList,function(i,n){getConfigData.createAttrList(configDoc,n,true)})}else{getConfigData.createAttrList(configDoc,null,true)}configDoc.find(".hid-config-id").val(configData.id)}else{configDoc.find(".hid-config-id").val('');getConfigData.createAttrList(configDoc,null,true)}})},addBotConfigHtml:function(flag){$(".column-config-panel .no-select-table").nextAll().remove();var htmlStr='<div class="model-content dn"><input type="hidden" class="hid-config-id" value=""/>';if(flag=="c"){htmlStr+='<div class="box-row">'+'<div class="box-content box-lable1" style=""><span style="letter-spacing: 15px;">所属</span>表：</div><div class="box-content table-name"></div><div class="box-content box-lable" style="width: 150px !important;">行或列：</div><div class="box-content box-content-read" style="width: 150px !important;">列</div><div class="box-content box-lable1">列号：</div><div class="box-content column-num"></div></div>'}else{htmlStr+='<div class="box-row"><div class="box-content box-lable1" style="width: 90px;"><span style="letter-spacing: 15px;">所属</span>表：</div><div class="box-content table-name"></div><div class="box-content box-lable1" style="width:90px;">列号：</div><div class="box-content column-num"></div><div class="box-content box-lable1" style="width:90px;">行号：</div><div class="box-content row-num"></div></div>'}htmlStr+='<div class="box-row"><div class="box-content box-lable" style="float: left;display: inline;">属性：</div><div class="property-model"><label class="check-label yt-radio check"><input id="radio1" type="radio" name="property"  value="3"/>数字 </label><label class="check-label yt-radio"><input id="radio1" type="radio" name="property"  value="2"/>文本</label><label class="check-label yt-radio"><input id="radio1" type="radio" name="property"  value="1"/>单表</label><label class="check-label yt-radio"><input id="radio1" type="radio" name="property"  value="4"/>表间</label></div></div><div class="box-row property-val-model" style="display: none;"><div class="box-content box-lable1 formual dn" style="width: 132px;"><span class="not-null">*</span><span class="letter6">计算公</span>式：</div><div class="box-content formual dn"><input class="yt-input formula-inpu" type="text" value="" /><span class="valid-font" style="top: 32px;"></span></div></div><div style="clear: both;"></div><div class="attributes-list"></div></div>';htmlStr+='<div class="config-btngroup" style="padding-bottom: 0px;"><button class="yt-option-btn yt-common-btn tb-save-btn">保存<input type="hidden" class="hid-flag" value="'+(flag=="c"?"c":"cr")+'"/></button><button class="yt-option-btn yt-cancel-btn r-cancel-btn">取消</button></div>';$(".column-config-panel").append(htmlStr);getConfigData.rowTdCellConfigBtnEvent()},rowTdCellConfigBtnEvent:function(){$(".config-btngroup .tb-save-btn").attr('disabled',false).off('click').on('click',function(){var configFlag=$(this).find(".hid-flag").val();if(configFlag=="c"){getConfigData.getcolumConfig($(".config-table.select-table .config-thead .config-btn.select-btn"),"c")}else if(configFlag=="cr"){getConfigData.getcolumConfig($(".config-table.select-table .config-thead .config-btn.select-btn"),"cr")}else{getConfigData.getcolumConfig($(".config-table.select-table tbody tr .config-btn.select-btn"),"r")}var tableId=tableIdObj.tableId;var datas="";if(getConfigData.configDatas){datas=getConfigData.configDatas;$.ajax({type:"post",url:"budget/table/saveTableCongfigDetail",async:false,data:getConfigData.configDatas,success:function(data){if(configFlag=="c"||configFlag=="cr"){$(".column-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','south');$(".column-config-panel .formula-inpu").val('')}else{$(".row-config-panel .model-content").hide().next().show();$('#config-layout').layout('collapse','east');$(".row-config-panel .formula-inpu").val('')}$(".select-table tr").removeClass("tr-shadow");$(".select-table td").removeClass("td-shadow cell-shadow").removeAttr("style");$yt_alert_Model.prompt("配置成功");var configTab=$("#table-list .table-active");getConfigData.getConfigDataList(tableIdObj);$(".config-btngroup .tb-save-btn").attr('disabled',true).unbind('click');setTimeout(function(){getConfigData.rowTdCellConfigBtnEvent()},2000);$(".rule-table tr th").removeClass("select-btn")},error:function(data){$yt_alert_Model.prompt("网络异常请稍后重试")}})}});$(".config-btngroup .r-cancel-btn").off('click').on('click',function(){var typeFlag=$(this).prev().find(".hid-flag").val();var panelFlag="";if(typeFlag=="c"||typeFlag=="cr"){panelFlag=$(".column-config-panel");panelFlag.find(".model-content,.config-btngroup").remove();panelFlag.find(".no-select-table").show();$('#config-layout').layout('collapse','south');$(".select-table td").removeClass("td-shadow cell-shadow").removeAttr("style")}else{panelFlag=$(".row-config-panel");$('#config-layout').layout('collapse','east');panelFlag.find(".model-content").hide().next().show();$(".select-table tr").removeClass("tr-shadow")}panelFlag.find(".config-btngroup").hide();panelFlag.find(".model-content input:not(.yt-radio input)").val('');panelFlag.find(".model-content select").niceSelect();panelFlag.find(".yt-radio input:eq(0)").setRadioState("check");$(".rule-table tr th").removeClass("select-btn")});$(".property-model .yt-radio input").off('change').on('change',function(){var thisVal=$(this).val();if(thisVal==1||thisVal==4){var thisInput=$(this).parents(".model-content").find(".formual").find("input");var thisObj="";thisObj=$("#createConfigTableDiv table.rule-table th.select-btn").data("configData");if(thisObj==undefined||thisObj==null){thisObj=$("#createConfigTableDiv table.rule-table td.cell-shadow").data("crConfigData")}if(thisObj&&thisObj.calcItem==thisVal){$(thisInput).val(thisObj.calcValue)}else{$(thisInput).val("")}$(".property-val-model").show();$(this).parents(".model-content").find(".formual").css("display","table-cell");if(thisVal==4){$(thisInput).css("cursor","pointer").attr("readonly","readonly");$(thisInput).off().on("click",function(){tableRelaCalcuObj.calcuTableInit($(thisInput))})}else{$(thisInput).off("click").css("cursor","default").removeAttr("readonly")}$(this).parents(".model-content").find(".formual").find("input").attr("validform","{isNull:true,blurFlag:true,msg:'请输入计算公式'}");$(this).parents(".model-content").find("select.word-num-sel").removeAttr("validform");$(this).parents(".model-content").find("select.word-num-sel").removeAttr("validform")}else{$(this).parents(".model-content").find(".formual").css("display","none");$(this).parents(".model-content").find(".formual").find("input").removeAttr("validform");$(".property-val-model").hide()}})},getUnitOpts:function(code){$.ajax({type:"post",url:$yt_option.base_path+'/budget/table/getBudgetClassifyDataByParams?tableKey=coso_classify_unit_main',async:false,data:{pageIndex:1,pageNum:9999,pageSize:10,params:''},success:function(data){var datas=data.data.rows;if(data.flag==0){var numOptions='<option value="">请选择</option>';$('#unitCode').empty();if(datas.length>0&&datas!=undefined&&datas!=null){$.each(datas,function(i,n){if(code&&code==n.code){numOptions+='<option value="'+n.code+'" selected="selected" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}else{numOptions+='<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>'}});$('#unitCode').append(numOptions)}$('#unitCode').niceSelect({search:true,backFunction:function(text){$('#unitCode').html('');if(text==""){$('#unitCode').append('<option value="">请选择</option>')}if(datas!=""&&datas.length>0){$.each(datas,function(i,n){if(n.name.indexOf(text)!=-1){$('#unitCode').append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}else if(n.code.indexOf(text)!=-1){$('#unitCode').append('<option value="'+n.code+'" sel-val="'+n.name+'">'+n.code+' '+n.name+'</option>')}})}}})}}})},getUnitCodeList:function(){},getBudgetTableDetailByTableId:function(tableId,creatTableAreaObj){$.ajax({type:'post',url:'budget/table/getBudgetTableDetailByTableId',async:false,data:{tableId:tableId},success:function(data){var dataObj=data.data||{};$(creatTableAreaObj).newRuleTable({theads:dataObj.theads,tbodys:dataObj.tbodys,propertyList:dataObj.propertyList,eventCheck:false,serialNumber:true});var propertyList=dataObj.propertyList;for(var i=0,len=propertyList.length;i<len;i+=1){var proper=propertyList[i];var index=proper.crNum.replace(proper.type,'');if(proper.type=='c'){$(creatTableAreaObj).find('.rule-table .indicate-head tr .indicate').eq(index-1).addClass('dis');$(creatTableAreaObj).find('.rule-table .yt-tbody tr').each(function(){$(this).find('td').eq(index-1).addClass('dis')})}else if(proper.type=='r'){$(creatTableAreaObj).find('.rule-table .yt-tbody tr').eq(index-1).find('td,th').addClass('dis')}}$('.rule-table').data('tableData',dataObj)}})},setNotChangeDict:function(list){var html='';$('.attributes-list-append').html('');var notChangeDistList=getConfigData.notChangeDistList||[];var notDist={};for(var i=0;i<notChangeDistList.length;i+=1){notDist[notChangeDistList[i].code]=notChangeDistList[i]}var notChangeDoctList=getConfigData.notChangeDoctList||[];var notDoct={};for(var j=0;j<notChangeDoctList.length;j+=1){notDoct[notChangeDoctList[j].code]=notChangeDoctList[j]}for(n in notDoct){if(notDist[n]){n=notDist[n];if(n.type=='SELECT'){html=$('<div class="box-row unit-code-row"><div class="box-content" style="letter-spacing: 1px;padding-left: 14px;">'+n.name+'：</div><div class="box-content box-lable2"><select name="" class="attributes" id="" style="display: none;"><option value="'+n.code+'">'+n.name+'</option></select><select name="" class="yt-select word-num-sel" id="" code="'+n.code+'" placeholder="请选择" validform="{isNull:true,changeFlag:true,msg:\'请选择'+n.name+'\'}"><option value="" selected="selected"></option></select><input type="hidden" class="hid-word-code" value=""><span class="valid-font" style="top:35px;"></span></div><div class="box-content box-button"><img src="../../../../../resources-sasac/images/common/search.png" class="search-img unit-code-search"></div></div>');html.find('select.attributes').html($('<option value="'+n.code+'">'+n.name+'</option>').data('opData',n));$('.attributes-list-append').append(html);getConfigData.setNotChangeSelectOption(html,n)}else if(n.type=='INPUT'){html=$('<div class="box-row"><div class="box-content" style="letter-spacing: 1px;padding-left: 14px;">'+n.name+'：</div><div class="box-content"><select name="" class="attributes" id="" style="display: none;"><option value="'+n.code+'">'+n.name+'</option></select><input type="text" value="'+(n.disValue?n.disValue:'')+'" code="'+n.code+'" class="yt-input word-code" id="" style="width: 130px; display: inline-block;" validform="{isNull:true,blurFlag:true,msg:\'请输入'+n.name+'\'}"><input type="hidden" class="hid-word-code" value=""><span class="valid-font" style="top:35px;"></span></div></div>');html.find('select.attributes').html($('<option value="'+n.code+'">'+n.name+'</option>').data('opData',notDist[n.code]));$('.attributes-list-append').append(html)}}else{n=notDoct[n];if(n.type=='SELECT'){html=$('<div class="box-row unit-code-row"><div class="box-content" style="letter-spacing: 1px;padding-left: 14px;">'+n.name+'：</div><div class="box-content box-lable2"><select name="" class="attributes" id="" style="display: none;"><option value="'+n.code+'">'+n.name+'</option></select><select name="" class="yt-select word-num-sel" id="" code="'+n.code+'" placeholder="请选择" validform="{isNull:true,changeFlag:true,msg:\'请选择'+n.name+'\'}"><option value="" selected="selected"></option></select><input type="hidden" class="hid-word-code" value=""><span class="valid-font" style="top:35px;"></span></div><div class="box-content box-button"><img src="../../../../../resources-sasac/images/common/search.png" class="search-img unit-code-search"></div></div>');html.find('select.attributes').html($('<option value="'+n.code+'">'+n.name+'</option>').data('opData',n));$('.attributes-list-append').append(html);getConfigData.setNotChangeSelectOption(html,n)}else if(n.type=='INPUT'){html=$('<div class="box-row"><div class="box-content" style="letter-spacing: 1px;padding-left: 14px;">'+n.name+'：</div><div class="box-content"><select name="" class="attributes" id="" style="display: none;"><option value="'+n.code+'">'+n.name+'</option></select><input type="text" value="'+(n.disValue?n.disValue:'')+'" code="'+n.code+'" class="yt-input word-code" id="" style="width: 130px; display: inline-block;" validform="{isNull:true,blurFlag:true,msg:\'请输入'+n.name+'\'}"><input type="hidden" class="hid-word-code" value=""><span class="valid-font" style="top:35px;"></span></div></div>');html.find('select.attributes').html($('<option value="'+n.code+'">'+n.name+'</option>').data('opData',n));$('.attributes-list-append').append(html)}}}},setNotChangeSelectOption:function(obj,opData){var selData=opData;var attrDoc=obj;if(selData&&selData.type.toUpperCase()=="SELECT"){var thisPar=attrDoc.parent().parent();getConfigData.selectCode(attrDoc);attrDoc.find(".word-code").hide();attrDoc.find(".word-num-sel").show();getConfigData.getSelValData(attrDoc,opData);attrDoc.find("input.word-code").removeAttr("validform")}else{attrDoc.find(".word-code").unbind();attrDoc.find(".search-img").remove();attrDoc.find(".word-code").show();attrDoc.find(".word-num-sel").hide().empty().removeAttr("validform");attrDoc.find("input.word-code").attr("validform","{isNull:true,msg:'请输入编码'}")}}};var tableRelaCalcuObj={calcuTableInit:function(thisInput,configSelCell){setInteractive();$(".table-rela-model").show();$("#calcuInput").val($(thisInput).val());tableRelaCalcuObj.calInputEvent();tableRelaCalcuObj.allDivClick();tableRelaCalcuObj.getPropertyTabInfo();$("#tableTemplate").css({"width":$(window).width()+"px","height":($(window).height()-120)+"px"});$(window).resize(function(){$("#tableTemplate").css({"width":$(window).width()+"px","height":($(window).height()-120)+"px"})});$("body").on('selectstart',function(){return false});$("body").on('contextmenu',function(e){e.preventDefault()});$("button.calcu-sure-btn").click(function(){var validFlag=true;if($("#calcuInput").val()==""){$yt_alert_Model.prompt("请完善计算公式!");validFlag=false;return false}else if(configSelCell&&configSelCell!=undefined&&configSelCell!=null){var calcuVal=$("#calcuInput").val();var calValuArr=calcuVal.replace(/[~'/<>@#$%^&*()-+_=:]/g,",");calValuArr=calValuArr.split(",");$.each(calValuArr,function(i,n){if(configSelCell==n){$yt_alert_Model.alertOne({haveCloseIcon:true,leftBtnName:"确定",cancelFunction:"",alertMsg:"计算公式中出现了相同表格的同一个单元格信息,请检查!",cancelFunction:function(){}});validFlag=false;return false}})}if(validFlag){$(thisInput).val($("#calcuInput").val());$(".table-rela-model").hide();$("#calcuInput").val('')}});$("button.calcu-close-btn").click(function(){$(".table-rela-model").hide();$("#calcuInput").val('')});$(".clear-lab").click(function(){$("#calcuInput").val('');tableRelaCalcuObj.screenCellsData();$(this).hide()})},getPropertyTabInfo:function(){$.ajax({type:'post',url:'budget/table/getSameAttrTabListByTableId',data:{tableId:tableIdObj.tableId},success:function(data){if(data.flag==0){var contStr="";$("select.attr-table-sel").empty();var optionStr='';if(data.data&&data.data.length>0){$.each(data.data,function(i,n){contStr='<div title="'+n.tableName+'"><input type="hidden" class="hid-table-id" value="'+n.tableId+'"/><input type="hidden" class="hid-table-code" value="'+n.tableCode+'"/></div>';$("#tableTemplate").append(contStr);optionStr+='<option value="'+n.tableId+'">'+n.tableName+'</option>'});$("select.attr-table-sel").append(optionStr);$("select.attr-table-sel").niceSelect();$("select.attr-table-sel").change(function(){var thisSel=$(this);$(".tabs-panels .panel .panel-body input.hid-table-id").each(function(i,n){if($(thisSel).val()==$(n).val()){$('#tableTemplate').tabs("select",$(n).parents(".panel").index());return false}})});$('#tableTemplate').tabs({onSelect:function(title,index){var tableId=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-id").val();var tableCode=$(".tabs-panels .panel").eq(index).find(".panel-body input.hid-table-code").val();var tabIndex=index;var thisSelPanel=$(".tabs-panels .panel").eq(tabIndex).find(".panel-body");getConfigData.getBudgetTableDetailByTableId(tableId,thisSelPanel);$(".tabs-panels .panel").eq(tabIndex).find(".panel-body .tab-table-title").remove();var tableTitle='<div class="tab-table-title">'+tableCode+'--'+title+'</div>';$(".tabs-panels .panel").eq(tabIndex).find(".panel-body table").before(tableTitle);tableRelaCalcuObj.tableRelaCellsEvent();$(thisSelPanel).find(".rule-table tbody tr td:not(.indicate,.dis)").html('<img class="img-def" src="'+configCommonObj.cellImgDef+'"/>');tableRelaCalcuObj.screenCellsData();$('select.attr-table-sel option[value="'+tableId+'"]').attr("selected","selected");$('select.attr-table-sel').niceSelect()}})}}}})},tableRelaCellsEvent:function(){$(".rule-table tbody tr td:not(.indicate,.dis)").on("mousedown",function(e){var me=$(this);var btnNumFlag=e.button;$yt_common.eventStopPageaction();$(".rule-table td").removeClass("cell-shadow");$(this).addClass("cell-shadow");$("img.img-def").css("display","none");$(this).find("img.img-def").css("display","inline-block");tableRelaCalcuObj.cellsImgEvent($(this).find("img.img-def"));var tab=$('#tableTemplate').tabs('getSelected');var tabIndex=$('#tableTemplate').tabs('getTabIndex',tab);var selPanlObj=$(".tabs-panels .panel").eq(tabIndex);var tableCode=selPanlObj.find(".panel-body input.hid-table-code").val();if(btnNumFlag==2){$('#rightButCon .readonly').off().on('click',function(){var validFlag=true;$(selPanlObj).find('table td.cell-check').each(function(){var td=$(this);var tr=td.parent();var c=td.index();var r=tr.index()+1;var cellsVal="";var inputtext=$("#calculationFormula").val();if(tableCode!=tableIdObj.tableCode){cellsVal=tableCode+"!c"+c+"r"+r}else{cellsVal="c"+c+"r"+r}if(!$(".cell-check img").hasClass("img-check")){var inputVal=$("#calcuInput").val();if(inputVal!=""){var selectStartIndex=$("#calcuInput").getSelectionStart()-1;if(0<=selectStartIndex){var regInputVal=inputVal.substr(selectStartIndex,1);var reg=/^[\(\{\[+\-*\/%]+$/i;if(reg.test(regInputVal)){$("#calcuInput").insertInputStr(cellsVal+"+")}else{$yt_alert_Model.prompt("请检查您的计算公式内容,不规范!");validFlag=false}}}else{$("#calcuInput").insertInputStr(cellsVal+"+")}}});if(validFlag){$(".cell-check .img-def").attr("src",configCommonObj.cellImgCheck);$(".cell-check img").removeClass("img-def");$(".cell-check img").addClass("img-check").css("display","inline-block")}});$(".clear-lab").show();rightButConPosition(e);setInterEvent(me,'.yt-tbody','tbody');$("body").one('click',function(){$('#rightButCon').hide()})}else if(btnNumFlag==0){var startTd=$(this);var y=$(this).index();var x=$(this).parent().index();var startIndex={x:x,y:y};$(".rule-table tbody tr td:not(.indicate,.dis)").removeClass('cell-check').on('mouseover',function(){endTd=$(this);var y=$(this).index();var x=$(this).parent().index();var endIndex={x:x,y:y};selectTd(startIndex,endIndex,'td:not(.indicate)','tbody')})}});$("#tableTemplate").on('mouseup','td,th',function(){$("#tableTemplate").find('td,th').off('mouseover')})},cellsImgEvent:function(obj){$(obj).off().on("click",function(){$yt_common.eventStopPageaction();var tab=$('#tableTemplate').tabs('getSelected');var tabIndex=$('#tableTemplate').tabs('getTabIndex',tab);var selPanlObj=$(".tabs-panels .panel").eq(tabIndex);var tdNum=selPanlObj.find(".indicate-head th").eq($(this).parent().index()).text().trim().toLocaleLowerCase();var trNum=$(this).parents("tr").find(".indicate").text().trim().toLocaleLowerCase();var cellsVal="";var tableCode=selPanlObj.find(".panel-body input.hid-table-code").val();if(tableCode!=tableIdObj.tableCode){cellsVal=tableCode+"!"+tdNum+trNum}else{cellsVal=tdNum+trNum}if(!$(this).hasClass("img-check")){var inputVal=$("#calcuInput").val();var selectStartIndex=$("#calcuInput").getSelectionStart()-1;if(0<=selectStartIndex){var regInputVal=inputVal.substr(selectStartIndex,1);var reg=/^[\(\{\[+\-*\/%]+$/i;if(reg.test(regInputVal)){$("#calcuInput").insertInputStr(cellsVal);$(this).attr("src",configCommonObj.cellImgCheck).removeClass("img-def").addClass("img-check")}else{$yt_alert_Model.prompt("请检查您的计算公式内容,不规范!")}}else{$("#calcuInput").insertInputStr(cellsVal);$(this).attr("src",configCommonObj.cellImgCheck).removeClass("img-def").addClass("img-check")}$(".clear-lab").show()}})},calInputEvent:function(){$("#calcuInput").keyup(function(ev){if($(this).val()!=""){$(".clear-lab").show()}var val=this.value;var e=ev||event;var reg=/[^A-Za-z0-9!(){}\[\]+\-*\/%.]+$/i;return this.value=this.value.replace(reg,"")});$("#calcuInput").on("blur",function(){$yt_common.eventStopPageaction();tableRelaCalcuObj.screenCellsData();if($(this).val()!=""){$(".clear-lab").show()}})},screenCellsData:function(){var tab=$('#tableTemplate').tabs('getSelected');var tabIndex=$('#tableTemplate').tabs('getTabIndex',tab);var selPanlObj=$(".tabs-panels .panel").eq(tabIndex);var thisTable=selPanlObj.find("table.rule-table");var tableCode=selPanlObj.find(".panel-body input.hid-table-code").val();if(tableCode!=tableIdObj.tableCode){tableCode=tableCode+"!"}var calcuInpuObj=$("#calcuInput");var cellsObj={};var cellsList=[];var cellTdText="";var cellRowText="";thisTable.find("tbody tr td:not(.indicate,.dis)").each(function(i,n){cellsObj={};cellTdText="";cellRowText="";cellTdText=thisTable.find('.indicate-head th:eq('+$(this).index()+')').text().trim().toLocaleLowerCase();cellRowText=$(this).parent().find(".indicate").text().trim().toLocaleLowerCase();if(tableCode!=tableIdObj.tableCode){$(this).data("cellData",tableCode+cellTdText+cellRowText);cellsObj.cells=tableCode+cellTdText+cellRowText}else{$(this).data("cellData",cellTdText+cellRowText);cellsObj.cells=cellTdText+cellRowText}cellsList.push(cellsObj)});console.log(cellsList);var calValuArr=$(calcuInpuObj).val().replace(/[~'/<>@#$%^&*()-+_=:]/g,",");calValuArr=calValuArr.split(",");console.log(calValuArr);var tempCells=[];$.each(calValuArr,function(i,n){$.each(cellsList,function(v,c){if(n==c.cells){tempCells.push(n)}})});thisTable.find("tbody tr td:not(.cell-shadow) img").hide().removeClass("img-check").addClass("img-def").attr("src",configCommonObj.cellImgDef);thisTable.find("tbody tr td.cell-shadow img").removeClass("img-check").addClass("img-def").attr("src",configCommonObj.cellImgDef);if(tempCells.length>0){$.each(tempCells,function(i,n){$.each(thisTable.find("tbody td:not(.indicate,.dis)"),function(i,t){if(n==$(t).data("cellData")){$(t).find("img").addClass("img-check").removeClass("img-def").attr("src",configCommonObj.cellImgCheck).show()}})})}},allDivClick:function(){$("#tableTemplate").off().on("click",function(){$("#calcuInput").blur(function(){$yt_common.eventStopPageaction();$("#calcuInput").focus()})})}};$.extend($.fn,{getSelectionStart:function(){var e=this[0];if(e.selectionStart){return e.selectionStart}else if(document.selection){e.focus();var r=document.selection.createRange();var sr=r.duplicate();sr.moveToElementText(e);sr.setEndPoint('EndToEnd',r);return sr.text.length-r.text.length}return 0},getSelectionEnd:function(){var e=this[0];if(e.selectionEnd){return e.selectionEnd}else if(document.selection){e.focus();var r=document.selection.createRange();var sr=r.duplicate();sr.moveToElementText(e);sr.setEndPoint('EndToEnd',r);return sr.text.length}return 0},insertInputStr:function(str){$(this).each(function(){var tb=$(this);if(document.selection){var r=document.selection.createRange();document.selection.empty();r.text=str;r.collapse();r.select()}else{var newstart=tb.get(0).selectionStart+str.length;tb.val(tb.val().substr(0,tb.get(0).selectionStart)+str+tb.val().substring(tb.get(0).selectionEnd));tb.get(0).selectionStart=newstart;tb.get(0).selectionEnd=newstart}});return this},setSelection:function(startIndex,len){$(this).each(function(){if(this.setSelectionRange){this.setSelectionRange(startIndex,startIndex+len)}else if(document.selection){var range=this.createTextRange();range.collapse(true);range.moveStart('character',startIndex);range.moveEnd('character',len);range.select()}else{this.selectionStart=startIndex;this.selectionEnd=startIndex+len}});return this},getSelection:function(){var elem=this[0];var sel='';if(document.selection){var r=document.selection.createRange();document.selection.empty();sel=r.text}else{var start=elem.selectionStart;var end=elem.selectionEnd;var content=$(elem).is(':input')?$(elem).val():$(elem).text();sel=content.substring(start,end)}return sel}});function selectTd(startIndex,endIndex,dom,box){var tab=$('#tableTemplate').tabs('getSelected');var tabIndex=$('#tableTemplate').tabs('getTabIndex',tab);var selPanlObj=$(".tabs-panels .panel").eq(tabIndex);var minX=null;var maxX=null;var minY=null;var maxY=null;if(startIndex.x<endIndex.x){minX=startIndex.x;maxX=endIndex.x}else{minX=endIndex.x;maxX=startIndex.x};if(startIndex.y<endIndex.y){minY=startIndex.y;maxY=endIndex.y}else{minY=endIndex.y;maxY=startIndex.y};startIndex={x:minX,y:minY};endIndex={x:maxX,y:maxY};$(selPanlObj).find("td,th").removeClass('cell-check');$(selPanlObj).find('.yt-tbody tr').removeClass('tr-shadow');$(selPanlObj).find('td,th').removeClass('td-shadow');for(var i=minX;i<=maxX;i+=1){var selectTr=$(selPanlObj).find(box).find("tr").eq(i);for(var j=minY;j<=maxY;j+=1){selectTr.find(dom).eq((j-1)).addClass('cell-check')}}}function setInteractive(){var html='<div id="rightButCon" class="right-button-context"><ul><li class="readonly">确定选中</li></ul></div>';html+='<div id="tableInputHolder" class="input-holder"><textarea id="handtableInput" class="hand-input"></textarea></div>';$("body").append(html)}function rightButConPosition(e){var left=e.clientX;var top=e.clientY;console.log(e);var rightButCon=$('#rightButCon');var width=rightButCon.width();var height=rightButCon.height();var w=$(window);var winWidth=w.width();var winHeight=w.height();left=width+left>winWidth?left-width:left;top=height+top>winHeight?top-height:top;rightButCon.show().css({left:left,top:top})}function setInterEvent(obj,site,type){$('#rightButCon .readonly-row:not(.dis)').off().on('click',function(e){var tr=obj;readOnlyRow(tr,type,'before')});$('#rightButCon .readonly-col:not(.dis)').off().on('click',function(e){var tr=obj;readOnlyCol(tr,type,'before')})}
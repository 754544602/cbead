var loanApply={loanId:"",riskExcMark:"../../../../../resources-sasac/images/common/war-red.png",riskWarImg:"../../../../../resources-sasac/images/common/risk-war.png",riskViaImg:"../../../../../resources-sasac/images/common/risk-via.png",init:function(){var requerParameter=$yt_common.GetRequest();loanApply.loanId=requerParameter.loanId;sysCommon.getLoginUserInfo();$("#loanApply select").niceSelect();loanApply.getInitFunDatas();$("#returnDate").calendar({speed:0,complement:true,readonly:true,lowerLimit:"2010/01/01",nowData:false,speed:0,dateFmt:"yyyy-MM-dd",callback:function(){$("#returnDate").parent().find(".risk-img").attr("src",loanApply.riskViaImg);sysCommon.clearValidInfo($("#returnDate"))}});loanApply.loanMoneyEvent();loanApply.funOperationEvent(loanApply.eaa);$("#loanApply").css("min-height",$(window).height()-32);loanApply.events();loanApply.fmMonList();if(loanApply.loanId!=""&&loanApply.loanId!=null){loanApply.getLoanDetailById()};loanApply.getCurrentUserIsSettleInfo()},getCurrentUserIsSettleInfo:function(){$.ajax({type:"post",url:"sz/loanApp/getCurrentUserIsSettleInfo",async:false,data:{},success:function(data){if(data.flag==0){$("#noCloseOut").text(data.data.noCloseOut);$("#loanAppNumStr").text(data.data.loanAppNumStr||'--')}}})},fmMonList:function(){$(".refund-tab-inp").attr("placeholder","0.00");var moneyInpArray=$(".refund-tab-inp");for(j=0;j<moneyInpArray.length;j+=1){if(moneyInpArray.eq(j).val()!=''){moneyInpArray.eq(j).val($yt_baseElement.fmMoney(moneyInpArray.eq(j).val()))}};var moneyTextArray=$(".moneyText");for(h=0;h<moneyTextArray.length;h+=1){if(moneyTextArray.eq(h).text()!=''){moneyTextArray.eq(h).text($yt_baseElement.fmMoney(moneyTextArray.eq(h).text()))}else{moneyTextArray.eq(h).text($yt_baseElement.fmMoney(0))}}},events:function(){var me=this;$('.refund-tab-inp').on('focus',function(){var ts=$(this);if(ts.val()!=""){ts.val($yt_baseElement.rmoney(ts.val()))}});$('.refund-tab-inp').on('blur',function(){var ts=$(this);if(ts.val()!=''){ts.val($yt_baseElement.fmMoney(ts.val()))}});$('.refund-tab-inp').on('keyup',function(){var ts=$(this);if(ts.val()!=''){ts.val(ts.val().replace(/[^\d.]/g,''))}});$('.yt-table tbody').on('click','tr',function(){var ts=$(this);var trs=ts.siblings();trs.removeClass('yt-table-active');ts.addClass('yt-table-active')});$("#cancelBtn").off().on('click',function(){window.history.back(-1)})},getLoanDetailById:function(){$.ajax({type:"post",url:"sz/loanApp/getLoanAppInfoDetailByLoanAppId",async:false,data:{loanAppId:loanApply.loanId},success:function(data){if(data.flag==0){var dataObj=data.data;if(dataObj&&dataObj!=""&&dataObj!=undefined){$("#busiUsers").text(dataObj.applicantUserName);$("#deptName").text(dataObj.applicantUserDeptName);$("#jobName").text(dataObj.applicantUserJobName==""?"--":dataObj.applicantUserJobName);$("#telPhone").text(dataObj.applicantUserPhone==""?"--":dataObj.applicantUserPhone);$("#loanApply").setDatas(dataObj);$("#moneyLower").text(arabiaToChinese(dataObj.loanAmount+''));$("#lifeOfLoan option").each(function(){if($(this).text()==dataObj.loanTerm){$(this).attr("selected",true)}});$("#lifeOfLoan").niceSelect();$('.pay-met input.radio-inpu[value="'+dataObj.paymentMethod+'"]').setRadioState("check");if(dataObj.isSettleInfo){$("#loanAppNumStr").text(dataObj.isSettleInfo.loanAppNumStr||'--');$("#noCloseOut").text(dataObj.isSettleInfo.noCloseOut)}}sysCommon.getApproveFlowData("SZ_LOAN_APP",dataObj.processInstanceId)}else{$yt_alert_Model.prompt(data.message,2000)}}})},getInitFunDatas:function(){$.ajax({type:"post",url:"basicconfig/dictInfo/getDictInfoByTypeCode",async:false,data:{dictTypeCode:"AMOUNT_NATURE"},success:function(data){if(data.flag==0){var optionText='<option value="">请选择</option>';if(data.data.length>0){$.each(data.data,function(i,n){if(n.dictTypeCode=="AMOUNT_NATURE"){optionText='<option value="'+n.value+'">'+n.disvalue+'</option>';$("#moneyQuality").append(optionText);$("#moneyQuality").niceSelect();$("#moneyQuality").on("change",function(){loanApply.getProjectInfoList($("#prjKeyWord").val(),$(this).val())})}});$("#moneyQuality").niceSelect()}}}});sysCommon.getApproveFlowData("SZ_LOAN_APP")},funOperationEvent:function(){$('#approveCanelBtn').on("click",function(){loanApply.clearPageData()});$("#approveSubBtn,#saveBtn").off().on("click",function(){var thisBtn=$(this);$(this).attr('disabled',true).addClass('btn-disabled');var ajaxUrl="";var validFlag=true;var fromUrl='';if(thisBtn.hasClass("sub-btn")){ajaxUrl="sz/loanApp/submitLoanAppInfo";validFlag=$yt_valid.validForm($("#loanApply"));fromUrl='view/system-sasac/expensesReim/module/approval/loanApprovalList.html'}if(thisBtn.hasClass("save-btn")){ajaxUrl="sz/loanApp/saveLoanAppInfoToDrafts";fromUrl='view/system-sasac/expensesReim/module/approval/draftsList.html'}if(validFlag){var formDatas=loanApply.getLoanFormData();$.ajax({type:"post",url:ajaxUrl,async:false,data:formDatas,success:function(data){$yt_alert_Model.prompt(data.message);if(data.flag==0){$yt_common.parentAction({url:$yt_option.parent_action_path,funName:'locationToMenu',data:{url:fromUrl }})};$(this).attr('disabled',false).removeClass('btn-disabled')}})}else{sysCommon.pageToScroll($("#loanApply .valid-font"));$(this).attr('disabled',false).removeClass('btn-disabled')}})},getLoanFormData:function(){var applicantUserCode="";if($("#hidUserCode").val()!=""){applicantUserCode=$("#hidUserCode").val()}else{applicantUserCode=$yt_common.user_info.userName}var loanTerm=$("#lifeOfLoan option:selected").text();loanTerm=(loanTerm=='请选择'?'':loanTerm);return{loanAppId:loanApply.loanId,loanAppNum:$("#hidFormNum").val(),isSpecial:'',loanAppName:$("#loanReason").val(),loanAmount:$yt_baseElement.rmoney($("#loanMoney").val()||'0'),paymentMethod:$(".pay-met .yt-radio.check input").val(),loanTerm:loanTerm,expectRepaymentTime:$("#returnDate").val(),applicantUser:applicantUserCode,parameters:"",nextCode:$("#operate-flow").val(),dealingWithPeople:$("#approve-users").val(),opintion:$("#operateMsg").val(),processInstanceId:$("#processInstanceId").val()}},clearPageData:function(){$("#loanApply input:not(.radio-inpu,.hid-risk-code),#loanApply textarea").val('');$("#loanMoney").val('');$("#radio1").setRadioState("check");$("#moneyLower").text('--');$("#approve-users,#operate-flow,#lifeOfLoan").each(function(i,n){$(this).find("option:eq(0)").attr("selected","selected")});$("#loanApply select").each(function(i,n){$(this).find("option:eq(0)").attr("selected","selected")});$("#loanApply select").niceSelect();$("#loanApply .risk-img").attr("src",loanApply.riskExcMark)},loanMoneyEvent:function(){$("#loanMoney").on("focus",function(){if($(this).val()!=""&&$(this).val()!=null){$(this).val($yt_baseElement.rmoney($(this).val()));$(this).select()}});$("#loanMoney").on("blur",function(){if($(this).val()!=""&&$(this).val()!=null){var fmMoney=$yt_baseElement.fmMoney($(this).val());$(this).val(fmMoney);var lowerMoney=arabiaToChinese($(this).val());$("#moneyLower").text(lowerMoney)}})}};$(function(){loanApply.init()});